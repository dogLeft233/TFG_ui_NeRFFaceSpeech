<!doctype html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>è®­ç»ƒæ¨¡å‹ - NeRFFaceSpeech</title>
  <style>
    :root {
      --primary: #1e40af;
      /* ä¸»è‰²è°ƒï¼šæ·±è“è‰²ï¼Œç”¨äºé€‰ä¸­çŠ¶æ€ã€å¼ºè°ƒæŒ‰é’® */
      --primary-2: #3b82f6;
      /* æ¬¡è¦ä¸»è‰²ï¼šä¸­é—´è“è‰²ï¼Œç”¨äºæ¸å˜ã€æ¬¡è¦å¼ºè°ƒ */
      --bg: #0b1020;
      /* é¡µé¢èƒŒæ™¯è‰²ï¼šæ·±è‰²èƒŒæ™¯ */
      --card: rgba(255, 255, 255, 0.06);
      /* å¡ç‰‡èƒŒæ™¯ï¼šåŠé€æ˜ç™½è‰²ï¼Œç”¨äºå†…å®¹å¡ç‰‡ */
      --border: rgba(255, 255, 255, 0.14);
      /* è¾¹æ¡†é¢œè‰²ï¼šåŠé€æ˜ç™½è‰²è¾¹æ¡† */
      --text: #e5e7eb;
      /* ä¸»æ–‡å­—é¢œè‰²ï¼šæµ…ç°è‰²æ–‡å­— */
      --muted: #9ca3af;
      /* æ¬¡è¦æ–‡å­—é¢œè‰²ï¼šç°è‰²ï¼Œç”¨äºè¾…åŠ©ä¿¡æ¯ */
      --g1: rgba(59, 130, 246, 0.16);
      /* æ¸å˜1ï¼šè“è‰²æ¸å˜ç‚¹1 */
      --card-bg: rgba(59, 130, 246, 0.25);
      /* å¡ç‰‡èƒŒæ™¯è‰²ï¼šæµ…è“è‰²ï¼Œç”¨äºé¦–é¡µå¡ç‰‡å’Œä¸‹æ‹‰èœå• */
      --g2: rgba(14, 165, 233, 0.14);
      /* æ¸å˜2ï¼šé’è‰²æ¸å˜ç‚¹2 */
      --g3: rgba(56, 189, 248, 0.12);
      /* æ¸å˜3ï¼šæµ…è“è‰²æ¸å˜ç‚¹3 */
    }

    body.theme-tech {
      --primary: #1e40af;
      /* ä¸»è‰²è°ƒï¼šæ·±è“è‰² */
      --primary-2: #3b82f6;
      /* æ¬¡è¦ä¸»è‰²ï¼šä¸­é—´è“è‰² */
      --bg: #0b1020;
      /* é¡µé¢èƒŒæ™¯è‰²ï¼šæ·±è‰²èƒŒæ™¯ */
      --card: rgba(255, 255, 255, 0.06);
      /* å¡ç‰‡èƒŒæ™¯ï¼šåŠé€æ˜ç™½è‰² */
      --border: rgba(255, 255, 255, 0.14);
      /* è¾¹æ¡†é¢œè‰²ï¼šåŠé€æ˜ç™½è‰²è¾¹æ¡† */
      --text: #e5e7eb;
      /* ä¸»æ–‡å­—é¢œè‰²ï¼šæµ…ç°è‰²æ–‡å­— */
      --muted: #9ca3af;
      /* æ¬¡è¦æ–‡å­—é¢œè‰²ï¼šç°è‰² */
      --g1: rgba(59, 130, 246, 0.16);
      /* æ¸å˜1ï¼šè“è‰²æ¸å˜ç‚¹1 */
      --g2: rgba(14, 165, 233, 0.14);
      /* æ¸å˜2ï¼šé’è‰²æ¸å˜ç‚¹2 */
      --g3: rgba(56, 189, 248, 0.12);
      /* æ¸å˜3ï¼šæµ…è“è‰²æ¸å˜ç‚¹3 */
      --card-bg: rgba(59, 130, 246, 0.25);
      /* å¡ç‰‡èƒŒæ™¯è‰²ï¼šæµ…è“è‰² */
    }

    body.theme-warm {
      --primary: #f97316;
      /* ä¸»è‰²è°ƒï¼šæ©™è‰²ï¼Œç”¨äºé€‰ä¸­çŠ¶æ€ã€å¼ºè°ƒæŒ‰é’® */
      --primary-2: #ea580c;
      /* æ¬¡è¦ä¸»è‰²ï¼šæ·±æ©™è‰²ï¼Œç”¨äºæ¸å˜ã€æ¬¡è¦å¼ºè°ƒ */
      --bg: #fff8f0;
      /* é¡µé¢èƒŒæ™¯è‰²ï¼šæµ…æš–è‰²èƒŒæ™¯ */
      --card: rgba(255, 255, 255, 0.9);
      /* å¡ç‰‡èƒŒæ™¯ï¼šåŠé€æ˜ç™½è‰² */
      --border: rgba(249, 115, 22, 0.2);
      /* è¾¹æ¡†é¢œè‰²ï¼šåŠé€æ˜æ©™è‰²è¾¹æ¡† */
      --text: #1f2937;
      /* ä¸»æ–‡å­—é¢œè‰²ï¼šæ·±ç°è‰²æ–‡å­— */
      --muted: #6b7280;
      /* æ¬¡è¦æ–‡å­—é¢œè‰²ï¼šç°è‰² */
      --g1: rgba(251, 191, 36, 0.15);
      /* æ¸å˜1ï¼šé»„è‰²æ¸å˜ç‚¹1 */
      --g2: rgba(249, 115, 22, 0.12);
      /* æ¸å˜2ï¼šæ©™è‰²æ¸å˜ç‚¹2 */
      --g3: rgba(234, 88, 12, 0.1);
      /* æ¸å˜3ï¼šæ·±æ©™è‰²æ¸å˜ç‚¹3 */
      --card-bg: rgba(251, 191, 36, 0.15);
      /* å¡ç‰‡èƒŒæ™¯è‰²ï¼šæµ…é»„è‰² */
    }

    body.theme-minimal {
      --primary: #6b7280;
      /* ä¸»è‰²è°ƒï¼šç°è‰²ï¼Œç”¨äºé€‰ä¸­çŠ¶æ€ã€å¼ºè°ƒæŒ‰é’® */
      --primary-2: #4b5563;
      /* æ¬¡è¦ä¸»è‰²ï¼šæ·±ç°è‰²ï¼Œç”¨äºæ¸å˜ã€æ¬¡è¦å¼ºè°ƒ */
      --bg: #f5f5f5;
      /* é¡µé¢èƒŒæ™¯è‰²ï¼šæµ…ç°è‰²èƒŒæ™¯ */
      --card: #ffffff;
      /* å¡ç‰‡èƒŒæ™¯ï¼šç™½è‰² */
      --border: #e5e7eb;
      /* è¾¹æ¡†é¢œè‰²ï¼šæµ…ç°è‰²è¾¹æ¡† */
      --text: #111827;
      /* ä¸»æ–‡å­—é¢œè‰²ï¼šæ·±è‰²æ–‡å­— */
      --muted: #6b7280;
      /* æ¬¡è¦æ–‡å­—é¢œè‰²ï¼šç°è‰² */
      --g1: rgba(107, 114, 128, 0.08);
      /* æ¸å˜1ï¼šç°è‰²æ¸å˜ç‚¹1 */
      --g2: rgba(75, 85, 99, 0.07);
      /* æ¸å˜2ï¼šæ·±ç°è‰²æ¸å˜ç‚¹2 */
      --g3: rgba(156, 163, 175, 0.06);
      /* æ¸å˜3ï¼šæµ…ç°è‰²æ¸å˜ç‚¹3 */
      --card-bg: rgba(107, 114, 128, 0.1);
      /* å¡ç‰‡èƒŒæ™¯è‰²ï¼šæµ…ç°è‰² */
    }

    * {
      box-sizing: border-box;
    }

    :root {
      --base-font-size: 14px;
      /* åŸºç¡€å­—å· */
    }

    html {
      font-size: var(--base-font-size);
    }

    body {
      margin: 0;
      font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      font-size: 1rem;
      /* ä½¿ç”¨remå•ä½ï¼ŒåŸºäºæ ¹å…ƒç´ å­—ä½“å¤§å° */
      background: radial-gradient(circle at 20% 20%, var(--g1), transparent 25%),
        radial-gradient(circle at 80% 30%, var(--g2), transparent 25%),
        radial-gradient(circle at 50% 80%, var(--g3), transparent 22%),
        var(--bg);
      color: var(--text);
      min-height: 100vh;
    }

    /* è®¾ç½®æŒ‰é’® */
    .settings-btn {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1000;
      padding: 10px 16px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: var(--card-bg);
      color: var(--text);
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .settings-btn:hover {
      background: var(--primary);
      color: #fff;
      border-color: var(--primary);
    }

    /* ä¾§è¾¹æ é®ç½© */
    .sidebar-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.4);
      z-index: 2000;
      transition: opacity 0.3s ease;
    }

    .sidebar-overlay.active {
      display: block;
    }

    /* ä¾§è¾¹æ  */
    .sidebar {
      position: fixed;
      top: 0;
      right: -400px;
      width: 400px;
      height: 100vh;
      background: var(--bg);
      border-left: 1px solid var(--border);
      z-index: 2001;
      transition: right 0.3s ease;
      overflow-y: auto;
      box-shadow: -4px 0 20px rgba(0, 0, 0, 0.2);
    }

    .sidebar.active {
      right: 0;
    }

    .sidebar-content {
      padding: 24px;
    }

    .sidebar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 16px;
      border-bottom: 1px solid var(--border);
    }

    .sidebar-header h2 {
      margin: 0;
      font-size: 20px;
      color: var(--text);
    }

    .sidebar-close {
      background: none;
      border: none;
      font-size: 28px;
      color: var(--muted);
      cursor: pointer;
      padding: 0;
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 8px;
      transition: all 0.2s ease;
    }

    .sidebar-close:hover {
      background: var(--card-bg);
      color: var(--text);
    }

    /* åˆ†é¡µæ ‡ç­¾ */
    .sidebar-tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 20px;
      border-bottom: 1px solid var(--border);
    }

    .sidebar-tab {
      padding: 10px 20px;
      background: none;
      border: none;
      border-bottom: 2px solid transparent;
      color: var(--muted);
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .sidebar-tab.active {
      color: var(--primary);
      border-bottom-color: var(--primary);
    }

    .sidebar-tab:hover {
      color: var(--text);
    }

    /* åˆ†é¡µå†…å®¹ */
    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    /* é€‰é¡¹ç½‘æ ¼ */
    .options-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 12px;
      margin-bottom: 20px;
    }

    .option-card {
      padding: 16px;
      border: 2px solid var(--border);
      border-radius: 12px;
      background: var(--card-bg);
      cursor: pointer;
      transition: all 0.2s ease;
      text-align: center;
    }

    .option-card:hover {
      border-color: var(--primary);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .option-card.selected {
      border-color: var(--primary);
      background: var(--primary);
      color: #fff;
    }

    .option-card.selected .option-name {
      color: #fff;
    }

    .option-name {
      font-size: 14px;
      font-weight: 500;
      color: var(--text);
      margin-bottom: 4px;
    }

    .option-desc {
      font-size: 12px;
      color: var(--muted);
    }

    .option-card.selected .option-desc {
      color: rgba(255, 255, 255, 0.9);
    }

    /* å­—å·é€‰æ‹© */
    .font-size-group {
      display: flex;
      gap: 8px;
      margin-bottom: 20px;
    }

    .font-size-btn {
      flex: 1;
      padding: 12px;
      border: 2px solid var(--border);
      border-radius: 10px;
      background: var(--card-bg);
      color: var(--text);
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .font-size-btn:hover {
      border-color: var(--primary);
    }

    .font-size-btn.selected {
      border-color: var(--primary);
      background: var(--primary);
      color: #fff;
    }

    .font-size-custom {
      margin-top: 16px;
    }

    .font-size-custom input {
      width: 100%;
      padding: 10px;
      border: 1px solid var(--border);
      border-radius: 8px;
      background: var(--card-bg);
      color: var(--text);
      font-size: 14px;
    }

    .page {
      max-width: 1400px;
      width: 94vw;
      margin: 0 auto;
      padding: 20px 24px 40px;
      min-height: 96vh;
    }

    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 16px;
    }

    h1 {
      margin: 0;
      font-size: 24px;
      letter-spacing: 0.4px;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 12px;
      background: rgba(59, 130, 246, 0.2);
      color: #c7d2fe;
      font-size: 12px;
      border: 1px solid rgba(96, 165, 250, 0.5);
    }

    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 18px;
      box-shadow: 0 12px 32px rgba(0, 0, 0, 0.25);
    }

    label {
      font-weight: 700;
      margin-bottom: 6px;
      display: block;
    }

    input {
      width: 100%;
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 12px 14px;
      font-size: 15px;
      background: rgba(255, 255, 255, 0.04);
      color: var(--text);
      outline: none;
      transition: border-color .15s ease, box-shadow .15s ease;
    }

    input:focus {
      border-color: rgba(96, 165, 250, 0.8);
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.25);
    }

    button.primary {
      background: linear-gradient(135deg, var(--primary), var(--primary-2));
      border: 1px solid var(--primary-2);
      color: #fff;
      font-weight: 700;
      border-radius: 12px;
      padding: 12px 14px;
      cursor: pointer;
      width: 100%;
    }

    .log-box {
      background: #0f172a;
      color: #e2e8f0;
      padding: 12px;
      border-radius: 12px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      min-height: 300px;
      max-height: 500px;
      overflow-y: auto;
      white-space: pre-wrap;
      word-break: break-all;
    }

    .training-config {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-bottom: 12px;
    }

    .training-config.full-width {
      grid-template-columns: 1fr;
    }

    .progress-bar {
      width: 100%;
      height: 8px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 4px;
      overflow: hidden;
      margin: 8px 0;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--primary), var(--primary-2));
      transition: width 0.3s ease;
    }

    .task-list {
      margin-top: 16px;
      padding: 12px;
      background: rgba(255, 255, 255, 0.02);
      border-radius: 12px;
      max-height: 200px;
      overflow-y: auto;
    }

    .task-item {
      padding: 8px;
      margin-bottom: 8px;
      background: rgba(255, 255, 255, 0.04);
      border-radius: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .task-status {
      padding: 4px 8px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 500;
    }

    .task-status.running {
      background: rgba(59, 130, 246, 0.3);
      color: #60a5fa;
    }

    .task-status.completed {
      background: rgba(34, 197, 94, 0.3);
      color: #4ade80;
    }

    .task-status.failed {
      background: rgba(239, 68, 68, 0.3);
      color: #f87171;
    }

    .task-status.stopped {
      background: rgba(107, 114, 128, 0.3);
      color: #9ca3af;
    }

    select {
      width: 100%;
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 12px 14px;
      font-size: 15px;
      background: rgba(255, 255, 255, 0.04);
      color: var(--text);
      outline: none;
      transition: border-color .15s ease, box-shadow .15s ease;
    }

    select:focus {
      border-color: rgba(96, 165, 250, 0.8);
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.25);
    }

    .row {
      display: flex;
      gap: 10px;
    }

    .row>* {
      flex: 1;
    }

    .help-btn {
      background: #fef3c7;
      color: #92400e;
      border: 1px solid #fcd34d;
      border-radius: 10px;
      padding: 8px 10px;
      cursor: pointer;
      font-weight: 600;
    }

    a {
      color: #bfdbfe;
      text-decoration: none;
    }

    footer {
      margin-top: 24px;
      padding: 12px;
      text-align: center;
      color: var(--muted);
      font-size: 13px;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
    }
  </style>
  <script src="settings.js"></script>
</head>

<body>
  <button class="settings-btn" id="settingsBtn">âš™ï¸ è®¾ç½®</button>

  <!-- ä¾§è¾¹æ é®ç½© -->
  <div class="sidebar-overlay" id="sidebarOverlay"></div>

  <!-- è®¾ç½®ä¾§è¾¹æ  -->
  <div class="sidebar" id="settingsSidebar">
    <div class="sidebar-content">
      <div class="sidebar-header">
        <h2>è®¾ç½®</h2>
        <button class="sidebar-close" id="sidebarClose">Ã—</button>
      </div>

      <div class="sidebar-tabs">
        <button class="sidebar-tab active" data-tab="theme">ä¸»é¢˜</button>
        <button class="sidebar-tab" data-tab="font">å­—ä½“</button>
      </div>

      <!-- ä¸»é¢˜è®¾ç½® -->
      <div class="tab-content active" id="themeTab">
        <div class="options-grid">
          <div class="option-card" data-theme="tech">
            <div class="option-name">ç§‘æŠ€é£</div>
            <div class="option-desc">æ·±è“è‰²ç§‘æŠ€æ„Ÿ</div>
          </div>
          <div class="option-card" data-theme="warm">
            <div class="option-name">æ¸©é¦¨é£</div>
            <div class="option-desc">æš–è‰²è°ƒæ¸©é¦¨</div>
          </div>
          <div class="option-card" data-theme="minimal">
            <div class="option-name">ç®€çº¦é£</div>
            <div class="option-desc">ç°è‰²ç®€çº¦</div>
          </div>
        </div>
      </div>

      <!-- å­—ä½“è®¾ç½® -->
      <div class="tab-content" id="fontTab">
        <div style="margin-bottom: 16px;">
          <label style="display: block; margin-bottom: 8px; color: var(--text); font-weight: 500;">å­—ä½“æ ·å¼</label>
          <div class="options-grid">
            <div class="option-card" data-font="SimSun">
              <div class="option-name">å®‹ä½“</div>
              <div class="option-desc">SimSun</div>
            </div>
            <div class="option-card" data-font="SimHei">
              <div class="option-name">é»‘ä½“</div>
              <div class="option-desc">SimHei</div>
            </div>
            <div class="option-card" data-font="Microsoft YaHei">
              <div class="option-name">å¾®è½¯é›…é»‘</div>
              <div class="option-desc">Microsoft YaHei</div>
            </div>
            <div class="option-card" data-font="Arial">
              <div class="option-name">Arial</div>
              <div class="option-desc">Arial</div>
            </div>
            <div class="option-card" data-font="Times New Roman">
              <div class="option-name">Times New Roman</div>
              <div class="option-desc">Times New Roman</div>
            </div>
            <div class="option-card" data-font="Inter">
              <div class="option-name">Inter</div>
              <div class="option-desc">Interï¼ˆé»˜è®¤ï¼‰</div>
            </div>
          </div>
        </div>

        <div>
          <label style="display: block; margin-bottom: 8px; color: var(--text); font-weight: 500;">å­—å·å¤§å°</label>
          <div class="font-size-group">
            <button class="font-size-btn" data-size="small">å°</button>
            <button class="font-size-btn" data-size="medium">ä¸­</button>
            <button class="font-size-btn" data-size="large">å¤§</button>
            <button class="font-size-btn" data-size="custom">è‡ªå®šä¹‰</button>
          </div>
          <div class="font-size-custom" id="customSizeInput" style="display: none;">
            <input type="number" id="customSizeValue" placeholder="è¾“å…¥å­—å·ï¼ˆpxï¼‰" min="10" max="24" value="14">
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="page">
    <header>
      <div style="display:flex; align-items:center; gap:12px;">
        <h1>è®­ç»ƒæ¨¡å‹</h1>
        <span class="pill">StyleNeRF æ¨¡å‹å¾®è°ƒè®­ç»ƒ</span>
      </div>
      <div style="display:flex; gap:10px; max-width:320px;">
        <a href="./index.html"><button class="primary"
            style="background:#1f2937; border:1px solid #374151;">è¿”å›é¦–é¡µ</button></a>
        <button class="help-btn" id="helpBtn">â— å¸®åŠ©</button>
      </div>
    </header>

    <div class="card">
      <div style="display:flex; flex-direction:column; gap:16px;">
        <!-- è®­ç»ƒé…ç½® -->
        <div>
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
            <label style="margin:0;">è®­ç»ƒé…ç½®</label>
            <div style="display:flex; gap:8px;">
              <button class="secondary" id="saveConfigBtn" style="width:auto; padding:6px 12px; font-size:12px;">ğŸ’¾
                ä¿å­˜é…ç½®</button>
              <button class="secondary" id="loadConfigBtn" style="width:auto; padding:6px 12px; font-size:12px;">ğŸ“‚
                åŠ è½½é…ç½®</button>
            </div>
          </div>
          <div class="training-config">
            <!-- æ–‡ä»¶ä¸Šä¼ åŒºåŸŸ -->
            <div class="training-config full-width">
              <label>è®­ç»ƒæ•°æ®ä¸Šä¼ </label>
              <div id="fileUploadArea"
                style="border:2px dashed var(--border); border-radius:12px; padding:24px; text-align:center; cursor:pointer; background:rgba(255,255,255,0.02); transition:all 0.2s;">
                <div style="font-size:48px; margin-bottom:8px;">ğŸ“</div>
                <div style="color:var(--text); margin-bottom:4px;">ç‚¹å‡»é€‰æ‹©æ–‡ä»¶æˆ–æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤å¤„</div>
                <div style="color:var(--muted); font-size:12px;">æ”¯æŒæ–‡ä»¶å¤¹é€‰æ‹©ï¼ˆé€šè¿‡è·¯å¾„è¾“å…¥ï¼‰</div>
                <input type="file" id="fileInput" webkitdirectory multiple style="display:none;" />
              </div>
              <div style="margin-top:8px;">
                <label style="font-size:12px; color:var(--muted);">æˆ–è¾“å…¥è®­ç»ƒæ•°æ®è·¯å¾„:</label>
                <input id="trainData"
                  placeholder="/root/autodl-tmp/TFG_TALK_NeRFaceSpeech/data/geneface_datasets/data/raw" />
              </div>
            </div>
            <div>
              <label>åŸºç¡€æ¨¡å‹</label>
              <select id="baseModel">
                <option value="ffhq_1024.pkl">ffhq_1024.pklï¼ˆé»˜è®¤ï¼‰</option>
              </select>
            </div>
            <div>
              <label>å­¦ä¹ ç‡ (Learning Rate)</label>
              <input type="number" id="learningRate" value="0.002" min="0.0001" max="0.1" step="0.0001" />
            </div>
            <div>
              <label>æ‰¹é‡å¤§å° (Batch Size)</label>
              <input type="number" id="batchSize" value="4" min="1" max="32" />
            </div>
            <div>
              <label>è®­ç»ƒè½®æ•° (kimg)</label>
              <input type="number" id="kimg" value="50" min="1" max="1000" />
            </div>
            <div>
              <label>å¿«ç…§é—´éš” (snap)</label>
              <input type="number" id="snap" value="5" min="1" max="100" />
            </div>
            <div>
              <label>å›¾åƒå¿«ç…§é—´éš” (imgsnap)</label>
              <input type="number" id="imgsnap" value="1" min="1" max="50" />
            </div>
            <div>
              <label>æ•°æ®å¢å¼º (aug)</label>
              <select id="aug">
                <option value="noaug">noaugï¼ˆæ— å¢å¼ºï¼‰</option>
                <option value="crop">cropï¼ˆè£å‰ªï¼‰</option>
              </select>
            </div>
            <div>
              <label>é•œåƒç¿»è½¬</label>
              <select id="mirror">
                <option value="false">å¦</option>
                <option value="true">æ˜¯</option>
              </select>
            </div>
            <div>
              <label>æ¨¡å‹é…ç½®</label>
              <select id="modelConfig">
                <option value="style_ffhq_ae_basic">style_ffhq_ae_basicï¼ˆé»˜è®¤ï¼‰</option>
              </select>
            </div>
          </div>
        </div>

        <!-- æ“ä½œæŒ‰é’® -->
        <div class="row">
          <button class="secondary" id="refreshModelsBtn">åˆ·æ–°æ¨¡å‹åˆ—è¡¨</button>
          <button class="secondary" id="refreshTasksBtn">åˆ·æ–°ä»»åŠ¡åˆ—è¡¨</button>
          <button class="primary" id="trainBtn">ğŸš€ å¯åŠ¨è®­ç»ƒ</button>
        </div>

        <!-- å½“å‰è®­ç»ƒä»»åŠ¡ -->
        <div id="currentTaskSection" style="display:none;">
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
            <label style="margin:0;">å½“å‰è®­ç»ƒä»»åŠ¡</label>
            <div style="display:flex; gap:8px;">
              <button class="secondary" id="pauseTrainBtn" style="width:auto; padding:6px 12px; font-size:12px;">â¸ï¸
                æš‚åœ</button>
              <button class="secondary" id="resumeTrainBtn"
                style="width:auto; padding:6px 12px; font-size:12px; display:none;">â–¶ï¸ æ¢å¤</button>
              <button class="secondary" id="stopTrainBtn"
                style="width:auto; padding:6px 12px; font-size:12px;">åœæ­¢è®­ç»ƒ</button>
            </div>
          </div>
          <div id="currentTaskInfo"
            style="padding:12px; background:rgba(255,255,255,0.02); border-radius:8px; margin-bottom:8px;">
            <div style="display:flex; justify-content:space-between; margin-bottom:4px;">
              <span>ä»»åŠ¡ID: <span id="currentTaskId"></span></span>
              <span class="task-status" id="currentTaskStatus">running</span>
            </div>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px; margin-bottom:8px;">
              <div>
                <div style="font-size:12px; color:var(--muted); margin-bottom:4px;">è®­ç»ƒè¿›åº¦</div>
                <div class="progress-bar">
                  <div class="progress-fill" id="currentTaskProgress" style="width:0%"></div>
                </div>
                <div style="font-size:12px; color:var(--muted); margin-top:4px;">
                  è¿›åº¦: <span id="currentTaskProgressText">0%</span> | Epoch: <span id="currentEpoch">0</span> | Step:
                  <span id="currentStep">0</span>
                </div>
              </div>
              <div>
                <div style="font-size:12px; color:var(--muted); margin-bottom:4px;">è®­ç»ƒæ—¶é—´</div>
                <div style="font-size:18px; font-weight:600; color:var(--text);">
                  <span id="trainingTime">00:00:00</span>
                </div>
                <div style="font-size:11px; color:var(--muted); margin-top:4px;">
                  å·²ç”¨: <span id="elapsedTime">0h 0m</span> | é¢„è®¡å‰©ä½™: <span id="estimatedTime">--</span>
                </div>
              </div>
            </div>
          </div>

          <!-- GPU ä½¿ç”¨ç‡ -->
          <div id="gpuStatsSection" style="display:none;">
            <label style="margin-bottom:8px; display:block;">GPU ä½¿ç”¨æƒ…å†µ</label>
            <div class="gpu-stats" id="gpuStats">
              <!-- GPU ç»Ÿè®¡ä¿¡æ¯å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
            </div>
          </div>

          <!-- æŸå¤±æ›²çº¿å›¾ -->
          <div id="lossChartSection" style="display:none;">
            <label style="margin-bottom:8px; display:block;">è®­ç»ƒæŸå¤±æ›²çº¿</label>
            <div class="chart-container">
              <canvas id="lossChart"></canvas>
            </div>
          </div>
        </div>

        <!-- è®­ç»ƒä»»åŠ¡åˆ—è¡¨ -->
        <div>
          <label>è®­ç»ƒä»»åŠ¡å†å²</label>
          <div class="task-list" id="taskList">
            <div style="text-align:center; color:var(--muted); padding:20px;">æš‚æ— è®­ç»ƒä»»åŠ¡</div>
          </div>
        </div>

        <!-- è®­ç»ƒæ—¥å¿— -->
        <div>
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
            <label style="margin:0;">è®­ç»ƒæ—¥å¿—ï¼ˆå®æ—¶è‡ªåŠ¨æ»šåŠ¨ï¼‰</label>
            <button class="secondary" id="clearLogBtn"
              style="width:auto; padding:6px 12px; font-size:12px;">æ¸…ç©ºæ—¥å¿—</button>
          </div>
          <div class="log-box" id="trainLog">ç­‰å¾…å¯åŠ¨è®­ç»ƒä»»åŠ¡...</div>
        </div>

        <!-- æ¨¡å‹ç®¡ç† -->
        <div>
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
            <label style="margin:0;">å·²è®­ç»ƒæ¨¡å‹</label>
            <button class="secondary" id="refreshModelsListBtn" style="width:auto; padding:6px 12px; font-size:12px;">ğŸ”„
              åˆ·æ–°åˆ—è¡¨</button>
          </div>
          <div class="model-list" id="modelList">
            <div style="text-align:center; color:var(--muted); padding:40px; grid-column:1/-1;">
              æš‚æ— å·²è®­ç»ƒæ¨¡å‹
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <footer>
    åŒ—äº¬ç†å·¥å¤§å­¦ Â· NeRFFaceSpeech å›¢é˜Ÿ
  </footer>

  <!-- Chart.js for loss curve visualization -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <script>
    // ç­‰å¾…DOMåŠ è½½å®Œæˆåå†åˆå§‹åŒ–è®¾ç½®äº‹ä»¶ç»‘å®š
    document.addEventListener('DOMContentLoaded', async () => {
      // åº”ç”¨è®¾ç½®ï¼ˆä»æ•°æ®åº“è¯»å–ï¼‰- ä¼˜åŒ–ï¼šåªè°ƒç”¨ä¸€æ¬¡APIï¼Œç„¶åå¹¶è¡Œæ›´æ–°UI
      try {
        // åªè°ƒç”¨ä¸€æ¬¡ fetchSettings()ï¼Œè·å–æ‰€æœ‰è®¾ç½®
        const settings = await fetchSettings();

        // å¹¶è¡Œåº”ç”¨è®¾ç½®å’Œæ›´æ–°é€‰æ‹©çŠ¶æ€ï¼ˆä½¿ç”¨å·²è·å–çš„è®¾ç½®ï¼Œé¿å…é‡å¤APIè°ƒç”¨ï¼‰
        await Promise.all([
          applySettingsOnly(settings),
          updateThemeSelection(settings),
          updateFontSelection(settings),
          updateFontSizeSelection(settings)
        ]);
      } catch (error) {
        console.error('åº”ç”¨è®¾ç½®å¤±è´¥:', error);
      }

      // ä¾§è¾¹æ æ§åˆ¶
      const settingsBtn = document.getElementById('settingsBtn');
      const settingsSidebar = document.getElementById('settingsSidebar');
      const sidebarOverlay = document.getElementById('sidebarOverlay');
      const sidebarClose = document.getElementById('sidebarClose');

      if (!settingsBtn || !settingsSidebar) {
        console.error('è®¾ç½®æŒ‰é’®æˆ–ä¾§è¾¹æ å…ƒç´ æœªæ‰¾åˆ°', {
          settingsBtn: !!settingsBtn,
          settingsSidebar: !!settingsSidebar
        });
        return;
      }

      function openSidebar() {
        settingsSidebar.classList.add('active');
        sidebarOverlay.classList.add('active');
        document.body.style.overflow = 'hidden';
      }

      function closeSidebar() {
        settingsSidebar.classList.remove('active');
        sidebarOverlay.classList.remove('active');
        document.body.style.overflow = '';
      }

      settingsBtn.addEventListener('click', openSidebar);
      if (sidebarClose) sidebarClose.addEventListener('click', closeSidebar);
      if (sidebarOverlay) sidebarOverlay.addEventListener('click', closeSidebar);

      // åˆ†é¡µåˆ‡æ¢
      document.querySelectorAll('.sidebar-tab').forEach(tab => {
        tab.addEventListener('click', () => {
          const targetTab = tab.dataset.tab;
          document.querySelectorAll('.sidebar-tab').forEach(t => t.classList.remove('active'));
          document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
          tab.classList.add('active');
          const targetContent = document.getElementById(targetTab + 'Tab');
          if (targetContent) targetContent.classList.add('active');
        });
      });

      // ä¸»é¢˜é€‰æ‹©
      document.querySelectorAll('[data-theme]').forEach(card => {
        card.addEventListener('click', () => {
          applyTheme(card.dataset.theme);
        });
      });

      // å­—ä½“é€‰æ‹©
      document.querySelectorAll('[data-font]').forEach(card => {
        card.addEventListener('click', () => {
          applyFont(card.dataset.font);
        });
      });

      // å­—å·é€‰æ‹©
      document.querySelectorAll('[data-size]').forEach(btn => {
        btn.addEventListener('click', () => {
          applyFontSize(btn.dataset.size);
        });
      });

      // è‡ªå®šä¹‰å­—å·è¾“å…¥
      const customSizeValue = document.getElementById('customSizeValue');
      if (customSizeValue) {
        customSizeValue.addEventListener('change', (e) => {
          if (customSizeValue.value) {
            applyFontSize('custom');
          }
        });
      }
    });
    // ==================== è®­ç»ƒåŠŸèƒ½ ====================
    // è‡ªåŠ¨æ£€æµ‹æœåŠ¡å™¨åœ°å€
    // è‡ªåŠ¨æ£€æµ‹æœåŠ¡å™¨åœ°å€
    const FASTAPI_URL = (() => {
      const currentOrigin = window.location.origin;
      const currentHostname = window.location.hostname;
      const currentPort = window.location.port;
      const currentPath = window.location.pathname;
      const currentProtocol = window.location.protocol;

      // å¦‚æœå½“å‰ç«¯å£æ˜¯7860ï¼ˆå‰ç«¯æœåŠ¡å™¨ï¼‰ï¼Œåˆ™ä½¿ç”¨åç«¯æœåŠ¡å™¨ï¼ˆ8000ç«¯å£ï¼‰
      if (currentPort === '7860') {
        const backendUrl = `${currentProtocol}//${currentHostname}:8000`;
        console.log('âœ… æ£€æµ‹åˆ°å‰ç«¯æœåŠ¡å™¨ï¼ˆç«¯å£7860ï¼‰ï¼Œä½¿ç”¨åç«¯APIæœåŠ¡å™¨:', backendUrl);
        return backendUrl;
      }

      // å¦‚æœè·¯å¾„åŒ…å« /webui/ï¼Œè¯´æ˜æ˜¯æŒ‚è½½åœ¨FastAPIä¸‹çš„
      if (currentPath.includes('/webui/')) {
        console.log('âœ… æ£€æµ‹åˆ°FastAPIé™æ€æ–‡ä»¶æœåŠ¡ï¼Œä½¿ç”¨å½“å‰origin:', currentOrigin);
        return currentOrigin;
      }

      // å¦åˆ™ä½¿ç”¨å½“å‰origin
      console.log('âœ… ä½¿ç”¨å½“å‰originä½œä¸ºAPIæœåŠ¡å™¨:', currentOrigin);
      return currentOrigin;
    })();

    console.log('æœ€ç»ˆç¡®å®šçš„APIæœåŠ¡å™¨åœ°å€:', FASTAPI_URL);
    const trainBtn = document.getElementById("trainBtn");
    const refreshModelsBtn = document.getElementById("refreshModelsBtn");
    const refreshTasksBtn = document.getElementById("refreshTasksBtn");
    const stopTrainBtn = document.getElementById("stopTrainBtn");
    const clearLogBtn = document.getElementById("clearLogBtn");
    const trainLog = document.getElementById("trainLog");
    const taskList = document.getElementById("taskList");
    const currentTaskSection = document.getElementById("currentTaskSection");

    let currentTaskId = null;
    let statusPollInterval = null;

    // åŠ è½½é»˜è®¤æ•°æ®é›†è·¯å¾„
    async function loadDefaultDatasetPath() {
      try {
        const res = await fetch(`${FASTAPI_URL}/train/datasets`);
        const data = await res.json();

        if (data.success && data.default_path) {
          const trainDataInput = document.getElementById("trainData");
          if (trainDataInput && !trainDataInput.value.trim()) {
            // åªæœ‰åœ¨è¾“å…¥æ¡†ä¸ºç©ºæ—¶æ‰è®¾ç½®é»˜è®¤å€¼ä½œä¸ºplaceholderæç¤º
            trainDataInput.placeholder = data.default_path;
            // å¦‚æœç”¨æˆ·æ²¡æœ‰è¾“å…¥ï¼Œä¹Ÿå¯ä»¥è‡ªåŠ¨å¡«å……ï¼ˆå¯é€‰ï¼‰
            // trainDataInput.value = data.default_path;
          }
        }
      } catch (e) {
        console.error("åŠ è½½é»˜è®¤æ•°æ®é›†è·¯å¾„å¤±è´¥:", e);
      }
    }

    // åŠ è½½åŸºç¡€æ¨¡å‹åˆ—è¡¨
    async function loadBaseModels() {
      try {
        const res = await fetch(`${FASTAPI_URL}/models`);
        const data = await res.json();

        // æ£€æŸ¥æ˜¯å¦æ˜¯é”™è¯¯å“åº”
        if (data.success === false || (data.error && !Array.isArray(data))) {
          const errorMsg = data.error || "æœªçŸ¥é”™è¯¯";
          appendLog(`âŒ æ¨¡å‹åˆ—è¡¨è·å–å¤±è´¥ï¼š${errorMsg}`);
          const baseModelSelect = document.getElementById("baseModel");
          if (baseModelSelect) {
            baseModelSelect.innerHTML = "";
            const opt = document.createElement("option");
            opt.value = "";
            opt.textContent = "æ¨¡å‹åŠ è½½å¤±è´¥";
            opt.disabled = true;
            baseModelSelect.appendChild(opt);
          }
          return;
        }

        // æ­£å¸¸æƒ…å†µï¼šdata åº”è¯¥æ˜¯æ•°ç»„
        if (!Array.isArray(data) || data.length === 0) {
          appendLog("âŒ æ¨¡å‹åˆ—è¡¨ä¸ºç©ºï¼Œè¯·æ£€æŸ¥æ¨¡å‹ç›®å½•");
          const baseModelSelect = document.getElementById("baseModel");
          if (baseModelSelect) {
            baseModelSelect.innerHTML = "";
            const opt = document.createElement("option");
            opt.value = "";
            opt.textContent = "æ¨¡å‹åˆ—è¡¨ä¸ºç©º";
            opt.disabled = true;
            baseModelSelect.appendChild(opt);
          }
          return;
        }

        const baseModelSelect = document.getElementById("baseModel");
        if (!baseModelSelect) return;
        baseModelSelect.innerHTML = "";
        data.forEach(model => {
          const opt = document.createElement("option");
          opt.value = model;
          opt.textContent = model;
          if (model === "ffhq_1024.pkl") {
            opt.selected = true;
          }
          baseModelSelect.appendChild(opt);
        });
      } catch (e) {
        appendLog(`âŒ åŠ è½½æ¨¡å‹åˆ—è¡¨å¤±è´¥: ${e.message || e}`);
        const baseModelSelect = document.getElementById("baseModel");
        if (baseModelSelect) {
          baseModelSelect.innerHTML = "";
          const opt = document.createElement("option");
          opt.value = "";
          opt.textContent = "åŠ è½½å¤±è´¥";
          opt.disabled = true;
          baseModelSelect.appendChild(opt);
        }
      }
    }

    // åŠ è½½è®­ç»ƒä»»åŠ¡åˆ—è¡¨
    async function loadTasks() {
      try {
        const res = await fetch(`${FASTAPI_URL}/train/tasks`);
        const data = await res.json();

        if (data.success && data.data && data.data.length > 0) {
          taskList.innerHTML = "";
          data.data.forEach(task => {
            const taskItem = document.createElement("div");
            taskItem.className = "task-item";
            taskItem.innerHTML = `
              <div>
                <div style="font-weight:500; margin-bottom:4px;">${task.task_id.substring(0, 8)}...</div>
                <div style="font-size:12px; color:var(--muted);">
                  ${new Date(task.start_time).toLocaleString('zh-CN')} | ${task.base_model}
                </div>
              </div>
              <div style="display:flex; align-items:center; gap:8px;">
                <span class="task-status ${task.status}">${getStatusText(task.status)}</span>
                <span style="font-size:12px;">${task.progress}%</span>
              </div>
            `;
            taskItem.addEventListener("click", () => {
              viewTask(task.task_id);
            });
            taskList.appendChild(taskItem);
          });
        } else {
          taskList.innerHTML = '<div style="text-align:center; color:var(--muted); padding:20px;">æš‚æ— è®­ç»ƒä»»åŠ¡</div>';
        }
      } catch (e) {
        appendLog("âŒ åŠ è½½ä»»åŠ¡åˆ—è¡¨å¤±è´¥: " + e.message);
      }
    }

    function getStatusText(status) {
      const statusMap = {
        "running": "è¿è¡Œä¸­",
        "completed": "å·²å®Œæˆ",
        "failed": "å¤±è´¥",
        "stopped": "å·²åœæ­¢",
        "pending": "ç­‰å¾…ä¸­"
      };
      return statusMap[status] || status;
    }

    // å¯åŠ¨è®­ç»ƒ
    async function startTraining() {
      const dataPath = document.getElementById("trainData").value.trim();
      if (!dataPath) {
        appendLog("âŒ è¯·è¾“å…¥è®­ç»ƒæ•°æ®è·¯å¾„");
        return;
      }

      const config = {
        data_path: dataPath,
        base_model: document.getElementById("baseModel").value,
        learning_rate: parseFloat(document.getElementById("learningRate").value) || 0.002,
        batch_size: parseInt(document.getElementById("batchSize").value) || 4,
        kimg: parseInt(document.getElementById("kimg").value) || 50,
        snap: parseInt(document.getElementById("snap").value) || 5,
        imgsnap: parseInt(document.getElementById("imgsnap").value) || 1,
        aug: document.getElementById("aug").value,
        mirror: document.getElementById("mirror").value === "true",
        config_name: document.getElementById("modelConfig").value
      };

      trainBtn.disabled = true;
      trainBtn.textContent = "å¯åŠ¨ä¸­...";
      appendLog("æ­£åœ¨å¯åŠ¨è®­ç»ƒä»»åŠ¡...");

      try {
        const res = await fetch(`${FASTAPI_URL}/train/start`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(config)
        });

        const data = await res.json();

        if (data.success) {
          currentTaskId = data.task_id;
          appendLog(`âœ… è®­ç»ƒä»»åŠ¡å·²å¯åŠ¨ï¼Œä»»åŠ¡ID: ${currentTaskId}`);
          currentTaskSection.style.display = "block";
          lossChartSection.style.display = "block";
          document.getElementById("currentTaskId").textContent = currentTaskId.substring(0, 16) + "...";
          startTrainingTimer();
          updateGPUStats();
          startStatusPolling();
          loadTasks();
        } else {
          appendLog("âŒ å¯åŠ¨è®­ç»ƒå¤±è´¥: " + (data.error || "æœªçŸ¥é”™è¯¯"));
        }
      } catch (e) {
        appendLog("âŒ è°ƒç”¨å¤±è´¥: " + e.message);
      } finally {
        trainBtn.disabled = false;
        trainBtn.textContent = "ğŸš€ å¯åŠ¨è®­ç»ƒ";
      }
    }

    // æŸ¥çœ‹ä»»åŠ¡è¯¦æƒ…
    async function viewTask(taskId) {
      currentTaskId = taskId;
      currentTaskSection.style.display = "block";
      document.getElementById("currentTaskId").textContent = taskId.substring(0, 16) + "...";
      startStatusPolling();
    }

    // åœæ­¢è®­ç»ƒ
    async function stopTraining() {
      if (!currentTaskId) return;

      if (!confirm("ç¡®å®šè¦åœæ­¢å½“å‰è®­ç»ƒä»»åŠ¡å—ï¼Ÿ")) {
        return;
      }

      try {
        const res = await fetch(`${FASTAPI_URL}/train/stop/${currentTaskId}`, {
          method: "POST"
        });

        const data = await res.json();

        if (data.success) {
          appendLog("âœ… è®­ç»ƒä»»åŠ¡å·²åœæ­¢");
          stopStatusPolling();
          loadTasks();
        } else {
          appendLog("âŒ åœæ­¢è®­ç»ƒå¤±è´¥: " + (data.error || "æœªçŸ¥é”™è¯¯"));
        }
      } catch (e) {
        appendLog("âŒ åœæ­¢è®­ç»ƒå¤±è´¥: " + e.message);
      }
    }

    // å¼€å§‹è½®è¯¢çŠ¶æ€
    function startStatusPolling() {
      if (statusPollInterval) {
        clearInterval(statusPollInterval);
      }

      statusPollInterval = setInterval(async () => {
        if (!currentTaskId) {
          stopStatusPolling();
          return;
        }

        try {
          const res = await fetch(`${FASTAPI_URL}/train/status/${currentTaskId}`);
          const data = await res.json();

          if (data.success) {
            const task = data.data;
            document.getElementById("currentTaskStatus").textContent = getStatusText(task.status);
            document.getElementById("currentTaskStatus").className = `task-status ${task.status}`;
            document.getElementById("currentTaskProgress").style.width = task.progress + "%";
            document.getElementById("currentTaskProgressText").textContent = task.progress + "%";

            // æ›´æ–°æ—¥å¿—
            if (task.recent_log && task.recent_log.length > 0) {
              const logText = task.recent_log.join("\n");
              trainLog.textContent = logText;
              trainLog.scrollTop = trainLog.scrollHeight;
            }

            // æ›´æ–°æŸå¤±æ›²çº¿ï¼ˆä»æ—¥å¿—ä¸­è§£ææŸå¤±å€¼ï¼‰
            updateLossChart(task.log || []);

            // å¦‚æœä»»åŠ¡å®Œæˆæˆ–å¤±è´¥ï¼Œåœæ­¢è½®è¯¢
            if (task.status === "completed" || task.status === "failed" || task.status === "stopped") {
              stopStatusPolling();
              stopTrainingTimer();
              if (task.status === "completed") {
                appendLog("âœ… è®­ç»ƒä»»åŠ¡å·²å®Œæˆï¼");
                loadTrainedModels(); // åˆ·æ–°æ¨¡å‹åˆ—è¡¨
              } else if (task.status === "failed") {
                appendLog("âŒ è®­ç»ƒä»»åŠ¡å¤±è´¥: " + (task.error || "æœªçŸ¥é”™è¯¯"));
              }
              loadTasks();
            }
          }
        } catch (e) {
          appendLog("âŒ è·å–ä»»åŠ¡çŠ¶æ€å¤±è´¥: " + e.message);
        }
      }, 2000); // æ¯2ç§’è½®è¯¢ä¸€æ¬¡
    }

    // åœæ­¢è½®è¯¢
    function stopStatusPolling() {
      if (statusPollInterval) {
        clearInterval(statusPollInterval);
        statusPollInterval = null;
      }
    }

    // è¿½åŠ æ—¥å¿—
    function appendLog(message) {
      const timestamp = new Date().toLocaleTimeString('zh-CN');
      trainLog.textContent += `[${timestamp}] ${message}\n`;
      trainLog.scrollTop = trainLog.scrollHeight;
    }

    // æ¸…ç©ºæ—¥å¿—
    function clearLog() {
      trainLog.textContent = "";
    }

    // ==================== æ–‡ä»¶ä¸Šä¼ åŠŸèƒ½ ====================
    fileUploadArea.addEventListener("click", () => fileInput.click());
    fileInput.addEventListener("change", (e) => {
      if (e.target.files.length > 0) {
        // æ³¨æ„ï¼šæµè§ˆå™¨å®‰å…¨é™åˆ¶ï¼Œæ— æ³•ç›´æ¥è·å–æ–‡ä»¶å¤¹è·¯å¾„
        // è¿™é‡Œåªæ˜¯æç¤ºç”¨æˆ·ï¼Œå®é™…è¿˜æ˜¯éœ€è¦æ‰‹åŠ¨è¾“å…¥è·¯å¾„
        appendLog("âš ï¸ æ–‡ä»¶é€‰æ‹©å®Œæˆã€‚ç”±äºæµè§ˆå™¨é™åˆ¶ï¼Œè¯·æ‰‹åŠ¨è¾“å…¥æ•°æ®è·¯å¾„ã€‚");
      }
    });

    // æ‹–æ‹½ä¸Šä¼ 
    fileUploadArea.addEventListener("dragover", (e) => {
      e.preventDefault();
      fileUploadArea.classList.add("dragover");
    });
    fileUploadArea.addEventListener("dragleave", () => {
      fileUploadArea.classList.remove("dragover");
    });
    fileUploadArea.addEventListener("drop", (e) => {
      e.preventDefault();
      fileUploadArea.classList.remove("dragover");
      appendLog("âš ï¸ æ–‡ä»¶æ‹–æ‹½å®Œæˆã€‚ç”±äºæµè§ˆå™¨é™åˆ¶ï¼Œè¯·æ‰‹åŠ¨è¾“å…¥æ•°æ®è·¯å¾„ã€‚");
    });

    // ==================== é…ç½®é¢„è®¾åŠŸèƒ½ ====================
    saveConfigBtn.addEventListener("click", () => {
      const configName = prompt("è¯·è¾“å…¥é…ç½®åç§°:");
      if (!configName) return;

      const config = {
        trainData: document.getElementById("trainData").value,
        baseModel: document.getElementById("baseModel").value,
        learningRate: document.getElementById("learningRate").value,
        batchSize: document.getElementById("batchSize").value,
        kimg: document.getElementById("kimg").value,
        snap: document.getElementById("snap").value,
        imgsnap: document.getElementById("imgsnap").value,
        aug: document.getElementById("aug").value,
        mirror: document.getElementById("mirror").value,
        modelConfig: document.getElementById("modelConfig").value
      };

      const savedConfigs = JSON.parse(localStorage.getItem("train_configs") || "{}");
      savedConfigs[configName] = config;
      localStorage.setItem("train_configs", JSON.stringify(savedConfigs));
      appendLog(`âœ… é…ç½® "${configName}" å·²ä¿å­˜`);
    });

    loadConfigBtn.addEventListener("click", () => {
      const savedConfigs = JSON.parse(localStorage.getItem("train_configs") || "{}");
      const configNames = Object.keys(savedConfigs);
      if (configNames.length === 0) {
        alert("æ²¡æœ‰ä¿å­˜çš„é…ç½®");
        return;
      }

      const selected = prompt(`è¯·è¾“å…¥è¦åŠ è½½çš„é…ç½®åç§°:\nå¯ç”¨é…ç½®: ${configNames.join(", ")}`);
      if (!selected || !savedConfigs[selected]) {
        return;
      }

      const config = savedConfigs[selected];
      document.getElementById("trainData").value = config.trainData || "";
      document.getElementById("baseModel").value = config.baseModel || "ffhq_1024.pkl";
      document.getElementById("learningRate").value = config.learningRate || "0.002";
      document.getElementById("batchSize").value = config.batchSize || "4";
      document.getElementById("kimg").value = config.kimg || "50";
      document.getElementById("snap").value = config.snap || "5";
      document.getElementById("imgsnap").value = config.imgsnap || "1";
      document.getElementById("aug").value = config.aug || "noaug";
      document.getElementById("mirror").value = config.mirror || "false";
      document.getElementById("modelConfig").value = config.modelConfig || "style_ffhq_ae_basic";
      appendLog(`âœ… é…ç½® "${selected}" å·²åŠ è½½`);
    });

    // ==================== æŸå¤±æ›²çº¿å›¾åˆå§‹åŒ– ====================
    function initLossChart() {
      const ctx = document.getElementById("lossChart");
      if (!ctx) return;

      lossChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: [],
          datasets: [
            { label: 'Total Loss', data: [], borderColor: '#3b82f6', backgroundColor: 'rgba(59,130,246,0.1)', tension: 0.1 },
            { label: 'G Loss', data: [], borderColor: '#10b981', backgroundColor: 'rgba(16,185,129,0.1)', tension: 0.1 },
            { label: 'D Loss', data: [], borderColor: '#f59e0b', backgroundColor: 'rgba(245,158,11,0.1)', tension: 0.1 }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { labels: { color: '#e5e7eb' } }
          },
          scales: {
            x: { ticks: { color: '#9ca3af' }, grid: { color: 'rgba(255,255,255,0.1)' } },
            y: { ticks: { color: '#9ca3af' }, grid: { color: 'rgba(255,255,255,0.1)' } }
          }
        }
      });
    }

    // ==================== GPU ä½¿ç”¨ç‡æ˜¾ç¤º ====================
    async function updateGPUStats() {
      // è¿™é‡Œéœ€è¦åç«¯APIæä¾›GPUä¿¡æ¯
      // æš‚æ—¶ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®
      gpuStatsSection.style.display = "block";
      const gpuStatsEl = document.getElementById("gpuStats");
      gpuStatsEl.innerHTML = `
        <div class="gpu-stat-card">
          <div class="gpu-stat-label">GPU ä½¿ç”¨ç‡</div>
          <div class="gpu-stat-value">85%</div>
          <div class="gpu-stat-bar"><div class="gpu-stat-bar-fill" style="width:85%"></div></div>
        </div>
        <div class="gpu-stat-card">
          <div class="gpu-stat-label">æ˜¾å­˜ä½¿ç”¨</div>
          <div class="gpu-stat-value">12.5 / 24 GB</div>
          <div class="gpu-stat-bar"><div class="gpu-stat-bar-fill" style="width:52%"></div></div>
        </div>
        <div class="gpu-stat-card">
          <div class="gpu-stat-label">GPU æ¸©åº¦</div>
          <div class="gpu-stat-value">72Â°C</div>
        </div>
      `;
    }

    // ==================== è®­ç»ƒæ—¶é—´ç»Ÿè®¡ ====================
    function startTrainingTimer() {
      trainingStartTime = Date.now();
      if (trainingTimerInterval) clearInterval(trainingTimerInterval);

      trainingTimerInterval = setInterval(() => {
        if (!trainingStartTime) return;
        const elapsed = Date.now() - trainingStartTime;
        const hours = Math.floor(elapsed / 3600000);
        const minutes = Math.floor((elapsed % 3600000) / 60000);
        const seconds = Math.floor((elapsed % 60000) / 1000);

        document.getElementById("trainingTime").textContent =
          `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        document.getElementById("elapsedTime").textContent = `${hours}h ${minutes}m`;
      }, 1000);
    }

    function stopTrainingTimer() {
      if (trainingTimerInterval) {
        clearInterval(trainingTimerInterval);
        trainingTimerInterval = null;
      }
    }

    // ==================== æ¨¡å‹ç®¡ç†åŠŸèƒ½ ====================
    async function loadTrainedModels() {
      try {
        // è¿™é‡Œéœ€è¦åç«¯APIæä¾›å·²è®­ç»ƒæ¨¡å‹åˆ—è¡¨
        // æš‚æ—¶ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®
        const modelListEl = document.getElementById("modelList");
        modelListEl.innerHTML = `
          <div style="text-align:center; color:var(--muted); padding:40px; grid-column:1/-1;">
            æš‚æ— å·²è®­ç»ƒæ¨¡å‹ï¼ˆåŠŸèƒ½å¼€å‘ä¸­ï¼‰
          </div>
        `;
      } catch (e) {
        appendLog("âŒ åŠ è½½æ¨¡å‹åˆ—è¡¨å¤±è´¥: " + e.message);
      }
    }

    // äº‹ä»¶ç»‘å®š
    trainBtn.addEventListener("click", startTraining);
    refreshModelsBtn.addEventListener("click", loadBaseModels);
    refreshTasksBtn.addEventListener("click", loadTasks);
    refreshModelsListBtn.addEventListener("click", loadTrainedModels);
    stopTrainBtn.addEventListener("click", stopTraining);
    clearLogBtn.addEventListener("click", clearLog);

    // åˆå§‹åŒ–
    loadBaseModels();
    loadDefaultDatasetPath();
    loadTasks();
    loadTrainedModels();
    initLossChart();

    // ==================== å¸®åŠ©åŠŸèƒ½ ====================
    function initHelp() {
      document.getElementById("helpBtn").addEventListener("click", () => {
        alert("ä½¿ç”¨æç¤ºï¼š\n" +
          "1. å¡«å†™è®­ç»ƒæ•°æ®è·¯å¾„ï¼ˆå•å¼ å›¾åƒæ•°æ®é›†ç›®å½•ï¼‰\n" +
          "2. é€‰æ‹©åŸºç¡€æ¨¡å‹å’Œé…ç½®å‚æ•°\n" +
          "3. ç‚¹å‡»â€œå¯åŠ¨è®­ç»ƒâ€å¼€å§‹è®­ç»ƒ\n" +
          "4. è®­ç»ƒæ—¥å¿—ä¼šå®æ—¶æ›´æ–°\n" +
          "5. å¯ä»¥æŸ¥çœ‹è®­ç»ƒä»»åŠ¡å†å²å’Œè¿›åº¦\n" +
          "6. è®­ç»ƒå®Œæˆåï¼Œæ¨¡å‹ä¼šä¿å­˜åˆ°è®­ç»ƒè¾“å‡ºç›®å½•");
      });
    }

    initHelp();
  </script>
</body>

</html>