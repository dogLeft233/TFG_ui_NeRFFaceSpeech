<!doctype html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>è§†é¢‘ç”Ÿæˆ - NeRFFaceSpeech</title>
  <style>
    :root {
      --primary: #1e40af;
      /* ä¸»è‰²è°ƒï¼šæ·±è“è‰²ï¼Œç”¨äºé€‰ä¸­çŠ¶æ€ã€å¼ºè°ƒæŒ‰é’® */
      --primary-2: #3b82f6;
      /* æ¬¡è¦ä¸»è‰²ï¼šä¸­é—´è“è‰²ï¼Œç”¨äºæ¸å˜ã€æ¬¡è¦å¼ºè°ƒ */
      --bg: #0b1020;
      /* é¡µé¢èƒŒæ™¯è‰²ï¼šæ·±è‰²èƒŒæ™¯ */
      --card: rgba(255, 255, 255, 0.06);
      /* å¡ç‰‡èƒŒæ™¯ï¼šåŠé€æ˜ç™½è‰²ï¼Œç”¨äºå†…å®¹å¡ç‰‡ */
      --border: rgba(255, 255, 255, 0.14);
      /* è¾¹æ¡†é¢œè‰²ï¼šåŠé€æ˜ç™½è‰²è¾¹æ¡† */
      --text: #e5e7eb;
      /* ä¸»æ–‡å­—é¢œè‰²ï¼šæµ…ç°è‰²æ–‡å­— */
      --muted: #9ca3af;
      /* æ¬¡è¦æ–‡å­—é¢œè‰²ï¼šç°è‰²ï¼Œç”¨äºè¾…åŠ©ä¿¡æ¯ */
      --g1: rgba(59, 130, 246, 0.16);
      /* æ¸å˜1ï¼šè“è‰²æ¸å˜ç‚¹1 */
      --g2: rgba(14, 165, 233, 0.14);
      /* æ¸å˜2ï¼šé’è‰²æ¸å˜ç‚¹2 */
      --g3: rgba(56, 189, 248, 0.12);
      /* æ¸å˜3ï¼šæµ…è“è‰²æ¸å˜ç‚¹3 */
      --grad1: #0b1220;
      /* æ¸å˜èµ·å§‹è‰²ï¼šæ·±è“è‰² */
      --grad2: #0f172a;
      /* æ¸å˜ç»“æŸè‰²ï¼šæ·±è“ç°è‰² */
      --card-bg: rgba(59, 130, 246, 0.25);
      /* å¡ç‰‡èƒŒæ™¯è‰²ï¼šæµ…è“è‰²ï¼Œç”¨äºé¦–é¡µå¡ç‰‡å’Œä¸‹æ‹‰èœå• */
    }

    body.theme-tech {
      --primary: #1e40af;
      /* ä¸»è‰²è°ƒï¼šæ·±è“è‰² */
      --primary-2: #3b82f6;
      /* æ¬¡è¦ä¸»è‰²ï¼šä¸­é—´è“è‰² */
      --bg: #0b1020;
      /* é¡µé¢èƒŒæ™¯è‰²ï¼šæ·±è‰²èƒŒæ™¯ */
      --card: rgba(255, 255, 255, 0.06);
      /* å¡ç‰‡èƒŒæ™¯ï¼šåŠé€æ˜ç™½è‰² */
      --border: rgba(255, 255, 255, 0.14);
      /* è¾¹æ¡†é¢œè‰²ï¼šåŠé€æ˜ç™½è‰²è¾¹æ¡† */
      --text: #e5e7eb;
      /* ä¸»æ–‡å­—é¢œè‰²ï¼šæµ…ç°è‰²æ–‡å­— */
      --muted: #9ca3af;
      /* æ¬¡è¦æ–‡å­—é¢œè‰²ï¼šç°è‰² */
      --g1: rgba(59, 130, 246, 0.16);
      /* æ¸å˜1ï¼šè“è‰²æ¸å˜ç‚¹1 */
      --g2: rgba(14, 165, 233, 0.14);
      /* æ¸å˜2ï¼šé’è‰²æ¸å˜ç‚¹2 */
      --g3: rgba(56, 189, 248, 0.12);
      /* æ¸å˜3ï¼šæµ…è“è‰²æ¸å˜ç‚¹3 */
      --grad1: #0b1220;
      /* æ¸å˜èµ·å§‹è‰²ï¼šæ·±è“è‰² */
      --grad2: #0f172a;
      /* æ¸å˜ç»“æŸè‰²ï¼šæ·±è“ç°è‰² */
      --card-bg: rgba(59, 130, 246, 0.25);
      /* å¡ç‰‡èƒŒæ™¯è‰²ï¼šæµ…è“è‰² */
    }

    body.theme-warm {
      --primary: #f97316;
      /* ä¸»è‰²è°ƒï¼šæ©™è‰²ï¼Œç”¨äºé€‰ä¸­çŠ¶æ€ã€å¼ºè°ƒæŒ‰é’® */
      --primary-2: #ea580c;
      /* æ¬¡è¦ä¸»è‰²ï¼šæ·±æ©™è‰²ï¼Œç”¨äºæ¸å˜ã€æ¬¡è¦å¼ºè°ƒ */
      --bg: #fff8f0;
      /* é¡µé¢èƒŒæ™¯è‰²ï¼šæµ…æš–è‰²èƒŒæ™¯ */
      --card: rgba(255, 255, 255, 0.9);
      /* å¡ç‰‡èƒŒæ™¯ï¼šåŠé€æ˜ç™½è‰² */
      --border: rgba(249, 115, 22, 0.2);
      /* è¾¹æ¡†é¢œè‰²ï¼šåŠé€æ˜æ©™è‰²è¾¹æ¡† */
      --text: #1f2937;
      /* ä¸»æ–‡å­—é¢œè‰²ï¼šæ·±ç°è‰²æ–‡å­— */
      --muted: #6b7280;
      /* æ¬¡è¦æ–‡å­—é¢œè‰²ï¼šç°è‰² */
      --g1: rgba(251, 191, 36, 0.15);
      /* æ¸å˜1ï¼šé»„è‰²æ¸å˜ç‚¹1 */
      --g2: rgba(249, 115, 22, 0.12);
      /* æ¸å˜2ï¼šæ©™è‰²æ¸å˜ç‚¹2 */
      --g3: rgba(234, 88, 12, 0.1);
      /* æ¸å˜3ï¼šæ·±æ©™è‰²æ¸å˜ç‚¹3 */
      --grad1: #fff8f0;
      /* æ¸å˜èµ·å§‹è‰²ï¼šæµ…æš–è‰² */
      --grad2: #fff5e6;
      /* æ¸å˜ç»“æŸè‰²ï¼šæµ…é»„è‰² */
      --card-bg: rgba(251, 191, 36, 0.15);
      /* å¡ç‰‡èƒŒæ™¯è‰²ï¼šæµ…é»„è‰² */
    }

    body.theme-minimal {
      --primary: #6b7280;
      /* ä¸»è‰²è°ƒï¼šç°è‰²ï¼Œç”¨äºé€‰ä¸­çŠ¶æ€ã€å¼ºè°ƒæŒ‰é’® */
      --primary-2: #4b5563;
      /* æ¬¡è¦ä¸»è‰²ï¼šæ·±ç°è‰²ï¼Œç”¨äºæ¸å˜ã€æ¬¡è¦å¼ºè°ƒ */
      --bg: #f5f5f5;
      /* é¡µé¢èƒŒæ™¯è‰²ï¼šæµ…ç°è‰²èƒŒæ™¯ */
      --card: #ffffff;
      /* å¡ç‰‡èƒŒæ™¯ï¼šç™½è‰² */
      --border: #e5e7eb;
      /* è¾¹æ¡†é¢œè‰²ï¼šæµ…ç°è‰²è¾¹æ¡† */
      --text: #111827;
      /* ä¸»æ–‡å­—é¢œè‰²ï¼šæ·±è‰²æ–‡å­— */
      --muted: #6b7280;
      /* æ¬¡è¦æ–‡å­—é¢œè‰²ï¼šç°è‰² */
      --g1: rgba(107, 114, 128, 0.08);
      /* æ¸å˜1ï¼šç°è‰²æ¸å˜ç‚¹1 */
      --g2: rgba(75, 85, 99, 0.07);
      /* æ¸å˜2ï¼šæ·±ç°è‰²æ¸å˜ç‚¹2 */
      --g3: rgba(156, 163, 175, 0.06);
      /* æ¸å˜3ï¼šæµ…ç°è‰²æ¸å˜ç‚¹3 */
      --grad1: #f9fafb;
      /* æ¸å˜èµ·å§‹è‰²ï¼šæµ…ç°è‰² */
      --grad2: #f3f4f6;
      /* æ¸å˜ç»“æŸè‰²ï¼šæ›´æµ…ç°è‰² */
      --card-bg: rgba(107, 114, 128, 0.1);
      /* å¡ç‰‡èƒŒæ™¯è‰²ï¼šæµ…ç°è‰² */
    }

    * {
      box-sizing: border-box;
    }

    :root {
      --base-font-size: 14px;
      /* åŸºç¡€å­—å· */
    }

    html {
      font-size: var(--base-font-size);
    }

    body {
      margin: 0;
      font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at 20% 20%, var(--g1), transparent 25%),
        radial-gradient(circle at 80% 30%, var(--g2), transparent 25%),
        radial-gradient(circle at 50% 80%, var(--g3), transparent 22%),
        var(--bg);
      color: var(--text);
      min-height: 100vh;
    }

    .page {
      max-width: 1400px;
      width: 94vw;
      margin: 0 auto;
      padding: 20px 24px 40px;
      min-height: 96vh;
    }

    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 16px;
    }

    h1 {
      margin: 0;
      font-size: 24px;
      letter-spacing: 0.4px;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 12px;
      background: rgba(59, 130, 246, 0.2);
      color: #c7d2fe;
      font-size: 12px;
      border: 1px solid rgba(96, 165, 250, 0.5);
    }

    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 18px;
      box-shadow: 0 12px 32px rgba(0, 0, 0, 0.25);
    }

    .grid {
      display: grid;
      grid-template-columns: 520px 1fr;
      gap: 18px;
      align-items: start;
    }

    label {
      font-weight: 700;
      margin-bottom: 6px;
      display: block;
    }

    input,
    select,
    textarea {
      width: 100%;
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 12px 14px;
      font-size: 15px;
      background: rgba(255, 255, 255, 0.04);
      color: var(--text);
      outline: none;
      transition: border-color .15s ease, box-shadow .15s ease;
    }

    input:focus,
    select:focus,
    textarea:focus {
      border-color: rgba(96, 165, 250, 0.8);
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.25);
    }

    textarea {
      min-height: 130px;
      resize: vertical;
    }

    button.primary {
      background: linear-gradient(135deg, var(--primary), var(--primary-2));
      border: 1px solid var(--primary-2);
      color: #fff;
      font-weight: 700;
      border-radius: 12px;
      padding: 12px 14px;
      cursor: pointer;
      width: 100%;
    }

    button.secondary {
      background: rgba(255, 255, 255, 0.08);
      border: 1px solid var(--border);
      color: #e5e7eb;
      font-weight: 600;
      border-radius: 12px;
      padding: 12px 14px;
      cursor: pointer;
      width: 100%;
    }

    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .muted {
      color: var(--muted);
      font-size: 13px;
    }

    .log-box {
      background: #0f172a;
      color: #e2e8f0;
      padding: 12px;
      border-radius: 12px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      min-height: 90px;
      white-space: pre-wrap;
      word-break: break-all;
    }

    .video-frame {
      width: 100%;
      aspect-ratio: 1 / 1;
      /* å›ºå®š1:1æ¯”ä¾‹ï¼ˆæ­£æ–¹å½¢ï¼‰ */
      max-width: 1024px;
      /* é™åˆ¶æœ€å¤§å®½åº¦ï¼ŒåŒ¹é…æ¨¡å‹è¾“å‡ºåˆ†è¾¨ç‡ */
      margin: 0 auto;
      /* å±…ä¸­æ˜¾ç¤º */
      background: linear-gradient(180deg, var(--grad1) 0%, var(--grad2) 100%);
      border-radius: 16px;
      border: 1px solid #1f2937;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      position: relative;
    }

    video {
      width: 100%;
      height: 100%;
      object-fit: contain;
      /* ä¿æŒå®½é«˜æ¯”ï¼Œé€‚åº”å®¹å™¨ */
      background: transparent !important;
      /* ç§»é™¤é»‘è‰²èƒŒæ™¯ï¼Œä½¿ç”¨é€æ˜ */
      display: none;
      max-width: 100%;
      max-height: 100%;
      position: relative;
      z-index: 10;
      /* æé«˜z-indexï¼Œç¡®ä¿åœ¨æœ€ä¸Šå±‚ */
    }

    video:not(.hidden) {
      display: block !important;
      visibility: visible !important;
      opacity: 1 !important;
      z-index: 10 !important;
      /* ç¡®ä¿è§†é¢‘åœ¨posterä¹‹ä¸Š */
      position: relative !important;
      background: transparent !important;
    }

    .video-poster {
      width: 100%;
      height: 100%;
      object-fit: contain;
      /* ä¿æŒå®½é«˜æ¯”ï¼Œé€‚åº”å®¹å™¨ */
      background: transparent;
      display: none;
      position: absolute;
      top: 0;
      left: 0;
      cursor: pointer;
      z-index: 5;
      /* posterçš„z-indexåº”è¯¥ä½äºvideo */
    }

    .video-poster:not(.hidden) {
      display: block !important;
      z-index: 5 !important;
    }

    .placeholder {
      color: #9ca3af;
      font-size: 16px;
      text-align: center;
      padding: 20px;
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* è¿›åº¦æ¡æ ·å¼ */
    .progress-container {
      margin-top: 12px;
      margin-bottom: 12px;
    }

    .progress-bar {
      width: 100%;
      height: 8px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 4px;
      overflow: hidden;
      margin-bottom: 8px;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--primary), var(--primary-2));
      width: 0%;
      transition: width 0.3s ease;
      border-radius: 4px;
    }

    .progress-text {
      font-size: 13px;
      color: var(--muted);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .step-indicator {
      display: flex;
      gap: 8px;
      margin-top: 8px;
      flex-wrap: wrap;
    }

    .step-item {
      padding: 4px 10px;
      border-radius: 6px;
      font-size: 12px;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid var(--border);
      color: var(--muted);
      transition: all 0.3s ease;
    }

    .step-item.active {
      background: var(--primary);
      color: #fff;
      border-color: var(--primary);
    }

    .step-item.completed {
      background: rgba(34, 197, 94, 0.2);
      color: #4ade80;
      border-color: rgba(34, 197, 94, 0.4);
    }

    /* è§†é¢‘æ“ä½œæŒ‰é’® */
    .video-controls {
      display: flex;
      gap: 8px;
      margin-top: 12px;
      flex-wrap: wrap;
    }

    .video-controls button {
      padding: 8px 16px;
      font-size: 13px;
      white-space: nowrap;
    }

    /* å‚æ•°æ˜¾ç¤ºå¡ç‰‡ */
    .param-card {
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 12px;
      margin-top: 12px;
      font-size: 13px;
    }

    .param-row {
      display: flex;
      justify-content: space-between;
      padding: 4px 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }

    .param-row:last-child {
      border-bottom: none;
    }

    .param-label {
      color: var(--muted);
    }

    .param-value {
      color: var(--text);
      font-weight: 500;
    }

    /* å†å²è®°å½• */
    .history-section {
      margin-top: 24px;
    }

    .history-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 12px;
      margin-top: 12px;
    }

    .history-item {
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 12px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .history-item:hover {
      background: rgba(255, 255, 255, 0.06);
      border-color: var(--primary);
    }

    .history-thumbnail {
      width: 100%;
      aspect-ratio: 16/9;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 6px;
      margin-bottom: 8px;
      object-fit: cover;
    }

    .history-info {
      font-size: 12px;
      color: var(--muted);
    }

    /* é”™è¯¯æç¤ºæ¨¡æ€æ¡† */
    .error-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      z-index: 3000;
      align-items: center;
      justify-content: center;
    }

    .error-modal.active {
      display: flex;
    }

    .error-content {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 24px;
      max-width: 500px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
    }

    .error-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }

    .error-title {
      font-size: 18px;
      font-weight: 600;
      color: #ef4444;
    }

    .error-close {
      background: none;
      border: none;
      font-size: 24px;
      color: var(--muted);
      cursor: pointer;
      padding: 0;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 6px;
    }

    .error-close:hover {
      background: rgba(255, 255, 255, 0.1);
    }

    .error-details {
      background: rgba(0, 0, 0, 0.3);
      border-radius: 8px;
      padding: 12px;
      font-family: monospace;
      font-size: 12px;
      color: var(--text);
      margin-top: 12px;
      display: none;
    }

    .error-details.active {
      display: block;
    }

    .error-actions {
      display: flex;
      gap: 8px;
      margin-top: 16px;
    }

    /* Toast æç¤º */
    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 12px 16px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      z-index: 4000;
      display: flex;
      align-items: center;
      gap: 12px;
      animation: slideIn 0.3s ease;
    }

    .toast.success {
      border-color: #22c55e;
      background: rgba(34, 197, 94, 0.1);
    }

    .toast.error {
      border-color: #ef4444;
      background: rgba(239, 68, 68, 0.1);
    }

    @keyframes slideIn {
      from {
        transform: translateX(100%);
        opacity: 0;
      }

      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    /* è§†é¢‘ä¿¡æ¯ */
    .video-info {
      margin-top: 12px;
      padding: 12px;
      background: rgba(255, 255, 255, 0.03);
      border-radius: 8px;
      font-size: 12px;
      color: var(--muted);
    }

    .row {
      display: flex;
      gap: 10px;
    }

    .row>* {
      flex: 1;
    }

    .help-btn {
      background: #fef3c7;
      color: #92400e;
      border: 1px solid #fcd34d;
      border-radius: 10px;
      padding: 8px 10px;
      cursor: pointer;
      font-weight: 600;
    }

    a {
      color: #bfdbfe;
      text-decoration: none;
    }

    footer {
      margin-top: 24px;
      padding: 12px;
      text-align: center;
      color: var(--muted);
      font-size: 13px;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
    }

    /* è®¾ç½®æŒ‰é’® */
    .settings-btn {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1000;
      padding: 10px 16px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: var(--card-bg);
      color: var(--text);
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .settings-btn:hover {
      background: var(--primary);
      color: #fff;
      border-color: var(--primary);
    }

    /* ä¾§è¾¹æ é®ç½© */
    .sidebar-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.4);
      z-index: 2000;
      transition: opacity 0.3s ease;
    }

    .sidebar-overlay.active {
      display: block;
    }

    /* ä¾§è¾¹æ  */
    .sidebar {
      position: fixed;
      top: 0;
      right: -400px;
      width: 400px;
      height: 100vh;
      background: var(--bg);
      border-left: 1px solid var(--border);
      z-index: 2001;
      transition: right 0.3s ease;
      overflow-y: auto;
      box-shadow: -4px 0 20px rgba(0, 0, 0, 0.2);
    }

    .sidebar.active {
      right: 0;
    }

    .sidebar-content {
      padding: 24px;
    }

    .sidebar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 16px;
      border-bottom: 1px solid var(--border);
    }

    .sidebar-header h2 {
      margin: 0;
      font-size: 20px;
      color: var(--text);
    }

    .sidebar-close {
      background: none;
      border: none;
      font-size: 28px;
      color: var(--muted);
      cursor: pointer;
      padding: 0;
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 8px;
      transition: all 0.2s ease;
    }

    .sidebar-close:hover {
      background: var(--card-bg);
      color: var(--text);
    }

    /* åˆ†é¡µæ ‡ç­¾ */
    .sidebar-tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 20px;
      border-bottom: 1px solid var(--border);
    }

    .sidebar-tab {
      padding: 10px 20px;
      background: none;
      border: none;
      border-bottom: 2px solid transparent;
      color: var(--muted);
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .sidebar-tab.active {
      color: var(--primary);
      border-bottom-color: var(--primary);
    }

    .sidebar-tab:hover {
      color: var(--text);
    }

    /* åˆ†é¡µå†…å®¹ */
    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    /* é€‰é¡¹ç½‘æ ¼ */
    .options-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 12px;
      margin-bottom: 20px;
    }

    .option-card {
      padding: 16px;
      border: 2px solid var(--border);
      border-radius: 12px;
      background: var(--card-bg);
      cursor: pointer;
      transition: all 0.2s ease;
      text-align: center;
    }

    .option-card:hover {
      border-color: var(--primary);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .option-card.selected {
      border-color: var(--primary);
      background: var(--primary);
      color: #fff;
    }

    .option-card.selected .option-name {
      color: #fff;
    }

    .option-name {
      font-size: 14px;
      font-weight: 500;
      color: var(--text);
      margin-bottom: 4px;
    }

    .option-desc {
      font-size: 12px;
      color: var(--muted);
    }

    .option-card.selected .option-desc {
      color: rgba(255, 255, 255, 0.9);
    }

    /* å­—å·é€‰æ‹© */
    .font-size-group {
      display: flex;
      gap: 8px;
      margin-bottom: 20px;
    }

    .font-size-btn {
      flex: 1;
      padding: 12px;
      border: 2px solid var(--border);
      border-radius: 10px;
      background: var(--card-bg);
      color: var(--text);
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .font-size-btn:hover {
      border-color: var(--primary);
    }

    .font-size-btn.selected {
      border-color: var(--primary);
      background: var(--primary);
      color: #fff;
    }

    .font-size-custom {
      margin-top: 16px;
    }

    .font-size-custom input {
      width: 100%;
      padding: 10px;
      border: 1px solid var(--border);
      border-radius: 8px;
      background: var(--card-bg);
      color: var(--text);
      font-size: 14px;
    }
  </style>
  <script src="settings.js"></script>
</head>

<body>
  <button class="settings-btn" id="settingsBtn">âš™ï¸ è®¾ç½®</button>

  <!-- ä¾§è¾¹æ é®ç½© -->
  <div class="sidebar-overlay" id="sidebarOverlay"></div>

  <!-- è®¾ç½®ä¾§è¾¹æ  -->
  <div class="sidebar" id="settingsSidebar">
    <div class="sidebar-content">
      <div class="sidebar-header">
        <h2>è®¾ç½®</h2>
        <button class="sidebar-close" id="sidebarClose">Ã—</button>
      </div>

      <div class="sidebar-tabs">
        <button class="sidebar-tab active" data-tab="theme">ä¸»é¢˜</button>
        <button class="sidebar-tab" data-tab="font">å­—ä½“</button>
      </div>

      <!-- ä¸»é¢˜è®¾ç½® -->
      <div class="tab-content active" id="themeTab">
        <div class="options-grid">
          <div class="option-card" data-theme="tech">
            <div class="option-name">ç§‘æŠ€é£</div>
            <div class="option-desc">æ·±è“è‰²ç§‘æŠ€æ„Ÿ</div>
          </div>
          <div class="option-card" data-theme="warm">
            <div class="option-name">æ¸©é¦¨é£</div>
            <div class="option-desc">æš–è‰²è°ƒæ¸©é¦¨</div>
          </div>
          <div class="option-card" data-theme="minimal">
            <div class="option-name">ç®€çº¦é£</div>
            <div class="option-desc">ç°è‰²ç®€çº¦</div>
          </div>
        </div>
      </div>

      <!-- å­—ä½“è®¾ç½® -->
      <div class="tab-content" id="fontTab">
        <div style="margin-bottom: 16px;">
          <label style="display: block; margin-bottom: 8px; color: var(--text); font-weight: 500;">å­—ä½“æ ·å¼</label>
          <div class="options-grid">
            <div class="option-card" data-font="SimSun">
              <div class="option-name">å®‹ä½“</div>
              <div class="option-desc">SimSun</div>
            </div>
            <div class="option-card" data-font="SimHei">
              <div class="option-name">é»‘ä½“</div>
              <div class="option-desc">SimHei</div>
            </div>
            <div class="option-card" data-font="Microsoft YaHei">
              <div class="option-name">å¾®è½¯é›…é»‘</div>
              <div class="option-desc">Microsoft YaHei</div>
            </div>
            <div class="option-card" data-font="Arial">
              <div class="option-name">Arial</div>
              <div class="option-desc">Arial</div>
            </div>
            <div class="option-card" data-font="Times New Roman">
              <div class="option-name">Times New Roman</div>
              <div class="option-desc">Times New Roman</div>
            </div>
            <div class="option-card" data-font="Inter">
              <div class="option-name">Inter</div>
              <div class="option-desc">Interï¼ˆé»˜è®¤ï¼‰</div>
            </div>
          </div>
        </div>

        <div>
          <label style="display: block; margin-bottom: 8px; color: var(--text); font-weight: 500;">å­—å·å¤§å°</label>
          <div class="font-size-group">
            <button class="font-size-btn" data-size="small">å°</button>
            <button class="font-size-btn" data-size="medium">ä¸­</button>
            <button class="font-size-btn" data-size="large">å¤§</button>
            <button class="font-size-btn" data-size="custom">è‡ªå®šä¹‰</button>
          </div>
          <div class="font-size-custom" id="customSizeInput" style="display: none;">
            <input type="number" id="customSizeValue" placeholder="è¾“å…¥å­—å·ï¼ˆpxï¼‰" min="10" max="24" value="14">
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="page">
    <header>
      <div style="display:flex; align-items:center; gap:12px;">
        <h1>è§†é¢‘ç”Ÿæˆ</h1>
        <span class="pill">æ–‡æœ¬ â†’ LLM+TTS â†’ NeRF è§†é¢‘</span>
      </div>
      <div class="row" style="max-width:480px; align-items:center;">
        <a href="./index.html" style="text-decoration:none;"><button class="secondary">è¿”å›é¦–é¡µ</button></a>
        <button class="help-btn" id="helpBtn">â— å¸®åŠ©</button>
      </div>
    </header>

    <div class="card">
      <div class="grid">
        <div>
          <div class="row">
            <label style="flex:1;">è¾“å…¥è¦è¯´çš„è¯</label>
          </div>
          <textarea id="textInput" placeholder="ä¾‹å¦‚ï¼šä½ å¥½ï¼Œè¯·ç®€è¦ä»‹ç»ä¸€ä¸‹äººå·¥æ™ºèƒ½"></textarea>
          <div class="row" style="margin-top:10px;">
            <div>
              <label>é€‰æ‹©è§’è‰²</label>
              <select id="characterInput">
                <option value="ayanami">ayanami</option>
                <option value="Aerith">Aerith</option>
              </select>
            </div>
            <div>
              <label>é€‰æ‹©æ¨¡å‹ï¼ˆpklï¼‰</label>
              <select id="modelInput"></select>
            </div>
          </div>
          <div class="row" style="margin-top:12px;">
            <button class="secondary" id="refreshBtn">åˆ·æ–°æ¨¡å‹åˆ—è¡¨</button>
            <button class="primary" id="runBtn">ğŸš€ å¼€å§‹ç”Ÿæˆè§†é¢‘</button>
          </div>
          <!-- è¿›åº¦æ˜¾ç¤º -->
          <div class="progress-container" id="progressContainer" style="display: none;">
            <div class="progress-bar">
              <div class="progress-fill" id="progressFill"></div>
            </div>
            <div class="progress-text">
              <span id="progressText">å‡†å¤‡ä¸­...</span>
              <span id="progressTime">é¢„è®¡å‰©ä½™æ—¶é—´: --</span>
            </div>
            <div class="step-indicator" id="stepIndicator">
              <div class="step-item" data-step="llm">LLM ç”Ÿæˆ</div>
              <div class="step-item" data-step="tts">TTS éŸ³é¢‘</div>
              <div class="step-item" data-step="nerf">NeRF è§†é¢‘</div>
            </div>
          </div>
          <div style="margin-top:12px;">
            <label>çŠ¶æ€ / æ—¥å¿—</label>
            <div class="log-box" id="statusBox">å°±ç»ª</div>
          </div>
          <!-- è§†é¢‘ä¿¡æ¯ï¼ˆç§»åˆ°å·¦ä¾§ï¼‰ -->
          <div class="video-info" id="videoInfo" style="display: none; margin-top: 12px;">
            <div class="param-row">
              <span class="param-label">åˆ†è¾¨ç‡:</span>
              <span class="param-value" id="videoResolution">--</span>
            </div>
            <div class="param-row">
              <span class="param-label">æ—¶é•¿:</span>
              <span class="param-value" id="videoDuration">--</span>
            </div>
            <div class="param-row">
              <span class="param-label">æ–‡ä»¶å¤§å°:</span>
              <span class="param-value" id="videoSize">--</span>
            </div>
          </div>
          <!-- è§†é¢‘è¯Šæ–­ä¿¡æ¯ï¼ˆç§»åˆ°å·¦ä¾§ï¼‰ -->
          <div class="card" id="videoDiagnostics"
            style="display: none; margin-top: 12px; background: rgba(255,193,7,0.1); border-color: rgba(255,193,7,0.3);">
            <div style="font-weight: 700; margin-bottom: 8px; color: #ffc107;">ğŸ” è§†é¢‘è¯Šæ–­ä¿¡æ¯ï¼ˆå¸®åŠ©æ’æŸ¥æ’­æ”¾é—®é¢˜ï¼‰</div>
            <div id="diagnosticsContent"
              style="font-size: 12px; font-family: monospace; color: var(--text); line-height: 1.6; max-height: 300px; overflow-y: auto;">
            </div>
          </div>
          <!-- å†å²è®°å½•æŒ‰é’® -->
          <div style="margin-top: 12px;">
            <label>å†å²è®°å½•</label>
            <div style="position: relative;">
              <button class="secondary" id="historyBtn" style="width: 100%;">ğŸ“‹ æŸ¥çœ‹å†å²è®°å½•</button>
              <div id="historyDropdown"
                style="display: none; position: absolute; top: 100%; left: 0; right: 0; margin-top: 4px; background: var(--card); border: 1px solid var(--border); border-radius: 8px; max-height: 400px; overflow-y: auto; z-index: 1000; box-shadow: 0 4px 12px rgba(0,0,0,0.3);">
                <div id="historyList" style="padding: 8px;"></div>
              </div>
            </div>
          </div>
        </div>
        <div>
          <div class="video-frame">
            <video id="videoOutput" controls preload="metadata" class="hidden" style="display: none;"></video>
            <img id="videoPoster" class="video-poster hidden" alt="è§†é¢‘å°é¢" style="display: none;">
            <div id="videoPlaceholder" class="placeholder">ç”Ÿæˆåå°†åœ¨æ­¤å±•ç¤ºè§†é¢‘</div>
          </div>
          <!-- è§†é¢‘æ“ä½œæŒ‰é’® -->
          <div class="video-controls" id="videoControls" style="display: none;">
            <button class="secondary" id="downloadBtn">â¬‡ï¸ ä¸‹è½½è§†é¢‘</button>
            <button class="secondary" id="fullscreenBtn">â›¶ å…¨å±æ’­æ”¾</button>
            <div style="display: flex; align-items: center; gap: 8px;">
              <label for="volumeControl" style="font-size: 12px; color: var(--muted);">ğŸ”Š</label>
              <input type="range" id="volumeControl" min="0" max="1" step="0.1" value="1"
                style="width: 100px; cursor: pointer;">
              <span id="volumeValue" style="font-size: 12px; color: var(--muted); min-width: 30px;">100%</span>
            </div>
            <select id="playbackSpeed" style="width: auto; padding: 8px 12px;">
              <option value="0.5">0.5x</option>
              <option value="0.75">0.75x</option>
              <option value="1" selected>1x</option>
              <option value="1.25">1.25x</option>
              <option value="1.5">1.5x</option>
              <option value="2">2x</option>
            </select>
          </div>
          <!-- å‚æ•°æ˜¾ç¤ºå¡ç‰‡ -->
          <div class="param-card" id="paramCard" style="display: none;">
            <div class="param-row" id="paramModelRow">
              <span class="param-label">æ¨¡å‹:</span>
              <span class="param-value" id="paramModel">--</span>
            </div>
            <div class="param-row" id="paramCharacterRow">
              <span class="param-label">è§’è‰²:</span>
              <span class="param-value" id="paramCharacter">--</span>
            </div>
            <div class="param-row" id="paramTimeRow">
              <span class="param-label">ç”Ÿæˆæ—¶é—´:</span>
              <span class="param-value" id="paramTime">--</span>
            </div>
            <div class="param-row" id="paramTextRow">
              <span class="param-label">æ–‡æœ¬:</span>
              <span class="param-value" id="paramText"
                style="max-width: 60%; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">--</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- é”™è¯¯æ¨¡æ€æ¡† -->
  <div class="error-modal" id="errorModal">
    <div class="error-content">
      <div class="error-header">
        <div class="error-title">âŒ ç”Ÿæˆå¤±è´¥</div>
        <button class="error-close" id="errorClose">Ã—</button>
      </div>
      <div id="errorMessage"></div>
      <div class="error-details" id="errorDetails"></div>
      <div style="margin-top: 12px;">
        <button class="secondary" id="toggleErrorDetails" style="width: auto;">æ˜¾ç¤ºè¯¦æƒ…</button>
      </div>
      <div class="error-actions">
        <button class="secondary" id="errorRetry" style="flex: 1;">é‡è¯•</button>
        <button class="primary" id="errorConfirm" style="flex: 1;">ç¡®å®š</button>
      </div>
    </div>
  </div>

  <footer>
    åŒ—äº¬ç†å·¥å¤§å­¦ Â· NeRFFaceSpeech å›¢é˜Ÿ
  </footer>

  <script>
    // è‡ªåŠ¨æ£€æµ‹æœåŠ¡å™¨åœ°å€ï¼ˆä»å½“å‰é¡µé¢çš„URLè·å–ï¼‰
    // è§„åˆ™ï¼š
    // 1. å¦‚æœå½“å‰æ˜¯å‰ç«¯æœåŠ¡å™¨ï¼ˆç«¯å£7860ï¼‰ï¼Œåˆ™ä½¿ç”¨åç«¯æœåŠ¡å™¨ï¼ˆç«¯å£8000ï¼‰
    // 2. å¦‚æœè·¯å¾„åŒ…å« /webui/ï¼Œè¯´æ˜æ˜¯æŒ‚è½½åœ¨FastAPIä¸‹çš„ï¼Œä½¿ç”¨å½“å‰origin
    // 3. å¦åˆ™ä½¿ç”¨å½“å‰originï¼ˆå‡è®¾å‰åç«¯åœ¨åŒä¸€æœåŠ¡å™¨ï¼‰
    const FASTAPI_URL = (() => {
      const currentOrigin = window.location.origin;
      const currentHostname = window.location.hostname;
      const currentPort = window.location.port;
      const currentPath = window.location.pathname;
      const currentProtocol = window.location.protocol;

      console.log('=== APIæœåŠ¡å™¨åœ°å€æ£€æµ‹ ===');
      console.log('å½“å‰URL:', window.location.href);
      console.log('Origin:', currentOrigin);
      console.log('Hostname:', currentHostname);
      console.log('Port:', currentPort || '(é»˜è®¤ç«¯å£)');
      console.log('Protocol:', currentProtocol);
      console.log('Path:', currentPath);

      // å¦‚æœå½“å‰ç«¯å£æ˜¯7860ï¼ˆå‰ç«¯æœåŠ¡å™¨ï¼‰ï¼Œåˆ™ä½¿ç”¨åç«¯æœåŠ¡å™¨ï¼ˆ8000ç«¯å£ï¼‰
      if (currentPort === '7860') {
        const backendUrl = `${currentProtocol}//${currentHostname}:8000`;
        console.log('âœ… æ£€æµ‹åˆ°å‰ç«¯æœåŠ¡å™¨ï¼ˆç«¯å£7860ï¼‰ï¼Œä½¿ç”¨åç«¯APIæœåŠ¡å™¨:', backendUrl);
        return backendUrl;
      }

      // å¦‚æœè·¯å¾„åŒ…å« /webui/ï¼Œè¯´æ˜æ˜¯æŒ‚è½½åœ¨ /webui ä¸‹çš„ï¼ˆFastAPIç›´æ¥æä¾›é™æ€æ–‡ä»¶ï¼‰
      // æœåŠ¡å™¨æ ¹è·¯å¾„å°±æ˜¯ origin
      if (currentPath.includes('/webui/')) {
        console.log('âœ… æ£€æµ‹åˆ°FastAPIé™æ€æ–‡ä»¶æœåŠ¡ï¼Œä½¿ç”¨å½“å‰origin:', currentOrigin);
        return currentOrigin;
      }

      // å¦‚æœç«¯å£æ˜¯8000æˆ–ç©ºï¼ˆé»˜è®¤ç«¯å£ï¼‰ï¼Œå‡è®¾æ˜¯FastAPIæœåŠ¡å™¨ï¼Œç›´æ¥ä½¿ç”¨
      if (currentPort === '8000' || !currentPort) {
        console.log('âœ… æ£€æµ‹åˆ°FastAPIæœåŠ¡å™¨ï¼ˆç«¯å£8000æˆ–é»˜è®¤ï¼‰ï¼Œä½¿ç”¨å½“å‰origin:', currentOrigin);
        return currentOrigin;
      }

      // å¦åˆ™ä½¿ç”¨å½“å‰originï¼ˆå‡è®¾å‰åç«¯åœ¨åŒä¸€æœåŠ¡å™¨ï¼‰
      console.log('âš ï¸  ä½¿ç”¨å½“å‰originä½œä¸ºAPIæœåŠ¡å™¨ï¼ˆæœªåŒ¹é…ä»»ä½•è§„åˆ™ï¼‰:', currentOrigin);
      return currentOrigin;
    })();

    console.log('=== æœ€ç»ˆç¡®å®šçš„APIæœåŠ¡å™¨åœ°å€ ===');
    console.log('FASTAPI_URL:', FASTAPI_URL);
    console.log('===================================');

    const modelsSelect = document.getElementById("modelInput");
    const statusBox = document.getElementById("statusBox");
    const video = document.getElementById("videoOutput");
    const videoPlaceholder = document.getElementById("videoPlaceholder");
    const runBtn = document.getElementById("runBtn");
    const refreshBtn = document.getElementById("refreshBtn");

    // è¾…åŠ©å‡½æ•°ï¼šè·å–readyStateåç§°ï¼ˆæå‰å®šä¹‰ï¼Œä¾›å…¨å±€ç›‘å¬å™¨ä½¿ç”¨ï¼‰
    function getReadyStateName(state) {
      const states = {
        0: 'HAVE_NOTHING',
        1: 'HAVE_METADATA',
        2: 'HAVE_CURRENT_DATA',
        3: 'HAVE_FUTURE_DATA',
        4: 'HAVE_ENOUGH_DATA'
      };
      return states[state] || `æœªçŸ¥(${state})`;
    }

    function getNetworkStateName(state) {
      const states = {
        0: 'NETWORK_EMPTY',
        1: 'NETWORK_IDLE',
        2: 'NETWORK_LOADING',
        3: 'NETWORK_NO_SOURCE'
      };
      return states[state] || `æœªçŸ¥(${state})`;
    }

    // å…¨å±€çš„è§†é¢‘æ’­æ”¾äº‹ä»¶ç›‘å¬å™¨ï¼ˆæ— è®ºè§†é¢‘å¦‚ä½•åŠ è½½éƒ½ä¼šè§¦å‘ï¼‰
    video.addEventListener('play', function onVideoPlay() {
      console.log('========================================');
      console.log('â–¶ï¸ [å…¨å±€ç›‘å¬å™¨] ç”¨æˆ·ç‚¹å‡»æ’­æ”¾æŒ‰é’® - è§†é¢‘å¼€å§‹æ’­æ”¾ (playäº‹ä»¶)');
      console.log('========================================');

      // ç«‹å³æ˜¾ç¤ºè¯Šæ–­ä¿¡æ¯åŒºåŸŸï¼ˆç¡®ä¿å¯è§ï¼‰
      const diagnosticsEl = document.getElementById("videoDiagnostics");
      if (diagnosticsEl) {
        diagnosticsEl.style.display = "block";
        try {
          diagnosticsEl.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        } catch (e) {
          // å¦‚æœscrollIntoViewå¤±è´¥ï¼Œè‡³å°‘ç¡®ä¿æ˜¾ç¤º
          console.warn('scrollIntoViewå¤±è´¥:', e);
        }
      }

      const hasVideo = video.videoWidth > 0 && video.videoHeight > 0;
      const hasAudio = video.duration > 0;
      const computedStyle = window.getComputedStyle(video);

      // è¯¦ç»†çš„è°ƒè¯•ä¿¡æ¯
      const debugInfo = {
        'è§†é¢‘å°ºå¯¸': `${video.videoWidth} Ã— ${video.videoHeight}` + (hasVideo ? ' âœ…' : ' âŒ æ²¡æœ‰è§†é¢‘è½¨é“'),
        'è§†é¢‘æ—¶é•¿': `${video.duration.toFixed(2)} ç§’` + (hasAudio ? ' âœ…' : ' âŒ'),
        'å½“å‰æ’­æ”¾æ—¶é—´': `${video.currentTime.toFixed(2)} ç§’`,
        'æ’­æ”¾é€Ÿåº¦': `${video.playbackRate}x`,
        'æ˜¯å¦æš‚åœ': video.paused ? 'æ˜¯' : 'å¦',
        'å°±ç»ªçŠ¶æ€': `${video.readyState} (${getReadyStateName(video.readyState)})`,
        'ç½‘ç»œçŠ¶æ€': `${video.networkState} (${getNetworkStateName(video.networkState)})`,
        'CSSæ˜¾ç¤º': computedStyle.display,
        'CSSå¯è§æ€§': computedStyle.visibility,
        'CSSé€æ˜åº¦': computedStyle.opacity,
        'CSSèƒŒæ™¯è‰²': computedStyle.backgroundColor,
        'CSS z-index': computedStyle.zIndex,
        'æ˜¯å¦æœ‰hiddenç±»': video.classList.contains('hidden') ? 'æ˜¯' : 'å¦',
        'è§†é¢‘æºURL': video.src || 'æœªè®¾ç½®'
      };

      console.log('æ’­æ”¾æ—¶è§†é¢‘çŠ¶æ€:');
      for (const [key, value] of Object.entries(debugInfo)) {
        console.log(`  - ${key}:`, value);
      }

      if (!hasVideo && hasAudio) {
        console.error('âš ï¸ è­¦å‘Šï¼šæ£€æµ‹åˆ°åªæœ‰éŸ³é¢‘è½¨é“ï¼Œæ²¡æœ‰è§†é¢‘ç”»é¢ï¼');
        if (typeof showToast === 'function') {
          showToast('âš ï¸ è­¦å‘Šï¼šè§†é¢‘åªæœ‰éŸ³é¢‘ï¼Œæ²¡æœ‰ç”»é¢', 'warning');
        }
      }

      // æ›´æ–°è¯Šæ–­ä¿¡æ¯ï¼ˆå¦‚æœå‡½æ•°å·²å®šä¹‰ï¼‰
      if (typeof updateDiagnostics === 'function') {
        updateDiagnostics();
      } else {
        console.warn('updateDiagnosticså‡½æ•°å°šæœªå®šä¹‰');
      }

      console.log('========================================');
    }, false); // ä½¿ç”¨æ•è·é˜¶æ®µï¼Œç¡®ä¿ä¼˜å…ˆè§¦å‘

    function setStatus(msg) { statusBox.textContent = msg; }
    function setLoading(button, loading) {
      if (loading) {
        button.disabled = true;
        button.dataset.origText = button.textContent;
        button.textContent = "å¤„ç†ä¸­...";
      } else {
        button.disabled = false;
        if (button.dataset.origText) button.textContent = button.dataset.origText;
      }
    }

    async function loadModels() {
      setLoading(refreshBtn, true);
      try {
        const res = await fetch(`${FASTAPI_URL}/models`, { method: "GET" });
        if (!res.ok) {
          const errorMsg = `æ¨¡å‹åˆ—è¡¨è·å–å¤±è´¥: HTTP ${res.status}`;
          setStatus(`âŒ ${errorMsg}`);
          showToast(errorMsg, "error");
          modelsSelect.innerHTML = "";
          const opt = document.createElement("option");
          opt.value = "";
          opt.textContent = "æ¨¡å‹åŠ è½½å¤±è´¥";
          opt.disabled = true;
          modelsSelect.appendChild(opt);
          return;
        }

        const data = await res.json();

        // æ£€æŸ¥æ˜¯å¦æ˜¯é”™è¯¯å“åº”
        if (data.success === false || (data.error && !Array.isArray(data))) {
          const errorMsg = data.error || "æœªçŸ¥é”™è¯¯";
          setStatus(`âŒ æ¨¡å‹åˆ—è¡¨è·å–å¤±è´¥ï¼š${errorMsg}`);
          showToast(errorMsg, "error");
          modelsSelect.innerHTML = "";
          const opt = document.createElement("option");
          opt.value = "";
          opt.textContent = "æ¨¡å‹åŠ è½½å¤±è´¥";
          opt.disabled = true;
          modelsSelect.appendChild(opt);
          return;
        }

        // æ­£å¸¸æƒ…å†µï¼šdata åº”è¯¥æ˜¯æ•°ç»„
        if (!Array.isArray(data) || data.length === 0) {
          setStatus("âŒ æ¨¡å‹åˆ—è¡¨ä¸ºç©ºï¼Œè¯·æ£€æŸ¥æ¨¡å‹ç›®å½•");
          modelsSelect.innerHTML = "";
          const opt = document.createElement("option");
          opt.value = "";
          opt.textContent = "æ¨¡å‹åˆ—è¡¨ä¸ºç©º";
          opt.disabled = true;
          modelsSelect.appendChild(opt);
          return;
        }

        modelsSelect.innerHTML = "";
        data.forEach(m => {
          const opt = document.createElement("option");
          opt.value = m; opt.textContent = m;
          modelsSelect.appendChild(opt);
        });
        setStatus("æ¨¡å‹åˆ—è¡¨å·²åˆ·æ–°");
      } catch (e) {
        setStatus(`âŒ æ¨¡å‹åˆ—è¡¨è·å–å¤±è´¥ï¼š${e.message || e}`);
        modelsSelect.innerHTML = "";
        const opt = document.createElement("option");
        opt.value = "";
        opt.textContent = "åŠ è½½å¤±è´¥";
        opt.disabled = true;
        modelsSelect.appendChild(opt);
      } finally {
        setLoading(refreshBtn, false);
      }
    }

    // è¿›åº¦ç®¡ç†
    let currentStep = '';
    let progressInterval = null;
    let startTime = null;
    let abortController = null;
    let currentTaskId = null; // å½“å‰ä»»åŠ¡ID
    let taskStatusPollInterval = null; // ä»»åŠ¡çŠ¶æ€è½®è¯¢é—´éš”

    let currentStage = null; // å½“å‰é˜¶æ®µ: 'llm', 'tts', 'nerf', 'save'
    let stageStartTime = null; // å½“å‰é˜¶æ®µçš„å¼€å§‹æ—¶é—´

    function updateProgress(step, progress, resetStage = false) {
      const progressFill = document.getElementById("progressFill");
      const progressText = document.getElementById("progressText");
      const stepIndicator = document.getElementById("stepIndicator");
      const progressContainer = document.getElementById("progressContainer");

      progressContainer.style.display = "block";

      // å¦‚æœåˆ‡æ¢é˜¶æ®µï¼Œé‡ç½®è¿›åº¦æ¡
      if (resetStage || currentStage !== step) {
        currentStage = step;
        stageStartTime = Date.now();
        progressFill.style.width = "0%";
      } else {
        progressFill.style.width = progress + "%";
      }

      const steps = {
        'llm': { text: 'é˜¶æ®µ1: LLM + TTS éŸ³é¢‘ç”Ÿæˆ', progress: 100 },
        'tts': { text: 'é˜¶æ®µ1: LLM + TTS éŸ³é¢‘ç”Ÿæˆ', progress: 100 },
        'nerf': { text: 'é˜¶æ®µ2: NeRF è§†é¢‘ç”Ÿæˆ', progress: 100 },
        'save': { text: 'é˜¶æ®µ3: ä¿å­˜è§†é¢‘æ–‡ä»¶', progress: 100 }
      };

      if (steps[step]) {
        progressText.textContent = steps[step].text;
        currentStep = step;
      }

      // æ›´æ–°æ­¥éª¤æŒ‡ç¤ºå™¨
      stepIndicator.querySelectorAll('.step-item').forEach(item => {
        const itemStep = item.dataset.step;
        item.classList.remove('active', 'completed');
        if (itemStep === step) {
          item.classList.add('active');
        } else if (getStepOrder(itemStep) < getStepOrder(step)) {
          item.classList.add('completed');
        }
      });

      // æ›´æ–°å‰©ä½™æ—¶é—´ï¼ˆåŸºäºå½“å‰é˜¶æ®µçš„å·²ç”¨æ—¶é—´ï¼‰
      if (stageStartTime) {
        const elapsed = (Date.now() - stageStartTime) / 1000;
        // åŸºäºå½“å‰é˜¶æ®µçš„æ—¶é—´ä¼°ç®—ï¼ˆç®€åŒ–å¤„ç†ï¼Œä½¿ç”¨å›ºå®šä¼°ç®—ï¼‰
        const timeText = `${Math.floor(elapsed)}ç§’`;
        document.getElementById("progressTime").textContent = `å½“å‰é˜¶æ®µç”¨æ—¶: ${timeText}`;
      }
    }

    // é€šè¿‡æ—¥å¿—æ¨æ–­å½“å‰é˜¶æ®µ
    function detectStageFromLogs(logs) {
      if (!logs || logs.length === 0) return null;

      let detectedStage = null;
      let stage1Complete = false;
      let stage2Complete = false;

      // ä»æœ€æ–°çš„æ—¥å¿—ä¸­æ¨æ–­é˜¶æ®µï¼ˆä»åå¾€å‰æŸ¥æ‰¾æœ€æ–°çš„é˜¶æ®µæ ‡è®°ï¼‰
      for (let i = logs.length - 1; i >= 0; i--) {
        const logMsg = logs[i].message || logs[i].content || '';
        const lowerMsg = logMsg.toLowerCase();

        // é˜¶æ®µå®Œæˆæ ‡è®°ï¼ˆä¼˜å…ˆæ£€æŸ¥ï¼‰
        if (logMsg.includes('é˜¶æ®µ1å®Œæˆ') || (logMsg.includes('é˜¶æ®µ1') && logMsg.includes('å®Œæˆ'))) {
          stage1Complete = true;
          if (!stage2Complete) {
            detectedStage = 'nerf'; // é˜¶æ®µ1å®Œæˆï¼Œè¿›å…¥é˜¶æ®µ2
            break;
          }
        }
        if (logMsg.includes('é˜¶æ®µ2å®Œæˆ') || (logMsg.includes('é˜¶æ®µ2') && logMsg.includes('å®Œæˆ'))) {
          stage2Complete = true;
          detectedStage = 'save'; // é˜¶æ®µ2å®Œæˆï¼Œè¿›å…¥é˜¶æ®µ3
          break;
        }
        if (logMsg.includes('é˜¶æ®µ3å®Œæˆ') || (logMsg.includes('é˜¶æ®µ3') && logMsg.includes('å®Œæˆ'))) {
          detectedStage = 'save';
          break;
        }

        // é˜¶æ®µå¼€å§‹æ ‡è®°
        if (logMsg.includes('é˜¶æ®µ1:') || logMsg.includes('é˜¶æ®µ1ï¼š') || (logMsg.includes('LLM + TTS') && !stage1Complete)) {
          detectedStage = 'llm';
          // ä¸breakï¼Œç»§ç»­æŸ¥æ‰¾æ˜¯å¦æœ‰å®Œæˆæ ‡è®°
        }
        if (logMsg.includes('é˜¶æ®µ2:') || logMsg.includes('é˜¶æ®µ2ï¼š') || (logMsg.includes('NeRF') && logMsg.includes('è§†é¢‘ç”Ÿæˆ') && !stage2Complete)) {
          if (!detectedStage || detectedStage === 'llm') {
            detectedStage = 'nerf';
          }
        }
        if (logMsg.includes('é˜¶æ®µ3:') || logMsg.includes('é˜¶æ®µ3ï¼š') || logMsg.includes('ä¿å­˜è§†é¢‘')) {
          detectedStage = 'save';
        }

        // é€šè¿‡å†…å®¹æ¨æ–­ï¼ˆä»…åœ¨æœªæ‰¾åˆ°é˜¶æ®µæ ‡è®°æ—¶ä½¿ç”¨ï¼‰
        if (!detectedStage) {
          if (lowerMsg.includes('è°ƒç”¨llm') || lowerMsg.includes('è°ƒç”¨å¤§æ¨¡å‹') || (lowerMsg.includes('ç”Ÿæˆå›ç­”') && !stage1Complete)) {
            detectedStage = 'llm';
          } else if (lowerMsg.includes('ttsè½¬æ¢') || (lowerMsg.includes('ç”ŸæˆéŸ³é¢‘') && !stage1Complete)) {
            detectedStage = 'tts';
          } else if (lowerMsg.includes('loading networks') || lowerMsg.includes('sampling') || lowerMsg.includes('download') || lowerMsg.includes('fetching')) {
            detectedStage = 'nerf';
          }
        }
      }

      return detectedStage || 'llm'; // é»˜è®¤è¿”å›ç¬¬ä¸€é˜¶æ®µ
    }

    // è½®è¯¢æ—¥å¿—ä»¥æ›´æ–°è¿›åº¦
    let logPollInterval = null;
    function startLogPolling() {
      let lastLogCount = 0;
      logPollInterval = setInterval(async () => {
        try {
          const response = await fetch(`${FASTAPI_URL}/logs/full?debug=false`);
          if (response.ok) {
            const data = await response.json();
            if (data.success && data.logs) {
              const logs = data.logs;
              // å¦‚æœæœ‰æ–°æ—¥å¿—
              if (logs.length > lastLogCount) {
                lastLogCount = logs.length;

                // æ£€æµ‹å½“å‰é˜¶æ®µ
                const detectedStage = detectStageFromLogs(logs);
                if (detectedStage && detectedStage !== currentStage) {
                  // é˜¶æ®µåˆ‡æ¢æ—¶é‡ç½®è¿›åº¦æ¡
                  if (detectedStage === 'llm' || detectedStage === 'tts') {
                    updateProgress('llm', 0, true); // é‡ç½®åˆ°é˜¶æ®µ1
                  } else if (detectedStage === 'nerf') {
                    updateProgress('nerf', 0, true); // é‡ç½®åˆ°é˜¶æ®µ2
                  } else if (detectedStage === 'save') {
                    updateProgress('save', 0, true); // é‡ç½®åˆ°é˜¶æ®µ3
                  }
                } else if (detectedStage === currentStage) {
                  // åŒä¸€é˜¶æ®µå†…ï¼Œæ ¹æ®æ—¶é—´ä¼°ç®—è¿›åº¦ï¼ˆç®€åŒ–å¤„ç†ï¼‰
                  if (stageStartTime) {
                    const elapsed = (Date.now() - stageStartTime) / 1000;
                    let estimatedProgress = 0;
                    if (detectedStage === 'llm' || detectedStage === 'tts') {
                      // é˜¶æ®µ1é¢„è®¡éœ€è¦10-30ç§’
                      estimatedProgress = Math.min(95, (elapsed / 30) * 100);
                    } else if (detectedStage === 'nerf') {
                      // é˜¶æ®µ2é¢„è®¡éœ€è¦30-120ç§’
                      estimatedProgress = Math.min(95, (elapsed / 120) * 100);
                    } else if (detectedStage === 'save') {
                      estimatedProgress = 100;
                    }
                    updateProgress(detectedStage, estimatedProgress, false);
                  }
                }
              }
            }
          }
        } catch (e) {
          // å¿½ç•¥è½®è¯¢é”™è¯¯
        }
      }, 1000); // æ¯ç§’è½®è¯¢ä¸€æ¬¡
    }

    function stopLogPolling() {
      if (logPollInterval) {
        clearInterval(logPollInterval);
        logPollInterval = null;
      }
    }

    function getStepOrder(step) {
      const order = { 'llm': 1, 'tts': 1, 'nerf': 2, 'save': 3 };
      return order[step] || 0;
    }

    function resetProgress() {
      document.getElementById("progressContainer").style.display = "none";
      document.getElementById("progressFill").style.width = "0%";
      currentStep = '';
      startTime = null;
      if (progressInterval) {
        clearInterval(progressInterval);
        progressInterval = null;
      }
    }

    // æ˜¾ç¤ºé”™è¯¯æ¨¡æ€æ¡†
    function showError(message, details = '') {
      const modal = document.getElementById("errorModal");
      const messageEl = document.getElementById("errorMessage");
      const detailsEl = document.getElementById("errorDetails");

      messageEl.textContent = message;
      if (details) {
        detailsEl.textContent = details;
        document.getElementById("toggleErrorDetails").style.display = "block";
      } else {
        document.getElementById("toggleErrorDetails").style.display = "none";
      }

      modal.classList.add("active");
    }

    // æ˜¾ç¤º Toast æç¤º
    function showToast(message, type = 'success') {
      const toast = document.createElement("div");
      toast.className = `toast ${type}`;
      toast.textContent = message;
      document.body.appendChild(toast);

      setTimeout(() => {
        toast.style.animation = "slideIn 0.3s ease reverse";
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }

    // ä»æ•°æ®åº“åŠ è½½å†å²è®°å½•
    // ä»æ–‡ä»¶è·¯å¾„æ„é€ è§†é¢‘URLï¼ˆä»è·¯å¾„ä¸­æå–æ–‡ä»¶åï¼‰
    function getVideoUrlFromPath(videoPath) {
      if (!videoPath) return null;

      try {
        // ä»è·¯å¾„ä¸­æå–æ–‡ä»¶åï¼ˆä¾‹å¦‚ï¼šä» /root/.../videos/xxx.mp4 æå– xxx.mp4ï¼‰
        const pathParts = videoPath.replace(/\\/g, '/').split('/');
        const fileName = pathParts[pathParts.length - 1];

        if (fileName && fileName.endsWith('.mp4')) {
          // æ„é€ URLï¼š/videos/{filename}
          return `${FASTAPI_URL}/videos/${fileName}`;
        }

        // å¦‚æœè·¯å¾„æ ¼å¼ä¸å¯¹ï¼Œå°è¯•ä»unique_idæ„é€ ï¼ˆå‘åå…¼å®¹ï¼‰
        console.warn('æ— æ³•ä»è·¯å¾„æå–æ–‡ä»¶åï¼Œè·¯å¾„æ ¼å¼:', videoPath);
        return null;
      } catch (e) {
        console.error('æ„é€ è§†é¢‘URLå¤±è´¥:', e, 'è·¯å¾„:', videoPath);
        return null;
      }
    }

    // ä»æ–‡ä»¶è·¯å¾„æ„é€ éŸ³é¢‘URL
    function getAudioUrlFromPath(audioPath) {
      if (!audioPath) return null;

      try {
        const pathParts = audioPath.replace(/\\/g, '/').split('/');
        const fileName = pathParts[pathParts.length - 1];

        if (fileName && (fileName.endsWith('.wav') || fileName.endsWith('.mp3'))) {
          return `${FASTAPI_URL}/audios/${fileName}`;
        }
        return null;
      } catch (e) {
        console.error('æ„é€ éŸ³é¢‘URLå¤±è´¥:', e);
        return null;
      }
    }

    // ä»æ–‡ä»¶è·¯å¾„æ„é€ æ–‡æœ¬URL
    function getTextUrlFromPath(textPath) {
      if (!textPath) return null;

      try {
        const pathParts = textPath.replace(/\\/g, '/').split('/');
        const fileName = pathParts[pathParts.length - 1];

        if (fileName && fileName.endsWith('.txt')) {
          return `${FASTAPI_URL}/texts/${fileName}`;
        }
        return null;
      } catch (e) {
        console.error('æ„é€ æ–‡æœ¬URLå¤±è´¥:', e);
        return null;
      }
    }

    async function loadHistory() {
      try {
        const response = await fetch(`${FASTAPI_URL}/generation_records?record_type=video&limit=100`);
        if (!response.ok) {
          const errorMsg = `åŠ è½½å†å²è®°å½•å¤±è´¥: HTTP ${response.status}`;
          console.error(errorMsg);
          setStatus(`âš ï¸ ${errorMsg}`);
          showToast(errorMsg, "error");
          return;
        }
        const data = await response.json();
        if (!data.success) {
          const errorMsg = data.error || "åŠ è½½å†å²è®°å½•å¤±è´¥";
          console.error(errorMsg);
          setStatus(`âš ï¸ ${errorMsg}`);
          showToast(errorMsg, "error");
          return;
        }
        if (data.data) {
          renderHistory(data.data);
        }
      } catch (e) {
        const errorMsg = `åŠ è½½å†å²è®°å½•å‡ºé”™: ${e.message || String(e)}`;
        console.error(errorMsg, e);
        setStatus(`âš ï¸ ${errorMsg}`);
        showToast(errorMsg, "error");
      }
    }

    // æ¸²æŸ“å†å²è®°å½•ï¼ˆä»æ•°æ®åº“æ•°æ®ï¼‰
    function renderHistory(records) {
      const historyList = document.getElementById("historyList");
      historyList.innerHTML = '';

      if (!records || records.length === 0) {
        historyList.innerHTML = '<div style="color: var(--muted); text-align: center; padding: 20px;">æš‚æ— å†å²è®°å½•</div>';
        return;
      }

      // è‡ªåŠ¨æ˜¾ç¤ºæœ€æ–°çš„è§†é¢‘ï¼ˆå¦‚æœå³ä¾§æ²¡æœ‰è§†é¢‘ï¼‰
      if (records.length > 0 && (!video.src || video.classList.contains("hidden"))) {
        const latestRecord = records[0]; // ç¬¬ä¸€æ¡æ˜¯æœ€æ–°çš„
        // ä»video_pathæ„é€ URL
        const videoUrl = getVideoUrlFromPath(latestRecord.video_path);
        if (videoUrl) {
          const params = {
            text: latestRecord.text || '',
            character: latestRecord.character || '',
            model: latestRecord.model_name || '',
            date: latestRecord.created_at || new Date().toLocaleString('zh-CN'),
            generation_time: latestRecord.generation_time,
            unique_id: latestRecord.unique_id
          };
          loadVideo(videoUrl, params);
        }
      }

      records.forEach((record, index) => {
        const historyItem = document.createElement("div");
        historyItem.className = "history-item";
        historyItem.style.cssText = "padding: 12px; border-bottom: 1px solid var(--border); cursor: pointer; transition: background 0.2s;";
        if (index < records.length - 1) {
          historyItem.style.borderBottom = "1px solid var(--border)";
        } else {
          historyItem.style.borderBottom = "none";
        }

        const date = record.created_at ? new Date(record.created_at).toLocaleString('zh-CN') : 'æœªçŸ¥æ—¶é—´';
        const genTime = record.generation_time ? `${Math.floor(record.generation_time)}ç§’` : '';
        const textPreview = (record.text || 'æ— æ–‡æœ¬').substring(0, 50) + ((record.text && record.text.length > 50) ? '...' : '');

        historyItem.innerHTML = `
          <div style="color: var(--text); font-weight: 500; margin-bottom: 4px;">${textPreview}</div>
          <div style="font-size: 12px; color: var(--muted);">${date}${genTime ? ` Â· ${genTime}` : ''}</div>
          <div style="font-size: 11px; color: var(--muted); margin-top: 2px;">${record.character || ''} Â· ${record.model_name || 'æ— æ¨¡å‹'}</div>
        `;

        historyItem.addEventListener('mouseenter', () => {
          historyItem.style.background = 'rgba(255,255,255,0.05)';
        });
        historyItem.addEventListener('mouseleave', () => {
          historyItem.style.background = 'transparent';
        });

        historyItem.addEventListener('click', () => {
          // åœ¨æ–°çª—å£æ‰“å¼€å†å²è®°å½•è¯¦æƒ…é¡µ
          if (record.unique_id) {
            const detailUrl = `${window.location.pathname}?record_id=${record.unique_id}`;
            window.open(detailUrl, '_blank');
          }
          // å…³é—­ä¸‹æ‹‰èœå•
          const dropdown = document.getElementById("historyDropdown");
          if (dropdown) {
            dropdown.style.display = "none";
          }
        });

        historyList.appendChild(historyItem);
      });
    }

    // åŠ è½½è§†é¢‘
    function loadVideo(videoUrl, params = null, autoPlay = false) {
      const video = document.getElementById("videoOutput");

      console.log('========================================');
      console.log('å¼€å§‹åŠ è½½è§†é¢‘');
      console.log('è§†é¢‘URL:', videoUrl);
      console.log('è‡ªåŠ¨æ’­æ”¾:', autoPlay);
      console.log('========================================');

      // æ¸…é™¤ä¹‹å‰çš„æºï¼ˆå¦‚æœéœ€è¦ï¼‰
      video.pause();
      video.src = '';
      video.load();

      // å…ˆéªŒè¯URLæ˜¯å¦å¯è®¿é—®
      console.log('æ­¥éª¤1: æ£€æŸ¥è§†é¢‘æ–‡ä»¶æ˜¯å¦å¯è®¿é—®...');
      fetch(videoUrl, { method: 'HEAD' })
        .then(response => {
          console.log('HTTP HEADè¯·æ±‚ç»“æœ:');
          console.log('  - çŠ¶æ€ç :', response.status, response.statusText);
          console.log('  - Content-Type:', response.headers.get('Content-Type'));
          console.log('  - Content-Length:', response.headers.get('Content-Length'));
          console.log('  - Accept-Ranges:', response.headers.get('Accept-Ranges'));
          console.log('  - æ‰€æœ‰å“åº”å¤´:', Object.fromEntries(response.headers.entries()));

          if (!response.ok) {
            console.error('âŒ è§†é¢‘æ–‡ä»¶HTTPè¯·æ±‚å¤±è´¥:', response.status, response.statusText);
            showToast(`è§†é¢‘æ–‡ä»¶æ— æ³•è®¿é—® (HTTP ${response.status})`, 'error');
            return;
          }

          const contentType = response.headers.get('Content-Type');
          if (contentType && !contentType.includes('video')) {
            console.warn('âš ï¸ Content-Typeå¯èƒ½ä¸æ­£ç¡®:', contentType);
          }

          // å¦‚æœHEADè¯·æ±‚æˆåŠŸï¼Œç»§ç»­è®¾ç½®è§†é¢‘æº
          console.log('æ­¥éª¤2: è®¾ç½®è§†é¢‘æºå¹¶é…ç½®äº‹ä»¶ç›‘å¬å™¨...');
          video.src = videoUrl;
          console.log('è§†é¢‘å…ƒç´ srcå·²è®¾ç½®:', video.src);

          // æ˜¾ç¤ºè§†é¢‘å…ƒç´ 
          video.classList.remove("hidden");
          video.style.display = "block";
          video.style.visibility = "visible";
          video.style.zIndex = "10";
          video.style.opacity = "1";
          video.style.background = "transparent";
          videoPlaceholder.classList.add("hidden");
          document.getElementById("videoControls").style.display = "flex";
          document.getElementById("videoInfo").style.display = "block";
          document.getElementById("videoDiagnostics").style.display = "block";

          // é…ç½®è‡ªåŠ¨æ’­æ”¾ï¼ˆéœ€è¦åœ¨è®¾ç½®srcåï¼Œåœ¨äº‹ä»¶ç›‘å¬å™¨ä¸­è®¿é—®autoPlayï¼‰
          setupVideoEventListeners(autoPlay);

          // å¼ºåˆ¶åŠ è½½è§†é¢‘ï¼ˆç¡®ä¿è§†é¢‘å¯ä»¥æ’­æ”¾ï¼‰
          video.load();

          // åˆå§‹è¯Šæ–­ä¿¡æ¯
          setTimeout(() => updateDiagnostics(), 500);
        })
        .catch(err => {
          console.error('âŒ æ£€æŸ¥è§†é¢‘æ–‡ä»¶å¤±è´¥:', err);
          showToast('æ— æ³•è®¿é—®è§†é¢‘æ–‡ä»¶ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥', 'error');
          console.error('é”™è¯¯è¯¦æƒ…:', err.message, err.stack);
          // å³ä½¿HEADè¯·æ±‚å¤±è´¥ï¼Œä¹Ÿå°è¯•è®¾ç½®è§†é¢‘æºï¼ˆå¯èƒ½æ˜¯CORSé—®é¢˜ï¼‰
          console.log('å°è¯•ç›´æ¥è®¾ç½®è§†é¢‘æºï¼ˆå¿½ç•¥HEADè¯·æ±‚å¤±è´¥ï¼‰...');
          video.src = videoUrl;
          video.classList.remove("hidden");
          video.style.display = "block";
          video.style.visibility = "visible";
          video.style.opacity = "1";
          video.style.zIndex = "10";
          video.style.position = "relative";
          video.style.background = "transparent";
          videoPlaceholder.classList.add("hidden");
          document.getElementById("videoControls").style.display = "flex";
          document.getElementById("videoInfo").style.display = "block";
          document.getElementById("videoDiagnostics").style.display = "block";
          setupVideoEventListeners(autoPlay);

          // å¼ºåˆ¶åŠ è½½è§†é¢‘ï¼ˆç¡®ä¿è§†é¢‘å¯ä»¥æ’­æ”¾ï¼‰
          video.load();

          // åˆå§‹è¯Šæ–­ä¿¡æ¯
          setTimeout(() => updateDiagnostics(), 500);
        });

      // è¾…åŠ©å‡½æ•°ï¼šè®¾ç½®è§†é¢‘äº‹ä»¶ç›‘å¬å™¨ï¼ˆä½¿ç”¨autoPlayå‚æ•°ï¼‰
      function setupVideoEventListeners(shouldAutoPlay) {
        // æ·»åŠ äº‹ä»¶ç›‘å¬å™¨ï¼ˆä½¿ç”¨ once é¿å…é‡å¤ï¼‰
        video.addEventListener('loadedmetadata', () => {
          console.log('è§†é¢‘å…ƒæ•°æ®å·²åŠ è½½');
          updateVideoInfo();
          checkVideoTracks(); // å»¶è¿Ÿæ£€æŸ¥è§†é¢‘è½¨é“

          // å°è¯•è·³è½¬åˆ°ç¬¬ä¸€å¸§ä»¥ç”Ÿæˆå°é¢
          try {
            video.currentTime = 0.1; // è·³åˆ°0.1ç§’å¤„
          } catch (e) {
            console.warn('æ— æ³•è®¾ç½®currentTime:', e);
          }
        }, { once: true });

        video.addEventListener('loadeddata', () => {
          console.log('è§†é¢‘æ•°æ®å·²åŠ è½½');
          updateVideoInfo();

          // ç”Ÿæˆå°é¢
          generateVideoPoster();
        }, { once: true });

        video.addEventListener('seeked', () => {
          // å½“è§†é¢‘è·³è½¬åˆ°æŒ‡å®šä½ç½®åï¼Œç”Ÿæˆå°é¢
          if (!videoPoster.src || videoPoster.classList.contains("hidden")) {
            generateVideoPoster();
          }
        }, { once: true });

        // è§†é¢‘å¼€å§‹æ’­æ”¾æ—¶éšè—å°é¢ - æ¯æ¬¡æ’­æ”¾éƒ½æ˜¾ç¤ºè°ƒè¯•ä¿¡æ¯
        video.addEventListener('play', () => {
          console.log('========================================');
          console.log('â–¶ï¸ ç”¨æˆ·ç‚¹å‡»æ’­æ”¾æŒ‰é’® - è§†é¢‘å¼€å§‹æ’­æ”¾ (playäº‹ä»¶)');
          console.log('========================================');

          // ç«‹å³æ˜¾ç¤ºè¯Šæ–­ä¿¡æ¯åŒºåŸŸï¼ˆç¡®ä¿å¯è§ï¼‰
          const diagnosticsEl = document.getElementById("videoDiagnostics");
          if (diagnosticsEl) {
            diagnosticsEl.style.display = "block";
            diagnosticsEl.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
          }

          const hasVideo = video.videoWidth > 0 && video.videoHeight > 0;
          const hasAudio = video.duration > 0;
          const computedStyle = window.getComputedStyle(video);

          // è¯¦ç»†çš„è°ƒè¯•ä¿¡æ¯
          const debugInfo = {
            'è§†é¢‘å°ºå¯¸': `${video.videoWidth} Ã— ${video.videoHeight}` + (hasVideo ? ' âœ…' : ' âŒ æ²¡æœ‰è§†é¢‘è½¨é“'),
            'è§†é¢‘æ—¶é•¿': `${video.duration.toFixed(2)} ç§’` + (hasAudio ? ' âœ…' : ' âŒ'),
            'å½“å‰æ’­æ”¾æ—¶é—´': `${video.currentTime.toFixed(2)} ç§’`,
            'æ’­æ”¾é€Ÿåº¦': `${video.playbackRate}x`,
            'æ˜¯å¦æš‚åœ': video.paused ? 'æ˜¯' : 'å¦',
            'å°±ç»ªçŠ¶æ€': `${video.readyState} (${getReadyStateName(video.readyState)})`,
            'ç½‘ç»œçŠ¶æ€': `${video.networkState} (${getNetworkStateName(video.networkState)})`,
            'CSSæ˜¾ç¤º': computedStyle.display,
            'CSSå¯è§æ€§': computedStyle.visibility,
            'CSSé€æ˜åº¦': computedStyle.opacity,
            'CSSèƒŒæ™¯è‰²': computedStyle.backgroundColor,
            'CSS z-index': computedStyle.zIndex,
            'æ˜¯å¦æœ‰hiddenç±»': video.classList.contains('hidden') ? 'æ˜¯' : 'å¦',
            'è§†é¢‘æºURL': video.src || 'æœªè®¾ç½®'
          };

          console.log('æ’­æ”¾æ—¶è§†é¢‘çŠ¶æ€:');
          for (const [key, value] of Object.entries(debugInfo)) {
            console.log(`  - ${key}:`, value);
          }

          // å¦‚æœæ’­æ”¾æ—¶ä»ç„¶æ²¡æœ‰æ£€æµ‹åˆ°è§†é¢‘è½¨é“ï¼Œå°è¯•ç­‰å¾…ä¸€æ®µæ—¶é—´åå†æ¬¡æ£€æŸ¥
          // æŸäº›è§†é¢‘ç¼–ç æ ¼å¼ï¼ˆå¦‚æŸäº›H.264å˜ä½“ï¼‰éœ€è¦å®é™…æ’­æ”¾ä¸€æ®µæ—¶é—´åæ‰èƒ½æ­£ç¡®è·å–å°ºå¯¸
          if (!hasVideo && hasAudio) {
            console.warn('âš ï¸ æ’­æ”¾æ—¶æ£€æµ‹åˆ°å°ºå¯¸ä¸º0ï¼Œç­‰å¾…ä¸€æ®µæ—¶é—´åå†æ¬¡æ£€æŸ¥...');

            // ç­‰å¾…2ç§’åå†æ¬¡æ£€æŸ¥ï¼ˆç»™è§†é¢‘æ—¶é—´è§£ç å’Œæ¸²æŸ“ï¼‰
            setTimeout(() => {
              const hasVideoAfterPlay = video.videoWidth > 0 && video.videoHeight > 0;
              console.log('æ’­æ”¾2ç§’åå†æ¬¡æ£€æŸ¥è§†é¢‘å°ºå¯¸:', {
                width: video.videoWidth,
                height: video.videoHeight,
                readyState: video.readyState
              });

              if (hasVideoAfterPlay) {
                console.log('âœ… æ’­æ”¾åæ£€æµ‹åˆ°è§†é¢‘è½¨é“ï¼');
                updateDiagnostics();
                updateVideoInfo();
              } else {
                console.error('âš ï¸ æ’­æ”¾åä»ç„¶æ²¡æœ‰æ£€æµ‹åˆ°è§†é¢‘è½¨é“');
                // åªåœ¨ç¡®å®æ²¡æœ‰è§†é¢‘è½¨é“æ—¶æ‰æ˜¾ç¤ºè­¦å‘Š
                // ä¸æ˜¾ç¤ºé”™è¯¯ï¼Œå› ä¸ºè§†é¢‘æ–‡ä»¶åœ¨æœ¬åœ°å¯ä»¥æ’­æ”¾ï¼Œå¯èƒ½æ˜¯æµè§ˆå™¨å…¼å®¹æ€§é—®é¢˜
                showToast('âš ï¸ æµè§ˆå™¨å¯èƒ½æ— æ³•è§£ç è¯¥è§†é¢‘æ ¼å¼ï¼Œä½†è§†é¢‘æ–‡ä»¶æœ¬èº«æ­£å¸¸ï¼ˆå¯åœ¨æœ¬åœ°æ’­æ”¾å™¨æ’­æ”¾ï¼‰', 'warning');
              }
            }, 2000);
          }

          if (!videoPoster.classList.contains("hidden")) {
            videoPoster.classList.add("hidden");
            videoPoster.style.display = "none";
          }

          // ç¡®ä¿è§†é¢‘å…ƒç´ å¯è§
          if (video.classList.contains("hidden")) {
            video.classList.remove("hidden");
          }
          video.style.display = "block";
          video.style.visibility = "visible";
          video.style.opacity = "1";
          video.style.zIndex = "10";
          video.style.position = "relative";
          video.style.background = "transparent";

          // å¼ºåˆ¶æ›´æ–°å¹¶æ˜¾ç¤ºè¯Šæ–­ä¿¡æ¯
          updateDiagnostics();

          console.log('========================================');
        });

        // è§†é¢‘å®é™…å¼€å§‹æ’­æ”¾æ—¶ï¼ˆplayingäº‹ä»¶ï¼‰
        video.addEventListener('playing', () => {
          console.log('â–¶ï¸ è§†é¢‘æ­£åœ¨æ’­æ”¾ (playingäº‹ä»¶)');
          updateDiagnostics();
        });

        // è§†é¢‘æš‚åœæ—¶
        video.addEventListener('pause', () => {
          console.log('â¸ï¸ è§†é¢‘å·²æš‚åœ (pauseäº‹ä»¶)');
          updateDiagnostics();
        });

        // è§†é¢‘ç­‰å¾…æ•°æ®æ—¶
        video.addEventListener('waiting', () => {
          console.log('â³ è§†é¢‘æ­£åœ¨ç¼“å†² (waitingäº‹ä»¶)');
          updateDiagnostics();
        });

        // è§†é¢‘å¯ä»¥ç»§ç»­æ’­æ”¾æ—¶
        video.addEventListener('playing', () => {
          console.log('â–¶ï¸ è§†é¢‘ç»§ç»­æ’­æ”¾ (playingäº‹ä»¶)');
        });

        video.addEventListener('canplay', () => {
          console.log('========================================');
          console.log('âœ… è§†é¢‘å¯ä»¥æ’­æ”¾ (canplayäº‹ä»¶)');
          console.log('è§†é¢‘å°ºå¯¸:', video.videoWidth, 'Ã—', video.videoHeight);
          console.log('è§†é¢‘æ—¶é•¿:', video.duration, 'ç§’');
          console.log('è§†é¢‘å°±ç»ªçŠ¶æ€ (readyState):', video.readyState, '(', getReadyStateName(video.readyState), ')');
          console.log('ç½‘ç»œçŠ¶æ€ (networkState):', video.networkState, '(', getNetworkStateName(video.networkState), ')');
          console.log('å½“å‰æ—¶é—´:', video.currentTime);
          console.log('========================================');
          updateVideoInfo();
          checkVideoTracks();
          updateDiagnostics(); // æ›´æ–°è¯Šæ–­ä¿¡æ¯

          // æ£€æŸ¥æ˜¯å¦æœ‰è§†é¢‘è½¨é“
          if (video.videoWidth === 0 || video.videoHeight === 0) {
            console.warn('âš ï¸ è§†é¢‘å°ºå¯¸ä¸º0ï¼Œå¯èƒ½æ²¡æœ‰è§†é¢‘è½¨é“');
            showToast('âš ï¸ è­¦å‘Šï¼šæ£€æµ‹åˆ°è§†é¢‘å¯èƒ½æ²¡æœ‰ç”»é¢ï¼Œåªæœ‰éŸ³é¢‘', 'warning');
          }

          // å¦‚æœè®¾ç½®äº†è‡ªåŠ¨æ’­æ”¾ï¼Œå°è¯•æ’­æ”¾
          if (shouldAutoPlay) {
            console.log('========================================');
            console.log('å°è¯•è‡ªåŠ¨æ’­æ”¾è§†é¢‘...');
            console.log('è§†é¢‘çŠ¶æ€:', {
              src: video.src,
              videoWidth: video.videoWidth,
              videoHeight: video.videoHeight,
              duration: video.duration,
              readyState: video.readyState,
              networkState: video.networkState
            });
            console.log('========================================');

            video.play()
              .then(() => {
                console.log('âœ… è§†é¢‘è‡ªåŠ¨æ’­æ”¾æˆåŠŸ');
                showToast('è§†é¢‘å¼€å§‹æ’­æ”¾', 'success');
                // å¼ºåˆ¶æ˜¾ç¤ºè¯Šæ–­ä¿¡æ¯
                document.getElementById("videoDiagnostics").style.display = "block";
                updateDiagnostics();
              })
              .catch(err => {
                console.error('========================================');
                console.error('âŒ è§†é¢‘è‡ªåŠ¨æ’­æ”¾å¤±è´¥');
                console.error('é”™è¯¯åç§°:', err.name);
                console.error('é”™è¯¯æ¶ˆæ¯:', err.message);
                console.error('è§†é¢‘çŠ¶æ€:', {
                  src: video.src,
                  videoWidth: video.videoWidth,
                  videoHeight: video.videoHeight,
                  duration: video.duration,
                  readyState: video.readyState,
                  networkState: video.networkState,
                  paused: video.paused
                });
                console.error('========================================');
                showToast(`è‡ªåŠ¨æ’­æ”¾å¤±è´¥: ${err.message}`, 'error');
                // å¼ºåˆ¶æ˜¾ç¤ºè¯Šæ–­ä¿¡æ¯
                document.getElementById("videoDiagnostics").style.display = "block";
                updateDiagnostics();
              });
          }
        }, { once: true });

        video.addEventListener('canplaythrough', () => {
          console.log('âœ… è§†é¢‘å·²åŠ è½½è¶³å¤Ÿæ•°æ®å¯ä»¥æµç•…æ’­æ”¾ (canplaythroughäº‹ä»¶)');
          console.log('è§†é¢‘ç¼“å†²èŒƒå›´:', Array.from({ length: video.buffered.length }, (_, i) => ({
            start: video.buffered.start(i),
            end: video.buffered.end(i)
          })));
        }, { once: true });
      }

      // ç”Ÿæˆå¹¶æ˜¾ç¤ºè§†é¢‘å°é¢
      function generateVideoPoster() {
        // ç­‰å¾…è§†é¢‘å…ƒæ•°æ®åŠ è½½
        const tryGeneratePoster = () => {
          if (video.readyState >= 2 && video.videoWidth > 0 && video.videoHeight > 0) { // HAVE_CURRENT_DATA
            try {
              const canvas = document.createElement('canvas');
              canvas.width = video.videoWidth;
              canvas.height = video.videoHeight;
              const ctx = canvas.getContext('2d');

              // ç»˜åˆ¶è§†é¢‘å½“å‰å¸§åˆ°canvas
              ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

              // å°†canvasè½¬ä¸ºå›¾ç‰‡URL
              const posterUrl = canvas.toDataURL('image/jpeg', 0.85);
              videoPoster.src = posterUrl;
              videoPoster.classList.remove("hidden");
              videoPoster.style.display = "block";

              // ç‚¹å‡»å°é¢æ—¶æ’­æ”¾è§†é¢‘
              videoPoster.onclick = () => {
                videoPoster.classList.add("hidden");
                videoPoster.style.display = "none";
                video.play().catch(e => {
                  console.error('æ’­æ”¾å¤±è´¥:', e);
                  showToast('è§†é¢‘æ’­æ”¾å¤±è´¥ï¼Œè¯·å°è¯•ä¸‹è½½è§†é¢‘', 'error');
                });
              };

              console.log('è§†é¢‘å°é¢å·²ç”Ÿæˆ:', canvas.width, 'Ã—', canvas.height);

              // ç«‹å³æ›´æ–°åˆ†è¾¨ç‡ä¿¡æ¯
              document.getElementById("videoResolution").textContent =
                `${video.videoWidth} Ã— ${video.videoHeight}`;
            } catch (e) {
              console.error('ç”Ÿæˆå°é¢å¤±è´¥:', e);
              // å¦‚æœç”Ÿæˆå°é¢å¤±è´¥ï¼Œè‡³å°‘æ˜¾ç¤ºè§†é¢‘å…ƒç´ 
            }
          } else if (video.readyState >= 1) {
            // å¦‚æœå…ƒæ•°æ®å·²åŠ è½½ä½†è¿˜æ²¡æœ‰è§†é¢‘æ•°æ®ï¼Œå†ç­‰ä¸€ä¼šå„¿
            setTimeout(tryGeneratePoster, 200);
          }
        };

        // å¼€å§‹å°è¯•ç”Ÿæˆå°é¢
        tryGeneratePoster();
      }

      // ä½¿ç”¨ä¸€æ¬¡æ€§äº‹ä»¶ç›‘å¬å™¨æ›´æ–°è§†é¢‘ä¿¡æ¯
      const updateVideoInfo = () => {
        // æ›´æ–°åˆ†è¾¨ç‡æ˜¾ç¤º
        if (video.videoWidth > 0 && video.videoHeight > 0) {
          document.getElementById("videoResolution").textContent =
            `${video.videoWidth} Ã— ${video.videoHeight}`;
        } else {
          // å¦‚æœreadyStateè¿˜å¾ˆä½ï¼Œè¯´æ˜å…ƒæ•°æ®è¿˜æ²¡åŠ è½½å®Œæˆï¼Œæ˜¾ç¤ºåŠ è½½ä¸­
          if (video.readyState < 1) {
            document.getElementById("videoResolution").textContent = 'åŠ è½½ä¸­...';
          } else {
            // readyState >= 1ä½†å°ºå¯¸è¿˜æ˜¯0ï¼Œå¯èƒ½æ˜¯çœŸçš„æ²¡æœ‰è§†é¢‘è½¨é“ï¼Œä½†ä¸ä¸€å®šæ˜¯é—®é¢˜
            // å¯èƒ½è§†é¢‘ç¼–ç æ ¼å¼éœ€è¦æ›´é•¿æ—¶é—´è§£ç ï¼Œæ‰€ä»¥å…ˆæ˜¾ç¤º"æ£€æµ‹ä¸­"
            document.getElementById("videoResolution").textContent = video.readyState >= 2 ? 'æ£€æµ‹ä¸­...' : 'åŠ è½½ä¸­...';
          }
        }

        // æ›´æ–°æ—¶é•¿æ˜¾ç¤º
        if (video.duration && !isNaN(video.duration) && isFinite(video.duration)) {
          document.getElementById("videoDuration").textContent =
            formatDuration(video.duration);
        } else {
          document.getElementById("videoDuration").textContent = '--';
        }

        console.log('è§†é¢‘ä¿¡æ¯å·²æ›´æ–°:', {
          width: video.videoWidth,
          height: video.videoHeight,
          duration: video.duration,
          readyState: video.readyState
        });

        // åŒæ—¶æ›´æ–°è¯Šæ–­ä¿¡æ¯
        updateDiagnostics();
      };

      // è§†é¢‘å…ƒæ•°æ®æ£€æŸ¥æ ‡å¿—ï¼Œé¿å…é‡å¤æ£€æŸ¥
      let metadataChecked = false;

      // æ›´æ–°è¯Šæ–­ä¿¡æ¯æ˜¾ç¤º
      function updateDiagnostics() {
        const diagnosticsEl = document.getElementById("videoDiagnostics");
        const diagnosticsContent = document.getElementById("diagnosticsContent");

        if (!diagnosticsEl || !diagnosticsContent) {
          console.warn('è¯Šæ–­ä¿¡æ¯å…ƒç´ ä¸å­˜åœ¨');
          return;
        }

        const hasVideo = video.videoWidth > 0 && video.videoHeight > 0;
        const hasAudio = video.duration > 0;
        const computedStyle = window.getComputedStyle(video);
        const info = {
          'è§†é¢‘URL': video.src || 'æœªè®¾ç½®',
          'è§†é¢‘å°ºå¯¸': hasVideo ? `${video.videoWidth} Ã— ${video.videoHeight}` : '0 Ã— 0 (âš ï¸ æ²¡æœ‰è§†é¢‘è½¨é“)',
          'è§†é¢‘æ—¶é•¿': hasAudio ? `${video.duration.toFixed(2)} ç§’` : 'æœªçŸ¥',
          'å°±ç»ªçŠ¶æ€': `${video.readyState} (${getReadyStateName(video.readyState)})`,
          'ç½‘ç»œçŠ¶æ€': `${video.networkState} (${getNetworkStateName(video.networkState)})`,
          'æ˜¯å¦æœ‰è§†é¢‘è½¨é“': hasVideo ? 'âœ… æ˜¯' : 'âŒ å¦ï¼ˆåªæœ‰éŸ³é¢‘ï¼‰',
          'æ˜¯å¦æœ‰éŸ³é¢‘è½¨é“': hasAudio ? 'âœ… æ˜¯' : 'âŒ å¦',
          'å½“å‰æ’­æ”¾æ—¶é—´': `${video.currentTime.toFixed(2)} ç§’`,
          'æ˜¯å¦æš‚åœ': video.paused ? 'æ˜¯' : 'å¦',
          'æ’­æ”¾é€Ÿåº¦': `${video.playbackRate}x`,
          'CSSæ˜¾ç¤º': computedStyle.display,
          'CSSå¯è§æ€§': computedStyle.visibility,
          'CSSé€æ˜åº¦': computedStyle.opacity,
          'CSSèƒŒæ™¯è‰²': computedStyle.backgroundColor,
          'CSS z-index': computedStyle.zIndex,
          'æ˜¯å¦æœ‰hiddenç±»': video.classList.contains('hidden') ? 'æ˜¯' : 'å¦',
          'è§†é¢‘å…ƒç´ ä½ç½®': video.style.position || computedStyle.position
        };

        let html = '';
        for (const [key, value] of Object.entries(info)) {
          const color = (key.includes('è½¨é“') && value.includes('å¦')) ? '#ff4444' : 'inherit';
          html += `<div style="margin: 4px 0;"><strong>${key}:</strong> <span style="color: ${color}">${value}</span></div>`;
        }

        diagnosticsContent.innerHTML = html;
        diagnosticsEl.style.display = 'block';

        // å¦‚æœæ²¡æœ‰è§†é¢‘è½¨é“ä½†æœ‰éŸ³é¢‘ï¼Œæ˜¾ç¤ºè­¦å‘Š
        if (!hasVideo && hasAudio && video.readyState >= 2) {
          showToast('âš ï¸ è­¦å‘Šï¼šè§†é¢‘æ–‡ä»¶å¯èƒ½åªæœ‰éŸ³é¢‘è½¨é“ï¼Œæ²¡æœ‰è§†é¢‘ç”»é¢', 'warning');
          diagnosticsEl.style.background = 'rgba(255,87,34,0.15)';
          diagnosticsEl.style.borderColor = 'rgba(255,87,34,0.4)';
        } else {
          diagnosticsEl.style.background = 'rgba(255,193,7,0.1)';
          diagnosticsEl.style.borderColor = 'rgba(255,193,7,0.3)';
        }
      }

      // æ£€æŸ¥è§†é¢‘æ˜¯å¦æœ‰æœ‰æ•ˆçš„è§†é¢‘è½¨é“
      function checkVideoTracks() {
        // å»¶è¿Ÿæ£€æŸ¥ï¼Œç»™è§†é¢‘ä¸€äº›æ—¶é—´åŠ è½½å…ƒæ•°æ®
        // ä½¿ç”¨å¤šæ¬¡æ£€æŸ¥ï¼Œå› ä¸ºæŸäº›è§†é¢‘ç¼–ç æ ¼å¼éœ€è¦æ›´é•¿æ—¶é—´è§£ç å…ƒæ•°æ®
        let checkCount = 0;
        const maxChecks = 10; // æœ€å¤šæ£€æŸ¥10æ¬¡ï¼Œæ¯æ¬¡é—´éš”1ç§’

        const checkInterval = setInterval(() => {
          checkCount++;

          if (metadataChecked && checkCount > 3) {
            clearInterval(checkInterval);
            return; // å·²ç»æ£€æŸ¥è¿‡äº†
          }

          // å¦‚æœè§†é¢‘å·²ç»åŠ è½½åˆ°å¯ä»¥è·å–å°ºå¯¸çš„çŠ¶æ€
          if (video.readyState >= 1) { // HAVE_METADATA
            const hasVideo = video.videoWidth > 0 && video.videoHeight > 0;
            const hasAudio = video.duration > 0;

            const checkInfo = {
              width: video.videoWidth,
              height: video.videoHeight,
              duration: video.duration,
              readyState: video.readyState,
              hasVideo: hasVideo,
              hasAudio: hasAudio
            };
            console.log(`è§†é¢‘è½¨é“æ£€æŸ¥ (ç¬¬${checkCount}æ¬¡):`, checkInfo);
            // è¾“å‡ºåˆ°ç»ˆç«¯ï¼ˆé€šè¿‡console.logï¼Œåç«¯ä¼šæ•è·ï¼‰
            console.log(`[å‰ç«¯è¯Šæ–­] è§†é¢‘è½¨é“æ£€æŸ¥ (ç¬¬${checkCount}æ¬¡): ${JSON.stringify(checkInfo)}`);

            // æ›´æ–°è¯Šæ–­ä¿¡æ¯
            updateDiagnostics();

            // å¦‚æœæ£€æµ‹åˆ°è§†é¢‘è½¨é“ï¼Œåœæ­¢æ£€æŸ¥
            if (hasVideo) {
              console.log('âœ… æ£€æµ‹åˆ°è§†é¢‘è½¨é“ï¼Œåœæ­¢æ£€æŸ¥');
              clearInterval(checkInterval);
              metadataChecked = true;
              return;
            }

            // åªæœ‰åœ¨å¤šæ¬¡æ£€æŸ¥åï¼ˆè‡³å°‘3æ¬¡ï¼Œå³3ç§’åï¼‰ä»ç„¶æ²¡æœ‰è§†é¢‘è½¨é“ä¸”æœ‰éŸ³é¢‘è½¨é“æ—¶æ‰è­¦å‘Š
            // æŸäº›è§†é¢‘ç¼–ç æ ¼å¼ï¼ˆå¦‚æŸäº›H.264å˜ä½“ï¼‰éœ€è¦æ›´é•¿æ—¶é—´æ¥è§£ç å…ƒæ•°æ®
            if (!hasVideo && hasAudio && checkCount >= 3 && video.readyState >= 2) {
              console.warn(`âš ï¸ ç¬¬${checkCount}æ¬¡æ£€æŸ¥ï¼šä»ç„¶æ²¡æœ‰æ£€æµ‹åˆ°è§†é¢‘è½¨é“`);

              // å°è¯•å¼ºåˆ¶é‡æ–°åŠ è½½è§†é¢‘å…ƒæ•°æ®
              if (checkCount === 3) {
                console.log('å°è¯•å¼ºåˆ¶é‡æ–°åŠ è½½è§†é¢‘å…ƒæ•°æ®...');
                try {
                  video.load(); // é‡æ–°åŠ è½½è§†é¢‘
                } catch (e) {
                  console.error('é‡æ–°åŠ è½½è§†é¢‘å¤±è´¥:', e);
                }
              }

              // åªåœ¨æœ€åä¸€æ¬¡æ£€æŸ¥æ—¶æ˜¾ç¤ºè­¦å‘Šï¼ˆä¸æ˜¯é”™è¯¯ï¼Œå› ä¸ºè§†é¢‘æ–‡ä»¶æœ¬èº«å¯èƒ½æ­£å¸¸ï¼‰
              if (checkCount >= maxChecks) {
                console.warn('âš ï¸ å¤šæ¬¡æ£€æŸ¥åä»ç„¶æ²¡æœ‰æ£€æµ‹åˆ°è§†é¢‘è½¨é“');
                // ä¸æ˜¾ç¤ºé”™è¯¯å¼¹çª—ï¼Œåªæ˜¾ç¤ºè­¦å‘Šæç¤ºï¼Œå› ä¸ºè§†é¢‘æ–‡ä»¶åœ¨æœ¬åœ°å¯ä»¥æ’­æ”¾
                // è¿™é€šå¸¸æ˜¯æµè§ˆå™¨å…¼å®¹æ€§é—®é¢˜ï¼Œè€Œä¸æ˜¯è§†é¢‘æ–‡ä»¶æœ¬èº«çš„é—®é¢˜
                showToast('âš ï¸ æµè§ˆå™¨å¯èƒ½æ— æ³•è§£ç è¯¥è§†é¢‘æ ¼å¼ï¼Œä½†è§†é¢‘æ–‡ä»¶æœ¬èº«æ­£å¸¸ï¼ˆå¯åœ¨æœ¬åœ°æ’­æ”¾å™¨æ’­æ”¾ï¼‰', 'warning');
                clearInterval(checkInterval);
                metadataChecked = true;
              }
            }

            // è¾¾åˆ°æœ€å¤§æ£€æŸ¥æ¬¡æ•°ååœæ­¢
            if (checkCount >= maxChecks) {
              clearInterval(checkInterval);
              metadataChecked = true;
            }
          } else if (checkCount >= maxChecks) {
            // å¦‚æœè¾¾åˆ°æœ€å¤§æ£€æŸ¥æ¬¡æ•°ä»ç„¶æ²¡æœ‰å…ƒæ•°æ®ï¼Œåœæ­¢æ£€æŸ¥
            clearInterval(checkInterval);
            metadataChecked = true;
          }
        }, 1000); // æ¯1ç§’æ£€æŸ¥ä¸€æ¬¡
      }

      // æ·»åŠ äº‹ä»¶ç›‘å¬å™¨ï¼ˆä½¿ç”¨ once é¿å…é‡å¤ï¼‰
      video.addEventListener('loadedmetadata', () => {
        console.log('è§†é¢‘å…ƒæ•°æ®å·²åŠ è½½');
        updateVideoInfo();
        checkVideoTracks(); // å»¶è¿Ÿæ£€æŸ¥è§†é¢‘è½¨é“

        // å°è¯•è·³è½¬åˆ°ç¬¬ä¸€å¸§ä»¥ç”Ÿæˆå°é¢
        try {
          video.currentTime = 0.1; // è·³åˆ°0.1ç§’å¤„
        } catch (e) {
          console.warn('æ— æ³•è®¾ç½®currentTime:', e);
        }
      }, { once: true });

      video.addEventListener('loadeddata', () => {
        console.log('è§†é¢‘æ•°æ®å·²åŠ è½½');
        updateVideoInfo();

        // ç”Ÿæˆå°é¢
        generateVideoPoster();
      }, { once: true });

      video.addEventListener('seeked', () => {
        // å½“è§†é¢‘è·³è½¬åˆ°æŒ‡å®šä½ç½®åï¼Œç”Ÿæˆå°é¢
        if (!videoPoster.src || videoPoster.classList.contains("hidden")) {
          generateVideoPoster();
        }
      }, { once: true });

      // è§†é¢‘å¼€å§‹æ’­æ”¾æ—¶éšè—å°é¢
      video.addEventListener('play', () => {
        if (!videoPoster.classList.contains("hidden")) {
          videoPoster.classList.add("hidden");
          videoPoster.style.display = "none";
        }
      });

      video.addEventListener('canplay', () => {
        console.log('========================================');
        console.log('âœ… è§†é¢‘å¯ä»¥æ’­æ”¾ (canplayäº‹ä»¶)');
        console.log('è§†é¢‘å°ºå¯¸:', video.videoWidth, 'Ã—', video.videoHeight);
        console.log('è§†é¢‘æ—¶é•¿:', video.duration, 'ç§’');
        console.log('è§†é¢‘å°±ç»ªçŠ¶æ€ (readyState):', video.readyState, '(4=HAVE_ENOUGH_DATA)');
        console.log('ç½‘ç»œçŠ¶æ€ (networkState):', video.networkState);
        console.log('å½“å‰æ—¶é—´:', video.currentTime);
        console.log('========================================');
        updateVideoInfo();
        checkVideoTracks(); // å†æ¬¡æ£€æŸ¥ï¼ˆå¦‚æœä¹‹å‰è¿˜æ²¡æ£€æŸ¥ï¼‰

        // å¦‚æœè®¾ç½®äº†è‡ªåŠ¨æ’­æ”¾ï¼Œå°è¯•æ’­æ”¾
        if (autoPlay) {
          console.log('å°è¯•è‡ªåŠ¨æ’­æ”¾è§†é¢‘...');
          video.play()
            .then(() => {
              console.log('âœ… è§†é¢‘è‡ªåŠ¨æ’­æ”¾æˆåŠŸ');
              showToast('è§†é¢‘å¼€å§‹æ’­æ”¾', 'success');
            })
            .catch(err => {
              console.error('âŒ è§†é¢‘è‡ªåŠ¨æ’­æ”¾å¤±è´¥:', err);
              console.error('é”™è¯¯åç§°:', err.name);
              console.error('é”™è¯¯æ¶ˆæ¯:', err.message);
              showToast(`è‡ªåŠ¨æ’­æ”¾å¤±è´¥: ${err.message}`, 'error');
              // å³ä½¿è‡ªåŠ¨æ’­æ”¾å¤±è´¥ï¼Œç”¨æˆ·ä»ç„¶å¯ä»¥æ‰‹åŠ¨ç‚¹å‡»æ’­æ”¾
            });
        }
      }, { once: true });

      // æ·»åŠ  canplaythrough äº‹ä»¶ç›‘å¬ï¼ˆå½“è§†é¢‘å·²ç»åŠ è½½è¶³å¤Ÿçš„æ•°æ®å¯ä»¥æµç•…æ’­æ”¾æ—¶ï¼‰
      video.addEventListener('canplaythrough', () => {
        console.log('âœ… è§†é¢‘å·²åŠ è½½è¶³å¤Ÿæ•°æ®å¯ä»¥æµç•…æ’­æ”¾ (canplaythroughäº‹ä»¶)');
        console.log('è§†é¢‘ç¼“å†²èŒƒå›´:', Array.from({ length: video.buffered.length }, (_, i) => ({
          start: video.buffered.start(i),
          end: video.buffered.end(i)
        })));
      }, { once: true });

      // å°è¯•è·å–æ–‡ä»¶å¤§å°
      fetch(videoUrl, { method: 'HEAD' })
        .then(response => {
          if (response.ok) {
            const contentLength = response.headers.get('content-length');
            if (contentLength) {
              const sizeMB = (parseInt(contentLength) / 1024 / 1024).toFixed(2);
              document.getElementById("videoSize").textContent = `${sizeMB} MB`;
            }
          }
        })
        .catch(() => {
          document.getElementById("videoSize").textContent = "æœªçŸ¥";
        });

      // å¼ºåˆ¶åŠ è½½è§†é¢‘
      video.load();

      // æ›´æ–°å‚æ•°æ˜¾ç¤ºï¼ˆå¦‚æœæ˜¯å†å²è®°å½•è¯¦æƒ…é¡µï¼Œåªæ˜¾ç¤ºç”Ÿæˆæ—¶é—´å’Œé—®é¢˜ï¼‰
      if (params) {
        const urlParams = new URLSearchParams(window.location.search);
        const isHistoryDetailPage = urlParams.has('record_id');

        document.getElementById("paramCard").style.display = "block";
        if (isHistoryDetailPage) {
          // å†å²è®°å½•è¯¦æƒ…é¡µï¼šåªæ˜¾ç¤ºæ—¶é—´å’Œé—®é¢˜
          document.getElementById("paramModelRow").style.display = "none"; // éšè—æ¨¡å‹è¡Œ
          document.getElementById("paramCharacterRow").style.display = "none"; // éšè—è§’è‰²è¡Œ
          document.getElementById("paramTimeRow").querySelector(".param-label").textContent = "ç”Ÿæˆæ—¶é—´:";
          document.getElementById("paramTime").textContent = params.date || new Date().toLocaleString('zh-CN');
          document.getElementById("paramTextRow").querySelector(".param-label").textContent = "é—®é¢˜:";
          document.getElementById("paramText").textContent = params.text || 'æ— é—®é¢˜';
        } else {
          // æ­£å¸¸é¡µé¢ï¼šæ˜¾ç¤ºå®Œæ•´ä¿¡æ¯
          document.getElementById("paramModelRow").style.display = "flex";
          document.getElementById("paramCharacterRow").style.display = "flex";
          document.getElementById("paramModelRow").querySelector(".param-label").textContent = "æ¨¡å‹:";
          document.getElementById("paramCharacterRow").querySelector(".param-label").textContent = "è§’è‰²:";
          document.getElementById("paramTimeRow").querySelector(".param-label").textContent = "ç”Ÿæˆæ—¶é—´:";
          document.getElementById("paramTextRow").querySelector(".param-label").textContent = "æ–‡æœ¬:";
          document.getElementById("paramModel").textContent = params.model || '';
          document.getElementById("paramCharacter").textContent = params.character || '';
          document.getElementById("paramTime").textContent = params.date || new Date().toLocaleString('zh-CN');
          document.getElementById("paramText").textContent = params.text || '';
        }
      }
    }

    function formatDuration(seconds) {
      const mins = Math.floor(seconds / 60);
      const secs = Math.floor(seconds % 60);
      return `${mins}:${secs.toString().padStart(2, '0')}`;
    }

    // ç¦ç”¨/å¯ç”¨è¾“å…¥æ§ä»¶
    function setInputsDisabled(disabled) {
      document.getElementById("textInput").disabled = disabled;
      document.getElementById("characterInput").disabled = disabled;
      modelsSelect.disabled = disabled;
      document.getElementById("refreshBtn").disabled = disabled;
    }

    // è®¾ç½®æŒ‰é’®çŠ¶æ€ï¼šä»»åŠ¡è¿è¡Œä¸­æ˜¾ç¤ºç»ˆæ­¢æŒ‰é’®ï¼Œå¦åˆ™æ˜¾ç¤ºå¼€å§‹ç”ŸæˆæŒ‰é’®
    function setRunButtonState(isRunning) {
      if (isRunning) {
        runBtn.innerHTML = "âŒ ç»ˆæ­¢ä»»åŠ¡";
        runBtn.style.background = "#ef4444";
        runBtn.style.borderColor = "#ef4444";
        runBtn.dataset.isRunning = "true";
      } else {
        runBtn.innerHTML = "ğŸš€ å¼€å§‹ç”Ÿæˆè§†é¢‘";
        runBtn.style.background = "";
        runBtn.style.borderColor = "";
        runBtn.dataset.isRunning = "false";
      }
    }

    // æ›´æ–°ä»»åŠ¡é…ç½®æ˜¾ç¤º
    function updateTaskConfig(task) {
      if (task && task.text) {
        document.getElementById("textInput").value = task.text;
        document.getElementById("characterInput").value = task.character || "ayanami";
        if (task.model_name) {
          modelsSelect.value = task.model_name;
        }
      }
    }

    // è½®è¯¢ä»»åŠ¡çŠ¶æ€
    async function pollTaskStatus(taskId) {
      try {
        const res = await fetch(`${FASTAPI_URL}/generate_video/status/${taskId}`);
        if (!res.ok) {
          console.error(`ä»»åŠ¡çŠ¶æ€æŸ¥è¯¢å¤±è´¥: HTTP ${res.status}`);
          return null;
        }
        const data = await res.json();
        if (data.success && data.data) {
          return data.data;
        }
        return null;
      } catch (e) {
        console.error('ä»»åŠ¡çŠ¶æ€æŸ¥è¯¢å‡ºé”™:', e);
        return null;
      }
    }

    // å¼€å§‹ä»»åŠ¡çŠ¶æ€è½®è¯¢
    function startTaskStatusPolling(taskId) {
      if (taskStatusPollInterval) {
        clearInterval(taskStatusPollInterval);
      }

      taskStatusPollInterval = setInterval(async () => {
        const task = await pollTaskStatus(taskId);
        if (!task) {
          return; // ä»»åŠ¡ä¸å­˜åœ¨æˆ–æŸ¥è¯¢å¤±è´¥
        }

        // æ›´æ–°ä»»åŠ¡é…ç½®æ˜¾ç¤ºï¼ˆå¦‚æœä»»åŠ¡æ­£åœ¨è¿è¡Œï¼‰
        if (task.status === "running" || task.status === "pending") {
          updateTaskConfig(task);
        }

        // æ ¹æ®ä»»åŠ¡çŠ¶æ€æ›´æ–°UI
        if (task.status === "completed") {
          // ä»»åŠ¡å®Œæˆ
          clearInterval(taskStatusPollInterval);
          taskStatusPollInterval = null;

          // åœæ­¢æ—¥å¿—è½®è¯¢
          stopLogPolling();

          // æ›´æ–°è¿›åº¦
          updateProgress('save', 100, true);

          // æ˜¾ç¤ºå®é™…ç”Ÿæˆæ—¶é—´
          if (task.generation_time) {
            const genTime = task.generation_time;
            const timeText = genTime > 60
              ? `${Math.floor(genTime / 60)}åˆ†${Math.floor(genTime % 60)}ç§’`
              : `${Math.floor(genTime)}ç§’`;
            document.getElementById("progressTime").textContent = `æ€»è€—æ—¶: ${timeText}`;
          }

          // åŠ è½½æœ€æ–°ç”Ÿæˆçš„è§†é¢‘ï¼ˆä»video_pathæ„é€ URLï¼‰
          const videoUrl = getVideoUrlFromPath(task.video_path);
          if (videoUrl) {
            const params = {
              text: task.text,
              character: task.character,
              model: task.model_name,
              date: new Date().toLocaleString('zh-CN'),
              generation_time: task.generation_time,
              unique_id: taskId
            };

            setTimeout(() => {
              loadVideo(videoUrl, params, true); // ç¬¬ä¸‰ä¸ªå‚æ•°trueè¡¨ç¤ºè‡ªåŠ¨æ’­æ”¾
              loadHistory(); // ä»æ•°æ®åº“é‡æ–°åŠ è½½å†å²è®°å½•
              setStatus(`âœ… è§†é¢‘ç”ŸæˆæˆåŠŸ (ç”¨æ—¶: ${task.generation_time ? Math.floor(task.generation_time) + 'ç§’' : 'æœªçŸ¥'})`);
              showToast("è§†é¢‘ç”ŸæˆæˆåŠŸï¼Œæ­£åœ¨è‡ªåŠ¨æ’­æ”¾...", "success");
              resetProgress();
            }, 500);
          } else {
            console.error('æ— æ³•ä»è·¯å¾„æ„é€ è§†é¢‘URL:', task.video_path);
            showError('è§†é¢‘åŠ è½½å¤±è´¥', `æ— æ³•ä»è·¯å¾„æ„é€ URL: ${task.video_path || 'è·¯å¾„ä¸ºç©º'}`);
          }

          // æ¢å¤è¾“å…¥
          setInputsDisabled(false);
          setRunButtonState(false);  // æŒ‰é’®æ¢å¤ä¸ºå¼€å§‹ç”Ÿæˆ
          currentTaskId = null;

        } else if (task.status === "failed") {
          // ä»»åŠ¡å¤±è´¥
          clearInterval(taskStatusPollInterval);
          taskStatusPollInterval = null;
          stopLogPolling();

          const errorMsg = task.error || "ç”Ÿæˆå¤±è´¥";
          setStatus("âŒ ç”Ÿæˆå¤±è´¥ï¼š" + errorMsg);
          showError("ç”Ÿæˆå¤±è´¥", errorMsg);
          resetProgress();

          // æ¢å¤è¾“å…¥
          setInputsDisabled(false);
          setRunButtonState(false);  // æŒ‰é’®æ¢å¤ä¸ºå¼€å§‹ç”Ÿæˆ
          currentTaskId = null;

        } else if (task.status === "cancelled") {
          // ä»»åŠ¡å·²å–æ¶ˆ
          clearInterval(taskStatusPollInterval);
          taskStatusPollInterval = null;

          // åœæ­¢æ—¥å¿—è½®è¯¢
          stopLogPolling();

          // æ¢å¤è¾“å…¥
          setInputsDisabled(false);
          setRunButtonState(false);  // æŒ‰é’®æ¢å¤ä¸ºå¼€å§‹ç”Ÿæˆ
          currentTaskId = null;

          setStatus("âŒ ä»»åŠ¡å·²ç»ˆæ­¢");
          showToast("ä»»åŠ¡å·²ç»ˆæ­¢", "info");
          resetProgress();

        } else if (task.status === "running" || task.status === "pending") {
          // ä»»åŠ¡è¿è¡Œä¸­ï¼Œç»§ç»­è½®è¯¢æ—¥å¿—
          // æ—¥å¿—è½®è¯¢å·²ç»åœ¨startLogPollingä¸­å¤„ç†
        }
      }, 2000); // æ¯2ç§’è½®è¯¢ä¸€æ¬¡
    }

    async function runPipeline() {
      const text = document.getElementById("textInput").value.trim();
      const character = document.getElementById("characterInput").value;
      const model = modelsSelect.value;
      if (!text) {
        showToast("è¯·è¾“å…¥æ–‡æœ¬", "error");
        return;
      }
      if (!model) {
        showToast("è¯·é€‰æ‹©æ¨¡å‹", "error");
        return;
      }

      // æ£€æŸ¥æ˜¯å¦å·²æœ‰ä»»åŠ¡åœ¨è¿è¡Œ
      if (currentTaskId && taskStatusPollInterval) {
        showToast("å·²æœ‰ä»»åŠ¡æ­£åœ¨è¿è¡Œï¼Œè¯·ç­‰å¾…å®Œæˆ", "warning");
        return;
      }

      // ç¦ç”¨è¾“å…¥
      setInputsDisabled(true);
      setRunButtonState(true);  // æŒ‰é’®å˜ä¸ºç»ˆæ­¢ä»»åŠ¡

      startTime = Date.now();

      // é‡ç½®UI
      video.classList.add("hidden");
      videoPlaceholder.classList.remove("hidden");
      document.getElementById("videoControls").style.display = "none";
      document.getElementById("videoInfo").style.display = "none";
      document.getElementById("paramCard").style.display = "none";

      try {
        // åˆå§‹åŒ–è¿›åº¦ï¼ˆé˜¶æ®µ1ï¼‰
        updateProgress('llm', 0, true);

        // å¼€å§‹è½®è¯¢æ—¥å¿—ä»¥æ›´æ–°è¿›åº¦
        startLogPolling();

        // æäº¤ä»»åŠ¡ï¼ˆç«‹å³è¿”å›ï¼‰
        const res = await fetch(`${FASTAPI_URL}/generate_video`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ text, character, model_name: model })
        });

        if (!res.ok) throw new Error(`HTTP ${res.status}`);

        const data = await res.json();
        if (!data.success) {
          stopLogPolling();
          throw new Error(data.error || "ä»»åŠ¡æäº¤å¤±è´¥");
        }

        // ä¿å­˜ä»»åŠ¡ID
        currentTaskId = data.unique_id;

        // å¼€å§‹è½®è¯¢ä»»åŠ¡çŠ¶æ€
        startTaskStatusPolling(currentTaskId);

        setStatus(`ğŸ“‹ ä»»åŠ¡å·²æäº¤ (ID: ${currentTaskId.substring(0, 8)}...)`);
        showToast("ä»»åŠ¡å·²æäº¤ï¼Œæ­£åœ¨åå°ç”Ÿæˆä¸­...", "info");

      } catch (e) {
        // åœæ­¢æ—¥å¿—è½®è¯¢
        stopLogPolling();
        const errorMsg = e.message || String(e);
        setStatus("âŒ ä»»åŠ¡æäº¤å¤±è´¥ï¼š" + errorMsg);
        showError("ä»»åŠ¡æäº¤å¤±è´¥", errorMsg);
        resetProgress();

        // æ¢å¤è¾“å…¥
        setInputsDisabled(false);
        setRunButtonState(false);  // æŒ‰é’®æ¢å¤ä¸ºå¼€å§‹ç”Ÿæˆ
        currentTaskId = null;
      }
    }

    function initHelp() {
      const btn = document.getElementById("helpBtn");
      btn.addEventListener("click", () => {
        alert("ä½¿ç”¨æç¤ºï¼š\\n1) è¾“å…¥æ–‡æœ¬ï¼Œé€‰æ‹©è§’è‰²ä¸æ¨¡å‹ã€‚\\n2) ç‚¹å‡»\"å¼€å§‹ç”Ÿæˆè§†é¢‘\"ã€‚\\n3) ç”Ÿæˆåè§†é¢‘è‡ªåŠ¨è½¬ç  H.264 å¹¶åœ¨å³ä¾§å±•ç¤ºã€‚\\nå¦‚éœ€è¿”å›é¦–é¡µï¼Œç‚¹å‡»å·¦ä¸Šè§’è¿”å›æŒ‰é’®ã€‚");
      });
    }

    // åˆå§‹åŒ–è§†é¢‘æ“ä½œæŒ‰é’®
    function initVideoControls() {
      const video = document.getElementById("videoOutput");
      const downloadBtn = document.getElementById("downloadBtn");
      const fullscreenBtn = document.getElementById("fullscreenBtn");
      const playbackSpeed = document.getElementById("playbackSpeed");
      const volumeControl = document.getElementById("volumeControl");
      const volumeValue = document.getElementById("volumeValue");

      // ä¸‹è½½æŒ‰é’®
      downloadBtn.addEventListener("click", () => {
        if (!video.src) {
          showToast("è§†é¢‘æœªåŠ è½½", "error");
          return;
        }
        const a = document.createElement("a");
        a.href = video.src;
        a.download = `nerffacespeech_${Date.now()}.mp4`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        showToast("è§†é¢‘ä¸‹è½½å·²å¼€å§‹", "success");
      });

      // å…¨å±æŒ‰é’® - ä¿®å¤å…¨å±åŠŸèƒ½
      fullscreenBtn.addEventListener("click", () => {
        if (!video.src) {
          showToast("è§†é¢‘æœªåŠ è½½", "error");
          return;
        }

        // å°è¯•ä½¿ç”¨æ ‡å‡†å…¨å±API
        if (video.requestFullscreen) {
          video.requestFullscreen().catch(err => {
            console.error('å…¨å±è¯·æ±‚å¤±è´¥:', err);
            showToast("æ— æ³•è¿›å…¥å…¨å±æ¨¡å¼", "error");
          });
        } else if (video.webkitRequestFullscreen) {
          // Safari/Chrome (æ—§ç‰ˆ)
          video.webkitRequestFullscreen();
        } else if (video.webkitEnterFullscreen) {
          // iOS Safari
          video.webkitEnterFullscreen();
        } else if (video.mozRequestFullScreen) {
          // Firefox (æ—§ç‰ˆ)
          video.mozRequestFullScreen();
        } else if (video.msRequestFullscreen) {
          // IE/Edge (æ—§ç‰ˆ)
          video.msRequestFullscreen();
        } else {
          // å¦‚æœæµè§ˆå™¨ä¸æ”¯æŒå…¨å±APIï¼Œå°è¯•ä½¿ç”¨videoå…ƒç´ çš„çˆ¶å®¹å™¨
          const videoFrame = video.closest('.video-frame');
          if (videoFrame && videoFrame.requestFullscreen) {
            videoFrame.requestFullscreen().catch(err => {
              console.error('å…¨å±è¯·æ±‚å¤±è´¥:', err);
              showToast("æ— æ³•è¿›å…¥å…¨å±æ¨¡å¼", "error");
            });
          } else {
            showToast("æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒå…¨å±åŠŸèƒ½", "warning");
          }
        }
      });

      // æ’­æ”¾é€Ÿåº¦æ§åˆ¶
      playbackSpeed.addEventListener("change", (e) => {
        if (video.src) {
          video.playbackRate = parseFloat(e.target.value);
        }
      });

      // éŸ³é‡æ§åˆ¶
      if (volumeControl && volumeValue) {
        // åˆå§‹åŒ–éŸ³é‡æ˜¾ç¤º
        volumeControl.value = video.volume || 1;
        volumeValue.textContent = Math.round((video.volume || 1) * 100) + '%';

        // éŸ³é‡å˜åŒ–äº‹ä»¶
        volumeControl.addEventListener("input", (e) => {
          const volume = parseFloat(e.target.value);
          video.volume = volume;
          volumeValue.textContent = Math.round(volume * 100) + '%';

          // æ›´æ–°éŸ³é‡å›¾æ ‡
          const label = volumeControl.previousElementSibling;
          if (label) {
            if (volume === 0) {
              label.textContent = 'ğŸ”‡';
            } else if (volume < 0.5) {
              label.textContent = 'ğŸ”‰';
            } else {
              label.textContent = 'ğŸ”Š';
            }
          }
        });

        // åŒæ­¥è§†é¢‘å…ƒç´ çš„éŸ³é‡å˜åŒ–ï¼ˆå¦‚æœç”¨æˆ·é€šè¿‡æµè§ˆå™¨æ§ä»¶è°ƒæ•´ï¼‰
        video.addEventListener("volumechange", () => {
          volumeControl.value = video.volume;
          volumeValue.textContent = Math.round(video.volume * 100) + '%';
          const label = volumeControl.previousElementSibling;
          if (label) {
            if (video.volume === 0) {
              label.textContent = 'ğŸ”‡';
            } else if (video.volume < 0.5) {
              label.textContent = 'ğŸ”‰';
            } else {
              label.textContent = 'ğŸ”Š';
            }
          }
        });
      }

      // æ·»åŠ è§†é¢‘é”™è¯¯å¤„ç†
      video.addEventListener('error', (e) => {
        console.error('========================================');
        console.error('âŒ è§†é¢‘æ’­æ”¾é”™è¯¯ (erroräº‹ä»¶)');
        console.error('========================================');
        console.error('è§†é¢‘URL:', video.src);
        console.error('è§†é¢‘readyState:', video.readyState, '(', getReadyStateName(video.readyState), ')');
        console.error('è§†é¢‘networkState:', video.networkState, '(', getNetworkStateName(video.networkState), ')');
        console.error('è§†é¢‘å°ºå¯¸:', video.videoWidth, 'Ã—', video.videoHeight);
        console.error('è§†é¢‘æ—¶é•¿:', video.duration);

        // å¼ºåˆ¶æ˜¾ç¤ºè¯Šæ–­ä¿¡æ¯
        document.getElementById("videoDiagnostics").style.display = "block";
        updateDiagnostics();

        if (video.error) {
          console.error('é”™è¯¯å¯¹è±¡:', video.error);
          console.error('é”™è¯¯ä»£ç :', video.error.code);
          console.error('é”™è¯¯æ¶ˆæ¯:', video.error.message);

          let errorMsg = 'è§†é¢‘åŠ è½½å¤±è´¥';
          let errorDetails = '';
          switch (video.error.code) {
            case video.error.MEDIA_ERR_ABORTED:
              errorMsg = 'è§†é¢‘åŠ è½½è¢«ä¸­æ­¢';
              errorDetails = 'ç”¨æˆ·ä¸­æ­¢äº†è§†é¢‘åŠ è½½ï¼Œæˆ–æµè§ˆå™¨å–æ¶ˆäº†è¯·æ±‚';
              break;
            case video.error.MEDIA_ERR_NETWORK:
              errorMsg = 'ç½‘ç»œé”™è¯¯ï¼Œæ— æ³•åŠ è½½è§†é¢‘';
              errorDetails = `URL: ${video.src}\nè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥å’Œè§†é¢‘æ–‡ä»¶æ˜¯å¦å­˜åœ¨`;
              break;
            case video.error.MEDIA_ERR_DECODE:
              errorMsg = 'è§†é¢‘è§£ç å¤±è´¥';
              errorDetails = 'å¯èƒ½æ˜¯è§†é¢‘æ–‡ä»¶æŸåã€ç¼–ç æ ¼å¼ä¸æ”¯æŒï¼Œæˆ–æµè§ˆå™¨æ— æ³•è§£ç è¯¥æ ¼å¼';
              break;
            case video.error.MEDIA_ERR_SRC_NOT_SUPPORTED:
              errorMsg = 'è§†é¢‘æ ¼å¼ä¸æ”¯æŒæˆ–æ–‡ä»¶ä¸å­˜åœ¨';
              errorDetails = `URL: ${video.src}\nè¯·æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨ï¼Œä»¥åŠæµè§ˆå™¨æ˜¯å¦æ”¯æŒè¯¥è§†é¢‘æ ¼å¼`;
              break;
            default:
              errorMsg = `è§†é¢‘åŠ è½½å¤±è´¥ (é”™è¯¯ä»£ç : ${video.error.code})`;
              errorDetails = `æœªçŸ¥é”™è¯¯ä»£ç : ${video.error.code}`;
          }
          console.error('é”™è¯¯ä¿¡æ¯:', errorMsg);
          console.error('é”™è¯¯è¯¦æƒ…:', errorDetails);
          showError(errorMsg, errorDetails);

          // å†æ¬¡å°è¯•æ£€æŸ¥æ–‡ä»¶
          if (video.src) {
            console.log('å°è¯•é€šè¿‡fetchæ£€æŸ¥è§†é¢‘æ–‡ä»¶...');
            fetch(video.src, { method: 'HEAD' })
              .then(response => {
                console.log('HEADè¯·æ±‚ç»“æœ:', response.status, response.statusText);
                console.log('Content-Type:', response.headers.get('Content-Type'));
                if (!response.ok) {
                  console.error('æ–‡ä»¶æ— æ³•è®¿é—®:', response.status, response.statusText);
                }
              })
              .catch(err => {
                console.error('HEADè¯·æ±‚å¤±è´¥ï¼Œå°è¯•GETè¯·æ±‚:', err);
                return fetch(video.src, { method: 'GET', headers: { 'Range': 'bytes=0-0' } })
                  .then(response => {
                    console.log('GETè¯·æ±‚ç»“æœ:', response.status, response.statusText);
                    console.log('Content-Type:', response.headers.get('Content-Type'));
                  })
                  .catch(err2 => {
                    console.error('æ‰€æœ‰æ£€æŸ¥è¯·æ±‚éƒ½å¤±è´¥:', err2);
                  });
              });
          }
        } else {
          console.error('è§†é¢‘é”™è¯¯å¯¹è±¡ä¸ºç©ºï¼Œä½†è§¦å‘äº†erroräº‹ä»¶');
          showError('è§†é¢‘åŠ è½½å¤±è´¥', 'é”™è¯¯å¯¹è±¡ä¸ºç©ºï¼Œå¯èƒ½æ˜¯æµè§ˆå™¨å…¼å®¹æ€§é—®é¢˜');
        }
        console.error('========================================');
      });

      // ç›‘å¬è§†é¢‘åŠ è½½è¿‡ç¨‹
      video.addEventListener('loadstart', () => {
        console.log('å¼€å§‹åŠ è½½è§†é¢‘:', video.src);
      });

      video.addEventListener('progress', () => {
        if (video.buffered.length > 0) {
          const bufferedEnd = video.buffered.end(video.buffered.length - 1);
          const duration = video.duration;
          if (duration > 0) {
            console.log(`è§†é¢‘åŠ è½½è¿›åº¦: ${(bufferedEnd / duration * 100).toFixed(1)}%`);
          }
        }
      });
    }

    // åˆå§‹åŒ–é”™è¯¯æ¨¡æ€æ¡†
    function initErrorModal() {
      const modal = document.getElementById("errorModal");
      const closeBtn = document.getElementById("errorClose");
      const confirmBtn = document.getElementById("errorConfirm");
      const retryBtn = document.getElementById("errorRetry");
      const toggleBtn = document.getElementById("toggleErrorDetails");
      const detailsEl = document.getElementById("errorDetails");

      closeBtn.addEventListener("click", () => {
        modal.classList.remove("active");
      });

      confirmBtn.addEventListener("click", () => {
        modal.classList.remove("active");
      });

      retryBtn.addEventListener("click", () => {
        modal.classList.remove("active");
        runPipeline();
      });

      toggleBtn.addEventListener("click", () => {
        const isActive = detailsEl.classList.contains("active");
        detailsEl.classList.toggle("active");
        toggleBtn.textContent = isActive ? "æ˜¾ç¤ºè¯¦æƒ…" : "éšè—è¯¦æƒ…";
      });

      modal.addEventListener("click", (e) => {
        if (e.target === modal) {
          modal.classList.remove("active");
        }
      });
    }

    // ç»ˆæ­¢ä»»åŠ¡åŠŸèƒ½
    async function cancelCurrentTask() {
      if (!currentTaskId) {
        showToast("æ²¡æœ‰æ­£åœ¨è¿è¡Œçš„ä»»åŠ¡", "warning");
        return;
      }

      if (!confirm("ç¡®å®šè¦ç»ˆæ­¢å½“å‰ä»»åŠ¡å—ï¼Ÿ")) {
        return;
      }

      try {
        const response = await fetch(`${FASTAPI_URL}/generate_video/cancel/${currentTaskId}`, {
          method: "POST"
        });

        const data = await response.json();
        if (data.success) {
          // åœæ­¢è½®è¯¢
          if (taskStatusPollInterval) {
            clearInterval(taskStatusPollInterval);
            taskStatusPollInterval = null;
          }
          stopLogPolling();

          // æ¢å¤UI
          setInputsDisabled(false);
          setRunButtonState(false);  // æŒ‰é’®æ¢å¤ä¸ºå¼€å§‹ç”Ÿæˆ
          resetProgress();
          currentTaskId = null;

          setStatus("âŒ ä»»åŠ¡å·²ç»ˆæ­¢");
          showToast("ä»»åŠ¡å·²ç»ˆæ­¢", "info");
        } else {
          showToast("ç»ˆæ­¢ä»»åŠ¡å¤±è´¥: " + (data.error || "æœªçŸ¥é”™è¯¯"), "error");
        }
      } catch (error) {
        console.error("ç»ˆæ­¢ä»»åŠ¡å¤±è´¥:", error);
        showToast("ç»ˆæ­¢ä»»åŠ¡å¤±è´¥: " + error.message, "error");
      }
    }

    // åˆå§‹åŒ–æŒ‰é’®ç‚¹å‡»é€»è¾‘
    function initCancelButton() {
      // runBtnæ ¹æ®çŠ¶æ€æ‰§è¡Œä¸åŒæ“ä½œ
      runBtn.addEventListener("click", () => {
        const isRunning = runBtn.dataset.isRunning === "true";
        if (isRunning) {
          // ä»»åŠ¡è¿è¡Œä¸­ï¼Œç‚¹å‡»åˆ™ç»ˆæ­¢ä»»åŠ¡
          cancelCurrentTask();
        } else {
          // ä»»åŠ¡æœªè¿è¡Œï¼Œç‚¹å‡»åˆ™å¼€å§‹ç”Ÿæˆ
          runPipeline();
        }
      });
    }

    // ç­‰å¾…DOMåŠ è½½å®Œæˆåå†åˆå§‹åŒ–è®¾ç½®äº‹ä»¶ç»‘å®š
    document.addEventListener('DOMContentLoaded', async () => {
      // åº”ç”¨è®¾ç½®ï¼ˆä»æ•°æ®åº“è¯»å–ï¼‰- ä¼˜åŒ–ï¼šåªè°ƒç”¨ä¸€æ¬¡APIï¼Œç„¶åå¹¶è¡Œæ›´æ–°UI
      try {
        // åªè°ƒç”¨ä¸€æ¬¡ fetchSettings()ï¼Œè·å–æ‰€æœ‰è®¾ç½®
        const settings = await fetchSettings();

        // å¹¶è¡Œåº”ç”¨è®¾ç½®å’Œæ›´æ–°é€‰æ‹©çŠ¶æ€ï¼ˆä½¿ç”¨å·²è·å–çš„è®¾ç½®ï¼Œé¿å…é‡å¤APIè°ƒç”¨ï¼‰
        await Promise.all([
          applySettingsOnly(settings),
          updateThemeSelection(settings),
          updateFontSelection(settings),
          updateFontSizeSelection(settings)
        ]);
      } catch (error) {
        console.error('åº”ç”¨è®¾ç½®å¤±è´¥:', error);
      }

      // ä¾§è¾¹æ æ§åˆ¶ - ç¡®ä¿è®¾ç½®æŒ‰é’®åŠŸèƒ½æ­£å¸¸
      const settingsBtn = document.getElementById('settingsBtn');
      const settingsSidebar = document.getElementById('settingsSidebar');
      const sidebarOverlay = document.getElementById('sidebarOverlay');
      const sidebarClose = document.getElementById('sidebarClose');

      if (!settingsBtn) {
        console.error('è®¾ç½®æŒ‰é’®æœªæ‰¾åˆ°');
      }
      if (!settingsSidebar) {
        console.error('è®¾ç½®ä¾§è¾¹æ æœªæ‰¾åˆ°');
      }

      function openSidebar() {
        if (!settingsSidebar || !sidebarOverlay) {
          console.error('æ— æ³•æ‰“å¼€ä¾§è¾¹æ ï¼šå…ƒç´ æœªæ‰¾åˆ°');
          return;
        }
        settingsSidebar.classList.add('active');
        sidebarOverlay.classList.add('active');
        document.body.style.overflow = 'hidden';
      }

      function closeSidebar() {
        if (!settingsSidebar || !sidebarOverlay) {
          return;
        }
        settingsSidebar.classList.remove('active');
        sidebarOverlay.classList.remove('active');
        document.body.style.overflow = '';
      }

      // ç»‘å®šè®¾ç½®æŒ‰é’®äº‹ä»¶
      if (settingsBtn) {
        settingsBtn.addEventListener('click', (e) => {
          e.preventDefault();
          e.stopPropagation();
          console.log('è®¾ç½®æŒ‰é’®è¢«ç‚¹å‡»');
          openSidebar();
        });
      } else {
        console.error('è®¾ç½®æŒ‰é’®ä¸å­˜åœ¨ï¼Œæ— æ³•ç»‘å®šäº‹ä»¶');
      }

      // ç»‘å®šå…³é—­æŒ‰é’®äº‹ä»¶
      if (sidebarClose) {
        sidebarClose.addEventListener('click', closeSidebar);
      }

      // ç»‘å®šé®ç½©ç‚¹å‡»äº‹ä»¶
      if (sidebarOverlay) {
        sidebarOverlay.addEventListener('click', closeSidebar);
      }

      // åˆ†é¡µåˆ‡æ¢
      document.querySelectorAll('.sidebar-tab').forEach(tab => {
        tab.addEventListener('click', () => {
          const targetTab = tab.dataset.tab;
          document.querySelectorAll('.sidebar-tab').forEach(t => t.classList.remove('active'));
          document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
          tab.classList.add('active');
          const targetContent = document.getElementById(targetTab + 'Tab');
          if (targetContent) targetContent.classList.add('active');
        });
      });

      // ä¸»é¢˜é€‰æ‹©
      document.querySelectorAll('[data-theme]').forEach(card => {
        card.addEventListener('click', () => {
          applyTheme(card.dataset.theme);
        });
      });

      // å­—ä½“é€‰æ‹©
      document.querySelectorAll('[data-font]').forEach(card => {
        card.addEventListener('click', () => {
          applyFont(card.dataset.font);
        });
      });

      // å­—å·é€‰æ‹©
      document.querySelectorAll('[data-size]').forEach(btn => {
        btn.addEventListener('click', () => {
          applyFontSize(btn.dataset.size);
        });
      });

      // è‡ªå®šä¹‰å­—å·è¾“å…¥
      const customSizeValue = document.getElementById('customSizeValue');
      if (customSizeValue) {
        customSizeValue.addEventListener('change', (e) => {
          if (customSizeValue.value) {
            applyFontSize('custom');
          }
        });
      }
    });

    refreshBtn.addEventListener("click", loadModels);
    // å†å²è®°å½•æŒ‰é’®å’Œä¸‹æ‹‰èœå•
    const historyBtn = document.getElementById("historyBtn");
    const historyDropdown = document.getElementById("historyDropdown");
    if (historyBtn && historyDropdown) {
      historyBtn.addEventListener("click", (e) => {
        e.stopPropagation();
        // åˆ‡æ¢ä¸‹æ‹‰èœå•æ˜¾ç¤º
        if (historyDropdown.style.display === "none" || !historyDropdown.style.display) {
          historyDropdown.style.display = "block";
          // å¦‚æœåˆ—è¡¨ä¸ºç©ºï¼ŒåŠ è½½å†å²è®°å½•
          const historyList = document.getElementById("historyList");
          if (!historyList.innerHTML || historyList.innerHTML.trim() === '') {
            loadHistory();
          }
        } else {
          historyDropdown.style.display = "none";
        }
      });

      // ç‚¹å‡»é¡µé¢å…¶ä»–åœ°æ–¹æ—¶å…³é—­ä¸‹æ‹‰èœå•
      document.addEventListener("click", (e) => {
        if (!historyBtn.contains(e.target) && !historyDropdown.contains(e.target)) {
          historyDropdown.style.display = "none";
        }
      });
    }
    initCancelButton(); // è¿™ä¸ªå‡½æ•°å†…éƒ¨å·²ç»å¤„ç†äº† runBtn çš„ç‚¹å‡»äº‹ä»¶ï¼ŒåŒ…æ‹¬ç”Ÿæˆå’Œå–æ¶ˆ
    initHelp();
    initVideoControls();
    initErrorModal();
    // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥æ˜¯å¦æœ‰æ­£åœ¨è¿è¡Œçš„ä»»åŠ¡
    async function checkRunningTasks() {
      try {
        // ä½¿ç”¨æ–°çš„APIç«¯ç‚¹æ£€æŸ¥æ˜¯å¦æœ‰æ­£åœ¨è¿è¡Œçš„ä»»åŠ¡
        const response = await fetch(`${FASTAPI_URL}/generate_video/running`);
        if (!response.ok) {
          const errorMsg = `æ£€æŸ¥è¿è¡Œä»»åŠ¡å¤±è´¥: HTTP ${response.status}`;
          console.error(errorMsg);
          setStatus(`âš ï¸ ${errorMsg}`);
          showToast(errorMsg, "error");
          return false;
        }

        const data = await response.json();
        if (!data.success) {
          const errorMsg = data.error || "æ£€æŸ¥è¿è¡Œä»»åŠ¡å¤±è´¥";
          console.error(errorMsg);
          setStatus(`âš ï¸ ${errorMsg}`);
          showToast(errorMsg, "error");
          return false;
        }

        if (data.data) {
          const task = data.data;
          // æœ‰ä»»åŠ¡æ­£åœ¨è¿è¡Œï¼Œæ¢å¤ä»»åŠ¡çŠ¶æ€
          currentTaskId = task.unique_id;
          setInputsDisabled(true);  // ç¦ç”¨è¾“å…¥
          setRunButtonState(true);  // æŒ‰é’®å˜ä¸ºç»ˆæ­¢ä»»åŠ¡
          updateTaskConfig(task);  // æ¢å¤ä»»åŠ¡é…ç½®æ˜¾ç¤º
          updateProgress('llm', 0, true);
          startLogPolling();  // å¼€å§‹è½®è¯¢æ—¥å¿—
          startTaskStatusPolling(currentTaskId);  // å¼€å§‹è½®è¯¢ä»»åŠ¡çŠ¶æ€
          setStatus(`ğŸ“‹ æ£€æµ‹åˆ°æ­£åœ¨è¿è¡Œçš„ä»»åŠ¡ (ID: ${currentTaskId.substring(0, 8)}...)`);
          return true;  // è¿”å›trueè¡¨ç¤ºæœ‰æ­£åœ¨è¿è¡Œçš„ä»»åŠ¡
        }

        return false;  // è¿”å›falseè¡¨ç¤ºæ²¡æœ‰æ­£åœ¨è¿è¡Œçš„ä»»åŠ¡
      } catch (e) {
        const errorMsg = `æ£€æŸ¥è¿è¡Œä»»åŠ¡å‡ºé”™: ${e.message || String(e)}`;
        console.error(errorMsg, e);
        setStatus(`âš ï¸ ${errorMsg}`);
        showToast(errorMsg, "error");
        return false;
      }
    }

    // æ£€æŸ¥æ˜¯å¦æ˜¯å†å²è®°å½•è¯¦æƒ…é¡µ
    const urlParams = new URLSearchParams(window.location.search);
    const recordId = urlParams.get('record_id');

    if (recordId) {
      // å†å²è®°å½•è¯¦æƒ…é¡µæ¨¡å¼ï¼šç¦ç”¨æ‰€æœ‰è¾“å…¥ï¼ŒåŠ è½½æŒ‡å®šè®°å½•
      setInputsDisabled(true);
      runBtn.style.display = "none"; // éšè—ç”ŸæˆæŒ‰é’®

      // éšè—å†å²è®°å½•æŒ‰é’®åŒºåŸŸï¼ˆè¯¦æƒ…é¡µä¸éœ€è¦ï¼‰
      const historyBtnContainer = document.querySelector('[id="historyBtn"]')?.parentElement?.parentElement;
      if (historyBtnContainer) {
        historyBtnContainer.style.display = "none";
      }

      // åŠ è½½å†å²è®°å½•è¯¦æƒ…
      (async () => {
        try {
          const response = await fetch(`${FASTAPI_URL}/generation_records/${recordId}`);
          if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
          }
          const data = await response.json();
          if (!data.success || !data.data) {
            throw new Error(data.error || "è®°å½•ä¸å­˜åœ¨");
          }

          const record = data.data;

          // è®¾ç½®é…ç½®æ˜¾ç¤ºï¼ˆåªè¯»ï¼‰
          if (record.text) {
            document.getElementById("textInput").value = record.text;
          }
          if (record.character) {
            document.getElementById("characterInput").value = record.character;
          }
          if (record.model_name) {
            modelsSelect.value = record.model_name;
          }

          // åŠ è½½è§†é¢‘ï¼ˆä»video_pathæ„é€ URLï¼‰
          const videoUrl = getVideoUrlFromPath(record.video_path);
          if (videoUrl) {
            const date = record.created_at ? new Date(record.created_at).toLocaleString('zh-CN') : new Date().toLocaleString('zh-CN');
            const params = {
              text: record.text || '',
              character: record.character || '',
              model: record.model_name || '',
              date: date,
              generation_time: record.generation_time,
              unique_id: record.unique_id,
              audio_url: getAudioUrlFromPath(record.audio_path),
              text_url: getTextUrlFromPath(record.text_path)
            };
            loadVideo(videoUrl, params);
            setStatus(`ğŸ“‹ å†å²è®°å½•è¯¦æƒ… - ${date}`);
          } else {
            setStatus("âš ï¸ è¯¥è®°å½•æ²¡æœ‰è§†é¢‘æˆ–è§†é¢‘è·¯å¾„æ— æ•ˆ");
            showToast("è§†é¢‘è·¯å¾„æ— æ•ˆæˆ–ä¸å­˜åœ¨", "error");
          }
        } catch (error) {
          const errorMsg = `åŠ è½½å†å²è®°å½•å¤±è´¥: ${error.message || String(error)}`;
          console.error(errorMsg, error);
          setStatus(`âŒ ${errorMsg}`);
          showToast(errorMsg, "error");
        }
      })();

      // ä¸åŠ è½½å†å²è®°å½•åˆ—è¡¨ï¼ˆè¯¦æƒ…é¡µä¸éœ€è¦æ˜¾ç¤ºåˆ—è¡¨ï¼‰
    } else {
      // æ­£å¸¸æ¨¡å¼ï¼šåŠ è½½å†å²è®°å½•å’Œæ¨¡å‹åˆ—è¡¨
      loadHistory(); // ä»æ•°æ®åº“åŠ è½½å†å²è®°å½•ï¼ˆä¼šè‡ªåŠ¨æ˜¾ç¤ºæœ€æ–°è§†é¢‘ï¼‰
      loadModels();

      // æ£€æŸ¥æ˜¯å¦æœ‰æ­£åœ¨è¿è¡Œçš„ä»»åŠ¡ï¼ˆå¿…é¡»åœ¨å…¶ä»–åˆå§‹åŒ–ä¹‹åï¼‰
      checkRunningTasks().then(hasRunningTask => {
        if (!hasRunningTask) {
          // å¦‚æœæ²¡æœ‰æ­£åœ¨è¿è¡Œçš„ä»»åŠ¡ï¼Œç¡®ä¿è¾“å…¥æ˜¯å¯ç”¨çš„
          setInputsDisabled(false);
        }
      });
    }
  </script>
</body>

</html>