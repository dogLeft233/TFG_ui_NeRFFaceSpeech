<!doctype html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>äººæœºå¯¹è¯ - NeRFFaceSpeech</title>
  <style>
    :root {
      --primary: #1e40af;
      /* ä¸»è‰²è°ƒï¼šæ·±è“è‰²ï¼Œç”¨äºé€‰ä¸­çŠ¶æ€ã€å¼ºè°ƒæŒ‰é’® */
      --primary-2: #3b82f6;
      /* æ¬¡è¦ä¸»è‰²ï¼šä¸­é—´è“è‰²ï¼Œç”¨äºæ¸å˜ã€æ¬¡è¦å¼ºè°ƒ */
      --bg: #0b1020;
      /* é¡µé¢èƒŒæ™¯è‰²ï¼šæ·±è‰²èƒŒæ™¯ */
      --card: rgba(255, 255, 255, 0.06);
      /* å¡ç‰‡èƒŒæ™¯ï¼šåŠé€æ˜ç™½è‰²ï¼Œç”¨äºå†…å®¹å¡ç‰‡ */
      --border: rgba(255, 255, 255, 0.14);
      /* è¾¹æ¡†é¢œè‰²ï¼šåŠé€æ˜ç™½è‰²è¾¹æ¡† */
      --text: #e5e7eb;
      /* ä¸»æ–‡å­—é¢œè‰²ï¼šæµ…ç°è‰²æ–‡å­— */
      --muted: #9ca3af;
      /* æ¬¡è¦æ–‡å­—é¢œè‰²ï¼šç°è‰²ï¼Œç”¨äºè¾…åŠ©ä¿¡æ¯ */
      --g1: rgba(59, 130, 246, 0.16);
      /* æ¸å˜1ï¼šè“è‰²æ¸å˜ç‚¹1 */
      --card-bg: rgba(59, 130, 246, 0.25);
      /* å¡ç‰‡èƒŒæ™¯è‰²ï¼šæµ…è“è‰²ï¼Œç”¨äºé¦–é¡µå¡ç‰‡å’Œä¸‹æ‹‰èœå• */
      --g2: rgba(14, 165, 233, 0.14);
      /* æ¸å˜2ï¼šé’è‰²æ¸å˜ç‚¹2 */
      --g3: rgba(56, 189, 248, 0.12);
      /* æ¸å˜3ï¼šæµ…è“è‰²æ¸å˜ç‚¹3 */
    }

    body.theme-tech {
      --primary: #1e40af;
      /* ä¸»è‰²è°ƒï¼šæ·±è“è‰² */
      --primary-2: #3b82f6;
      /* æ¬¡è¦ä¸»è‰²ï¼šä¸­é—´è“è‰² */
      --bg: #0b1020;
      /* é¡µé¢èƒŒæ™¯è‰²ï¼šæ·±è‰²èƒŒæ™¯ */
      --card: rgba(255, 255, 255, 0.06);
      /* å¡ç‰‡èƒŒæ™¯ï¼šåŠé€æ˜ç™½è‰² */
      --border: rgba(255, 255, 255, 0.14);
      /* è¾¹æ¡†é¢œè‰²ï¼šåŠé€æ˜ç™½è‰²è¾¹æ¡† */
      --text: #e5e7eb;
      /* ä¸»æ–‡å­—é¢œè‰²ï¼šæµ…ç°è‰²æ–‡å­— */
      --muted: #9ca3af;
      /* æ¬¡è¦æ–‡å­—é¢œè‰²ï¼šç°è‰² */
      --g1: rgba(59, 130, 246, 0.16);
      /* æ¸å˜1ï¼šè“è‰²æ¸å˜ç‚¹1 */
      --g2: rgba(14, 165, 233, 0.14);
      /* æ¸å˜2ï¼šé’è‰²æ¸å˜ç‚¹2 */
      --g3: rgba(56, 189, 248, 0.12);
      /* æ¸å˜3ï¼šæµ…è“è‰²æ¸å˜ç‚¹3 */
      --card-bg: rgba(59, 130, 246, 0.25);
      /* å¡ç‰‡èƒŒæ™¯è‰²ï¼šæµ…è“è‰² */
    }

    body.theme-warm {
      --primary: #f97316;
      /* ä¸»è‰²è°ƒï¼šæ©™è‰²ï¼Œç”¨äºé€‰ä¸­çŠ¶æ€ã€å¼ºè°ƒæŒ‰é’® */
      --primary-2: #ea580c;
      /* æ¬¡è¦ä¸»è‰²ï¼šæ·±æ©™è‰²ï¼Œç”¨äºæ¸å˜ã€æ¬¡è¦å¼ºè°ƒ */
      --bg: #fff8f0;
      /* é¡µé¢èƒŒæ™¯è‰²ï¼šæµ…æš–è‰²èƒŒæ™¯ */
      --card: rgba(255, 255, 255, 0.9);
      /* å¡ç‰‡èƒŒæ™¯ï¼šåŠé€æ˜ç™½è‰² */
      --border: rgba(249, 115, 22, 0.2);
      /* è¾¹æ¡†é¢œè‰²ï¼šåŠé€æ˜æ©™è‰²è¾¹æ¡† */
      --text: #1f2937;
      /* ä¸»æ–‡å­—é¢œè‰²ï¼šæ·±ç°è‰²æ–‡å­— */
      --muted: #6b7280;
      /* æ¬¡è¦æ–‡å­—é¢œè‰²ï¼šç°è‰² */
      --g1: rgba(251, 191, 36, 0.15);
      /* æ¸å˜1ï¼šé»„è‰²æ¸å˜ç‚¹1 */
      --g2: rgba(249, 115, 22, 0.12);
      /* æ¸å˜2ï¼šæ©™è‰²æ¸å˜ç‚¹2 */
      --g3: rgba(234, 88, 12, 0.1);
      /* æ¸å˜3ï¼šæ·±æ©™è‰²æ¸å˜ç‚¹3 */
      --card-bg: rgba(251, 191, 36, 0.15);
      /* å¡ç‰‡èƒŒæ™¯è‰²ï¼šæµ…é»„è‰² */
    }

    body.theme-minimal {
      --primary: #6b7280;
      /* ä¸»è‰²è°ƒï¼šç°è‰²ï¼Œç”¨äºé€‰ä¸­çŠ¶æ€ã€å¼ºè°ƒæŒ‰é’® */
      --primary-2: #4b5563;
      /* æ¬¡è¦ä¸»è‰²ï¼šæ·±ç°è‰²ï¼Œç”¨äºæ¸å˜ã€æ¬¡è¦å¼ºè°ƒ */
      --bg: #f5f5f5;
      /* é¡µé¢èƒŒæ™¯è‰²ï¼šæµ…ç°è‰²èƒŒæ™¯ */
      --card: #ffffff;
      /* å¡ç‰‡èƒŒæ™¯ï¼šç™½è‰² */
      --border: #e5e7eb;
      /* è¾¹æ¡†é¢œè‰²ï¼šæµ…ç°è‰²è¾¹æ¡† */
      --text: #111827;
      /* ä¸»æ–‡å­—é¢œè‰²ï¼šæ·±è‰²æ–‡å­— */
      --muted: #6b7280;
      /* æ¬¡è¦æ–‡å­—é¢œè‰²ï¼šç°è‰² */
      --g1: rgba(107, 114, 128, 0.08);
      /* æ¸å˜1ï¼šç°è‰²æ¸å˜ç‚¹1 */
      --g2: rgba(75, 85, 99, 0.07);
      /* æ¸å˜2ï¼šæ·±ç°è‰²æ¸å˜ç‚¹2 */
      --g3: rgba(156, 163, 175, 0.06);
      /* æ¸å˜3ï¼šæµ…ç°è‰²æ¸å˜ç‚¹3 */
      --card-bg: rgba(107, 114, 128, 0.1);
      /* å¡ç‰‡èƒŒæ™¯è‰²ï¼šæµ…ç°è‰² */
    }

    * {
      box-sizing: border-box;
    }

    :root {
      --base-font-size: 14px;
      /* åŸºç¡€å­—å· */
    }

    html {
      font-size: var(--base-font-size);
    }

    body {
      margin: 0;
      font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      font-size: 1rem;
      /* ä½¿ç”¨remå•ä½ï¼ŒåŸºäºæ ¹å…ƒç´ å­—ä½“å¤§å° */
      background: radial-gradient(circle at 20% 20%, var(--g1), transparent 25%),
        radial-gradient(circle at 80% 30%, var(--g2), transparent 25%),
        radial-gradient(circle at 50% 80%, var(--g3), transparent 22%),
        var(--bg);
      color: var(--text);
      min-height: 100vh;
    }

    /* è®¾ç½®æŒ‰é’® */
    .settings-btn {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1000;
      padding: 10px 16px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: var(--card-bg);
      color: var(--text);
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .settings-btn:hover {
      background: var(--primary);
      color: #fff;
      border-color: var(--primary);
    }

    /* ä¾§è¾¹æ é®ç½© */
    .sidebar-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.4);
      z-index: 2000;
      transition: opacity 0.3s ease;
    }

    .sidebar-overlay.active {
      display: block;
    }

    /* ä¾§è¾¹æ  */
    .sidebar {
      position: fixed;
      top: 0;
      right: -400px;
      width: 400px;
      height: 100vh;
      background: var(--bg);
      border-left: 1px solid var(--border);
      z-index: 2001;
      transition: right 0.3s ease;
      overflow-y: auto;
      box-shadow: -4px 0 20px rgba(0, 0, 0, 0.2);
    }

    .sidebar.active {
      right: 0;
    }

    .sidebar-content {
      padding: 24px;
    }

    .sidebar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 16px;
      border-bottom: 1px solid var(--border);
    }

    .sidebar-header h2 {
      margin: 0;
      font-size: 20px;
      color: var(--text);
    }

    .sidebar-close {
      background: none;
      border: none;
      font-size: 28px;
      color: var(--muted);
      cursor: pointer;
      padding: 0;
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 8px;
      transition: all 0.2s ease;
    }

    .sidebar-close:hover {
      background: var(--card-bg);
      color: var(--text);
    }

    /* åˆ†é¡µæ ‡ç­¾ */
    .sidebar-tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 20px;
      border-bottom: 1px solid var(--border);
    }

    .sidebar-tab {
      padding: 10px 20px;
      background: none;
      border: none;
      border-bottom: 2px solid transparent;
      color: var(--muted);
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .sidebar-tab.active {
      color: var(--primary);
      border-bottom-color: var(--primary);
    }

    .sidebar-tab:hover {
      color: var(--text);
    }

    /* åˆ†é¡µå†…å®¹ */
    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    /* é€‰é¡¹ç½‘æ ¼ */
    .options-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 12px;
      margin-bottom: 20px;
    }

    .option-card {
      padding: 16px;
      border: 2px solid var(--border);
      border-radius: 12px;
      background: var(--card-bg);
      cursor: pointer;
      transition: all 0.2s ease;
      text-align: center;
    }

    .option-card:hover {
      border-color: var(--primary);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .option-card.selected {
      border-color: var(--primary);
      background: var(--primary);
      color: #fff;
    }

    .option-card.selected .option-name {
      color: #fff;
    }

    .option-name {
      font-size: 14px;
      font-weight: 500;
      color: var(--text);
      margin-bottom: 4px;
    }

    .option-desc {
      font-size: 12px;
      color: var(--muted);
    }

    .option-card.selected .option-desc {
      color: rgba(255, 255, 255, 0.9);
    }

    /* å­—å·é€‰æ‹© */
    .font-size-group {
      display: flex;
      gap: 8px;
      margin-bottom: 20px;
    }

    .font-size-btn {
      flex: 1;
      padding: 12px;
      border: 2px solid var(--border);
      border-radius: 10px;
      background: var(--card-bg);
      color: var(--text);
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .font-size-btn:hover {
      border-color: var(--primary);
    }

    .font-size-btn.selected {
      border-color: var(--primary);
      background: var(--primary);
      color: #fff;
    }

    .font-size-custom {
      margin-top: 16px;
    }

    .font-size-custom input {
      width: 100%;
      padding: 10px;
      border: 1px solid var(--border);
      border-radius: 8px;
      background: var(--card-bg);
      color: var(--text);
      font-size: 14px;
    }

    .page {
      max-width: 1400px;
      width: 94vw;
      margin: 0 auto;
      padding: 20px 24px 40px;
      min-height: 96vh;
    }

    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 16px;
    }

    h1 {
      margin: 0;
      font-size: 24px;
      letter-spacing: 0.4px;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 12px;
      background: rgba(59, 130, 246, 0.2);
      color: #c7d2fe;
      font-size: 12px;
      border: 1px solid rgba(96, 165, 250, 0.5);
    }

    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 18px;
      box-shadow: 0 12px 32px rgba(0, 0, 0, 0.25);
    }

    label {
      font-weight: 700;
      margin-bottom: 6px;
      display: block;
    }

    textarea {
      width: 100%;
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 12px 14px;
      font-size: 15px;
      background: rgba(255, 255, 255, 0.04);
      color: var(--text);
      outline: none;
      transition: border-color .15s ease, box-shadow .15s ease;
      min-height: 140px;
      resize: vertical;
    }

    textarea:focus {
      border-color: rgba(96, 165, 250, 0.8);
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.25);
    }

    button.primary {
      background: linear-gradient(135deg, var(--primary), var(--primary-2));
      border: 1px solid var(--primary-2);
      color: #fff;
      font-weight: 700;
      border-radius: 12px;
      padding: 12px 14px;
      cursor: pointer;
      width: 100%;
    }

    .log-box {
      background: #0f172a;
      color: #e2e8f0;
      padding: 12px;
      border-radius: 12px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      min-height: 120px;
      white-space: pre-wrap;
      word-break: break-all;
    }

    .help-btn {
      background: #fef3c7;
      color: #92400e;
      border: 1px solid #fcd34d;
      border-radius: 10px;
      padding: 8px 10px;
      cursor: pointer;
      font-weight: 600;
    }

    a {
      color: #bfdbfe;
      text-decoration: none;
    }

    footer {
      margin-top: 24px;
      padding: 12px;
      text-align: center;
      color: var(--muted);
      font-size: 13px;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
    }

    /* èŠå¤©ç•Œé¢æ ·å¼ */
    .chat-container {
      display: flex;
      flex-direction: column;
      height: calc(100vh - 200px);
      max-height: 800px;
      min-height: 600px;
    }

    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 16px;
      background: rgba(255, 255, 255, 0.02);
      border-radius: 12px;
      margin-bottom: 16px;
    }

    .message {
      display: flex;
      gap: 12px;
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .message.user {
      justify-content: flex-end;
    }

    .message.assistant {
      justify-content: flex-start;
    }

    .message-bubble {
      max-width: 70%;
      padding: 12px 16px;
      border-radius: 16px;
      word-wrap: break-word;
      position: relative;
    }

    .message.user .message-bubble {
      background: var(--primary);
      color: #fff;
      border-bottom-right-radius: 4px;
    }

    .message.assistant .message-bubble {
      background: var(--card);
      color: var(--text);
      border: 1px solid var(--border);
      border-bottom-left-radius: 4px;
    }

    .message-time {
      font-size: 11px;
      color: var(--muted);
      margin-top: 4px;
      text-align: right;
    }

    .message.assistant .message-time {
      text-align: left;
    }

    .message-audio {
      margin-top: 8px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .audio-player {
      flex: 1;
      height: 32px;
    }

    .audio-player audio {
      width: 100%;
      height: 32px;
    }

    .chat-input-area {
      display: flex;
      flex-direction: column;
      gap: 12px;
      padding: 16px;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
    }

    .input-row {
      display: flex;
      gap: 8px;
      align-items: flex-end;
    }

    .input-row textarea {
      flex: 1;
      min-height: 60px;
      max-height: 120px;
      resize: vertical;
    }

    .input-actions {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .icon-btn {
      width: 40px;
      height: 40px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: var(--card-bg);
      color: var(--text);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
      font-size: 18px;
    }

    .icon-btn:hover {
      background: var(--primary);
      color: #fff;
      border-color: var(--primary);
    }

    .icon-btn.recording {
      background: #ef4444;
      color: #fff;
      border-color: #ef4444;
      animation: pulse 1.5s infinite;
    }

    @keyframes pulse {

      0%,
      100% {
        opacity: 1;
      }

      50% {
        opacity: 0.7;
      }
    }

    .icon-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .volume-control {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 10px;
    }

    .volume-control input[type="range"] {
      width: 100px;
    }

    .volume-control.muted {
      opacity: 0.5;
    }

    .file-input-wrapper {
      position: relative;
      display: inline-block;
    }

    .file-input-wrapper input[type="file"] {
      position: absolute;
      opacity: 0;
      width: 0;
      height: 0;
    }

    .typing-indicator {
      display: flex;
      gap: 4px;
      padding: 12px 16px;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 16px;
      border-bottom-left-radius: 4px;
      max-width: 70px;
      position: relative;
    }

    .typing-indicator-wrapper {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .cancel-typing-btn {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      border: 1px solid var(--border);
      background: var(--card-bg);
      color: var(--text);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      transition: all 0.2s ease;
      flex-shrink: 0;
    }

    .cancel-typing-btn:hover {
      background: #ef4444;
      color: #fff;
      border-color: #ef4444;
    }

    .typing-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--muted);
      animation: typing 1.4s infinite;
    }

    .typing-dot:nth-child(2) {
      animation-delay: 0.2s;
    }

    .typing-dot:nth-child(3) {
      animation-delay: 0.4s;
    }

    @keyframes typing {

      0%,
      60%,
      100% {
        transform: translateY(0);
      }

      30% {
        transform: translateY(-10px);
      }
    }

    .empty-state {
      text-align: center;
      color: var(--muted);
      padding: 40px;
    }

    /* æ¶ˆæ¯çŠ¶æ€ */
    .message-status {
      font-size: 11px;
      color: var(--muted);
      margin-top: 4px;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .message.user .message-status {
      justify-content: flex-end;
    }

    .message-status.sending::before {
      content: "â³";
      animation: spin 1s linear infinite;
    }

    .message-status.sent::before {
      content: "âœ“";
    }

    .message-status.error::before {
      content: "âŒ";
    }

    @keyframes spin {
      from {
        transform: rotate(0deg);
      }

      to {
        transform: rotate(360deg);
      }
    }

    /* å¯¹è¯ç®¡ç†ä¾§è¾¹æ  */
    .chat-sidebar {
      position: fixed;
      left: -320px;
      top: 0;
      width: 320px;
      height: 100vh;
      background: var(--bg);
      border-right: 1px solid var(--border);
      z-index: 1500;
      transition: left 0.3s ease;
      display: flex;
      flex-direction: column;
      box-shadow: 4px 0 20px rgba(0, 0, 0, 0.2);
    }

    .chat-sidebar.active {
      left: 0;
    }

    .chat-sidebar-header {
      padding: 20px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .chat-sidebar-header h3 {
      margin: 0;
      font-size: 18px;
      color: var(--text);
    }

    .chat-sidebar-close {
      background: none;
      border: none;
      font-size: 24px;
      color: var(--muted);
      cursor: pointer;
      padding: 0;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 8px;
      transition: all 0.2s ease;
    }

    .chat-sidebar-close:hover {
      background: var(--card-bg);
      color: var(--text);
    }

    .chat-sidebar-content {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
    }

    .chat-sidebar-actions {
      padding: 16px;
      border-top: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .sidebar-btn {
      padding: 10px 16px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: var(--card-bg);
      color: var(--text);
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 14px;
      text-align: left;
    }

    .sidebar-btn:hover {
      background: var(--primary);
      color: #fff;
      border-color: var(--primary);
    }

    .sidebar-btn.danger:hover {
      background: #ef4444;
      border-color: #ef4444;
    }

    .history-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .history-item {
      padding: 12px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: var(--card-bg);
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .history-item:hover {
      background: var(--primary);
      color: #fff;
      border-color: var(--primary);
    }

    .history-item.active {
      background: var(--primary);
      color: #fff;
      border-color: var(--primary);
    }

    .history-item-title {
      font-weight: 500;
      margin-bottom: 4px;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 8px;
      flex: 1;
    }

    .history-item-title input {
      flex: 1;
      background: transparent;
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 4px 8px;
      color: var(--text);
      font-size: 14px;
      font-weight: 500;
      outline: none;
    }

    .history-item-title input:focus {
      border-color: var(--primary);
      background: var(--card-bg);
    }

    .history-item-edit {
      opacity: 0;
      transition: opacity 0.2s ease;
      cursor: pointer;
      padding: 2px 4px;
      border-radius: 4px;
      font-size: 12px;
    }

    .history-item:hover .history-item-edit {
      opacity: 1;
    }

    .history-item-edit:hover {
      background: rgba(255, 255, 255, 0.1);
    }

    .history-item-time {
      font-size: 11px;
      opacity: 0.7;
    }

    .retry-btn {
      margin-top: 8px;
      padding: 6px 12px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: var(--card-bg);
      color: var(--text);
      cursor: pointer;
      font-size: 12px;
      transition: all 0.2s ease;
    }

    .retry-btn:hover {
      background: var(--primary);
      color: #fff;
      border-color: var(--primary);
    }

    /* æµå¼è¾“å‡ºåŠ¨ç”» */
    .streaming-text {
      display: inline;
    }

    .streaming-cursor {
      display: inline-block;
      width: 2px;
      height: 1em;
      background: var(--primary);
      animation: blink 1s infinite;
      margin-left: 2px;
    }

    @keyframes blink {

      0%,
      50% {
        opacity: 1;
      }

      51%,
      100% {
        opacity: 0;
      }
    }

    /* å¯¹è¯ç®¡ç†æŒ‰é’® */
    .chat-manage-btn {
      position: fixed;
      top: 20px;
      left: 20px;
      z-index: 1000;
      padding: 10px 16px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: var(--card-bg);
      color: var(--text);
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .chat-manage-btn:hover {
      background: var(--primary);
      color: #fff;
      border-color: var(--primary);
    }
  </style>
  <script src="settings.js"></script>
</head>

<body>
  <button class="chat-manage-btn" id="chatManageBtn">ğŸ’¬ å¯¹è¯ç®¡ç†</button>
  <button class="settings-btn" id="settingsBtn">âš™ï¸ è®¾ç½®</button>

  <!-- å¯¹è¯ç®¡ç†ä¾§è¾¹æ  -->
  <div class="chat-sidebar" id="chatSidebar">
    <div class="chat-sidebar-header">
      <h3>å¯¹è¯ç®¡ç†</h3>
      <button class="chat-sidebar-close" id="chatSidebarClose">Ã—</button>
    </div>
    <div class="chat-sidebar-content">
      <div class="history-list" id="historyList">
        <div class="history-item active" data-id="current">
          <div class="history-item-title">å½“å‰å¯¹è¯</div>
          <div class="history-item-time">è¿›è¡Œä¸­</div>
        </div>
      </div>
    </div>
    <div class="chat-sidebar-actions">
      <button class="sidebar-btn" id="newChatBtn">â• æ–°å»ºå¯¹è¯</button>
      <button class="sidebar-btn" id="exportChatBtn">ğŸ“¥ å¯¼å‡ºå¯¹è¯è®°å½•</button>
      <button class="sidebar-btn danger" id="clearChatBtn">ğŸ—‘ï¸ æ¸…ç©ºå½“å‰å¯¹è¯</button>
    </div>
  </div>

  <!-- ä¾§è¾¹æ é®ç½© -->
  <div class="sidebar-overlay" id="sidebarOverlay"></div>

  <!-- è®¾ç½®ä¾§è¾¹æ  -->
  <div class="sidebar" id="settingsSidebar">
    <div class="sidebar-content">
      <div class="sidebar-header">
        <h2>è®¾ç½®</h2>
        <button class="sidebar-close" id="sidebarClose">Ã—</button>
      </div>

      <div class="sidebar-tabs">
        <button class="sidebar-tab active" data-tab="theme">ä¸»é¢˜</button>
        <button class="sidebar-tab" data-tab="font">å­—ä½“</button>
      </div>

      <!-- ä¸»é¢˜è®¾ç½® -->
      <div class="tab-content active" id="themeTab">
        <div class="options-grid">
          <div class="option-card" data-theme="tech">
            <div class="option-name">ç§‘æŠ€é£</div>
            <div class="option-desc">æ·±è“è‰²ç§‘æŠ€æ„Ÿ</div>
          </div>
          <div class="option-card" data-theme="warm">
            <div class="option-name">æ¸©é¦¨é£</div>
            <div class="option-desc">æš–è‰²è°ƒæ¸©é¦¨</div>
          </div>
          <div class="option-card" data-theme="minimal">
            <div class="option-name">ç®€çº¦é£</div>
            <div class="option-desc">ç°è‰²ç®€çº¦</div>
          </div>
        </div>
      </div>

      <!-- å­—ä½“è®¾ç½® -->
      <div class="tab-content" id="fontTab">
        <div style="margin-bottom: 16px;">
          <label style="display: block; margin-bottom: 8px; color: var(--text); font-weight: 500;">å­—ä½“æ ·å¼</label>
          <div class="options-grid">
            <div class="option-card" data-font="SimSun">
              <div class="option-name">å®‹ä½“</div>
              <div class="option-desc">SimSun</div>
            </div>
            <div class="option-card" data-font="SimHei">
              <div class="option-name">é»‘ä½“</div>
              <div class="option-desc">SimHei</div>
            </div>
            <div class="option-card" data-font="Microsoft YaHei">
              <div class="option-name">å¾®è½¯é›…é»‘</div>
              <div class="option-desc">Microsoft YaHei</div>
            </div>
            <div class="option-card" data-font="Arial">
              <div class="option-name">Arial</div>
              <div class="option-desc">Arial</div>
            </div>
            <div class="option-card" data-font="Times New Roman">
              <div class="option-name">Times New Roman</div>
              <div class="option-desc">Times New Roman</div>
            </div>
            <div class="option-card" data-font="Inter">
              <div class="option-name">Inter</div>
              <div class="option-desc">Interï¼ˆé»˜è®¤ï¼‰</div>
            </div>
          </div>
        </div>

        <div>
          <label style="display: block; margin-bottom: 8px; color: var(--text); font-weight: 500;">å­—å·å¤§å°</label>
          <div class="font-size-group">
            <button class="font-size-btn" data-size="small">å°</button>
            <button class="font-size-btn" data-size="medium">ä¸­</button>
            <button class="font-size-btn" data-size="large">å¤§</button>
            <button class="font-size-btn" data-size="custom">è‡ªå®šä¹‰</button>
          </div>
          <div class="font-size-custom" id="customSizeInput" style="display: none;">
            <input type="number" id="customSizeValue" placeholder="è¾“å…¥å­—å·ï¼ˆpxï¼‰" min="10" max="24" value="14">
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="page">
    <header>
      <div style="display:flex; align-items:center; gap:12px;">
        <h1>äººæœºå¯¹è¯</h1>
        <span class="pill">å®æ—¶å¯¹è¯ Â· LLM + TTS</span>
      </div>
      <div style="display:flex; gap:10px; max-width:320px;">
        <a href="./index.html"><button class="primary"
            style="background:#1f2937; border:1px solid #374151;">è¿”å›é¦–é¡µ</button></a>
        <button class="help-btn" id="helpBtn">â— å¸®åŠ©</button>
      </div>
    </header>

    <div class="card chat-container">
      <!-- èŠå¤©æ¶ˆæ¯åŒºåŸŸ -->
      <div class="chat-messages" id="chatMessages">
        <div class="empty-state">
          <p>ğŸ‘‹ å¼€å§‹å¯¹è¯å§ï¼è¾“å…¥æ–‡å­—æˆ–å½•åˆ¶è¯­éŸ³ä¸AIäº¤æµ</p>
        </div>
      </div>

      <!-- è¾“å…¥åŒºåŸŸ -->
      <div class="chat-input-area">
        <!-- éŸ³é‡æ§åˆ¶ -->
        <div class="volume-control" id="volumeControl">
          <button class="icon-btn" id="volumeBtn" title="éŸ³é‡æ§åˆ¶">ğŸ”Š</button>
          <input type="range" id="volumeSlider" min="0" max="100" value="50" style="width: 100px;">
          <span id="volumeValue">50%</span>
        </div>

        <!-- è¾“å…¥æ¡†å’ŒæŒ‰é’® -->
        <div class="input-row">
          <textarea id="chatInput" placeholder="è¾“å…¥æ¶ˆæ¯... (Shift+Enteræ¢è¡Œï¼ŒEnterå‘é€)"></textarea>
          <div class="input-actions">
            <!-- è¯­éŸ³å½•åˆ¶æŒ‰é’® -->
            <button class="icon-btn" id="recordBtn" title="å½•åˆ¶è¯­éŸ³">ğŸ¤</button>
            <!-- ä¸Šä¼ éŸ³é¢‘æŒ‰é’® -->
            <div class="file-input-wrapper">
              <input type="file" id="audioUpload" accept="audio/*">
              <button class="icon-btn" id="uploadBtn" title="ä¸Šä¼ éŸ³é¢‘æ–‡ä»¶">ğŸ“</button>
            </div>
            <!-- å‘é€æŒ‰é’® -->
            <button class="primary" id="sendBtn" style="width: auto; padding: 10px 20px;">å‘é€</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <footer>
    åŒ—äº¬ç†å·¥å¤§å­¦ Â· NeRFFaceSpeech å›¢é˜Ÿ
  </footer>

  <script>
    // ç­‰å¾…DOMåŠ è½½å®Œæˆåå†åˆå§‹åŒ–è®¾ç½®äº‹ä»¶ç»‘å®š
    document.addEventListener('DOMContentLoaded', async () => {
      // åº”ç”¨è®¾ç½®ï¼ˆä»æ•°æ®åº“è¯»å–ï¼‰- ä¼˜åŒ–ï¼šåªè°ƒç”¨ä¸€æ¬¡APIï¼Œç„¶åå¹¶è¡Œæ›´æ–°UI
      try {
        // åªè°ƒç”¨ä¸€æ¬¡ fetchSettings()ï¼Œè·å–æ‰€æœ‰è®¾ç½®
        const settings = await fetchSettings();

        // å¹¶è¡Œåº”ç”¨è®¾ç½®å’Œæ›´æ–°é€‰æ‹©çŠ¶æ€ï¼ˆä½¿ç”¨å·²è·å–çš„è®¾ç½®ï¼Œé¿å…é‡å¤APIè°ƒç”¨ï¼‰
        await Promise.all([
          applySettingsOnly(settings),
          updateThemeSelection(settings),
          updateFontSelection(settings),
          updateFontSizeSelection(settings)
        ]);
      } catch (error) {
        console.error('åº”ç”¨è®¾ç½®å¤±è´¥:', error);
      }

      // ä¾§è¾¹æ æ§åˆ¶
      const settingsBtn = document.getElementById('settingsBtn');
      const settingsSidebar = document.getElementById('settingsSidebar');
      const sidebarOverlay = document.getElementById('sidebarOverlay');
      const sidebarClose = document.getElementById('sidebarClose');

      if (!settingsBtn || !settingsSidebar) {
        console.error('è®¾ç½®æŒ‰é’®æˆ–ä¾§è¾¹æ å…ƒç´ æœªæ‰¾åˆ°', {
          settingsBtn: !!settingsBtn,
          settingsSidebar: !!settingsSidebar
        });
        return;
      }

      function openSidebar() {
        settingsSidebar.classList.add('active');
        sidebarOverlay.classList.add('active');
        document.body.style.overflow = 'hidden';
      }

      function closeSidebar() {
        settingsSidebar.classList.remove('active');
        sidebarOverlay.classList.remove('active');
        document.body.style.overflow = '';
      }

      settingsBtn.addEventListener('click', openSidebar);
      if (sidebarClose) sidebarClose.addEventListener('click', closeSidebar);
      if (sidebarOverlay) sidebarOverlay.addEventListener('click', closeSidebar);

      // åˆ†é¡µåˆ‡æ¢
      document.querySelectorAll('.sidebar-tab').forEach(tab => {
        tab.addEventListener('click', () => {
          const targetTab = tab.dataset.tab;
          document.querySelectorAll('.sidebar-tab').forEach(t => t.classList.remove('active'));
          document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
          tab.classList.add('active');
          const targetContent = document.getElementById(targetTab + 'Tab');
          if (targetContent) targetContent.classList.add('active');
        });
      });

      // ä¸»é¢˜é€‰æ‹©
      document.querySelectorAll('[data-theme]').forEach(card => {
        card.addEventListener('click', () => {
          applyTheme(card.dataset.theme);
        });
      });

      // å­—ä½“é€‰æ‹©
      document.querySelectorAll('[data-font]').forEach(card => {
        card.addEventListener('click', () => {
          applyFont(card.dataset.font);
        });
      });

      // å­—å·é€‰æ‹©
      document.querySelectorAll('[data-size]').forEach(btn => {
        btn.addEventListener('click', () => {
          applyFontSize(btn.dataset.size);
        });
      });

      // è‡ªå®šä¹‰å­—å·è¾“å…¥
      const customSizeValue = document.getElementById('customSizeValue');
      if (customSizeValue) {
        customSizeValue.addEventListener('change', (e) => {
          if (customSizeValue.value) {
            applyFontSize('custom');
          }
        });
      }
    });

    const volumeSlider = document.getElementById("volumeSlider");
    const volumeControl = document.getElementById("volumeControl");

    let mediaRecorder = null;
    let audioChunks = [];
    let isRecording = false;
    let isMuted = false;
    let character = "ayanami"; // é»˜è®¤è§’è‰²
    let currentChatId = "current"; // å½“å‰å¯¹è¯IDï¼ˆå‰ç«¯ä½¿ç”¨çš„IDï¼‰
    let currentSessionId = null; // å½“å‰ä¼šè¯IDï¼ˆåç«¯æ•°æ®åº“çš„session_idï¼‰
    let chatHistory = {}; // å­˜å‚¨æ‰€æœ‰å¯¹è¯å†å² {chatId: {messages: [], title: "", time: "", sessionId: null}}
    let isWaitingForAudio = false; // æ˜¯å¦æ­£åœ¨ç­‰å¾…éŸ³é¢‘è¿”å›
    let abortController = null; // ç”¨äºå–æ¶ˆæ­£åœ¨è¿›è¡Œçš„è¯·æ±‚

    // åç«¯APIåœ°å€ - è‡ªåŠ¨æ£€æµ‹æœåŠ¡å™¨åœ°å€
    // è‡ªåŠ¨æ£€æµ‹æœåŠ¡å™¨åœ°å€
    const FASTAPI_URL = (() => {
      const currentOrigin = window.location.origin;
      const currentHostname = window.location.hostname;
      const currentPort = window.location.port;
      const currentPath = window.location.pathname;
      const currentProtocol = window.location.protocol;

      // å¦‚æœå½“å‰ç«¯å£æ˜¯7860ï¼ˆå‰ç«¯æœåŠ¡å™¨ï¼‰ï¼Œåˆ™ä½¿ç”¨åç«¯æœåŠ¡å™¨ï¼ˆ8000ç«¯å£ï¼‰
      if (currentPort === '7860') {
        const backendUrl = `${currentProtocol}//${currentHostname}:8000`;
        console.log('âœ… æ£€æµ‹åˆ°å‰ç«¯æœåŠ¡å™¨ï¼ˆç«¯å£7860ï¼‰ï¼Œä½¿ç”¨åç«¯APIæœåŠ¡å™¨:', backendUrl);
        return backendUrl;
      }

      // å¦‚æœè·¯å¾„åŒ…å« /webui/ï¼Œè¯´æ˜æ˜¯æŒ‚è½½åœ¨FastAPIä¸‹çš„
      if (currentPath.includes('/webui/')) {
        console.log('âœ… æ£€æµ‹åˆ°FastAPIé™æ€æ–‡ä»¶æœåŠ¡ï¼Œä½¿ç”¨å½“å‰origin:', currentOrigin);
        return currentOrigin;
      }

      // å¦åˆ™ä½¿ç”¨å½“å‰origin
      console.log('âœ… ä½¿ç”¨å½“å‰originä½œä¸ºAPIæœåŠ¡å™¨:', currentOrigin);
      return currentOrigin;
    })();

    console.log('æœ€ç»ˆç¡®å®šçš„APIæœåŠ¡å™¨åœ°å€:', FASTAPI_URL);
    let isStreaming = false; // æ˜¯å¦æ­£åœ¨æµå¼è¾“å‡º
    let streamingMessageId = null; // æ­£åœ¨æµå¼è¾“å‡ºçš„æ¶ˆæ¯ID

    // ä»æ•°æ®åº“åŠ è½½å¯¹è¯å†å²
    async function loadChatHistoryFromDatabase() {
      try {
        const response = await fetch(`${FASTAPI_URL}/chat/sessions?limit=100`);
        if (!response.ok) {
          console.error("åŠ è½½å¯¹è¯å†å²å¤±è´¥:", response.status);
          return;
        }
        const data = await response.json();
        if (data.success && data.data) {
          const sessions = data.data;

          // å°†æ•°æ®åº“ä¼šè¯è½¬æ¢ä¸ºå‰ç«¯æ ¼å¼
          for (const session of sessions) {
            const sessionId = session.session_id;
            const frontendChatId = sessionId; // ä½¿ç”¨session_idä½œä¸ºå‰ç«¯chatId

            // è·å–è¯¥ä¼šè¯çš„æ‰€æœ‰æ¶ˆæ¯
            const messagesResponse = await fetch(`${FASTAPI_URL}/chat/sessions/${sessionId}/messages`);
            if (messagesResponse.ok) {
              const messagesData = await messagesResponse.json();
              if (messagesData.success && messagesData.data && messagesData.data.length > 0) {
                // åªåŠ è½½æœ‰æ¶ˆæ¯çš„ä¼šè¯ï¼ˆè¿‡æ»¤ç©ºä¼šè¯ï¼‰
                const messages = messagesData.data.map(msg => ({
                  text: msg.text_content || '',
                  isUser: msg.message_type === 'user',
                  audioBase64: msg.audio_base64 || null,
                  audioUrl: msg.audio_url || null,
                  audioDuration: 0,
                  messageId: msg.message_id,
                  status: 'sent',
                  time: msg.created_at
                }));

                chatHistory[frontendChatId] = {
                  messages: messages,
                  title: session.title || messages[0]?.text?.substring(0, 20) || 'æœªå‘½åå¯¹è¯',
                  time: session.created_at,
                  sessionId: sessionId
                };
              }
            }
          }

          updateHistoryList();
        }
      } catch (error) {
        console.error("ä»æ•°æ®åº“åŠ è½½å¯¹è¯å†å²å¤±è´¥:", error);
      }
    }

    // åˆå§‹åŒ–å¯¹è¯å†å²
    async function initChatHistory() {
      // ä»æ•°æ®åº“åŠ è½½å†å²è®°å½•
      await loadChatHistoryFromDatabase();

      // åˆå§‹åŒ–å½“å‰å¯¹è¯
      if (!chatHistory[currentChatId]) {
        chatHistory[currentChatId] = {
          messages: [],
          title: "å½“å‰å¯¹è¯",
          time: new Date().toISOString()
        };
      }
    }

    // ä¿å­˜å¯¹è¯å†å²ï¼ˆä¸å†ä½¿ç”¨localStorageï¼Œè®°å½•å·²é€šè¿‡APIä¿å­˜åˆ°æ•°æ®åº“ï¼‰
    function saveChatHistory() {
      // ä¸å†ä½¿ç”¨localStorageï¼Œè®°å½•å·²é€šè¿‡APIä¿å­˜åˆ°æ•°æ®åº“
      // è¿™é‡Œä¿ç•™å‡½æ•°æ˜¯ä¸ºäº†å…¼å®¹ç°æœ‰ä»£ç ï¼Œä½†ä¸æ‰§è¡Œä»»ä½•æ“ä½œ
    }

    // æ›´æ–°å¯¹è¯æ ‡é¢˜ï¼ˆä½¿ç”¨ç¬¬ä¸€æ¡ç”¨æˆ·æ¶ˆæ¯ï¼‰
    function updateChatTitle(chatId, firstUserMessage) {
      if (chatHistory[chatId] && firstUserMessage) {
        const title = firstUserMessage.length > 20
          ? firstUserMessage.substring(0, 20) + "..."
          : firstUserMessage;
        chatHistory[chatId].title = title;
        saveChatHistory();
        updateHistoryList();
      }
    }

    // æ·»åŠ æ¶ˆæ¯åˆ°èŠå¤©ç•Œé¢
    function addMessage(text, isUser, audioBase64 = null, audioDuration = 0, messageId = null, status = 'sent', messageData = null) {
      // å¦‚æœæ˜¯ç¬¬ä¸€æ¡æ¶ˆæ¯ï¼Œæ¸…ç©ºç©ºçŠ¶æ€
      const emptyState = chatMessages.querySelector('.empty-state');
      if (emptyState) {
        emptyState.remove();
      }

      if (!messageId) {
        messageId = `msg-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
      }

      const messageDiv = document.createElement("div");
      messageDiv.className = `message ${isUser ? 'user' : 'assistant'}`;
      messageDiv.dataset.messageId = messageId;

      const bubble = document.createElement("div");
      bubble.className = "message-bubble";
      bubble.textContent = text;

      const time = document.createElement("div");
      time.className = "message-time";
      time.textContent = new Date().toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });

      // æ·»åŠ æ¶ˆæ¯çŠ¶æ€ï¼ˆä»…ç”¨æˆ·æ¶ˆæ¯æ˜¾ç¤ºï¼‰
      if (isUser) {
        const statusDiv = document.createElement("div");
        statusDiv.className = `message-status ${status}`;
        statusDiv.id = `status-${messageId}`;
        messageDiv.appendChild(statusDiv);
      }

      messageDiv.appendChild(bubble);
      messageDiv.appendChild(time);

      // å¦‚æœæ˜¯AIå›å¤ä¸”æœ‰éŸ³é¢‘ï¼Œæ·»åŠ éŸ³é¢‘æ’­æ”¾å™¨
      const hasAudio = audioBase64 || (messageData && messageData.audioUrl);
      if (!isUser && hasAudio) {
        const audioDiv = document.createElement("div");
        audioDiv.className = "message-audio";
        const audio = document.createElement("audio");
        audio.className = "audio-player";
        audio.controls = true;
        audio.volume = isMuted ? 0 : volumeSlider.value / 100;

        // ä¼˜å…ˆä½¿ç”¨URLï¼Œå¦‚æœä¸å­˜åœ¨åˆ™ä½¿ç”¨base64
        if (messageData && messageData.audioUrl) {
          audio.src = `${FASTAPI_URL}${messageData.audioUrl}`;
        } else if (audioBase64) {
          audio.src = `data:audio/wav;base64,${audioBase64}`;
        }

        audioDiv.appendChild(audio);
        bubble.appendChild(audioDiv);

        // ä¿å­˜å½“å‰éŸ³é¢‘å¼•ç”¨
        currentAudio = audio;

        // è®¾ç½®åˆå§‹éŸ³é‡
        audio.volume = isMuted ? 0 : volumeSlider.value / 100;

        // è‡ªåŠ¨æ’­æ”¾ï¼ˆå¦‚æœæœªé™éŸ³ï¼‰
        if (!isMuted) {
          audio.play().catch(e => console.log("è‡ªåŠ¨æ’­æ”¾å¤±è´¥:", e));
        }
      }

      chatMessages.appendChild(messageDiv);
      chatMessages.scrollTop = chatMessages.scrollHeight;

      // ä¿å­˜åˆ°å¯¹è¯å†å²ï¼ˆå»¶è¿Ÿä¿å­˜ï¼Œé¿å…åœ¨æµå¼è¾“å‡ºæ—¶é¢‘ç¹ä¿å­˜ï¼‰
      if (chatHistory[currentChatId] && !isStreaming) {
        const existingMessage = chatHistory[currentChatId].messages.find(m => m.messageId === messageId);
        if (!existingMessage) {
          chatHistory[currentChatId].messages.push({
            text,
            isUser,
            audioBase64,
            audioDuration,
            messageId,
            status,
            time: new Date().toISOString()
          });
          saveChatHistory();
        }
      }

      return messageDiv;
    }

    // æ›´æ–°æ¶ˆæ¯çŠ¶æ€
    function updateMessageStatus(messageId, status) {
      const statusDiv = document.getElementById(`status-${messageId}`);
      if (statusDiv) {
        statusDiv.className = `message-status ${status}`;
      }

      // æ›´æ–°å†å²è®°å½•ä¸­çš„çŠ¶æ€
      if (chatHistory[currentChatId]) {
        const message = chatHistory[currentChatId].messages.find(m => m.messageId === messageId);
        if (message) {
          message.status = status;
          saveChatHistory();
        }
      }
    }

    // æ›´æ–°æ¶ˆæ¯å†…å®¹ï¼ˆç”¨äºæµå¼è¾“å‡ºï¼‰
    function updateMessageText(messageId, text, isComplete = false) {
      const messageDiv = document.querySelector(`[data-message-id="${messageId}"]`);
      if (messageDiv) {
        const bubble = messageDiv.querySelector('.message-bubble');
        if (bubble) {
          if (isComplete) {
            bubble.textContent = text;
            // ç§»é™¤æµå¼å…‰æ ‡
            const cursor = bubble.querySelector('.streaming-cursor');
            if (cursor) {
              cursor.remove();
            }
          } else {
            bubble.innerHTML = `<span class="streaming-text">${text}</span><span class="streaming-cursor"></span>`;
          }
          chatMessages.scrollTop = chatMessages.scrollHeight;
        }
      }

      // æ›´æ–°å†å²è®°å½•
      if (chatHistory[currentChatId]) {
        const message = chatHistory[currentChatId].messages.find(m => m.messageId === messageId);
        if (message) {
          message.text = text;
          saveChatHistory();
        }
      }
    }

    // æ˜¾ç¤ºè¾“å…¥æŒ‡ç¤ºå™¨ï¼ˆå¸¦å–æ¶ˆæŒ‰é’®ï¼‰
    function showTypingIndicator() {
      const indicator = document.createElement("div");
      indicator.className = "message assistant";
      indicator.id = "typingIndicator";

      const wrapper = document.createElement("div");
      wrapper.className = "typing-indicator-wrapper";

      const typingDiv = document.createElement("div");
      typingDiv.className = "typing-indicator";
      typingDiv.innerHTML = `
        <div class="typing-dot"></div>
        <div class="typing-dot"></div>
        <div class="typing-dot"></div>
      `;

      const cancelBtn = document.createElement("button");
      cancelBtn.className = "cancel-typing-btn";
      cancelBtn.textContent = "Ã—";
      cancelBtn.title = "å–æ¶ˆå›å¤";
      cancelBtn.onclick = () => {
        if (abortController) {
          abortController.abort();
        }
        hideTypingIndicator();
      };

      wrapper.appendChild(typingDiv);
      wrapper.appendChild(cancelBtn);
      indicator.appendChild(wrapper);
      chatMessages.appendChild(indicator);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    // éšè—è¾“å…¥æŒ‡ç¤ºå™¨
    function hideTypingIndicator() {
      const indicator = document.getElementById("typingIndicator");
      if (indicator) {
        indicator.remove();
      }
    }

    // æ£€æŸ¥æ˜¯å¦å¯ç”¨äº†éŸ³é¢‘ï¼ˆé€šè¿‡éŸ³é‡æ§åˆ¶æŒ‰é’®çŠ¶æ€æˆ–é…ç½®ï¼‰
    function isAudioEnabled() {
      // æ£€æŸ¥éŸ³é‡æ§åˆ¶æ˜¯å¦å¯è§ä¸”æœªé™éŸ³
      const volumeControl = document.getElementById("volumeControl");
      return volumeControl && !volumeControl.classList.contains("muted") && volumeSlider.value > 0;
    }

    // ç®€å•çš„toastæç¤ºå‡½æ•°
    function showToast(message, type = 'info') {
      // åˆ›å»ºä¸€ä¸ªç®€å•çš„toastå…ƒç´ 
      const toast = document.createElement('div');
      toast.style.cssText = `
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        padding: 12px 24px;
        background: ${type === 'error' ? '#ef4444' : type === 'success' ? '#10b981' : type === 'warning' ? '#f59e0b' : '#3b82f6'};
        color: white;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        z-index: 10000;
        font-size: 14px;
        font-weight: 500;
      `;
      toast.textContent = message;
      document.body.appendChild(toast);

      // 3ç§’åè‡ªåŠ¨ç§»é™¤
      setTimeout(() => {
        toast.style.opacity = '0';
        toast.style.transition = 'opacity 0.3s';
        setTimeout(() => {
          document.body.removeChild(toast);
        }, 300);
      }, 3000);
    }

    // å‘é€æ¶ˆæ¯
    async function sendMessage(text, retryMessageId = null) {
      if (!text.trim()) return;

      // å¦‚æœæ­£åœ¨ç­‰å¾…éŸ³é¢‘è¿”å›ï¼Œç¦æ­¢å‘é€æ–°æ¶ˆæ¯
      if (isWaitingForAudio || isStreaming) {
        showToast("è¯·ç­‰å¾…AIå›å¤å®Œæˆåå†å‘é€", "warning");
        return;
      }

      const userMessageId = retryMessageId || `user-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
      const enable_audio = isAudioEnabled();

      // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯ï¼ˆå¦‚æœæ˜¯é‡è¯•ï¼Œä¸é‡å¤æ·»åŠ ï¼‰
      if (!retryMessageId) {
        addMessage(text, true, null, 0, userMessageId, 'sending');
        updateChatTitle(currentChatId, text);
        chatInput.value = "";
      } else {
        // é‡è¯•æ—¶æ›´æ–°çŠ¶æ€
        updateMessageStatus(userMessageId, 'sending');
      }

      // æ˜¾ç¤ºè¾“å…¥æŒ‡ç¤ºå™¨
      showTypingIndicator();

      // ç¦ç”¨å‘é€æŒ‰é’®
      sendBtn.disabled = true;
      sendBtn.textContent = enable_audio ? "ç”Ÿæˆä¸­ï¼ˆå«éŸ³é¢‘ï¼‰..." : "å‘é€ä¸­...";

      // åˆ›å»ºAbortControllerç”¨äºå–æ¶ˆè¯·æ±‚
      abortController = new AbortController();

      try {
        const response = await fetch(`${FASTAPI_URL}/chat`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            text: text,
            character: character,
            enable_audio: enable_audio,
            session_id: currentSessionId  // ä½¿ç”¨å½“å‰ä¼šè¯ID
          }),
          signal: abortController.signal  // æ”¯æŒå–æ¶ˆè¯·æ±‚
        });

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        const data = await response.json();

        hideTypingIndicator();

        // æ›´æ–°ç”¨æˆ·æ¶ˆæ¯çŠ¶æ€ä¸ºå·²é€è¾¾
        updateMessageStatus(userMessageId, 'sent');

        // æ›´æ–°ä¼šè¯IDï¼ˆå¦‚æœAPIè¿”å›äº†æ–°çš„ä¼šè¯IDï¼‰
        if (data.data && data.data.session_id) {
          currentSessionId = data.data.session_id;
          // å¦‚æœå½“å‰å¯¹è¯è¿˜æ²¡æœ‰sessionIdï¼Œæ›´æ–°å®ƒ
          if (chatHistory[currentChatId] && !chatHistory[currentChatId].sessionId) {
            chatHistory[currentChatId].sessionId = currentSessionId;
          }
        }

        if (data.success) {
          const answer = data.data.llm_answer || "";
          const audioBase64 = data.data.audio_base64 || null;
          const audioUrl = data.data.audio_url || null;  // å¦‚æœéŸ³é¢‘å·²ä¿å­˜ä¸ºæ–‡ä»¶
          const audioDuration = data.data.audio_duration || 0;
          const assistantMessageId = data.data.assistant_message_id || `assistant-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;

          if (enable_audio && (audioBase64 || audioUrl)) {
            // å¼€å¯å£°éŸ³æ—¶ï¼šç­‰å¾…éŸ³é¢‘ç”Ÿæˆå®Œæ¯•åå†æ˜¾ç¤ºæ–‡æœ¬ï¼Œå¹¶åŒæ­¥æ’­æ”¾
            isWaitingForAudio = true;

            // å…ˆåˆ›å»ºç©ºæ¶ˆæ¯
            addMessage("", false, null, 0, assistantMessageId);

            const messageDiv = document.querySelector(`[data-message-id="${assistantMessageId}"]`);
            if (messageDiv) {
              const bubble = messageDiv.querySelector('.message-bubble');
              if (bubble) {
                const audioDiv = document.createElement("div");
                audioDiv.className = "message-audio";
                const audio = document.createElement("audio");
                audio.className = "audio-player";
                audio.controls = true;
                audio.volume = isMuted ? 0 : volumeSlider.value / 100;

                // ä¼˜å…ˆä½¿ç”¨URLï¼Œå¦‚æœä¸å­˜åœ¨åˆ™ä½¿ç”¨base64
                if (audioUrl) {
                  audio.src = `${FASTAPI_URL}${audioUrl}`;
                } else if (audioBase64) {
                  audio.src = `data:audio/wav;base64,${audioBase64}`;
                }

                audioDiv.appendChild(audio);
                bubble.appendChild(audioDiv);

                currentAudio = audio;

                try {
                  // ç­‰å¾…éŸ³é¢‘åŠ è½½å®Œæˆ
                  await new Promise((resolve, reject) => {
                    audio.addEventListener('loadeddata', resolve, { once: true });
                    audio.addEventListener('error', reject, { once: true });

                    // è¶…æ—¶å¤„ç†ï¼ˆ10ç§’ï¼‰
                    setTimeout(() => reject(new Error('éŸ³é¢‘åŠ è½½è¶…æ—¶')), 10000);
                  });

                  // éŸ³é¢‘åŠ è½½å®Œæˆåï¼ŒåŒæ­¥æ’­æ”¾å’Œæ–‡æœ¬æ˜¾ç¤º
                  streamingMessageId = assistantMessageId;
                  isStreaming = true;

                  // å¼€å§‹æ’­æ”¾éŸ³é¢‘
                  if (!isMuted) {
                    audio.play().catch(e => console.log("è‡ªåŠ¨æ’­æ”¾å¤±è´¥:", e));
                  }

                  // æ ¹æ®éŸ³é¢‘æ’­æ”¾è¿›åº¦åŒæ­¥æ˜¾ç¤ºæ–‡æœ¬
                  const totalDuration = audio.duration || audioDuration;
                  const textLength = answer.length;
                  let displayedLength = 0;

                  const updateTextWithAudio = () => {
                    if (!isStreaming) return; // å¦‚æœæµå¼è¾“å‡ºå·²åœæ­¢ï¼Œä¸å†æ›´æ–°

                    const currentTime = audio.currentTime;
                    const progress = totalDuration > 0 ? currentTime / totalDuration : 0;
                    const targetLength = Math.floor(textLength * progress);

                    // é€æ­¥æ˜¾ç¤ºæ–‡æœ¬ï¼ˆæ¯æ¬¡æ˜¾ç¤ºä¸€äº›å­—ç¬¦ï¼‰
                    if (targetLength > displayedLength) {
                      const newText = answer.substring(0, targetLength);
                      updateMessageText(assistantMessageId, newText, false);
                      displayedLength = targetLength;
                    }

                    // å¦‚æœéŸ³é¢‘æ’­æ”¾å®Œæˆæˆ–å·²æ˜¾ç¤ºæ‰€æœ‰æ–‡æœ¬
                    if (audio.ended || displayedLength >= textLength) {
                      updateMessageText(assistantMessageId, answer, true);
                      isStreaming = false;
                      streamingMessageId = null;
                      isWaitingForAudio = false;
                      sendBtn.disabled = false;
                      sendBtn.textContent = "å‘é€";
                    }
                  };

                  // ç›‘å¬éŸ³é¢‘æ’­æ”¾è¿›åº¦
                  audio.addEventListener('timeupdate', updateTextWithAudio);

                  // éŸ³é¢‘æ’­æ”¾ç»“æŸæ—¶æ˜¾ç¤ºå®Œæ•´æ–‡æœ¬
                  audio.addEventListener('ended', () => {
                    updateMessageText(assistantMessageId, answer, true);
                    isStreaming = false;
                    streamingMessageId = null;
                    isWaitingForAudio = false;
                    sendBtn.disabled = false;
                    sendBtn.textContent = "å‘é€";
                  }, { once: true });

                  // ç«‹å³æ˜¾ç¤ºä¸€éƒ¨åˆ†æ–‡æœ¬ï¼ˆç¬¬ä¸€ä¸ªå­—ç¬¦ï¼‰
                  if (answer.length > 0) {
                    updateMessageText(assistantMessageId, answer[0], false);
                    displayedLength = 1;
                  }

                  // æ›´æ–°å†å²è®°å½•ä¸­çš„éŸ³é¢‘
                  if (chatHistory[currentChatId]) {
                    const message = chatHistory[currentChatId].messages.find(m => m.messageId === assistantMessageId);
                    if (message) {
                      message.audioBase64 = audioBase64;
                      message.audioUrl = audioUrl;
                      message.audioDuration = audioDuration;
                    }
                  }
                } catch (audioError) {
                  console.error("éŸ³é¢‘åŠ è½½å¤±è´¥:", audioError);
                  // å¦‚æœéŸ³é¢‘åŠ è½½å¤±è´¥ï¼Œå›é€€åˆ°çº¯æ–‡æœ¬æ˜¾ç¤º
                  isWaitingForAudio = false;
                  streamingMessageId = assistantMessageId;
                  isStreaming = true;

                  // é€å­—æ˜¾ç¤ºæ–‡æœ¬
                  let currentText = "";
                  for (let i = 0; i < answer.length; i++) {
                    if (!isStreaming) break;
                    currentText += answer[i];
                    updateMessageText(assistantMessageId, currentText, false);
                    await new Promise(resolve => setTimeout(resolve, 30));
                  }

                  updateMessageText(assistantMessageId, answer, true);
                  isStreaming = false;
                  streamingMessageId = null;
                  sendBtn.disabled = false;
                  sendBtn.textContent = "å‘é€";
                }
              }
            }
          } else {
            // å…³é—­å£°éŸ³æ—¶ï¼šç«‹å³é€å­—æ˜¾ç¤ºæ–‡æœ¬
            streamingMessageId = assistantMessageId;
            isStreaming = true;

            // å…ˆåˆ›å»ºç©ºæ¶ˆæ¯
            addMessage("", false, null, 0, assistantMessageId);

            // é€å­—æ˜¾ç¤º
            let currentText = "";
            for (let i = 0; i < answer.length; i++) {
              // æ£€æŸ¥æ˜¯å¦è¢«å–æ¶ˆ
              if (!isStreaming) {
                break;
              }
              currentText += answer[i];
              updateMessageText(assistantMessageId, currentText, false);
              await new Promise(resolve => setTimeout(resolve, 30)); // 30mså»¶è¿Ÿï¼Œæ¨¡æ‹Ÿæ‰“å­—æ•ˆæœ
            }

            // å®Œæˆæµå¼è¾“å‡º
            updateMessageText(assistantMessageId, answer, true);
            isStreaming = false;
            streamingMessageId = null;

            // æ–‡æœ¬æ˜¾ç¤ºå®Œæˆåï¼Œå¯ä»¥ç«‹å³è¾“å…¥ä¸‹ä¸€ä¸ªé—®é¢˜
            sendBtn.disabled = false;
            sendBtn.textContent = "å‘é€";
            isWaitingForAudio = false;
          }

          // ä¿å­˜æ¶ˆæ¯åˆ°å†å²è®°å½•
          if (chatHistory[currentChatId]) {
            const existingMessage = chatHistory[currentChatId].messages.find(m => m.messageId === assistantMessageId);
            if (!existingMessage) {
              chatHistory[currentChatId].messages.push({
                text: answer,
                isUser: false,
                audioBase64: audioBase64,
                audioUrl: audioUrl,
                audioDuration: audioDuration,
                messageId: assistantMessageId,
                status: 'sent',
                time: new Date().toISOString()
              });
            }
          }

          // ä¿å­˜å†å²è®°å½•ï¼ˆæ•°æ®åº“å·²è‡ªåŠ¨ä¿å­˜ï¼Œè¿™é‡Œä¸éœ€è¦é¢å¤–æ“ä½œï¼‰
          saveChatHistory();
        } else {
          // é”™è¯¯å¤„ç†
          isWaitingForAudio = false;
          const errorMessage = "âŒ é”™è¯¯: " + (data.error || "æœªçŸ¥é”™è¯¯");
          const errorMessageId = `msg-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
          const errorDiv = addMessage(errorMessage, false, null, 0, errorMessageId);

          // æ·»åŠ é‡è¯•æŒ‰é’®
          const retryBtn = document.createElement("button");
          retryBtn.className = "retry-btn";
          retryBtn.textContent = "ğŸ”„ é‡è¯•";
          retryBtn.onclick = () => {
            sendMessage(text, userMessageId);
            errorDiv.remove();
          };
          errorDiv.querySelector('.message-bubble').appendChild(retryBtn);

          // æ›´æ–°ç”¨æˆ·æ¶ˆæ¯çŠ¶æ€ä¸ºé”™è¯¯
          updateMessageStatus(userMessageId, 'error');
        }
      } catch (error) {
        hideTypingIndicator();
        isWaitingForAudio = false;

        // å¦‚æœæ˜¯å–æ¶ˆè¯·æ±‚ï¼Œä¸æ˜¾ç¤ºé”™è¯¯
        if (error.name === 'AbortError') {
          console.log("è¯·æ±‚å·²å–æ¶ˆ");
          // åœæ­¢æµå¼è¾“å‡º
          isStreaming = false;
          const currentStreamingId = streamingMessageId; // ä¿å­˜å½“å‰å€¼
          streamingMessageId = null;
          isWaitingForAudio = false;

          // ç§»é™¤å‘é€ä¸­çš„ç”¨æˆ·æ¶ˆæ¯
          const userMessageDiv = document.querySelector(`[data-message-id="${userMessageId}"]`);
          if (userMessageDiv) {
            userMessageDiv.remove();
          }

          // ç§»é™¤æ­£åœ¨ç”Ÿæˆçš„æ¶ˆæ¯ï¼ˆå¦‚æœæœ‰ï¼‰
          if (currentStreamingId) {
            const streamingDiv = document.querySelector(`[data-message-id="${currentStreamingId}"]`);
            if (streamingDiv) {
              streamingDiv.remove();
            }
          }

          // ç§»é™¤è¾“å…¥æŒ‡ç¤ºå™¨
          hideTypingIndicator();

          // æ¢å¤å‘é€æŒ‰é’®
          sendBtn.disabled = false;
          sendBtn.textContent = "å‘é€";

          return;
        }

        const errorMessage = "âŒ ç½‘ç»œé”™è¯¯: " + error.message;
        const errorMessageId = `msg-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
        const errorDiv = addMessage(errorMessage, false, null, 0, errorMessageId);

        // æ·»åŠ é‡è¯•æŒ‰é’®
        const retryBtn = document.createElement("button");
        retryBtn.className = "retry-btn";
        retryBtn.textContent = "ğŸ”„ é‡è¯•";
        retryBtn.onclick = () => {
          sendMessage(text, userMessageId);
          errorDiv.remove();
        };
        errorDiv.querySelector('.message-bubble').appendChild(retryBtn);

        // æ›´æ–°ç”¨æˆ·æ¶ˆæ¯çŠ¶æ€ä¸ºé”™è¯¯
        updateMessageStatus(userMessageId, 'error');
      } finally {
        // å¦‚æœä¸åœ¨ç­‰å¾…éŸ³é¢‘ï¼Œæ¢å¤å‘é€æŒ‰é’®
        if (!isWaitingForAudio) {
          sendBtn.disabled = false;
          sendBtn.textContent = "å‘é€";
        }
        abortController = null;
      }
    }

    // å‘é€æŒ‰é’®ç‚¹å‡»
    sendBtn.addEventListener("click", () => {
      sendMessage(chatInput.value.trim());
    });

    // Enterå‘é€ï¼ŒShift+Enteræ¢è¡Œ
    chatInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        sendMessage(chatInput.value.trim());
      }
    });

    // ==================== è¯­éŸ³å½•åˆ¶åŠŸèƒ½ ====================
    async function startRecording() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);
        audioChunks = [];

        mediaRecorder.ondataavailable = (event) => {
          audioChunks.push(event.data);
        };

        mediaRecorder.onstop = async () => {
          const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });

          // å°†éŸ³é¢‘è½¬æ¢ä¸ºæ–‡æœ¬ï¼ˆè¿™é‡Œéœ€è¦è¯­éŸ³è¯†åˆ«APIï¼Œæš‚æ—¶æç¤ºç”¨æˆ·ï¼‰
          // ç›®å‰å…ˆæç¤ºç”¨æˆ·è¯­éŸ³å½•åˆ¶åŠŸèƒ½éœ€è¦è¯­éŸ³è¯†åˆ«æ”¯æŒ
          alert("è¯­éŸ³å½•åˆ¶å®Œæˆï¼\næ³¨æ„ï¼šè¯­éŸ³è½¬æ–‡æœ¬åŠŸèƒ½éœ€è¦åç«¯è¯­éŸ³è¯†åˆ«APIæ”¯æŒï¼Œå½“å‰ç‰ˆæœ¬è¯·ä½¿ç”¨æ–‡æœ¬è¾“å…¥ã€‚");

          // åœæ­¢æ‰€æœ‰éŸ³é¢‘è½¨é“
          stream.getTracks().forEach(track => track.stop());
        };

        mediaRecorder.start();
        isRecording = true;
        recordBtn.classList.add("recording");
        recordBtn.textContent = "â¹ï¸";
        recordBtn.title = "åœæ­¢å½•åˆ¶";
      } catch (error) {
        alert("æ— æ³•è®¿é—®éº¦å…‹é£: " + error.message);
      }
    }

    function stopRecording() {
      if (mediaRecorder && isRecording) {
        mediaRecorder.stop();
        isRecording = false;
        recordBtn.classList.remove("recording");
        recordBtn.textContent = "ğŸ¤";
        recordBtn.title = "å½•åˆ¶è¯­éŸ³";
      }
    }

    recordBtn.addEventListener("click", () => {
      if (isRecording) {
        stopRecording();
      } else {
        startRecording();
      }
    });

    // ==================== éŸ³é¢‘ä¸Šä¼ åŠŸèƒ½ ====================
    uploadBtn.addEventListener("click", () => {
      audioUpload.click();
    });

    audioUpload.addEventListener("change", async (e) => {
      const file = e.target.files[0];
      if (!file) return;

      if (!file.type.startsWith('audio/')) {
        alert("è¯·é€‰æ‹©éŸ³é¢‘æ–‡ä»¶ï¼");
        return;
      }

      // è¿™é‡Œéœ€è¦è¯­éŸ³è¯†åˆ«APIå°†éŸ³é¢‘è½¬ä¸ºæ–‡æœ¬
      // ç›®å‰å…ˆæç¤ºç”¨æˆ·
      alert("éŸ³é¢‘ä¸Šä¼ æˆåŠŸï¼\næ³¨æ„ï¼šè¯­éŸ³è½¬æ–‡æœ¬åŠŸèƒ½éœ€è¦åç«¯è¯­éŸ³è¯†åˆ«APIæ”¯æŒï¼Œå½“å‰ç‰ˆæœ¬è¯·ä½¿ç”¨æ–‡æœ¬è¾“å…¥ã€‚");

      // é‡ç½®æ–‡ä»¶è¾“å…¥
      audioUpload.value = "";
    });

    // ==================== éŸ³é‡æ§åˆ¶ ====================
    function updateAllAudioVolumes() {
      const allAudios = document.querySelectorAll('.audio-player');
      const volume = isMuted ? 0 : volumeSlider.value / 100;
      allAudios.forEach(audio => {
        audio.volume = volume;
      });
    }

    volumeSlider.addEventListener("input", (e) => {
      const volume = e.target.value;
      volumeValue.textContent = volume + "%";
      updateAllAudioVolumes();
    });

    volumeBtn.addEventListener("click", () => {
      isMuted = !isMuted;

      if (isMuted) {
        volumeBtn.textContent = "ğŸ”‡";
        volumeControl.classList.add("muted");
      } else {
        volumeBtn.textContent = "ğŸ”Š";
        volumeControl.classList.remove("muted");
      }
      updateAllAudioVolumes();
    });

    // ==================== å¸®åŠ©åŠŸèƒ½ ====================
    function initHelp() {
      const btn = document.getElementById("helpBtn");
      btn.addEventListener("click", () => {
        alert("ä½¿ç”¨æç¤ºï¼š\n" +
          "1. åœ¨è¾“å…¥æ¡†ä¸­è¾“å…¥æ–‡å­—ï¼ŒæŒ‰Enterå‘é€\n" +
          "2. ç‚¹å‡»ğŸ¤æŒ‰é’®å¯ä»¥å½•åˆ¶è¯­éŸ³ï¼ˆéœ€è¦è¯­éŸ³è¯†åˆ«æ”¯æŒï¼‰\n" +
          "3. ç‚¹å‡»ğŸ“æŒ‰é’®å¯ä»¥ä¸Šä¼ éŸ³é¢‘æ–‡ä»¶\n" +
          "4. ä½¿ç”¨éŸ³é‡æ»‘å—æ§åˆ¶AIå›å¤çš„è¯­éŸ³éŸ³é‡\n" +
          "5. ç‚¹å‡»ğŸ”Š/ğŸ”‡æŒ‰é’®å¯ä»¥é™éŸ³/å–æ¶ˆé™éŸ³");
      });
    }

    // ==================== å¯¹è¯ç®¡ç†åŠŸèƒ½ ====================
    const chatManageBtn = document.getElementById("chatManageBtn");
    const chatSidebar = document.getElementById("chatSidebar");
    const chatSidebarClose = document.getElementById("chatSidebarClose");
    const newChatBtn = document.getElementById("newChatBtn");
    const exportChatBtn = document.getElementById("exportChatBtn");
    const clearChatBtn = document.getElementById("clearChatBtn");
    const historyList = document.getElementById("historyList");

    // æ‰“å¼€/å…³é—­å¯¹è¯ç®¡ç†ä¾§è¾¹æ 
    chatManageBtn.addEventListener("click", () => {
      chatSidebar.classList.toggle("active");
    });

    chatSidebarClose.addEventListener("click", () => {
      chatSidebar.classList.remove("active");
    });

    // ç¼–è¾‘å¯¹è¯åç§°
    function editChatName(chatId, titleSpan, editBtn) {
      const chatData = chatHistory[chatId];
      if (!chatData) return;

      const currentTitle = chatData.title || 'æœªå‘½åå¯¹è¯';
      const input = document.createElement("input");
      input.type = "text";
      input.value = currentTitle;
      input.style.width = "100%";

      // æ›¿æ¢æ ‡é¢˜ä¸ºè¾“å…¥æ¡†
      titleSpan.style.display = 'none';
      editBtn.style.display = 'none';
      titleSpan.parentElement.insertBefore(input, titleSpan);

      input.focus();
      input.select();

      const finishEdit = () => {
        const newTitle = input.value.trim() || 'æœªå‘½åå¯¹è¯';
        chatData.title = newTitle;
        titleSpan.textContent = newTitle;
        titleSpan.style.display = '';
        editBtn.style.display = '';
        input.remove();
        saveChatHistory();
        updateHistoryList(); // é‡æ–°æ¸²æŸ“ä»¥æ›´æ–°æ˜¾ç¤º
      };

      input.addEventListener("blur", finishEdit);
      input.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          e.preventDefault();
          finishEdit();
        } else if (e.key === "Escape") {
          titleSpan.style.display = '';
          editBtn.style.display = '';
          input.remove();
        }
      });
    }

    // æ›´æ–°å†å²åˆ—è¡¨
    function updateHistoryList() {
      historyList.innerHTML = '';

      // æ·»åŠ å½“å‰å¯¹è¯
      const currentItem = document.createElement("div");
      currentItem.className = `history-item ${currentChatId === 'current' ? 'active' : ''}`;
      currentItem.dataset.id = 'current';

      const currentTitleDiv = document.createElement("div");
      currentTitleDiv.className = "history-item-title";

      const currentTitleSpan = document.createElement("span");
      currentTitleSpan.textContent = "å½“å‰å¯¹è¯";
      currentTitleSpan.style.flex = '1';
      currentTitleSpan.style.cursor = 'pointer';

      const currentEditBtn = document.createElement("span");
      currentEditBtn.className = "history-item-edit";
      currentEditBtn.textContent = "âœï¸";
      currentEditBtn.title = "ç¼–è¾‘åç§°";
      currentEditBtn.onclick = (e) => {
        e.stopPropagation();
        editChatName('current', currentTitleSpan, currentEditBtn);
      };

      // åŒå‡»æ ‡é¢˜ä¹Ÿå¯ä»¥ç¼–è¾‘
      currentTitleSpan.ondblclick = (e) => {
        e.stopPropagation();
        editChatName('current', currentTitleSpan, currentEditBtn);
      };

      currentTitleDiv.appendChild(currentTitleSpan);
      currentTitleDiv.appendChild(currentEditBtn);

      const currentTimeDiv = document.createElement("div");
      currentTimeDiv.className = "history-item-time";
      currentTimeDiv.textContent = "è¿›è¡Œä¸­";

      currentItem.appendChild(currentTitleDiv);
      currentItem.appendChild(currentTimeDiv);
      currentItem.addEventListener("click", () => switchChat('current'));
      historyList.appendChild(currentItem);

      // æ·»åŠ å†å²å¯¹è¯ï¼ˆè¿‡æ»¤æ‰ç©ºçš„ä¼šè¯ï¼‰
      const sortedChats = Object.entries(chatHistory)
        .filter(([id]) => id !== 'current')
        .filter(([id, data]) => data.messages && data.messages.length > 0)  // åªæ˜¾ç¤ºæœ‰æ¶ˆæ¯çš„ä¼šè¯
        .sort((a, b) => new Date(b[1].time) - new Date(a[1].time));

      sortedChats.forEach(([chatId, chatData]) => {
        const item = document.createElement("div");
        item.className = `history-item ${currentChatId === chatId ? 'active' : ''}`;
        item.dataset.id = chatId;

        const titleDiv = document.createElement("div");
        titleDiv.className = "history-item-title";

        const titleSpan = document.createElement("span");
        titleSpan.textContent = chatData.title || 'æœªå‘½åå¯¹è¯';
        titleSpan.style.flex = '1';
        titleSpan.style.cursor = 'pointer';

        const editBtn = document.createElement("span");
        editBtn.className = "history-item-edit";
        editBtn.textContent = "âœï¸";
        editBtn.title = "ç¼–è¾‘åç§°";
        editBtn.onclick = (e) => {
          e.stopPropagation();
          editChatName(chatId, titleSpan, editBtn);
        };

        // åŒå‡»æ ‡é¢˜ä¹Ÿå¯ä»¥ç¼–è¾‘
        titleSpan.ondblclick = (e) => {
          e.stopPropagation();
          editChatName(chatId, titleSpan, editBtn);
        };

        titleDiv.appendChild(titleSpan);
        titleDiv.appendChild(editBtn);

        const timeDiv = document.createElement("div");
        timeDiv.className = "history-item-time";
        timeDiv.textContent = new Date(chatData.time).toLocaleString('zh-CN');

        item.appendChild(titleDiv);
        item.appendChild(timeDiv);
        item.addEventListener("click", () => switchChat(chatId));
        historyList.appendChild(item);
      });
    }

    // åˆ‡æ¢å¯¹è¯
    function switchChat(chatId) {
      // ä¿å­˜å½“å‰å¯¹è¯
      if (chatHistory[currentChatId]) {
        saveChatHistory();
      }

      // åˆ‡æ¢åˆ°æ–°å¯¹è¯
      currentChatId = chatId;

      // å¦‚æœå¯¹è¯ä¸å­˜åœ¨ï¼Œåˆ›å»ºæ–°å¯¹è¯
      if (!chatHistory[currentChatId]) {
        chatHistory[currentChatId] = {
          messages: [],
          title: chatId === 'current' ? "å½“å‰å¯¹è¯" : "æ–°å¯¹è¯",
          time: new Date().toISOString(),
          sessionId: null
        };
      } else {
        // å¦‚æœå¯¹è¯å­˜åœ¨ï¼Œæ¢å¤ä¼šè¯ID
        currentSessionId = chatHistory[currentChatId].sessionId || null;
      }

      // æ¸…ç©ºæ¶ˆæ¯æ˜¾ç¤ºåŒºåŸŸ
      chatMessages.innerHTML = '';

      // åŠ è½½å¯¹è¯æ¶ˆæ¯
      const messages = chatHistory[currentChatId].messages || [];
      if (messages.length === 0) {
        chatMessages.innerHTML = '<div class="empty-state"><p>ğŸ‘‹ å¼€å§‹å¯¹è¯å§ï¼è¾“å…¥æ–‡å­—æˆ–å½•åˆ¶è¯­éŸ³ä¸AIäº¤æµ</p></div>';
      } else {
        // ä¸´æ—¶ç¦ç”¨ä¿å­˜ï¼Œé¿å…é‡å¤ä¿å­˜
        const wasStreaming = isStreaming;
        isStreaming = true;

        messages.forEach(msg => {
          const messageDiv = addMessage(
            msg.text,
            msg.isUser,
            msg.audioBase64,
            msg.audioDuration,
            msg.messageId,
            msg.status || 'sent',
            { audioUrl: msg.audioUrl }
          );

          // å¦‚æœæ˜¯é”™è¯¯æ¶ˆæ¯ï¼Œæ·»åŠ é‡è¯•æŒ‰é’®
          if (!msg.isUser && msg.text.includes('âŒ')) {
            const retryBtn = document.createElement("button");
            retryBtn.className = "retry-btn";
            retryBtn.textContent = "ğŸ”„ é‡è¯•";
            retryBtn.onclick = () => {
              // æ‰¾åˆ°å¯¹åº”çš„ç”¨æˆ·æ¶ˆæ¯
              const userMsg = messages.find(m => m.isUser && messages.indexOf(m) < messages.indexOf(msg));
              if (userMsg) {
                sendMessage(userMsg.text, userMsg.messageId);
                messageDiv.remove();
              }
            };
            messageDiv.querySelector('.message-bubble').appendChild(retryBtn);
          }
        });

        // æ¢å¤æµå¼çŠ¶æ€
        isStreaming = wasStreaming;
      }

      // æ›´æ–°å†å²åˆ—è¡¨
      updateHistoryList();

      // å…³é—­ä¾§è¾¹æ 
      chatSidebar.classList.remove("active");
    }

    // æ–°å»ºå¯¹è¯
    newChatBtn.addEventListener("click", () => {
      const newChatId = `chat-${Date.now()}`;
      chatHistory[newChatId] = {
        messages: [],
        title: "æ–°å¯¹è¯",
        time: new Date().toISOString()
      };
      saveChatHistory();
      switchChat(newChatId);
    });

    // æ¸…ç©ºå½“å‰å¯¹è¯
    clearChatBtn.addEventListener("click", () => {
      if (confirm("ç¡®å®šè¦æ¸…ç©ºå½“å‰å¯¹è¯å—ï¼Ÿ")) {
        if (chatHistory[currentChatId]) {
          chatHistory[currentChatId].messages = [];
          chatHistory[currentChatId].title = "å½“å‰å¯¹è¯";
          chatHistory[currentChatId].time = new Date().toISOString();
          saveChatHistory();
        }
        chatMessages.innerHTML = '<div class="empty-state"><p>ğŸ‘‹ å¼€å§‹å¯¹è¯å§ï¼è¾“å…¥æ–‡å­—æˆ–å½•åˆ¶è¯­éŸ³ä¸AIäº¤æµ</p></div>';
        updateHistoryList();
      }
    });

    // å¯¼å‡ºå¯¹è¯è®°å½•
    exportChatBtn.addEventListener("click", () => {
      if (!chatHistory[currentChatId] || chatHistory[currentChatId].messages.length === 0) {
        alert("å½“å‰å¯¹è¯ä¸ºç©ºï¼Œæ— æ³•å¯¼å‡º");
        return;
      }

      const messages = chatHistory[currentChatId].messages;
      let exportText = `å¯¹è¯è®°å½• - ${new Date().toLocaleString('zh-CN')}\n`;
      exportText += "=".repeat(50) + "\n\n";

      messages.forEach(msg => {
        const role = msg.isUser ? "ç”¨æˆ·" : "AI";
        const time = new Date(msg.time).toLocaleString('zh-CN');
        exportText += `[${time}] ${role}:\n${msg.text}\n\n`;
      });

      // åˆ›å»ºä¸‹è½½é“¾æ¥
      const blob = new Blob([exportText], { type: 'text/plain;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `å¯¹è¯è®°å½•_${new Date().toISOString().slice(0, 10)}.txt`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    });

    // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨åŠ è½½å†å²èŠå¤©è®°å½•
    initChatHistory().then(() => {
      updateHistoryList();
    });

    // é¡µé¢å¸è½½æ—¶å–æ¶ˆæ­£åœ¨è¿›è¡Œçš„è¯·æ±‚ï¼ˆåªæœ‰çœŸæ­£å…³é—­æ ‡ç­¾é¡µæ—¶æ‰å–æ¶ˆï¼‰
    window.addEventListener('beforeunload', () => {
      if (abortController) {
        abortController.abort();
      }
    });

    // åˆå§‹åŒ–
    initHelp();
  </script>
</body>

</html>