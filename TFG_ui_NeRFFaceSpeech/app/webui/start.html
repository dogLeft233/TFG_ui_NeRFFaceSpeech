<!doctype html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>NeRFFaceSpeech - å¼€å§‹ç•Œé¢</title>
    <link rel="stylesheet" href="style.css" onerror="console.warn('style.css åŠ è½½å¤±è´¥ï¼Œé¡µé¢å¯èƒ½æ— æ³•æ­£å¸¸æ˜¾ç¤º')">
    <script src="settings.js" onerror="console.warn('settings.js åŠ è½½å¤±è´¥ï¼Œé¡µé¢å°†ä½¿ç”¨é»˜è®¤è®¾ç½®'); window.settingsJsFailed = true;"></script>
    <script src="api.js" onerror="console.warn('api.js åŠ è½½å¤±è´¥ï¼Œéƒ¨åˆ†åŠŸèƒ½å¯èƒ½ä¸å¯ç”¨'); window.apiJsFailed = true;"></script>
    <script>
        // å…¨å±€é”™è¯¯å¤„ç† - å¿…é¡»åœ¨å…¶ä»–è„šæœ¬ä¹‹å‰å®šä¹‰
        window.addEventListener('error', function(e) {
            console.error('[start.html] å…¨å±€é”™è¯¯:', {
                message: e.message,
                filename: e.filename,
                lineno: e.lineno,
                colno: e.colno,
                error: e.error
            });
            // ä¸é˜»æ­¢é”™è¯¯ä¼ æ’­ï¼Œä½†è®°å½•è¯¦ç»†ä¿¡æ¯
        }, true);
        
        // æœªå¤„ç†çš„Promiseæ‹’ç»
        window.addEventListener('unhandledrejection', function(e) {
            console.error('[start.html] æœªå¤„ç†çš„Promiseæ‹’ç»:', e.reason);
            // ä¸é˜»æ­¢é»˜è®¤è¡Œä¸ºï¼Œä½†è®°å½•é”™è¯¯
        });
        
        // ç«‹å³è¾“å‡ºæ—¥å¿—ï¼Œç¡®è®¤è„šæœ¬å¼€å§‹æ‰§è¡Œ
        console.log('[start.html] è„šæœ¬å¼€å§‹æ‰§è¡Œï¼Œæ—¶é—´:', new Date().toISOString());
    </script>
</head>

<body>
    <!-- ç«‹å³æ˜¾ç¤ºåŸºæœ¬å†…å®¹ï¼Œé˜²æ­¢é¡µé¢å®Œå…¨ç©ºç™½ -->
    <script>
        // ç«‹å³æ‰§è¡Œï¼Œç¡®ä¿å³ä½¿å¤–éƒ¨è„šæœ¬å¤±è´¥ï¼Œé¡µé¢ä¹Ÿæœ‰åŸºæœ¬å†…å®¹
        (function() {
            try {
                console.log('[start.html] bodyè„šæœ¬å¼€å§‹æ‰§è¡Œ');
                // ç¡®ä¿bodyå†…å®¹å¯è§
                if (document.body) {
                    document.body.style.visibility = 'visible';
                    document.body.style.opacity = '1';
                }
            } catch(e) {
                console.error('[start.html] bodyè„šæœ¬æ‰§è¡Œé”™è¯¯:', e);
            }
        })();
    </script>
    
    <button class="settings-btn" id="settingsBtn">âš™ï¸ è®¾ç½®</button>

    <!-- ä¾§è¾¹æ é®ç½© -->
    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <!-- è®¾ç½®ä¾§è¾¹æ  -->
    <div class="sidebar" id="settingsSidebar">
        <div class="sidebar-content">
            <div class="sidebar-header">
                <h2>è®¾ç½®</h2>
                <button class="sidebar-close" id="sidebarClose">Ã—</button>
            </div>

            <div class="sidebar-tabs">
                <button class="sidebar-tab active" data-tab="theme">ä¸»é¢˜</button>
                <button class="sidebar-tab" data-tab="font">å­—ä½“</button>
            </div>

            <!-- ä¸»é¢˜è®¾ç½® -->
            <div class="tab-content active" id="themeTab">
                <div class="options-grid">
                    <div class="option-card" data-theme="tech">
                        <div class="option-name">ç§‘æŠ€é£</div>
                        <div class="option-desc">æ·±è“è‰²ç§‘æŠ€æ„Ÿ</div>
                    </div>
                    <div class="option-card" data-theme="warm">
                        <div class="option-name">æ¸©é¦¨é£</div>
                        <div class="option-desc">æš–è‰²è°ƒæ¸©é¦¨</div>
                    </div>
                    <div class="option-card" data-theme="minimal">
                        <div class="option-name">ç®€çº¦é£</div>
                        <div class="option-desc">ç°è‰²ç®€çº¦</div>
                    </div>
                </div>
            </div>

            <!-- å­—ä½“è®¾ç½® -->
            <div class="tab-content" id="fontTab">
                <div style="margin-bottom: 16px;">
                    <label
                        style="display: block; margin-bottom: 8px; color: var(--text); font-weight: 500;">å­—ä½“æ ·å¼</label>
                    <div class="options-grid">
                        <div class="option-card" data-font="SimSun">
                            <div class="option-name">å®‹ä½“</div>
                            <div class="option-desc">SimSun</div>
                        </div>
                        <div class="option-card" data-font="SimHei">
                            <div class="option-name">é»‘ä½“</div>
                            <div class="option-desc">SimHei</div>
                        </div>
                        <div class="option-card" data-font="Microsoft YaHei">
                            <div class="option-name">å¾®è½¯é›…é»‘</div>
                            <div class="option-desc">Microsoft YaHei</div>
                        </div>
                        <div class="option-card" data-font="Arial">
                            <div class="option-name">Arial</div>
                            <div class="option-desc">Arial</div>
                        </div>
                        <div class="option-card" data-font="Times New Roman">
                            <div class="option-name">Times New Roman</div>
                            <div class="option-desc">Times New Roman</div>
                        </div>
                        <div class="option-card" data-font="Inter">
                            <div class="option-name">Inter</div>
                            <div class="option-desc">Interï¼ˆé»˜è®¤ï¼‰</div>
                        </div>
                    </div>
                </div>

                <div>
                    <label
                        style="display: block; margin-bottom: 8px; color: var(--text); font-weight: 500;">å­—å·å¤§å°</label>
                    <div class="font-size-group">
                        <button class="font-size-btn" data-size="small">å°</button>
                        <button class="font-size-btn" data-size="medium">ä¸­</button>
                        <button class="font-size-btn" data-size="large">å¤§</button>
                        <button class="font-size-btn" data-size="custom">è‡ªå®šä¹‰</button>
                    </div>
                    <div class="font-size-custom" id="customSizeInput" style="display: none;">
                        <input type="number" id="customSizeValue" placeholder="è¾“å…¥å­—å·ï¼ˆpxï¼‰" min="10" max="24" value="14">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="header">
            <h1>NeRFFaceSpeech</h1>
            <p>AI é©±åŠ¨çš„è¯­éŸ³è§†é¢‘ç”Ÿæˆç³»ç»Ÿ</p>
        </div>

        <div class="cards">
            <!-- åç«¯å…¥å£ -->
            <div class="card" onclick="openBackendLogs()">
                <div class="card-icon">ğŸ–¥ï¸</div>
                <h2>åç«¯ç®¡ç†</h2>
                <p>æŸ¥çœ‹åç«¯è¾“å‡ºæ—¥å¿—å’Œç³»ç»ŸçŠ¶æ€<br>ç›‘æ§ç³»ç»Ÿè¿è¡ŒçŠ¶æ€</p>
                <div class="card-url" id="backendUrl">http://localhost:8000/</div>
                <div class="card-actions" onclick="event.stopPropagation()">
                    <button class="card-btn secondary" onclick="openBackendDocs()">ğŸ“– API æ–‡æ¡£</button>
                </div>
            </div>

            <!-- å‰ç«¯åº”ç”¨å…¥å£ -->
            <div class="card" onclick="openFrontend()">
                <div class="card-icon">ğŸ¨</div>
                <h2>å‰ç«¯åº”ç”¨</h2>
                <p>ä½¿ç”¨æ ¸å¿ƒåŠŸèƒ½æ¨¡å—<br>è§†é¢‘ç”Ÿæˆã€å¯¹è¯ã€è®­ç»ƒ</p>
                <div class="card-url">Web UI</div>
                <div class="card-actions" onclick="event.stopPropagation()">
                    <button class="card-btn secondary" onclick="openGuide()">ğŸ“– æ“ä½œæŒ‡å—</button>
                </div>
            </div>
        </div>

        <!-- çŠ¶æ€æ£€æŸ¥ -->
        <div class="status">
            <div class="status-item">
                <span class="status-label">åç«¯æœåŠ¡å™¨</span>
                <span class="status-value">
                    <span class="status-dot" id="backendStatus"></span>
                    <span id="backendText">æ£€æŸ¥ä¸­...</span>
                </span>
            </div>
            <div class="status-item">
                <span class="status-label">å‰ç«¯æœåŠ¡å™¨</span>
                <span class="status-value">
                    <span class="status-dot active"></span>
                    <span>è¿è¡Œä¸­</span>
                </span>
            </div>
        </div>

        <!-- API åœ°å€é…ç½® -->
        <div class="api-config" id="apiConfig" style="display: none;">
            <div class="config-card">
                <h3>é…ç½®åç«¯åœ°å€</h3>
                <p class="config-desc">å¦‚æœåç«¯åœ¨è¿œç¨‹æœåŠ¡å™¨æˆ–ä½¿ç”¨äº†ç«¯å£è½¬å‘ï¼Œè¯·åœ¨æ­¤é…ç½®</p>
                <div class="config-input-group">
                    <label for="apiUrlInput">åç«¯ API åœ°å€ï¼š</label>
                    <input type="text" id="apiUrlInput" placeholder="http://localhost:8000"
                        value="http://localhost:8000">
                    <div class="config-hint">
                        <p>ğŸ’¡ æç¤ºï¼š</p>
                        <ul>
                            <li>å¦‚æœä½¿ç”¨ç«¯å£è½¬å‘ï¼ˆå¦‚ï¼š<code>ssh -L 8000:localhost:8000</code>ï¼‰ï¼Œä½¿ç”¨
                                <code>http://localhost:8000</code>
                            </li>
                            <li>å¦‚æœåç«¯åœ¨è¿œç¨‹æœåŠ¡å™¨ï¼Œä½¿ç”¨ <code>http://æœåŠ¡å™¨IP:8000</code></li>
                            <li>ä¹Ÿå¯ä»¥é€šè¿‡ URL å‚æ•°è®¾ç½®ï¼š<code>?api_url=http://your-server:8000</code></li>
                        </ul>
                    </div>
                    <div class="config-buttons">
                        <button class="btn-save" onclick="saveApiUrl()">ä¿å­˜</button>
                        <button class="btn-cancel" onclick="cancelApiConfig()">å–æ¶ˆ</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="footer">
            <span>åŒ—äº¬ç†å·¥å¤§å­¦ Â· NeRFFaceSpeech å›¢é˜Ÿ</span>
            <span style="margin-left: 20px;">
                <a href="#" onclick="showApiConfig(); return false;"
                    style="color: var(--muted); text-decoration: none; font-size: 12px;">
                    âš™ï¸ é…ç½®åç«¯åœ°å€
                </a>
            </span>
        </div>
    </div>

    <script>
        // è·å– API åœ°å€çš„å‡½æ•°ï¼ˆä¾›å…¨å±€ä½¿ç”¨ï¼‰
        function getApiUrl() {
            if (typeof window !== 'undefined') {
                if (window.API_BASE_URL) return window.API_BASE_URL;
                if (window.getApiBaseUrl) return window.getApiBaseUrl();
            }
            const saved = localStorage.getItem('API_BASE_URL');
            return saved || 'http://localhost:8000';
        }

        // ç­‰å¾…é¡µé¢åŠ è½½å®Œæˆ
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('[start.html] DOMContentLoaded äº‹ä»¶è§¦å‘ï¼Œæ—¶é—´:', new Date().toISOString());
            console.log('[start.html] é¡µé¢å…ƒç´ æ•°é‡:', document.querySelectorAll('*').length);
            
            // å®šä¹‰é»˜è®¤è®¾ç½®
            const defaultSettings = {
                nerf_theme: "tech",
                nerf_font: "Inter",
                nerf_font_size: "medium",
                nerf_custom_font_size: "14"
            };
            
            // ç«‹å³åº”ç”¨é»˜è®¤è®¾ç½®ï¼Œç¡®ä¿é¡µé¢å¯ä»¥ç«‹å³æ˜¾ç¤ºï¼ˆä½¿ç”¨setTimeouté¿å…é˜»å¡ï¼‰
            setTimeout(() => {
                try {
                    if (typeof applySettingsOnly === 'function') {
                        applySettingsOnly(defaultSettings).catch(e => {
                            console.error('åº”ç”¨é»˜è®¤è®¾ç½®å¤±è´¥:', e);
                        });
                    } else {
                        console.warn('applySettingsOnly å‡½æ•°ä¸å¯ç”¨ï¼Œè·³è¿‡è®¾ç½®åº”ç”¨');
                    }
                } catch (e) {
                    console.error('åº”ç”¨é»˜è®¤è®¾ç½®å¼‚å¸¸:', e);
                }
            }, 0);
            
            // ç„¶åå¼‚æ­¥å°è¯•ä»æ•°æ®åº“è·å–è®¾ç½®ï¼ˆä¸é˜»å¡é¡µé¢æ˜¾ç¤ºï¼‰
            setTimeout(async () => {
                try {
                    console.log('[start.html] å¼€å§‹è·å–è®¾ç½®...');
                    
                    if (typeof fetchSettings !== 'function') {
                        console.warn('[start.html] fetchSettings å‡½æ•°ä¸å¯ç”¨ï¼Œä½¿ç”¨é»˜è®¤è®¾ç½®');
                        return;
                    }
                    
                    // è®¾ç½®è¶…æ—¶ä¿æŠ¤
                    const settingsPromise = fetchSettings().catch(err => {
                        console.warn('âš ï¸ fetchSettings å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤è®¾ç½®:', err);
                        return defaultSettings;
                    });
                    
                    const timeoutPromise = new Promise((resolve) => {
                        setTimeout(() => {
                            console.warn('âš ï¸ è·å–è®¾ç½®è¶…æ—¶ï¼ˆ3ç§’ï¼‰ï¼Œä½¿ç”¨é»˜è®¤è®¾ç½®');
                            resolve(defaultSettings);
                        }, 3000); // 3ç§’è¶…æ—¶
                    });
                    
                    const settings = await Promise.race([settingsPromise, timeoutPromise]);
                    console.log('[start.html] è®¾ç½®è·å–å®Œæˆ:', settings);
                    
                    // åº”ç”¨ä»æ•°æ®åº“è·å–çš„è®¾ç½®
                    if (typeof applySettingsOnly === 'function') {
                        await applySettingsOnly(settings).catch(e => console.error('åº”ç”¨è®¾ç½®å¤±è´¥:', e));
                    }
                    if (typeof updateThemeSelection === 'function') {
                        await updateThemeSelection(settings).catch(e => console.error('æ›´æ–°ä¸»é¢˜é€‰æ‹©å¤±è´¥:', e));
                    }
                    if (typeof updateFontSelection === 'function') {
                        await updateFontSelection(settings).catch(e => console.error('æ›´æ–°å­—ä½“é€‰æ‹©å¤±è´¥:', e));
                    }
                    if (typeof updateFontSizeSelection === 'function') {
                        await updateFontSizeSelection(settings).catch(e => console.error('æ›´æ–°å­—å·é€‰æ‹©å¤±è´¥:', e));
                    }
            } catch (error) {
                    console.error('å¼‚æ­¥è·å–è®¾ç½®å¤±è´¥:', error);
                    // å¤±è´¥ä¸å½±å“é¡µé¢æ˜¾ç¤º
                }
            }, 100);

            // è®¾ç½®ä¾§è¾¹æ æ§åˆ¶
            const settingsBtn = document.getElementById('settingsBtn');
            const settingsSidebar = document.getElementById('settingsSidebar');
            const sidebarOverlay = document.getElementById('sidebarOverlay');
            const sidebarClose = document.getElementById('sidebarClose');

            if (settingsBtn && settingsSidebar) {
                const openSidebar = () => {
                    settingsSidebar.classList.add('active');
                    sidebarOverlay.classList.add('active');
                };

                const closeSidebar = () => {
                    settingsSidebar.classList.remove('active');
                    sidebarOverlay.classList.remove('active');
                };

                settingsBtn.addEventListener('click', openSidebar);
                if (sidebarClose) sidebarClose.addEventListener('click', closeSidebar);
                if (sidebarOverlay) sidebarOverlay.addEventListener('click', closeSidebar);

                // æ ‡ç­¾åˆ‡æ¢
                document.querySelectorAll('.sidebar-tab').forEach(tab => {
                    tab.addEventListener('click', () => {
                        const targetTab = tab.dataset.tab;
                        document.querySelectorAll('.sidebar-tab').forEach(t => t.classList.remove('active'));
                        document.querySelectorAll('.sidebar .tab-content').forEach(c => c.classList.remove('active'));
                        tab.classList.add('active');
                        const targetContent = document.getElementById(targetTab + 'Tab');
                        if (targetContent) targetContent.classList.add('active');
                    });
                });

                // ä¸»é¢˜é€‰æ‹©
                document.querySelectorAll('[data-theme]').forEach(card => {
                    card.addEventListener('click', () => {
                        applyTheme(card.dataset.theme);
                    });
                });

                // å­—ä½“é€‰æ‹©
                document.querySelectorAll('[data-font]').forEach(card => {
                    card.addEventListener('click', () => {
                        applyFont(card.dataset.font);
                    });
                });

                // å­—å·é€‰æ‹©
                document.querySelectorAll('[data-size]').forEach(btn => {
                    btn.addEventListener('click', () => {
                        if (btn.dataset.size === 'custom') {
                            const customInput = document.getElementById('customSizeInput');
                            if (customInput) customInput.style.display = 'block';
                        } else {
                            const customInput = document.getElementById('customSizeInput');
                            if (customInput) customInput.style.display = 'none';
                            applyFontSize(btn.dataset.size);
                        }
                    });
                });

                // è‡ªå®šä¹‰å­—å·è¾“å…¥
                const customSizeInput = document.getElementById('customSizeValue');
                if (customSizeInput) {
                    customSizeInput.addEventListener('change', () => {
                        applyFontSize('custom');
                    });
                }
            }

            // æ›´æ–°åç«¯ URL æ˜¾ç¤º
            const apiUrl = getApiUrl();
            document.getElementById('backendUrl').textContent = apiUrl + '/';

            // åœ¨æ§åˆ¶å°æ‰“å°åç«¯åœ°å€
            console.log('========================================');
            console.log('ğŸ”— åç«¯ API åœ°å€ä¿¡æ¯');
            console.log('========================================');
            console.log('åç«¯åœ°å€:', apiUrl);
            console.log('API æ–‡æ¡£:', apiUrl + '/docs');
            console.log('æ¥æº:', (() => {
                if (window.API_BASE_URL && window.API_BASE_URL === apiUrl) {
                    return 'settings.js (window.API_BASE_URL)';
                }
                if (window.getApiBaseUrl && window.getApiBaseUrl() === apiUrl) {
                    return 'api.js (getApiBaseUrl())';
                }
                const saved = localStorage.getItem('API_BASE_URL');
                if (saved === apiUrl) {
                    return 'localStorage';
                }
                return 'é»˜è®¤å€¼';
            })());
            console.log('========================================');

            // æ£€æŸ¥åç«¯çŠ¶æ€
            async function checkBackendStatus() {
                const statusDot = document.getElementById('backendStatus');
                const statusText = document.getElementById('backendText');

                // å…ˆæ˜¾ç¤ºæ£€æŸ¥ä¸­çŠ¶æ€
                statusText.textContent = 'æ£€æŸ¥ä¸­...';
                statusText.style.color = '#9ca3af'; // muted color

                try {
                    // ä½¿ç”¨ api.js ä¸­çš„ checkBackendConnection å‡½æ•°ï¼ˆå¦‚æœå·²åŠ è½½ï¼‰
                    if (typeof checkBackendConnection === 'function') {
                        const isConnected = await checkBackendConnection();

                        if (isConnected) {
                            // è¿æ¥æˆåŠŸ
                            statusDot.classList.add('active');
                            statusText.textContent = 'âœ… è¿æ¥æˆåŠŸ';
                            statusText.style.color = '#4ade80';
                        } else {
                            // è¿æ¥å¤±è´¥
                            statusDot.classList.remove('active');
                            statusText.textContent = 'âŒ è¿æ¥å¤±è´¥';
                            statusText.style.color = '#ef4444';
                        }
                    } else {
                        // å¦‚æœ api.js æœªåŠ è½½ï¼Œç›´æ¥ä½¿ç”¨ fetch
                        const currentApiUrl = getApiUrl();
                        const response = await fetch(`${currentApiUrl}/docs`, {
                            method: 'GET',
                            mode: 'cors',
                            cache: 'no-cache',
                            signal: AbortSignal.timeout(3000)
                        });

                        if (response.ok) {
                            statusDot.classList.add('active');
                            statusText.textContent = 'âœ… è¿æ¥æˆåŠŸ';
                            statusText.style.color = '#4ade80';
                        } else {
                            statusDot.classList.remove('active');
                            statusText.textContent = `âŒ è¿æ¥å¤±è´¥ (${response.status})`;
                            statusText.style.color = '#ef4444';
                        }
                    }
                } catch (error) {
                    // ç½‘ç»œé”™è¯¯æˆ–è¶…æ—¶
                    statusDot.classList.remove('active');

                    if (error.name === 'AbortError' || error.name === 'TimeoutError') {
                        statusText.textContent = 'â±ï¸ è¿æ¥è¶…æ—¶';
                        statusText.style.color = '#f59e0b';
                    } else if (error.message && error.message.includes('Failed to fetch')) {
                        statusText.textContent = 'âŒ æ— æ³•è¿æ¥';
                        statusText.style.color = '#ef4444';
                    } else {
                        statusText.textContent = 'âŒ è¿æ¥å¤±è´¥';
                        statusText.style.color = '#ef4444';
                    }
                }
            }

            // æ‰“å¼€åç«¯è¾“å‡ºæ—¥å¿—ï¼ˆé»˜è®¤ï¼‰
            window.openBackendLogs = function () {
                window.open('logs.html', '_blank');
            };

            // æ‰“å¼€åç«¯ API æ–‡æ¡£
            window.openBackendDocs = function (e) {
                if (e) e.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡
                const currentApiUrl = getApiUrl();
                window.open(`${currentApiUrl}/docs`, '_blank');
            };

            // æ‰“å¼€æ•°æ®åº“é¡µé¢
            window.openDatabase = function (e) {
                if (e) e.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡
                window.open('database.html', '_blank');
            };

            // æ‰“å¼€å‰ç«¯åº”ç”¨
            window.openFrontend = function () {
                window.open('index.html', '_blank');
            };

            // æ‰“å¼€æ“ä½œæŒ‡å—
            window.openGuide = function (e) {
                if (e) e.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡
                window.open('guide.html', '_blank');
            };

            // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥çŠ¶æ€ï¼ˆä½¿ç”¨setTimeouté¿å…é˜»å¡ï¼‰
            setTimeout(() => {
                checkBackendStatus().catch(e => {
                    console.error('æ£€æŸ¥åç«¯çŠ¶æ€å¤±è´¥:', e);
                });
            }, 100);
            
            // æ¯5ç§’æ£€æŸ¥ä¸€æ¬¡
            setInterval(() => {
                checkBackendStatus().catch(e => {
                    console.error('å®šæœŸæ£€æŸ¥åç«¯çŠ¶æ€å¤±è´¥:', e);
                });
            }, 5000);

            // æ£€æŸ¥ URL å‚æ•°ä¸­æ˜¯å¦æœ‰ api_url
            const urlParams = new URLSearchParams(window.location.search);
            const apiUrlFromUrl = urlParams.get('api_url') || urlParams.get('apiUrl');
            if (apiUrlFromUrl) {
                console.log('ä» URL å‚æ•°æ£€æµ‹åˆ°åç«¯åœ°å€:', apiUrlFromUrl);
                // æ›´æ–°æ˜¾ç¤º
                document.getElementById('backendUrl').textContent = apiUrlFromUrl + '/';
                // ä¿å­˜åˆ° localStorage
                localStorage.setItem('API_BASE_URL', apiUrlFromUrl);
                // æ›´æ–° window.API_BASE_URLï¼ˆå¦‚æœ settings.js å·²åŠ è½½ï¼‰
                if (window.API_BASE_URL) {
                    window.API_BASE_URL = apiUrlFromUrl;
                }
                // é‡æ–°æ£€æŸ¥è¿æ¥
                checkBackendStatus().catch(e => {
                    console.error('é‡æ–°æ£€æŸ¥åç«¯çŠ¶æ€å¤±è´¥:', e);
                });
            }
        });

        // æ˜¾ç¤º API é…ç½®ç•Œé¢
        function showApiConfig() {
            const configDiv = document.getElementById('apiConfig');
            const input = document.getElementById('apiUrlInput');
            const currentUrl = getApiUrl();
            input.value = currentUrl;
            configDiv.style.display = 'block';
            // æ»šåŠ¨åˆ°é…ç½®åŒºåŸŸ
            configDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        // ä¿å­˜ API åœ°å€
        function saveApiUrl() {
            const input = document.getElementById('apiUrlInput');
            const newUrl = input.value.trim();

            if (!newUrl) {
                alert('è¯·è¾“å…¥åç«¯åœ°å€');
                return;
            }

            // éªŒè¯ URL æ ¼å¼
            try {
                new URL(newUrl);
            } catch (e) {
                alert('è¯·è¾“å…¥æœ‰æ•ˆçš„ URL åœ°å€ï¼ˆä¾‹å¦‚ï¼šhttp://localhost:8000ï¼‰');
                return;
            }

            // ä¿å­˜åˆ° localStorage
            localStorage.setItem('API_BASE_URL', newUrl);

            // æ›´æ–° window.API_BASE_URL
            if (window.API_BASE_URL) {
                window.API_BASE_URL = newUrl;
            }

            // æ›´æ–°æ˜¾ç¤º
            document.getElementById('backendUrl').textContent = newUrl + '/';

            // éšè—é…ç½®ç•Œé¢
            document.getElementById('apiConfig').style.display = 'none';

            // é‡æ–°æ£€æŸ¥è¿æ¥
            checkBackendStatus();

            // æ˜¾ç¤ºæˆåŠŸæç¤º
            alert('åç«¯åœ°å€å·²æ›´æ–°ä¸ºï¼š' + newUrl + '\næ­£åœ¨é‡æ–°æ£€æŸ¥è¿æ¥...');

            // åˆ·æ–°é¡µé¢ä»¥åº”ç”¨æ–°é…ç½®
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        }

        // å–æ¶ˆé…ç½®
        function cancelApiConfig() {
            document.getElementById('apiConfig').style.display = 'none';
        }
    </script>
</body>

</html>