<!doctype html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>è¯­éŸ³å¯¹è¯ - NeRFFaceSpeech</title>
    <link rel="stylesheet" href="style.css">
    <script src="settings.js"></script>
    <script src="api.js"></script>
    <style>
        :root {
        --primary: #1e40af;
        --primary-2: #3b82f6;
        --bg: #0b1020;
        --card: rgba(255, 255, 255, 0.06);
        --border: rgba(255, 255, 255, 0.14);
        --text: #e5e7eb;
        --muted: #9ca3af;
        --g1: rgba(59, 130, 246, 0.16);
        --g2: rgba(14, 165, 233, 0.14);
        --g3: rgba(56, 189, 248, 0.12);
        --card-bg: rgb(24, 66, 134);
        --base-font-size: 14px;
        }

        body.theme-tech {
        --primary: #1e40af;
        --primary-2: #3b82f6;
        --bg: #0b1020;
        --card: rgba(255, 255, 255, 0.06);
        --border: rgba(255, 255, 255, 0.14);
        --text: #e5e7eb;
        --muted: #9ca3af;
        --g1: rgba(59, 130, 246, 0.16);
        --g2: rgba(14, 165, 233, 0.14);
        --g3: rgba(56, 189, 248, 0.12);
        --card-bg: rgb(24, 66, 134);
        }

        body.theme-warm {
            --primary: #f97316;
            --primary-2: #ea580c;
            --bg: #fff8f0;
            --card: rgba(255, 255, 255, 0.9);
            --border: rgba(249, 115, 22, 0.2);
            --text: #1f2937;
            --muted: #6b7280;
            --g1: rgba(251, 191, 36, 0.15);
            --g2: rgba(249, 115, 22, 0.12);
            --g3: rgba(234, 88, 12, 0.1);
            --card-bg: rgba(251, 191, 36, 0.15);
        }

        body.theme-minimal {
            --primary: #6b7280;
            --primary-2: #4b5563;
            --bg: #f5f5f5;
            --card: #ffffff;
            --border: #e5e7eb;
            --text: #111827;
            --muted: #6b7280;
            --g1: rgba(107, 114, 128, 0.08);
            --g2: rgba(75, 85, 99, 0.07);
            --g3: rgba(156, 163, 175, 0.06);
            --card-bg: rgba(107, 114, 128, 0.1);
        }

        html {
            font-size: var(--base-font-size);
        }

        body {
            margin: 0;
            font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background: radial-gradient(circle at 20% 20%, var(--g1), transparent 25%),
                radial-gradient(circle at 80% 30%, var(--g2), transparent 25%),
                radial-gradient(circle at 50% 80%, var(--g3), transparent 22%),
                var(--bg);
            color: var(--text);
            min-height: 100vh;
        }

        .page {
            max-width: 1400px;
            width: 94vw;
            margin: 0 auto;
            padding: 20px 24px 40px;
            min-height: 96vh;
        }

        header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            margin-bottom: 16px;
        }

        h1 {
            margin: 0;
            font-size: 24px;
            letter-spacing: 0.4px;
        }

        .back-btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 16px;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid var(--border);
            color: var(--text);
            text-decoration: none;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .back-btn:hover {
            background: rgba(255, 255, 255, 0.12);
            border-color: var(--primary-2);
        }

        .card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 18px;
            box-shadow: 0 12px 32px rgba(0, 0, 0, 0.25);
        }

        .grid {
            display: grid;
            grid-template-columns: 520px 1fr;
            gap: 18px;
            align-items: start;
        }

        @media (max-width: 1200px) {
            .grid {
                grid-template-columns: 1fr;
            }
        }

        label {
            font-weight: 700;
            margin-bottom: 6px;
            display: block;
        }

        input,
        select,
        textarea {
            width: 100%;
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 12px 14px;
            font-size: 15px;
            background: var(--card-bg);
            color: var(--text);
            outline: none;
            transition: border-color .15s ease, box-shadow .15s ease;
        }

        input:focus,
        select:focus,
        textarea:focus {
            border-color: rgba(96, 165, 250, 0.8);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.25);
        }

        textarea {
            min-height: 80px;
            resize: vertical;
        }

        button.primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-2));
            border: 1px solid var(--primary-2);
            color: #fff;
            font-weight: 700;
            border-radius: 12px;
            padding: 12px 14px;
            cursor: pointer;
            width: 100%;
            transition: opacity 0.2s ease;
        }

        button.primary:hover:not(:disabled) {
            opacity: 0.9;
        }

        button.secondary {
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid var(--border);
            color: var(--text);
            font-weight: 600;
            border-radius: 12px;
            padding: 12px 14px;
            cursor: pointer;
            width: 100%;
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .muted {
            color: var(--muted);
            font-size: 13px;
        }

        .status-box {
            background: #0f172a;
            color: #e2e8f0;
            padding: 12px;
            border-radius: 12px;
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
            min-height: 60px;
            white-space: pre-wrap;
            word-break: break-all;
            font-size: 13px;
        }

        .video-container {
            position: relative;
            width: 100%;
            background: #000;
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 16px;
        }

        .video-container video {
            width: 100%;
            display: block;
        }

        .video-placeholder {
            width: 100%;
            aspect-ratio: 16/9;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(0, 0, 0, 0.3);
            color: var(--muted);
            font-size: 16px;
            border-radius: 12px;
        }

        .hidden {
            display: none !important;
        }

        .progress-container {
            margin-top: 12px;
            margin-bottom: 12px;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 8px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--primary-2));
            width: 0%;
            transition: width 0.3s ease;
            border-radius: 4px;
        }

        .progress-text {
            font-size: 13px;
            color: var(--muted);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .video-controls {
            display: flex;
            gap: 8px;
            margin-top: 12px;
            flex-wrap: wrap;
        }

        .video-controls button {
            flex: 1;
            min-width: 100px;
        }

        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 12px;
            background: var(--card);
            border: 1px solid var(--border);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .btn-group {
            display: flex;
            gap: 8px;
        }

        .btn-group button {
            flex: 1;
        }

        /* éŸ³é¢‘è¾“å…¥åŒºåŸŸæ ·å¼ */
        .audio-input-section {
            margin-top: 18px;
            padding-top: 18px;
            border-top: 1px solid var(--border);
        }

        .input-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }

        .tab-btn {
            flex: 1;
            padding: 10px;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.04);
            color: var(--text);
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 14px;
            font-weight: 600;
        }

        .tab-btn.active {
            background: rgba(59, 130, 246, 0.2);
            border-color: var(--primary-2);
            color: var(--primary-2);
        }

        .tab-btn:hover:not(.active) {
            background: rgba(255, 255, 255, 0.08);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* éº¦å…‹é£å½•éŸ³æŒ‰é’® */
        .record-btn {
            width: 100%;
            padding: 16px;
            border-radius: 12px;
            border: 2px solid var(--border);
            background: rgba(255, 255, 255, 0.08);
            color: var(--text);
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .record-btn:hover:not(:disabled) {
            background: rgba(255, 255, 255, 0.12);
            border-color: var(--primary-2);
        }

        .record-btn.recording {
            background: rgba(239, 68, 68, 0.2);
            border-color: #ef4444;
            color: #ef4444;
            animation: pulse 1.5s ease-in-out infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.7;
            }
        }

        /* æ–‡ä»¶ä¸Šä¼ åŒºåŸŸ */
        .file-upload-area {
            border: 2px dashed var(--border);
            border-radius: 12px;
            padding: 24px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            background: rgba(255, 255, 255, 0.04);
        }

        .file-upload-area:hover {
            border-color: var(--primary-2);
            background: rgba(255, 255, 255, 0.08);
        }

        .file-upload-area.dragover {
            border-color: var(--primary-2);
            background: rgba(59, 130, 246, 0.1);
        }

        .file-input {
            display: none;
        }

        .file-info {
            margin-top: 12px;
            padding: 8px;
            background: rgba(255, 255, 255, 0.06);
            border-radius: 8px;
            font-size: 13px;
            color: var(--muted);
        }

        .audio-preview {
            margin-top: 12px;
            width: 100%;
        }

        .audio-preview audio {
            width: 100%;
        }

        /* è¯†åˆ«æ–‡æœ¬æ˜¾ç¤º */
        .recognized-text {
            margin-top: 12px;
            padding: 12px;
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: 8px;
            font-size: 14px;
            color: var(--text);
            min-height: 40px;
        }

        .recognized-text.empty {
            color: var(--muted);
            font-style: italic;
        }

        /* è®¾ç½®æŒ‰é’® */
        .settings-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            padding: 10px 16px;
            border-radius: 10px;
            border: 1px solid var(--border);
            background: var(--card-bg);
            color: var(--text);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .settings-btn:hover {
            background: var(--primary);
            color: #fff;
            border-color: var(--primary);
        }

        /* ä¾§è¾¹æ é®ç½© */
        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.4);
            z-index: 2000;
            transition: opacity 0.3s ease;
        }

        .sidebar-overlay.active {
            display: block;
        }

        /* ä¾§è¾¹æ  */
        .sidebar {
            position: fixed;
            top: 0;
            right: -400px;
            width: 400px;
            height: 100vh;
            background: var(--bg);
            border-left: 1px solid var(--border);
            z-index: 2001;
            transition: right 0.3s ease;
            overflow-y: auto;
            box-shadow: -4px 0 20px rgba(0, 0, 0, 0.2);
        }

        .sidebar.active {
            right: 0;
        }

        .sidebar-content {
            padding: 24px;
        }

        .sidebar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border);
        }

        .sidebar-header h2 {
            margin: 0;
            font-size: 20px;
            color: var(--text);
        }

        .sidebar-close {
            background: none;
            border: none;
            font-size: 28px;
            color: var(--muted);
            cursor: pointer;
            padding: 0;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            transition: all 0.2s ease;
        }

        .sidebar-close:hover {
            background: var(--card-bg);
            color: var(--text);
        }

        /* åˆ†é¡µæ ‡ç­¾ */
        .sidebar-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--border);
        }

        .sidebar-tab {
            padding: 10px 20px;
            background: none;
            border: none;
            border-bottom: 2px solid transparent;
            color: var(--muted);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .sidebar-tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        .sidebar-tab:hover {
            color: var(--text);
        }

        /* åˆ†é¡µå†…å®¹ */
        .sidebar .tab-content {
            display: none;
        }

        .sidebar .tab-content.active {
            display: block;
        }

        /* é€‰é¡¹ç½‘æ ¼ */
        .options-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 12px;
            margin-bottom: 20px;
        }

        .option-card {
            padding: 16px;
            border: 2px solid var(--border);
            border-radius: 12px;
            background: var(--card-bg);
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
        }

        .option-card:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .option-card.selected {
            border-color: var(--primary);
            background: var(--primary);
            color: #fff;
        }

        .option-card.selected .option-name {
            color: #fff;
        }

        .option-name {
            font-size: 14px;
            font-weight: 500;
            color: var(--text);
            margin-bottom: 4px;
        }

        .option-desc {
            font-size: 12px;
            color: var(--muted);
        }

        .option-card.selected .option-desc {
            color: rgba(255, 255, 255, 0.9);
        }

        /* å­—å·é€‰æ‹© */
        .font-size-group {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
        }

        .font-size-btn {
            flex: 1;
            padding: 12px;
            border: 2px solid var(--border);
            border-radius: 10px;
            background: var(--card-bg);
            color: var(--text);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .font-size-btn:hover {
            border-color: var(--primary);
        }

        .font-size-btn.selected {
            border-color: var(--primary);
            background: var(--primary);
            color: #fff;
        }

        .font-size-custom {
            margin-top: 16px;
        }

        .font-size-custom input {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: var(--card-bg);
            color: var(--text);
            font-size: 14px;
        }

        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                right: -100%;
            }
        }
    </style>
</head>

<body>
    <button class="settings-btn" id="settingsBtn">âš™ï¸ è®¾ç½®</button>

    <!-- ä¾§è¾¹æ é®ç½© -->
    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <!-- è®¾ç½®ä¾§è¾¹æ  -->
    <div class="sidebar" id="settingsSidebar">
        <div class="sidebar-content">
            <div class="sidebar-header">
                <h2>è®¾ç½®</h2>
                <button class="sidebar-close" id="sidebarClose">Ã—</button>
            </div>

            <div class="sidebar-tabs">
                <button class="sidebar-tab active" data-tab="theme">ä¸»é¢˜</button>
                <button class="sidebar-tab" data-tab="font">å­—ä½“</button>
            </div>

            <!-- ä¸»é¢˜è®¾ç½® -->
            <div class="tab-content active" id="themeTab">
                <div class="options-grid">
                    <div class="option-card" data-theme="tech">
                        <div class="option-name">ç§‘æŠ€é£</div>
                        <div class="option-desc">æ·±è“è‰²ç§‘æŠ€æ„Ÿ</div>
                    </div>
                    <div class="option-card" data-theme="warm">
                        <div class="option-name">æ¸©é¦¨é£</div>
                        <div class="option-desc">æš–è‰²è°ƒæ¸©é¦¨</div>
                    </div>
                    <div class="option-card" data-theme="minimal">
                        <div class="option-name">ç®€çº¦é£</div>
                        <div class="option-desc">ç°è‰²ç®€çº¦</div>
                    </div>
                </div>
            </div>

            <!-- å­—ä½“è®¾ç½® -->
            <div class="tab-content" id="fontTab">
                <div style="margin-bottom: 16px;">
                    <label
                        style="display: block; margin-bottom: 8px; color: var(--text); font-weight: 500;">å­—ä½“æ ·å¼</label>
                    <div class="options-grid">
                        <div class="option-card" data-font="SimSun">
                            <div class="option-name">å®‹ä½“</div>
                            <div class="option-desc">SimSun</div>
                        </div>
                        <div class="option-card" data-font="SimHei">
                            <div class="option-name">é»‘ä½“</div>
                            <div class="option-desc">SimHei</div>
                        </div>
                        <div class="option-card" data-font="Microsoft YaHei">
                            <div class="option-name">å¾®è½¯é›…é»‘</div>
                            <div class="option-desc">Microsoft YaHei</div>
                        </div>
                        <div class="option-card" data-font="Arial">
                            <div class="option-name">Arial</div>
                            <div class="option-desc">Arial</div>
                        </div>
                        <div class="option-card" data-font="Times New Roman">
                            <div class="option-name">Times New Roman</div>
                            <div class="option-desc">Times New Roman</div>
                        </div>
                        <div class="option-card" data-font="Inter">
                            <div class="option-name">Inter</div>
                            <div class="option-desc">Interï¼ˆé»˜è®¤ï¼‰</div>
                        </div>
                    </div>
                </div>

                <div>
                    <label
                        style="display: block; margin-bottom: 8px; color: var(--text); font-weight: 500;">å­—å·å¤§å°</label>
                    <div class="font-size-group">
                        <button class="font-size-btn" data-size="small">å°</button>
                        <button class="font-size-btn" data-size="medium">ä¸­</button>
                        <button class="font-size-btn" data-size="large">å¤§</button>
                        <button class="font-size-btn" data-size="custom">è‡ªå®šä¹‰</button>
                    </div>
                    <div class="font-size-custom" id="customSizeInput" style="display: none;">
                        <input type="number" id="customSizeValue" placeholder="è¾“å…¥å­—å·ï¼ˆpxï¼‰" min="10" max="24" value="14">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="page">
        <header>
            <a href="index.html" class="back-btn">â† è¿”å›é¦–é¡µ</a>
            <h1>ğŸ¤ è¯­éŸ³å¯¹è¯</h1>
            <div></div>
        </header>

        <div class="grid">
            <!-- å·¦ä¾§ï¼šè¾“å…¥åŒºåŸŸ -->
            <div>
                <div class="card">
                    <!-- è¾“å…¥æ–¹å¼åˆ‡æ¢ -->
                    <div class="input-tabs">
                        <button class="tab-btn active" onclick="switchTab('microphone')">ğŸ¤ éº¦å…‹é£</button>
                        <button class="tab-btn" onclick="switchTab('upload')">ğŸ“ ä¸Šä¼ éŸ³é¢‘</button>
                    </div>

                    <!-- éº¦å…‹é£è¾“å…¥ -->
                    <div id="microphoneTab" class="tab-content active">
                        <button class="record-btn" id="recordBtn" onclick="toggleRecording()">
                            <span id="recordIcon">ğŸ¤</span>
                            <span id="recordText">ç‚¹å‡»å¼€å§‹å½•éŸ³</span>
                        </button>
                        <div class="muted" style="margin-top: 8px; text-align: center;">
                            ç‚¹å‡»æŒ‰é’®å¼€å§‹å½•éŸ³ï¼Œå†æ¬¡ç‚¹å‡»åœæ­¢
                        </div>
                        <div id="recordingTime"
                            style="display: none; text-align: center; margin-top: 8px; color: #ef4444; font-weight: 600;">
                            å½•éŸ³ä¸­: 00:00
                        </div>
                    </div>

                    <!-- æ–‡ä»¶ä¸Šä¼ è¾“å…¥ -->
                    <div id="uploadTab" class="tab-content">
                        <div class="file-upload-area" id="fileUploadArea"
                            onclick="document.getElementById('audioFileInput').click()">
                            <div style="font-size: 48px; margin-bottom: 8px;">ğŸ“</div>
                            <div style="font-weight: 600; margin-bottom: 4px;">ç‚¹å‡»æˆ–æ‹–æ‹½éŸ³é¢‘æ–‡ä»¶åˆ°è¿™é‡Œ</div>
                            <div class="muted" style="font-size: 12px;">æ”¯æŒ WAV, MP3, M4A ç­‰æ ¼å¼</div>
                        </div>
                        <input type="file" id="audioFileInput" class="file-input" accept="audio/*"
                            onchange="handleFileSelect(event)">
                        <div id="fileInfo" class="file-info" style="display: none;"></div>
                        <div id="audioPreview" class="audio-preview" style="display: none;"></div>
                    </div>

                    <!-- è¯†åˆ«æ–‡æœ¬æ˜¾ç¤º -->
                    <div style="margin-top: 18px;">
                        <label>è¯†åˆ«æ–‡æœ¬</label>
                        <div class="recognized-text empty" id="recognizedText">ç­‰å¾…è¾“å…¥...</div>
                    </div>

                    <!-- è§’è‰²å’Œæ¨¡å‹é€‰æ‹© -->
                    <label for="characterInput" style="margin-top: 18px;">è§’è‰²</label>
                    <div class="btn-group" style="margin-bottom: 8px;">
                        <select id="characterInput">
                            <option value="">åŠ è½½ä¸­...</option>
                        </select>
                        <button class="secondary" id="refreshCharacterBtn" onclick="loadCharacters()">ğŸ”„</button>
                    </div>

                    <label for="modelSelect" style="margin-top: 18px;">æ¨¡å‹</label>
                    <div class="btn-group" style="margin-bottom: 8px;">
                        <select id="modelSelect">
                            <option value="">åŠ è½½ä¸­...</option>
                        </select>
                        <button class="secondary" id="refreshBtn" onclick="loadModels()">ğŸ”„</button>
                    </div>

                    <button class="primary" id="generateBtn" onclick="startGeneration()">ğŸš€ å¼€å§‹ç”Ÿæˆè§†é¢‘</button>
                    <button class="secondary" id="cancelBtn" onclick="cancelGeneration()"
                        style="display: none; margin-top: 8px;">âŒ ç»ˆæ­¢ä»»åŠ¡</button>

                    <div class="progress-container" id="progressContainer" style="display: none;">
                        <div class="progress-bar">
                            <div class="progress-fill" id="progressFill"></div>
                        </div>
                        <div class="progress-text">
                            <span id="progressText">å‡†å¤‡ä¸­...</span>
                            <span id="progressPercent">0%</span>
                        </div>
                    </div>

                    <div class="status-box" id="statusBox" style="margin-top: 12px;">ç­‰å¾…å¼€å§‹...</div>
                </div>
            </div>

            <!-- å³ä¾§ï¼šè§†é¢‘æ˜¾ç¤ºåŒºåŸŸ -->
            <div>
                <div class="card">
                    <div class="video-placeholder" id="videoPlaceholder">
                        ç­‰å¾…ç”Ÿæˆè§†é¢‘...
                    </div>

                    <div class="video-container hidden" id="videoContainer">
                        <video id="videoOutput" controls></video>
                    </div>

                    <div class="video-controls" id="videoControls" style="display: none; margin-top: 12px;">
                        <button class="secondary" onclick="downloadVideo()">ğŸ“¥ ä¸‹è½½è§†é¢‘</button>
                        <button class="secondary" onclick="fullscreenVideo()">ğŸ” å…¨å±</button>
                    </div>

                    <div id="videoInfo" style="display: none; margin-top: 12px; font-size: 13px; color: var(--muted);">
                        <div>ç”Ÿæˆæ—¶é—´: <span id="generationTime">-</span></div>
                        <div>ä»»åŠ¡ID: <span id="taskId">-</span></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentTaskId = null;
        let statusPollInterval = null;
        let mediaRecorder = null;
        let audioChunks = [];
        let isRecording = false;
        let recordingTimer = null;
        let recordingStartTime = null;
        let currentAudioBase64 = null;
        let currentAudioFile = null;

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', async () => {
            // åº”ç”¨è®¾ç½®ï¼ˆä»æ•°æ®åº“è¯»å–ï¼‰
            try {
                const settings = await fetchSettings();
                await Promise.all([
                    applySettingsOnly(settings),
                    updateThemeSelection(settings),
                    updateFontSelection(settings),
                    updateFontSizeSelection(settings)
                ]);
            } catch (error) {
                console.error('åº”ç”¨è®¾ç½®å¤±è´¥:', error);
            }

            // è®¾ç½®ä¾§è¾¹æ æ§åˆ¶
            const settingsBtn = document.getElementById('settingsBtn');
            const settingsSidebar = document.getElementById('settingsSidebar');
            const sidebarOverlay = document.getElementById('sidebarOverlay');
            const sidebarClose = document.getElementById('sidebarClose');

            if (settingsBtn && settingsSidebar) {
                const openSidebar = () => {
                    settingsSidebar.classList.add('active');
                    sidebarOverlay.classList.add('active');
                };

                const closeSidebar = () => {
                    settingsSidebar.classList.remove('active');
                    sidebarOverlay.classList.remove('active');
                };

                settingsBtn.addEventListener('click', openSidebar);
                if (sidebarClose) sidebarClose.addEventListener('click', closeSidebar);
                if (sidebarOverlay) sidebarOverlay.addEventListener('click', closeSidebar);

                // æ ‡ç­¾åˆ‡æ¢
                document.querySelectorAll('.sidebar-tab').forEach(tab => {
                    tab.addEventListener('click', () => {
                        const targetTab = tab.dataset.tab;
                        document.querySelectorAll('.sidebar-tab').forEach(t => t.classList.remove('active'));
                        document.querySelectorAll('.sidebar .tab-content').forEach(c => c.classList.remove('active'));
                        tab.classList.add('active');
                        const targetContent = document.getElementById(targetTab + 'Tab');
                        if (targetContent) targetContent.classList.add('active');
                    });
                });

                // ä¸»é¢˜é€‰æ‹©
                document.querySelectorAll('[data-theme]').forEach(card => {
                    card.addEventListener('click', () => {
                        applyTheme(card.dataset.theme);
                    });
                });

                // å­—ä½“é€‰æ‹©
                document.querySelectorAll('[data-font]').forEach(card => {
                    card.addEventListener('click', () => {
                        applyFont(card.dataset.font);
                    });
                });

                // å­—å·é€‰æ‹©
                document.querySelectorAll('[data-size]').forEach(btn => {
                    btn.addEventListener('click', () => {
                        if (btn.dataset.size === 'custom') {
                            const customInput = document.getElementById('customSizeInput');
                            if (customInput) customInput.style.display = 'block';
                        } else {
                            const customInput = document.getElementById('customSizeInput');
                            if (customInput) customInput.style.display = 'none';
                            applyFontSize(btn.dataset.size);
                        }
                    });
                });

                // è‡ªå®šä¹‰å­—å·è¾“å…¥
                const customSizeInput = document.getElementById('customSizeValue');
                if (customSizeInput) {
                    customSizeInput.addEventListener('change', () => {
                        applyFontSize('custom');
                    });
                }
            }

            // åŸæœ‰çš„åˆå§‹åŒ–ä»£ç 
            // å…ˆåŠ è½½è§’è‰²å’Œæ¨¡å‹åˆ—è¡¨ï¼Œç„¶åå†æ£€æŸ¥è¿è¡Œä¸­çš„ä»»åŠ¡
            await Promise.all([loadCharacters(), loadModels()]);
            checkRunningTask();
            setupFileUpload();
        });

        // åŠ è½½è§’è‰²åˆ—è¡¨ï¼ˆå¸¦è¶…æ—¶å¤„ç†ï¼‰
        async function loadCharacters() {
            const select = document.getElementById('characterInput');
            const refreshBtn = document.getElementById('refreshCharacterBtn');
            const isUserRefresh = refreshBtn && refreshBtn.disabled === false; // åˆ¤æ–­æ˜¯å¦æ˜¯ç”¨æˆ·ä¸»åŠ¨åˆ·æ–°

            try {
                if (refreshBtn) refreshBtn.disabled = true;
                select.innerHTML = '<option value="">åŠ è½½ä¸­...</option>';

                // api.js ä¸­å·²ç»è®¾ç½®äº† 5 ç§’è¶…æ—¶ï¼Œè¿™é‡Œç›´æ¥è°ƒç”¨å³å¯
                const characters = await getCharacters();

                if (characters.length === 0) {
                    select.innerHTML = '<option value="">æœªæ‰¾åˆ°è§’è‰²</option>';
                    if (isUserRefresh) {
                        showToast('æœªæ‰¾åˆ°å·²è®­ç»ƒçš„è§’è‰²', 'warning');
                    }
                    return;
                }

                select.innerHTML = characters.map(c => `<option value="${c}">${c}</option>`).join('');
                if (characters.length > 0) {
                    select.value = characters[0];
                }
            } catch (error) {
                console.error('åŠ è½½è§’è‰²å¤±è´¥:', error);
                const errorMsg = error.message || 'æœªçŸ¥é”™è¯¯';

                // æ ¹æ®é”™è¯¯ç±»å‹æ˜¾ç¤ºä¸åŒçš„æç¤º
                if (errorMsg.includes('è¶…æ—¶') || errorMsg.includes('timeout') || errorMsg.includes('Failed to fetch')) {
                    select.innerHTML = '<option value="">åç«¯æœªè¿æ¥</option>';
                    if (isUserRefresh) {
                        showToast('åç«¯æœåŠ¡æœªå¯åŠ¨æˆ–æ— æ³•è¿æ¥', 'error');
                    } else {
                        console.warn('åç«¯æœåŠ¡å¯èƒ½æœªå¯åŠ¨ï¼Œé¡µé¢å·²å°±ç»ªï¼Œå¯ä»¥ç¨åé‡è¯•');
                    }
                } else {
                    select.innerHTML = '<option value="">åŠ è½½å¤±è´¥</option>';
                    if (isUserRefresh) {
                        showToast('åŠ è½½è§’è‰²å¤±è´¥: ' + errorMsg, 'error');
                    }
                }
            } finally {
                if (refreshBtn) refreshBtn.disabled = false;
            }
        }

        // åˆ‡æ¢è¾“å…¥æ–¹å¼
        function switchTab(tab) {
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

            if (tab === 'microphone') {
                document.querySelector('.tab-btn:first-child').classList.add('active');
                document.getElementById('microphoneTab').classList.add('active');
            } else {
                document.querySelector('.tab-btn:last-child').classList.add('active');
                document.getElementById('uploadTab').classList.add('active');
            }

            // æ¸…é™¤ä¹‹å‰çš„è¾“å…¥
            clearAudioInput();
        }

        // è®¾ç½®æ–‡ä»¶ä¸Šä¼ 
        function setupFileUpload() {
            const uploadArea = document.getElementById('fileUploadArea');
            const fileInput = document.getElementById('audioFileInput');

            // æ‹–æ‹½ä¸Šä¼ 
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });

            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('dragover');
            });

            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    const file = files[0];
                    // æ£€æŸ¥æ–‡ä»¶ç±»å‹ï¼šMIMEç±»å‹æˆ–æ–‡ä»¶æ‰©å±•å
                    const isAudioFile = file.type.startsWith('audio/') ||
                        /\.(wav|mp3|m4a|ogg|flac|aac|wma|opus)$/i.test(file.name);
                    if (isAudioFile) {
                        handleAudioFile(file);
                    } else {
                        showToast('è¯·ä¸Šä¼ éŸ³é¢‘æ–‡ä»¶ï¼ˆæ”¯æŒ WAV, MP3, M4A ç­‰æ ¼å¼ï¼‰', 'error');
                    }
                }
            });
        }

        // å¤„ç†æ–‡ä»¶é€‰æ‹©
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                handleAudioFile(file);
            }
        }

        // å¤„ç†éŸ³é¢‘æ–‡ä»¶
        async function handleAudioFile(file) {
            console.log('å¤„ç†éŸ³é¢‘æ–‡ä»¶:', file.name, file.type, file.size);
            currentAudioFile = file;
            currentAudioBase64 = null;

            // æ˜¾ç¤ºæ–‡ä»¶ä¿¡æ¯
            const fileInfo = document.getElementById('fileInfo');
            fileInfo.style.display = 'block';
            fileInfo.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span>ğŸ“ ${file.name}</span>
                    <span style="color: var(--muted);">${(file.size / 1024).toFixed(2)} KB</span>
                </div>
            `;

            // æ˜¾ç¤ºéŸ³é¢‘é¢„è§ˆ
            const audioPreview = document.getElementById('audioPreview');
            audioPreview.style.display = 'block';
            const audioUrl = URL.createObjectURL(file);
            audioPreview.innerHTML = `<audio controls src="${audioUrl}"></audio>`;

            // è½¬æ¢ä¸ºBase64
            try {
                updateStatus('ğŸ“ æ­£åœ¨è¯»å–éŸ³é¢‘æ–‡ä»¶...');
                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        const arrayBuffer = e.target.result;
                        console.log('æ–‡ä»¶è¯»å–å®Œæˆï¼Œå¤§å°:', arrayBuffer.byteLength);

                        // ä½¿ç”¨æ›´å®‰å…¨çš„æ–¹å¼è½¬æ¢ä¸ºBase64
                        const bytes = new Uint8Array(arrayBuffer);
                        let binary = '';
                        const len = bytes.byteLength;
                        for (let i = 0; i < len; i++) {
                            binary += String.fromCharCode(bytes[i]);
                        }
                        const base64 = btoa(binary);

                        currentAudioBase64 = base64;
                        console.log('Base64è½¬æ¢å®Œæˆï¼Œé•¿åº¦:', base64.length);

                        updateStatus('âœ… éŸ³é¢‘æ–‡ä»¶å·²åŠ è½½ï¼Œç‚¹å‡»"ç”Ÿæˆè§†é¢‘"æŒ‰é’®å°†è‡ªåŠ¨è¿›è¡Œè¯­éŸ³è¯†åˆ«');

                        // æ›´æ–°è¯†åˆ«æ–‡æœ¬æ˜¾ç¤º
                        const recognizedTextEl = document.getElementById('recognizedText');
                        recognizedTextEl.textContent = 'éŸ³é¢‘å·²åŠ è½½ï¼Œç­‰å¾…ç”Ÿæˆ...';
                        recognizedTextEl.classList.remove('empty');

                        showToast('éŸ³é¢‘æ–‡ä»¶å·²åŠ è½½', 'success');
                    } catch (error) {
                        console.error('Base64è½¬æ¢å¤±è´¥:', error);
                        showToast('éŸ³é¢‘æ–‡ä»¶å¤„ç†å¤±è´¥: ' + error.message, 'error');
                        currentAudioBase64 = null;
                    }
                };
                reader.onerror = (error) => {
                    console.error('æ–‡ä»¶è¯»å–é”™è¯¯:', error);
                    showToast('è¯»å–éŸ³é¢‘æ–‡ä»¶å¤±è´¥', 'error');
                    currentAudioBase64 = null;
                };
                reader.readAsArrayBuffer(file);
            } catch (error) {
                console.error('è¯»å–æ–‡ä»¶å¤±è´¥:', error);
                showToast('è¯»å–éŸ³é¢‘æ–‡ä»¶å¤±è´¥: ' + error.message, 'error');
                currentAudioBase64 = null;
            }
        }

        // åˆ‡æ¢å½•éŸ³çŠ¶æ€
        async function toggleRecording() {
            if (!isRecording) {
                await startRecording();
            } else {
                stopRecording();
            }
        }

        // å¼€å§‹å½•éŸ³
        async function startRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];

                mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) {
                        audioChunks.push(event.data);
                    }
                };

                mediaRecorder.onstop = async () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });

                    // è½¬æ¢ä¸ºBase64
                    const reader = new FileReader();
                    reader.onload = async () => {
                        const arrayBuffer = reader.result;
                        const base64 = btoa(String.fromCharCode(...new Uint8Array(arrayBuffer)));
                        currentAudioBase64 = base64;
                        currentAudioFile = null;

                        // æ˜¾ç¤ºéŸ³é¢‘é¢„è§ˆ
                        const audioPreview = document.getElementById('audioPreview');
                        audioPreview.style.display = 'block';
                        const audioUrl = URL.createObjectURL(audioBlob);
                        audioPreview.innerHTML = `<audio controls src="${audioUrl}"></audio>`;

                        // æ›´æ–°è¯†åˆ«æ–‡æœ¬æ˜¾ç¤º
                        const recognizedTextEl = document.getElementById('recognizedText');
                        recognizedTextEl.textContent = 'å½•éŸ³å®Œæˆï¼Œç‚¹å‡»"ç”Ÿæˆè§†é¢‘"æŒ‰é’®å°†è‡ªåŠ¨è¿›è¡Œè¯­éŸ³è¯†åˆ«';
                        recognizedTextEl.classList.remove('empty');
                    };
                    reader.readAsArrayBuffer(audioBlob);

                    // åœæ­¢æ‰€æœ‰éŸ³é¢‘è½¨é“
                    stream.getTracks().forEach(track => track.stop());
                };

                mediaRecorder.start();
                isRecording = true;

                // æ›´æ–°UI
                const recordBtn = document.getElementById('recordBtn');
                recordBtn.classList.add('recording');
                document.getElementById('recordIcon').textContent = 'â¹ï¸';
                document.getElementById('recordText').textContent = 'ç‚¹å‡»åœæ­¢å½•éŸ³';

                // æ˜¾ç¤ºå½•éŸ³æ—¶é—´
                const recordingTime = document.getElementById('recordingTime');
                recordingTime.style.display = 'block';
                recordingStartTime = Date.now();
                recordingTimer = setInterval(() => {
                    const elapsed = Math.floor((Date.now() - recordingStartTime) / 1000);
                    const minutes = Math.floor(elapsed / 60);
                    const seconds = elapsed % 60;
                    recordingTime.textContent = `å½•éŸ³ä¸­: ${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
                }, 1000);

                updateStatus('ğŸ¤ æ­£åœ¨å½•éŸ³...');
            } catch (error) {
                console.error('å½•éŸ³å¤±è´¥:', error);
                showToast('æ— æ³•è®¿é—®éº¦å…‹é£: ' + error.message, 'error');
            }
        }

        // åœæ­¢å½•éŸ³
        function stopRecording() {
            if (mediaRecorder && isRecording) {
                mediaRecorder.stop();
                isRecording = false;

                // æ›´æ–°UI
                const recordBtn = document.getElementById('recordBtn');
                recordBtn.classList.remove('recording');
                document.getElementById('recordIcon').textContent = 'ğŸ¤';
                document.getElementById('recordText').textContent = 'ç‚¹å‡»å¼€å§‹å½•éŸ³';

                // éšè—å½•éŸ³æ—¶é—´
                const recordingTime = document.getElementById('recordingTime');
                recordingTime.style.display = 'none';
                if (recordingTimer) {
                    clearInterval(recordingTimer);
                    recordingTimer = null;
                }

                updateStatus('â¹ï¸ å½•éŸ³å·²åœæ­¢ï¼Œæ­£åœ¨å¤„ç†...');
            }
        }

        // è¯­éŸ³è¯†åˆ«
        async function performTranscription() {
            if (!currentAudioBase64) {
                showToast('æ²¡æœ‰å¯è¯†åˆ«çš„éŸ³é¢‘', 'error');
                return null;
            }

            try {
                updateStatus('ğŸ” æ­£åœ¨è¿›è¡Œè¯­éŸ³è¯†åˆ«...');
                const recognizedTextEl = document.getElementById('recognizedText');
                recognizedTextEl.textContent = 'è¯†åˆ«ä¸­...';
                recognizedTextEl.classList.remove('empty');

                // ä½¿ç”¨api.jsä¸­çš„å‡½æ•°ï¼Œæ”¯æŒè¶…æ—¶å¤„ç†
                const result = await transcribeAudio({
                    audio_base64: currentAudioBase64,
                    model_name: 'base',
                    language: null,
                    task: 'transcribe'
                });

                if (result.success && result.data) {
                    const text = result.data.text || '';
                    recognizedTextEl.textContent = text || 'æœªè¯†åˆ«åˆ°æ–‡æœ¬';
                    recognizedTextEl.classList.remove('empty');
                    updateStatus('âœ… è¯­éŸ³è¯†åˆ«æˆåŠŸï¼Œå¼€å§‹ç”Ÿæˆè§†é¢‘');
                    showToast('è¯­éŸ³è¯†åˆ«æˆåŠŸ', 'success');
                    return text;
                } else {
                    throw new Error(result.error?.message || result.error || 'è¯†åˆ«å¤±è´¥');
                }
            } catch (error) {
                console.error('è¯­éŸ³è¯†åˆ«å¤±è´¥:', error);
                const recognizedTextEl = document.getElementById('recognizedText');
                const errorMsg = error.message || 'è¯†åˆ«å¤±è´¥';
                recognizedTextEl.textContent = 'è¯†åˆ«å¤±è´¥: ' + errorMsg;
                recognizedTextEl.classList.add('empty');
                updateStatus('âŒ è¯­éŸ³è¯†åˆ«å¤±è´¥: ' + errorMsg);
                showToast('è¯­éŸ³è¯†åˆ«å¤±è´¥: ' + errorMsg, 'error');
                return null;
            }
        }

        // æ¸…é™¤éŸ³é¢‘è¾“å…¥
        function clearAudioInput() {
            // åœæ­¢å½•éŸ³
            if (isRecording) {
                stopRecording();
            }

            // æ¸…é™¤æ–‡ä»¶
            currentAudioFile = null;
            currentAudioBase64 = null;
            document.getElementById('audioFileInput').value = '';
            document.getElementById('fileInfo').style.display = 'none';
            document.getElementById('audioPreview').style.display = 'none';
            document.getElementById('recognizedText').textContent = 'ç­‰å¾…è¾“å…¥...';
            document.getElementById('recognizedText').classList.add('empty');
        }

        // åŠ è½½æ¨¡å‹åˆ—è¡¨
        async function loadModels() {
            const select = document.getElementById('modelSelect');
            const refreshBtn = document.getElementById('refreshBtn');

            try {
                refreshBtn.disabled = true;
                select.innerHTML = '<option value="">åŠ è½½ä¸­...</option>';

                const models = await getModels();

                if (models.length === 0) {
                    select.innerHTML = '<option value="">æœªæ‰¾åˆ°æ¨¡å‹</option>';
                    showToast('æœªæ‰¾åˆ°æ¨¡å‹', 'error');
                    return;
                }

                select.innerHTML = models.map(m => `<option value="${m}">${m}</option>`).join('');
                if (models.length > 0) {
                    select.value = models[0];
                }
            } catch (error) {
                console.error('åŠ è½½æ¨¡å‹å¤±è´¥:', error);
                const errorMsg = error.message || 'æœªçŸ¥é”™è¯¯';
                if (errorMsg.includes('è¶…æ—¶') || errorMsg.includes('timeout') || errorMsg.includes('Failed to fetch')) {
                    select.innerHTML = '<option value="">åç«¯æœªè¿æ¥</option>';
                } else {
                    select.innerHTML = '<option value="">åŠ è½½å¤±è´¥</option>';
                    showToast('åŠ è½½æ¨¡å‹å¤±è´¥: ' + errorMsg, 'error');
                }
            } finally {
                refreshBtn.disabled = false;
            }
        }

        // æ£€æŸ¥æ˜¯å¦æœ‰æ­£åœ¨è¿è¡Œçš„ä»»åŠ¡
        async function checkRunningTask() {
            try {
                const apiUrl = getApiBaseUrl();
                const response = await fetch(`${apiUrl}/generate_video/running`, {
                    signal: AbortSignal.timeout(3000)
                });

                if (!response.ok) {
                    return;
                }

                const data = await response.json();

                if (data.success && data.data) {
                    const task = data.data;
                    if (task.status === 'pending' || task.status === 'running') {
                        currentTaskId = task.unique_id;
                        document.getElementById('characterInput').value = task.character || 'ayanami';
                        document.getElementById('modelSelect').value = task.model_name || '';
                        setInputsDisabled(true);
                        document.getElementById('generateBtn').style.display = 'none';
                        document.getElementById('cancelBtn').style.display = 'block';
                        document.getElementById('progressContainer').style.display = 'block';
                        startStatusPolling(currentTaskId, task.start_time);
                        showToast('æ£€æµ‹åˆ°æ­£åœ¨è¿è¡Œçš„ä»»åŠ¡ï¼Œå·²æ¢å¤', 'info');
                    }
                }
            } catch (error) {
                // é™é»˜å¤±è´¥
            }
        }

        // å¼€å§‹ç”Ÿæˆè§†é¢‘
        async function startGeneration() {
            const character = document.getElementById('characterInput').value;
            const model = document.getElementById('modelSelect').value;

            if (!model) {
                showToast('è¯·é€‰æ‹©æ¨¡å‹', 'error');
                return;
            }

            // ç¦ç”¨è¾“å…¥
            setInputsDisabled(true);
            document.getElementById('generateBtn').style.display = 'none';
            document.getElementById('cancelBtn').style.display = 'block';
            document.getElementById('progressContainer').style.display = 'block';

            // é‡ç½®UI
            document.getElementById('videoContainer').classList.add('hidden');
            document.getElementById('videoPlaceholder').classList.remove('hidden');
            document.getElementById('videoPlaceholder').textContent = 'ç­‰å¾…ç”Ÿæˆè§†é¢‘...';
            document.getElementById('videoControls').style.display = 'none';
            document.getElementById('videoInfo').style.display = 'none';
            updateStatus('ğŸ“‹ å‡†å¤‡ä¸­...');
            updateProgress(0, 'å‡†å¤‡ä¸­...');

            try {
                let text = null;

                // æ£€æŸ¥æ˜¯å¦æœ‰éŸ³é¢‘è¾“å…¥ï¼ˆBase64æˆ–æ–‡ä»¶å¯¹è±¡ï¼‰
                console.log('å¼€å§‹ç”Ÿæˆè§†é¢‘ï¼Œæ£€æŸ¥éŸ³é¢‘è¾“å…¥:', {
                    hasBase64: !!currentAudioBase64,
                    hasFile: !!currentAudioFile,
                    base64Length: currentAudioBase64 ? currentAudioBase64.length : 0,
                    fileName: currentAudioFile ? currentAudioFile.name : 'none'
                });

                // å¦‚æœæœ‰éŸ³é¢‘æ–‡ä»¶ä½†æ²¡æœ‰Base64ï¼Œå…ˆè½¬æ¢ä¸ºBase64
                if (currentAudioFile && !currentAudioBase64) {
                    updateStatus('ğŸ“ æ£€æµ‹åˆ°éŸ³é¢‘æ–‡ä»¶ï¼Œæ­£åœ¨è½¬æ¢...');
                    updateProgress(2, 'å¤„ç†éŸ³é¢‘æ–‡ä»¶...');

                    // å°†æ–‡ä»¶è½¬æ¢ä¸ºBase64
                    await new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            try {
                                const arrayBuffer = e.target.result;
                                const bytes = new Uint8Array(arrayBuffer);
                                let binary = '';
                                for (let i = 0; i < bytes.byteLength; i++) {
                                    binary += String.fromCharCode(bytes[i]);
                                }
                                currentAudioBase64 = btoa(binary);
                                console.log('æ–‡ä»¶è½¬æ¢ä¸ºBase64å®Œæˆï¼Œé•¿åº¦:', currentAudioBase64.length);
                                resolve();
                            } catch (error) {
                                console.error('Base64è½¬æ¢å¤±è´¥:', error);
                                reject(error);
                            }
                        };
                        reader.onerror = (error) => {
                            console.error('æ–‡ä»¶è¯»å–é”™è¯¯:', error);
                            reject(error);
                        };
                        reader.readAsArrayBuffer(currentAudioFile);
                    });
                }

                // å¦‚æœæœ‰éŸ³é¢‘è¾“å…¥ï¼Œå…ˆè¿›è¡Œè¯­éŸ³è¯†åˆ«
                if (currentAudioBase64) {
                    updateStatus('ğŸ” æ£€æµ‹åˆ°éŸ³é¢‘è¾“å…¥ï¼Œå¼€å§‹è¯­éŸ³è¯†åˆ«...');
                    updateProgress(5, 'è¯­éŸ³è¯†åˆ«ä¸­...');

                    text = await performTranscription();

                    if (!text) {
                        throw new Error('è¯­éŸ³è¯†åˆ«å¤±è´¥ï¼Œæ— æ³•ç”Ÿæˆè§†é¢‘');
                    }
                } else {
                    // å¦‚æœæ²¡æœ‰éŸ³é¢‘è¾“å…¥ï¼Œå°è¯•ä»è¯†åˆ«æ–‡æœ¬åŒºåŸŸè·å–æ–‡æœ¬
                    const recognizedTextEl = document.getElementById('recognizedText');
                    text = recognizedTextEl.textContent.trim();

                    if (!text || text === 'ç­‰å¾…è¾“å…¥...' || text === 'éŸ³é¢‘å·²åŠ è½½ï¼Œç­‰å¾…ç”Ÿæˆ...' || text.includes('è¯†åˆ«ä¸­') || text.includes('è¯†åˆ«å¤±è´¥')) {
                        showToast('è¯·å…ˆä¸Šä¼ éŸ³é¢‘æ–‡ä»¶æˆ–è¿›è¡Œå½•éŸ³', 'error');
                        resetUI();
                        return;
                    }
                }

                // æäº¤è§†é¢‘ç”Ÿæˆä»»åŠ¡
                updateStatus('ğŸ“‹ æäº¤ä»»åŠ¡ä¸­...');
                updateProgress(10, 'æäº¤ä»»åŠ¡...');

                const result = await generateVideo({
                    text: text,
                    character: character,
                    model_name: model
                });

                if (!result.success) {
                    throw new Error(result.error || 'ä»»åŠ¡æäº¤å¤±è´¥');
                }

                currentTaskId = result.unique_id;
                updateStatus(`ğŸ“‹ ä»»åŠ¡å·²æäº¤ (ID: ${currentTaskId.substring(0, 8)}...)`);
                showToast('ä»»åŠ¡å·²æäº¤ï¼Œæ­£åœ¨åå°ç”Ÿæˆä¸­...', 'info');

                // å¼€å§‹è½®è¯¢çŠ¶æ€
                startStatusPolling(currentTaskId);

            } catch (error) {
                console.error('ç”Ÿæˆå¤±è´¥:', error);
                updateStatus('âŒ ä»»åŠ¡æäº¤å¤±è´¥: ' + error.message);
                showToast('ä»»åŠ¡æäº¤å¤±è´¥: ' + error.message, 'error');
                resetUI();
            }
        }

        // å¼€å§‹çŠ¶æ€è½®è¯¢
        function startStatusPolling(taskId, taskStartTime = null) {
            if (statusPollInterval) {
                clearInterval(statusPollInterval);
            }

            let pollCount = 0;
            let lastProgress = 0;
            let consecutiveFailures = 0;

            let startTime;
            if (taskStartTime) {
                try {
                    startTime = new Date(taskStartTime).getTime();
                } catch (e) {
                    startTime = Date.now();
                }
            } else {
                startTime = Date.now();
            }

            const MAX_RUNTIME_SECONDS = 1800;

            statusPollInterval = setInterval(async () => {
                pollCount++;
                const elapsedSeconds = (Date.now() - startTime) / 1000;

                if (elapsedSeconds > MAX_RUNTIME_SECONDS) {
                    clearInterval(statusPollInterval);
                    statusPollInterval = null;
                    updateStatus('â±ï¸ ä»»åŠ¡è¿è¡Œæ—¶é—´è¿‡é•¿ï¼Œå·²åœæ­¢ç›‘æ§ã€‚');
                    resetUI();
                    showToast('ä»»åŠ¡è¿è¡Œæ—¶é—´è¿‡é•¿ï¼Œå·²åœæ­¢ç›‘æ§', 'warning');
                    return;
                }

                try {
                    const response = await getVideoGenerationStatus(taskId);

                    if (!response.success) {
                        consecutiveFailures++;
                        if (consecutiveFailures >= 5) {
                            clearInterval(statusPollInterval);
                            statusPollInterval = null;
                            updateStatus('âŒ ä»»åŠ¡çŠ¶æ€æŸ¥è¯¢å¤±è´¥ï¼Œå·²åœæ­¢ç›‘æ§');
                            resetUI();
                            showToast('ä»»åŠ¡çŠ¶æ€æŸ¥è¯¢å¤±è´¥ï¼Œè¯·æ£€æŸ¥åç«¯æœåŠ¡', 'error');
                        }
                        return;
                    }

                    if (!response.data) {
                        consecutiveFailures++;
                        if (consecutiveFailures >= 5) {
                            clearInterval(statusPollInterval);
                            statusPollInterval = null;
                            updateStatus('âŒ ä»»åŠ¡ä¸å­˜åœ¨ï¼Œå·²åœæ­¢ç›‘æ§');
                            resetUI();
                        }
                        return;
                    }

                    consecutiveFailures = 0;

                    const task = response.data;
                    const status = task.status;

                    if (status === 'pending') {
                        updateProgress(10, 'ä»»åŠ¡æ’é˜Ÿä¸­...');
                        lastProgress = 10;
                    } else if (status === 'running') {
                        let progress = 30;
                        if (elapsedSeconds <= 30) {
                            progress = 30 + Math.floor((elapsedSeconds / 30) * 10);
                        } else if (elapsedSeconds <= 90) {
                            progress = 40 + Math.floor(((elapsedSeconds - 30) / 60) * 10);
                        } else if (elapsedSeconds <= 150) {
                            progress = 50 + Math.floor(((elapsedSeconds - 90) / 60) * 10);
                        } else if (elapsedSeconds <= 210) {
                            progress = 60 + Math.floor(((elapsedSeconds - 150) / 60) * 10);
                        } else if (elapsedSeconds <= 270) {
                            progress = 70 + Math.floor(((elapsedSeconds - 210) / 60) * 10);
                        } else {
                            progress = Math.min(80 + Math.floor(((elapsedSeconds - 270) / 60) * 10), 90);
                        }

                        if (progress < lastProgress) {
                            progress = lastProgress;
                        } else if (progress === lastProgress && elapsedSeconds > 60) {
                            progress = Math.min(lastProgress + 0.5, 90);
                        }

                        lastProgress = progress;

                        const minutes = Math.floor(elapsedSeconds / 60);
                        const seconds = Math.floor(elapsedSeconds % 60);
                        const timeStr = minutes > 0 ? `${minutes}åˆ†${seconds}ç§’` : `${seconds}ç§’`;
                        updateProgress(progress, `ç”Ÿæˆä¸­... (å·²è¿è¡Œ ${timeStr})`);
                    } else if (status === 'completed') {
                        clearInterval(statusPollInterval);
                        statusPollInterval = null;

                        updateProgress(100, 'ç”Ÿæˆå®Œæˆï¼');
                        updateStatus('âœ… è§†é¢‘ç”ŸæˆæˆåŠŸï¼');

                        const videoUrl = `${getApiBaseUrl()}/videos/${taskId}.mp4`;
                        displayVideo(videoUrl, task);

                        resetUI();
                        showToast('è§†é¢‘ç”ŸæˆæˆåŠŸï¼', 'success');

                    } else if (status === 'failed' || status === 'cancelled') {
                        clearInterval(statusPollInterval);
                        statusPollInterval = null;

                        const error = task.error || (status === 'cancelled' ? 'ä»»åŠ¡å·²å–æ¶ˆ' : 'æœªçŸ¥é”™è¯¯');
                        updateStatus(`âŒ ${status === 'cancelled' ? 'ä»»åŠ¡å·²å–æ¶ˆ' : 'ç”Ÿæˆå¤±è´¥'}: ${error}`);
                        showToast(status === 'cancelled' ? 'ä»»åŠ¡å·²å–æ¶ˆ' : ('ç”Ÿæˆå¤±è´¥: ' + error), 'error');
                        resetUI();
                    }
                } catch (error) {
                    console.error('çŠ¶æ€æŸ¥è¯¢å¼‚å¸¸:', error);
                    consecutiveFailures++;

                    if (consecutiveFailures >= 5) {
                        clearInterval(statusPollInterval);
                        statusPollInterval = null;
                        updateStatus('âŒ çŠ¶æ€æŸ¥è¯¢å¤±è´¥ï¼Œå·²åœæ­¢ç›‘æ§');
                        resetUI();
                        showToast('çŠ¶æ€æŸ¥è¯¢å¤±è´¥ï¼Œè¯·æ£€æŸ¥åç«¯æœåŠ¡', 'error');
                    }
                }
            }, 2000);
        }

        // æ˜¾ç¤ºè§†é¢‘
        function displayVideo(videoUrl, task) {
            const video = document.getElementById('videoOutput');
            const videoContainer = document.getElementById('videoContainer');
            const placeholder = document.getElementById('videoPlaceholder');

            // æ·»åŠ æ—¶é—´æˆ³å‚æ•°ï¼Œé¿å…ç¼“å­˜é—®é¢˜
            const urlWithTimestamp = videoUrl + (videoUrl.includes('?') ? '&' : '?') + 't=' + Date.now();

            // è®¾ç½®è§†é¢‘æº
            video.src = urlWithTimestamp;
            video.load();

            // æ˜¾ç¤ºè§†é¢‘å®¹å™¨ï¼Œéšè—å ä½ç¬¦
            videoContainer.classList.remove('hidden');
            placeholder.classList.add('hidden');

            // å¤„ç†è§†é¢‘åŠ è½½é”™è¯¯
            video.onerror = function (e) {
                console.error('è§†é¢‘åŠ è½½å¤±è´¥:', videoUrl, e);
                showToast('è§†é¢‘åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥è§†é¢‘æ–‡ä»¶æ˜¯å¦å­˜åœ¨', 'error');
                videoContainer.classList.add('hidden');
                placeholder.classList.remove('hidden');
                placeholder.textContent = 'è§†é¢‘åŠ è½½å¤±è´¥';
            };

            // è§†é¢‘å¯ä»¥æ’­æ”¾æ—¶æ˜¾ç¤ºæ§åˆ¶æŒ‰é’®å’Œä¿¡æ¯
            video.oncanplay = function () {
                console.log('è§†é¢‘å¯ä»¥æ’­æ”¾:', videoUrl);
                document.getElementById('videoControls').style.display = 'flex';
                document.getElementById('videoInfo').style.display = 'block';

                if (task && task.generation_time) {
                    document.getElementById('generationTime').textContent = `${task.generation_time.toFixed(2)} ç§’`;
                }
                if (task && task.unique_id) {
                    document.getElementById('taskId').textContent = task.unique_id.substring(0, 16) + '...';
                }
            };
        }

        // ç»ˆæ­¢ä»»åŠ¡
        async function cancelGeneration() {
            if (!currentTaskId) {
                return;
            }

            if (!confirm('ç¡®å®šè¦ç»ˆæ­¢å½“å‰ä»»åŠ¡å—ï¼Ÿ')) {
                return;
            }

            try {
                const apiUrl = getApiBaseUrl();
                const response = await fetch(`${apiUrl}/generate_video/cancel/${currentTaskId}`, {
                    method: 'POST'
                });
                const data = await response.json();

                if (data.success) {
                    showToast('ä»»åŠ¡å·²ç»ˆæ­¢', 'info');
                } else {
                    showToast('ç»ˆæ­¢ä»»åŠ¡å¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'), 'error');
                }
            } catch (error) {
                console.error('ç»ˆæ­¢ä»»åŠ¡å¤±è´¥:', error);
                showToast('ç»ˆæ­¢ä»»åŠ¡å¤±è´¥: ' + error.message, 'error');
            }

            resetUI();
        }

        // ä¸‹è½½è§†é¢‘
        function downloadVideo() {
            const video = document.getElementById('videoOutput');
            if (!video.src) {
                showToast('è§†é¢‘æœªåŠ è½½', 'error');
                return;
            }
            const a = document.createElement('a');
            a.href = video.src;
            a.download = `nerffacespeech_${Date.now()}.mp4`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            showToast('è§†é¢‘ä¸‹è½½å·²å¼€å§‹', 'success');
        }

        // å…¨å±æ’­æ”¾
        function fullscreenVideo() {
            const video = document.getElementById('videoOutput');
            if (video.requestFullscreen) {
                video.requestFullscreen();
            } else if (video.webkitRequestFullscreen) {
                video.webkitRequestFullscreen();
            } else if (video.mozRequestFullScreen) {
                video.mozRequestFullScreen();
            } else if (video.msRequestFullscreen) {
                video.msRequestFullscreen();
            }
        }

        // æ›´æ–°çŠ¶æ€
        function updateStatus(message) {
            document.getElementById('statusBox').textContent = message;
        }

        // æ›´æ–°è¿›åº¦
        function updateProgress(percent, text) {
            document.getElementById('progressFill').style.width = percent + '%';
            document.getElementById('progressText').textContent = text || 'å¤„ç†ä¸­...';
            document.getElementById('progressPercent').textContent = Math.round(percent) + '%';
        }

        // ç¦ç”¨/å¯ç”¨è¾“å…¥
        function setInputsDisabled(disabled) {
            document.getElementById('characterInput').disabled = disabled;
            document.getElementById('modelSelect').disabled = disabled;
            document.getElementById('refreshBtn').disabled = disabled;
            const refreshCharacterBtn = document.getElementById('refreshCharacterBtn');
            if (refreshCharacterBtn) refreshCharacterBtn.disabled = disabled;
            document.getElementById('recordBtn').disabled = disabled;
            document.getElementById('audioFileInput').disabled = disabled;
        }

        // é‡ç½®UI
        function resetUI() {
            if (statusPollInterval) {
                clearInterval(statusPollInterval);
                statusPollInterval = null;
            }

            currentTaskId = null;
            setInputsDisabled(false);
            document.getElementById('generateBtn').style.display = 'block';
            document.getElementById('cancelBtn').style.display = 'none';
            document.getElementById('progressContainer').style.display = 'none';
        }

        // æ˜¾ç¤ºæç¤ºæ¶ˆæ¯
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = message;

            const colors = {
                success: '#4ade80',
                error: '#ef4444',
                info: '#3b82f6'
            };
            toast.style.borderLeft = `4px solid ${colors[type] || colors.info}`;

            document.body.appendChild(toast);

            setTimeout(() => {
                toast.style.animation = 'slideIn 0.3s ease reverse';
                setTimeout(() => {
                    document.body.removeChild(toast);
                }, 300);
            }, 3000);
        }

        // é¡µé¢å¸è½½æ—¶æ¸…ç†
        window.addEventListener('beforeunload', () => {
            if (statusPollInterval) {
                clearInterval(statusPollInterval);
            }
            if (isRecording) {
                stopRecording();
            }
        });
    </script>
</body>

</html>