<!doctype html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>è§†é¢‘ç”Ÿæˆ - NeRFFaceSpeech</title>
    <link rel="stylesheet" href="style.css">
    <script src="settings.js"></script>
    <script src="api.js"></script>
    <style>
        :root {
        --primary: #1e40af;
        --primary-2: #3b82f6;
        --bg: #0b1020;
        --card: rgba(255, 255, 255, 0.06);
        --border: rgba(255, 255, 255, 0.14);
        --text: #e5e7eb;
        --muted: #9ca3af;
        --g1: rgba(59, 130, 246, 0.16);
        --g2: rgba(14, 165, 233, 0.14);
        --g3: rgba(56, 189, 248, 0.12);
        --card-bg: rgb(24, 66, 134);
        --base-font-size: 14px;
        }

        body.theme-tech {
        --primary: #1e40af;
        --primary-2: #3b82f6;
        --bg: #0b1020;
        --card: rgba(255, 255, 255, 0.06);
        --border: rgba(255, 255, 255, 0.14);
        --text: #e5e7eb;
        --muted: #9ca3af;
        --g1: rgba(59, 130, 246, 0.16);
        --g2: rgba(14, 165, 233, 0.14);
        --g3: rgba(56, 189, 248, 0.12);
        --card-bg: rgb(24, 66, 134);
        }

        body.theme-warm {
            --primary: #f97316;
            --primary-2: #ea580c;
            --bg: #fff8f0;
            --card: rgba(255, 255, 255, 0.9);
            --border: rgba(249, 115, 22, 0.2);
            --text: #1f2937;
            --muted: #6b7280;
            --g1: rgba(251, 191, 36, 0.15);
            --g2: rgba(249, 115, 22, 0.12);
            --g3: rgba(234, 88, 12, 0.1);
            --card-bg: rgba(251, 191, 36, 0.15);
        }

        body.theme-minimal {
            --primary: #6b7280;
            --primary-2: #4b5563;
            --bg: #f5f5f5;
            --card: #ffffff;
            --border: #e5e7eb;
            --text: #111827;
            --muted: #6b7280;
            --g1: rgba(107, 114, 128, 0.08);
            --g2: rgba(75, 85, 99, 0.07);
            --g3: rgba(156, 163, 175, 0.06);
            --card-bg: rgba(107, 114, 128, 0.1);
        }

        html {
            font-size: var(--base-font-size);
        }

        body {
            margin: 0;
            font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background: radial-gradient(circle at 20% 20%, var(--g1), transparent 25%),
                radial-gradient(circle at 80% 30%, var(--g2), transparent 25%),
                radial-gradient(circle at 50% 80%, var(--g3), transparent 22%),
                var(--bg);
            color: var(--text);
            min-height: 100vh;
        }

        .page {
            max-width: 1400px;
            width: 94vw;
            margin: 0 auto;
            padding: 20px 24px 40px;
            min-height: 96vh;
        }

        header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            margin-bottom: 16px;
        }

        h1 {
            margin: 0;
            font-size: 24px;
            letter-spacing: 0.4px;
        }

        .back-btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 16px;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid var(--border);
            color: var(--text);
            text-decoration: none;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .back-btn:hover {
            background: rgba(255, 255, 255, 0.12);
            border-color: var(--primary-2);
        }

        .card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 18px;
            box-shadow: 0 12px 32px rgba(0, 0, 0, 0.25);
        }

        .grid {
            display: grid;
            grid-template-columns: 520px 1fr;
            gap: 18px;
            align-items: start;
        }

        @media (max-width: 1200px) {
            .grid {
                grid-template-columns: 1fr;
            }
        }

        label {
            font-weight: 700;
            margin-bottom: 6px;
            display: block;
        }

        input,
        textarea {
            width: 100%;
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 12px 14px;
            font-size: 15px;
            background: rgba(255, 255, 255, 0.04);
            color: var(--text);
            outline: none;
            transition: border-color .15s ease, box-shadow .15s ease;
        }

        select {
            width: 100%;
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 12px 14px;
            font-size: 15px;
            background: var(--card-bg);
            color: var(--text);
            outline: none;
            transition: border-color .15s ease, box-shadow .15s ease;
        }

        input:focus,
        select:focus,
        textarea:focus {
            border-color: rgba(96, 165, 250, 0.8);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.25);
        }

        textarea {
            min-height: 130px;
            resize: vertical;
        }

        button.primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-2));
            border: 1px solid var(--primary-2);
            color: #fff;
            font-weight: 700;
            border-radius: 12px;
            padding: 12px 14px;
            cursor: pointer;
            width: 100%;
            transition: opacity 0.2s ease;
        }

        button.primary:hover:not(:disabled) {
            opacity: 0.9;
        }

        button.secondary {
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid var(--border);
            color: var(--text);
            font-weight: 600;
            border-radius: 12px;
            padding: 12px 14px;
            cursor: pointer;
            width: 100%;
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .muted {
            color: var(--muted);
            font-size: 13px;
        }

        .status-box {
            background: #0f172a;
            color: #e2e8f0;
            padding: 12px;
            border-radius: 12px;
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
            min-height: 60px;
            white-space: pre-wrap;
            word-break: break-all;
            font-size: 13px;
        }

        .video-container {
            position: relative;
            width: 100%;
            background: #000;
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 16px;
        }

        .video-container video {
            width: 100%;
            display: block;
        }

        .video-placeholder {
            width: 100%;
            aspect-ratio: 16/9;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(0, 0, 0, 0.3);
            color: var(--muted);
            font-size: 16px;
            border-radius: 12px;
        }

        .hidden {
            display: none !important;
        }

        .progress-container {
            margin-top: 12px;
            margin-bottom: 12px;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 8px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--primary-2));
            width: 0%;
            transition: width 0.3s ease;
            border-radius: 4px;
        }

        .progress-text {
            font-size: 13px;
            color: var(--muted);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .video-controls {
            display: flex;
            gap: 8px;
            margin-top: 12px;
            flex-wrap: wrap;
        }

        .video-controls button {
            flex: 1;
            min-width: 100px;
        }

        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 12px;
            background: var(--card);
            border: 1px solid var(--border);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .btn-group {
            display: flex;
            gap: 8px;
        }

        .btn-group button {
            flex: 1;
        }

        /* è®¾ç½®æŒ‰é’® */
        .settings-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            padding: 10px 16px;
            border-radius: 10px;
            border: 1px solid var(--border);
            background: var(--card-bg);
            color: var(--text);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .settings-btn:hover {
            background: var(--primary);
            color: #fff;
            border-color: var(--primary);
        }

        /* ä¾§è¾¹æ é®ç½© */
        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.4);
            z-index: 2000;
            transition: opacity 0.3s ease;
        }

        .sidebar-overlay.active {
            display: block;
        }

        /* ä¾§è¾¹æ  */
        .sidebar {
            position: fixed;
            top: 0;
            right: -400px;
            width: 400px;
            height: 100vh;
            background: var(--bg);
            border-left: 1px solid var(--border);
            z-index: 2001;
            transition: right 0.3s ease;
            overflow-y: auto;
            box-shadow: -4px 0 20px rgba(0, 0, 0, 0.2);
        }

        .sidebar.active {
            right: 0;
        }

        .sidebar-content {
            padding: 24px;
        }

        .sidebar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border);
        }

        .sidebar-header h2 {
            margin: 0;
            font-size: 20px;
            color: var(--text);
        }

        .sidebar-close {
            background: none;
            border: none;
            font-size: 28px;
            color: var(--muted);
            cursor: pointer;
            padding: 0;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            transition: all 0.2s ease;
        }

        .sidebar-close:hover {
            background: var(--card-bg);
            color: var(--text);
        }

        /* åˆ†é¡µæ ‡ç­¾ */
        .sidebar-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--border);
        }

        .sidebar-tab {
            padding: 10px 20px;
            background: none;
            border: none;
            border-bottom: 2px solid transparent;
            color: var(--muted);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .sidebar-tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        .sidebar-tab:hover {
            color: var(--text);
        }

        /* åˆ†é¡µå†…å®¹ */
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* é€‰é¡¹ç½‘æ ¼ */
        .options-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 12px;
            margin-bottom: 20px;
        }

        .option-card {
            padding: 16px;
            border: 2px solid var(--border);
            border-radius: 12px;
            background: var(--card-bg);
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
        }

        .option-card:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .option-card.selected {
            border-color: var(--primary);
            background: var(--primary);
            color: #fff;
        }

        .option-card.selected .option-name {
            color: #fff;
        }

        .option-name {
            font-size: 14px;
            font-weight: 500;
            color: var(--text);
            margin-bottom: 4px;
        }

        .option-desc {
            font-size: 12px;
            color: var(--muted);
        }

        .option-card.selected .option-desc {
            color: rgba(255, 255, 255, 0.9);
        }

        /* å­—å·é€‰æ‹© */
        .font-size-group {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
        }

        .font-size-btn {
            flex: 1;
            padding: 12px;
            border: 2px solid var(--border);
            border-radius: 10px;
            background: var(--card-bg);
            color: var(--text);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .font-size-btn:hover {
            border-color: var(--primary);
        }

        .font-size-btn.selected {
            border-color: var(--primary);
            background: var(--primary);
            color: #fff;
        }

        .font-size-custom {
            margin-top: 16px;
        }

        .font-size-custom input {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: var(--card-bg);
            color: var(--text);
            font-size: 14px;
        }

        /* å†å²è®°å½•ä¾§è¾¹æ  */
        .history-sidebar {
            position: fixed;
            left: -320px;
            top: 0;
            width: 320px;
            height: 100vh;
            background: var(--bg);
            border-right: 1px solid var(--border);
            z-index: 1500;
            transition: left 0.3s ease;
            display: flex;
            flex-direction: column;
            box-shadow: 4px 0 20px rgba(0, 0, 0, 0.2);
        }

        .history-sidebar.active {
            left: 0;
        }

        .history-sidebar-header {
            padding: 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .history-sidebar-header h3 {
            margin: 0;
            font-size: 18px;
            color: var(--text);
        }

        .history-sidebar-close {
            background: none;
            border: none;
            font-size: 24px;
            color: var(--muted);
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            transition: all 0.2s ease;
        }

        .history-sidebar-close:hover {
            background: var(--card-bg);
            color: var(--text);
        }

        .history-sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
        }

        .history-list-container {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .history-item {
            padding: 12px;
            border-radius: 10px;
            border: 1px solid var(--border);
            background: var(--card-bg);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .history-item:hover {
            background: var(--primary);
            color: #fff;
            border-color: var(--primary);
        }

        .history-item.active {
            background: var(--primary);
            color: #fff;
            border-color: var(--primary);
        }

        .history-item-text {
            font-weight: 500;
            margin-bottom: 4px;
            font-size: 14px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .history-item-time {
            font-size: 11px;
            opacity: 0.7;
        }

        .history-sidebar-actions {
            padding: 16px;
            border-top: 1px solid var(--border);
        }

        .back-to-task-btn {
            width: 100%;
            padding: 10px 16px;
            border-radius: 10px;
            border: 1px solid var(--border);
            background: var(--primary);
            color: #fff;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 14px;
            font-weight: 500;
        }

        .back-to-task-btn:hover {
            background: var(--primary-2);
            border-color: var(--primary-2);
        }

        .back-to-task-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                right: -100%;
            }

            .history-sidebar {
                width: 100%;
                left: -100%;
            }
        }
    </style>
</head>

<body>
    <button class="settings-btn" id="settingsBtn">âš™ï¸ è®¾ç½®</button>

    <!-- å†å²è®°å½•ä¾§è¾¹æ  -->
    <div class="history-sidebar" id="historySidebar">
        <div class="history-sidebar-header">
            <h3>å†å²è®°å½•</h3>
            <button class="history-sidebar-close" id="historySidebarClose">Ã—</button>
        </div>
        <div class="history-sidebar-content">
            <div class="history-list-container" id="historyListContainer">
                <div style="color: var(--muted); text-align: center; padding: 20px;">åŠ è½½ä¸­...</div>
            </div>
        </div>
        <div class="history-sidebar-actions">
            <button class="back-to-task-btn" id="backToTaskBtn">ğŸš€ å¼€å§‹æ–°ä»»åŠ¡</button>
        </div>
    </div>

    <!-- ä¾§è¾¹æ é®ç½© -->
    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <!-- è®¾ç½®ä¾§è¾¹æ  -->
    <div class="sidebar" id="settingsSidebar">
        <div class="sidebar-content">
            <div class="sidebar-header">
                <h2>è®¾ç½®</h2>
                <button class="sidebar-close" id="sidebarClose">Ã—</button>
            </div>

            <div class="sidebar-tabs">
                <button class="sidebar-tab active" data-tab="theme">ä¸»é¢˜</button>
                <button class="sidebar-tab" data-tab="font">å­—ä½“</button>
            </div>

            <!-- ä¸»é¢˜è®¾ç½® -->
            <div class="tab-content active" id="themeTab">
                <div class="options-grid">
                    <div class="option-card" data-theme="tech">
                        <div class="option-name">ç§‘æŠ€é£</div>
                        <div class="option-desc">æ·±è“è‰²ç§‘æŠ€æ„Ÿ</div>
                    </div>
                    <div class="option-card" data-theme="warm">
                        <div class="option-name">æ¸©é¦¨é£</div>
                        <div class="option-desc">æš–è‰²è°ƒæ¸©é¦¨</div>
                    </div>
                    <div class="option-card" data-theme="minimal">
                        <div class="option-name">ç®€çº¦é£</div>
                        <div class="option-desc">ç°è‰²ç®€çº¦</div>
                    </div>
                </div>
            </div>

            <!-- å­—ä½“è®¾ç½® -->
            <div class="tab-content" id="fontTab">
                <div style="margin-bottom: 16px;">
                    <label
                        style="display: block; margin-bottom: 8px; color: var(--text); font-weight: 500;">å­—ä½“æ ·å¼</label>
                    <div class="options-grid">
                        <div class="option-card" data-font="SimSun">
                            <div class="option-name">å®‹ä½“</div>
                            <div class="option-desc">SimSun</div>
                        </div>
                        <div class="option-card" data-font="SimHei">
                            <div class="option-name">é»‘ä½“</div>
                            <div class="option-desc">SimHei</div>
                        </div>
                        <div class="option-card" data-font="Microsoft YaHei">
                            <div class="option-name">å¾®è½¯é›…é»‘</div>
                            <div class="option-desc">Microsoft YaHei</div>
                        </div>
                        <div class="option-card" data-font="Arial">
                            <div class="option-name">Arial</div>
                            <div class="option-desc">Arial</div>
                        </div>
                        <div class="option-card" data-font="Times New Roman">
                            <div class="option-name">Times New Roman</div>
                            <div class="option-desc">Times New Roman</div>
                        </div>
                        <div class="option-card" data-font="Inter">
                            <div class="option-name">Inter</div>
                            <div class="option-desc">Interï¼ˆé»˜è®¤ï¼‰</div>
                        </div>
                    </div>
                </div>

                <div>
                    <label
                        style="display: block; margin-bottom: 8px; color: var(--text); font-weight: 500;">å­—å·å¤§å°</label>
                    <div class="font-size-group">
                        <button class="font-size-btn" data-size="small">å°</button>
                        <button class="font-size-btn" data-size="medium">ä¸­</button>
                        <button class="font-size-btn" data-size="large">å¤§</button>
                        <button class="font-size-btn" data-size="custom">è‡ªå®šä¹‰</button>
                    </div>
                    <div class="font-size-custom" id="customSizeInput" style="display: none;">
                        <input type="number" id="customSizeValue" placeholder="è¾“å…¥å­—å·ï¼ˆpxï¼‰" min="10" max="24" value="14">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="page">
        <header>
            <a href="index.html" class="back-btn">â† è¿”å›é¦–é¡µ</a>
            <h1>ğŸ¬ è§†é¢‘ç”Ÿæˆ</h1>
            <button class="back-btn" id="historyBtn" style="margin: 0;">ğŸ“‹ å†å²è®°å½•</button>
        </header>

        <div class="grid">
            <!-- å·¦ä¾§ï¼šè¾“å…¥åŒºåŸŸ -->
            <div>
                <div class="card">
                    <label for="textInput">è¾“å…¥æ–‡æœ¬</label>
                    <textarea id="textInput" placeholder="è¾“å…¥è¦ç”Ÿæˆçš„æ–‡æœ¬å†…å®¹..."></textarea>
                    <div class="muted" style="margin-top: 6px;">è¾“å…¥ä½ æƒ³è¦ç”Ÿæˆçš„æ–‡æœ¬å†…å®¹</div>

                    <label for="characterInput" style="margin-top: 18px;">è§’è‰²</label>
                    <div class="btn-group" style="margin-bottom: 8px;">
                        <select id="characterInput">
                            <option value="">åŠ è½½ä¸­...</option>
                        </select>
                        <button class="secondary" id="refreshCharacterBtn" onclick="loadCharacters()">ğŸ”„</button>
                    </div>

                    <label for="modelSelect" style="margin-top: 18px;">æ¨¡å‹</label>
                    <div class="btn-group" style="margin-bottom: 8px;">
                        <select id="modelSelect">
                            <option value="">åŠ è½½ä¸­...</option>
                        </select>
                        <button class="secondary" id="refreshBtn" onclick="loadModels()">ğŸ”„</button>
                    </div>

                    <button class="primary" id="generateBtn" onclick="startGeneration()">ğŸš€ å¼€å§‹ç”Ÿæˆè§†é¢‘</button>
                    <button class="secondary" id="cancelBtn" onclick="cancelGeneration()"
                        style="display: none; margin-top: 8px;">âŒ ç»ˆæ­¢ä»»åŠ¡</button>

                    <div class="progress-container" id="progressContainer" style="display: none;">
                        <div class="progress-bar">
                            <div class="progress-fill" id="progressFill"></div>
                        </div>
                        <div class="progress-text">
                            <span id="progressText">å‡†å¤‡ä¸­...</span>
                            <span id="progressPercent">0%</span>
                        </div>
                    </div>

                    <div class="status-box" id="statusBox" style="margin-top: 12px;">ç­‰å¾…å¼€å§‹...</div>
                </div>
            </div>

            <!-- å³ä¾§ï¼šè§†é¢‘æ˜¾ç¤ºåŒºåŸŸ -->
            <div>
                <div class="card">
                    <div class="video-placeholder" id="videoPlaceholder">
                        ç­‰å¾…ç”Ÿæˆè§†é¢‘...
                    </div>

                    <div class="video-container hidden" id="videoContainer">
                        <video id="videoOutput" controls></video>
                    </div>

                    <div class="video-controls" id="videoControls" style="display: none; margin-top: 12px;">
                        <button class="secondary" onclick="downloadVideo()">ğŸ“¥ ä¸‹è½½è§†é¢‘</button>
                        <button class="secondary" onclick="fullscreenVideo()">ğŸ” å…¨å±</button>
                    </div>

                    <div id="videoInfo" style="display: none; margin-top: 12px; font-size: 13px; color: var(--muted);">
                        <div>ç”Ÿæˆæ—¶é—´: <span id="generationTime">-</span></div>
                        <div>ä»»åŠ¡ID: <span id="taskId">-</span></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentTaskId = null;
        let statusPollInterval = null;
        let currentViewMode = 'task'; // 'task' æˆ– 'history'
        let viewingHistoryId = null; // å½“å‰æŸ¥çœ‹çš„å†å²è®°å½•ID
        let savedTaskState = null; // ä¿å­˜çš„å½“å‰ä»»åŠ¡çŠ¶æ€

        // ==================== å†å²è®°å½•åŠŸèƒ½ ====================
        const historyBtn = document.getElementById("historyBtn");
        const historySidebar = document.getElementById("historySidebar");
        const historySidebarClose = document.getElementById("historySidebarClose");
        const historyListContainer = document.getElementById("historyListContainer");
        const backToTaskBtn = document.getElementById("backToTaskBtn");

        // æ‰“å¼€/å…³é—­å†å²è®°å½•ä¾§è¾¹æ 
        if (historyBtn && historySidebar) {
            historyBtn.addEventListener("click", () => {
                historySidebar.classList.toggle("active");
                if (historySidebar.classList.contains("active")) {
                    loadHistoryList();
                }
            });
        }

        if (historySidebarClose) {
            historySidebarClose.addEventListener("click", () => {
                historySidebar.classList.remove("active");
            });
        }

        // åŠ è½½å†å²è®°å½•åˆ—è¡¨
        async function loadHistoryList() {
            try {
                historyListContainer.innerHTML = '<div style="color: var(--muted); text-align: center; padding: 20px;">åŠ è½½ä¸­...</div>';
                const apiUrl = getApiBaseUrl();
                const response = await fetch(`${apiUrl}/generation_records?record_type=video&limit=100`, {
                    signal: AbortSignal.timeout(5000)
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const data = await response.json();
                if (!data.success || !data.data || data.data.length === 0) {
                    historyListContainer.innerHTML = '<div style="color: var(--muted); text-align: center; padding: 20px;">æš‚æ— å†å²è®°å½•</div>';
                    return;
                }

                const records = data.data;
                historyListContainer.innerHTML = '';

                // å¯¹äºæ¯ä¸ªè®°å½•ï¼Œæ£€æŸ¥æ˜¯å¦æ˜¯è¿è¡Œä¸­çš„ä»»åŠ¡
                const checkTasks = records.map(async (record) => {
                    const item = document.createElement("div");
                    const isActive = viewingHistoryId === record.unique_id;
                    
                    // æ£€æŸ¥æ˜¯å¦æ˜¯å½“å‰è¿è¡Œä¸­çš„ä»»åŠ¡ï¼ˆé€šè¿‡æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€ï¼‰
                    let isCurrentTask = false;
                    let taskStatus = null;
                    const recordTaskId = record.unique_id;
                    
                    // å¦‚æœè¿™ä¸ªè®°å½•çš„ä»»åŠ¡IDåŒ¹é…å½“å‰ä»»åŠ¡IDæˆ–ä¿å­˜çš„ä»»åŠ¡IDï¼ŒæŸ¥è¯¢çŠ¶æ€
                    if (currentTaskId === recordTaskId || savedTaskState?.taskId === recordTaskId) {
                        try {
                            // å¿«é€ŸæŸ¥è¯¢ä»»åŠ¡çŠ¶æ€
                            const statusResponse = await getVideoGenerationStatus(recordTaskId);
                            if (statusResponse.success && statusResponse.data) {
                                taskStatus = statusResponse.data.status;
                                if (taskStatus === 'pending' || taskStatus === 'running') {
                                    isCurrentTask = true;
                                    // æ›´æ–° currentTaskId å’Œ savedTaskStateï¼ˆå¦‚æœè¿˜æ²¡æœ‰è®¾ç½®ï¼‰
                                    if (!currentTaskId) {
                                        currentTaskId = recordTaskId;
                                    }
                                    if (!savedTaskState) {
                                        savedTaskState = {
                                            taskId: recordTaskId,
                                            text: record.text || '',
                                            character: record.character || '',
                                            model: record.model_name || '',
                                            statusPollInterval: false,
                                            taskStartTime: statusResponse.data.start_time || null
                                        };
                                    }
                                }
                            }
                        } catch (e) {
                            // æŸ¥è¯¢å¤±è´¥ï¼Œå¿½ç•¥ï¼ˆå¯èƒ½æ˜¯ä»»åŠ¡å·²å®Œæˆæˆ–ä¸å­˜åœ¨ï¼‰
                            console.log('æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€å¤±è´¥:', e);
                        }
                    }
                    
                    item.className = `history-item ${isActive || isCurrentTask ? 'active' : ''}`;
                    item.dataset.id = recordTaskId;

                    const textDiv = document.createElement("div");
                    textDiv.className = "history-item-text";
                    const textPreview = (record.text || 'æ— æ–‡æœ¬').substring(0, 30) + ((record.text && record.text.length > 30) ? '...' : '');
                    textDiv.textContent = textPreview;

                    const timeDiv = document.createElement("div");
                    timeDiv.className = "history-item-time";
                    let timeText = '';
                    if (isCurrentTask && (taskStatus === 'pending' || taskStatus === 'running')) {
                        timeText = 'ç”Ÿæˆä¸­...';
                    } else {
                    const date = record.created_at ? new Date(record.created_at).toLocaleString('zh-CN') : 'æœªçŸ¥æ—¶é—´';
                        timeText = date;
                    }
                    timeDiv.textContent = timeText;

                    item.appendChild(textDiv);
                    item.appendChild(timeDiv);

                    item.addEventListener("click", () => {
                        // å¦‚æœæ˜¯è¿è¡Œä¸­çš„ä»»åŠ¡ï¼Œè¿”å›ä»»åŠ¡ç•Œé¢ï¼›å¦åˆ™æŸ¥çœ‹å†å²è®°å½•
                        if (isCurrentTask) {
                            backToCurrentTask();
                        } else {
                            switchToHistoryRecord(recordTaskId);
                        }
                    });

                    return item;
                });
                
                // ç­‰å¾…æ‰€æœ‰ä»»åŠ¡çŠ¶æ€æŸ¥è¯¢å®Œæˆåå†æ·»åŠ åˆ°DOM
                const items = await Promise.all(checkTasks);
                items.forEach(item => {
                    historyListContainer.appendChild(item);
                });
                
                // æ›´æ–°æŒ‰é’®çŠ¶æ€ï¼ˆå¯èƒ½åœ¨æŸ¥è¯¢è¿‡ç¨‹ä¸­å‘ç°äº†è¿è¡Œä¸­çš„ä»»åŠ¡ï¼‰
                updateBackToTaskButton();
            } catch (error) {
                console.error('åŠ è½½å†å²è®°å½•å¤±è´¥:', error);
                historyListContainer.innerHTML = '<div style="color: var(--muted); text-align: center; padding: 20px;">åŠ è½½å¤±è´¥</div>';
            }
        }

        // åˆ‡æ¢åˆ°å†å²è®°å½•è§†å›¾
        async function switchToHistoryRecord(recordId) {
            try {
                // ä¿å­˜å½“å‰ä»»åŠ¡çŠ¶æ€
                if (currentViewMode === 'task' && currentTaskId) {
                    savedTaskState = {
                        taskId: currentTaskId,
                        text: document.getElementById('textInput').value,
                        character: document.getElementById('characterInput').value,
                        model: document.getElementById('modelSelect').value,
                        statusPollInterval: statusPollInterval ? true : false
                    };
                }

                // ç¦ç”¨è¾“å…¥
                setInputsDisabled(true);
                document.getElementById('generateBtn').style.display = 'none';
                document.getElementById('cancelBtn').style.display = 'none';
                document.getElementById('progressContainer').style.display = 'none';

                // åŠ è½½å†å²è®°å½•è¯¦æƒ…
                const apiUrl = getApiBaseUrl();
                const response = await fetch(`${apiUrl}/generation_records/${recordId}`, {
                    signal: AbortSignal.timeout(5000)
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const data = await response.json();
                if (!data.success || !data.data) {
                    throw new Error(data.error || 'è®°å½•ä¸å­˜åœ¨');
                }

                const record = data.data;
                viewingHistoryId = recordId;
                currentViewMode = 'history';

                // è®¾ç½®è¾“å…¥æ¡†å€¼ï¼ˆåªè¯»ï¼‰
                document.getElementById('textInput').value = record.text || '';
                document.getElementById('characterInput').value = record.character || '';
                document.getElementById('modelSelect').value = record.model_name || '';

                // æ˜¾ç¤ºè§†é¢‘
                if (record.video_path) {
                    // ä»è·¯å¾„ä¸­æå–æ–‡ä»¶åï¼ˆä¾‹å¦‚ï¼šä» /root/.../videos/xxx.mp4 æå– xxx.mp4ï¼‰
                    const pathParts = record.video_path.replace(/\\/g, '/').split('/');
                    const fileName = pathParts[pathParts.length - 1];
                    if (fileName && fileName.endsWith('.mp4')) {
                        const videoUrl = `${apiUrl}/videos/${fileName}`;
                        displayVideo(videoUrl, {
                            generation_time: record.generation_time,
                            unique_id: record.unique_id
                        });
                    } else {
                        console.error('æ— æ³•ä»è·¯å¾„æå–æ–‡ä»¶å:', record.video_path);
                        document.getElementById('videoContainer').classList.add('hidden');
                        document.getElementById('videoPlaceholder').classList.remove('hidden');
                        document.getElementById('videoPlaceholder').textContent = 'è§†é¢‘è·¯å¾„æ— æ•ˆ';
                    }
                } else {
                    document.getElementById('videoContainer').classList.add('hidden');
                    document.getElementById('videoPlaceholder').classList.remove('hidden');
                    document.getElementById('videoPlaceholder').textContent = 'è¯¥è®°å½•æ²¡æœ‰è§†é¢‘';
                }

                updateStatus(`ğŸ“‹ å†å²è®°å½• - ${new Date(record.created_at).toLocaleString('zh-CN')}`);
                
                // æ›´æ–°æŒ‰é’®çŠ¶æ€
                updateBackToTaskButton();

                // æ›´æ–°å†å²åˆ—è¡¨é«˜äº®
                loadHistoryList();

                // å…³é—­ä¾§è¾¹æ 
                historySidebar.classList.remove("active");
            } catch (error) {
                console.error('åŠ è½½å†å²è®°å½•å¤±è´¥:', error);
                showToast('åŠ è½½å†å²è®°å½•å¤±è´¥: ' + error.message, 'error');
            }
        }

        // è¿”å›å½“å‰ä»»åŠ¡
        async function backToCurrentTask() {
            // é¦–å…ˆæ£€æŸ¥æ˜¯å¦æœ‰ä¿å­˜çš„ä»»åŠ¡çŠ¶æ€
            if (savedTaskState && savedTaskState.taskId) {
                // æ¢å¤ä»»åŠ¡çŠ¶æ€
                currentViewMode = 'task';
                viewingHistoryId = null;

                // æ¢å¤è¾“å…¥æ¡†å€¼
                document.getElementById('textInput').value = savedTaskState.text || '';
                document.getElementById('characterInput').value = savedTaskState.character || '';
                document.getElementById('modelSelect').value = savedTaskState.model || '';

                // æ¢å¤ä»»åŠ¡ID
                currentTaskId = savedTaskState.taskId;

                // æ¸…ç©ºè§†é¢‘æ˜¾ç¤ºï¼ˆä»»åŠ¡è¿˜åœ¨è¿è¡Œä¸­ï¼Œä¸åº”è¯¥æ˜¾ç¤ºæ—§çš„è§†é¢‘ï¼‰
                document.getElementById('videoContainer').classList.add('hidden');
                document.getElementById('videoPlaceholder').classList.remove('hidden');
                document.getElementById('videoPlaceholder').textContent = 'ç­‰å¾…ç”Ÿæˆè§†é¢‘...';
                document.getElementById('videoControls').style.display = 'none';
                document.getElementById('videoInfo').style.display = 'none';

                // ç¦ç”¨è¾“å…¥ï¼ˆä¸æ”¯æŒä¿®æ”¹ï¼‰
                setInputsDisabled(true);
                document.getElementById('generateBtn').style.display = 'none';
                document.getElementById('cancelBtn').style.display = 'block';
                document.getElementById('progressContainer').style.display = 'block';

                // å…ˆæŸ¥è¯¢å½“å‰ä»»åŠ¡çŠ¶æ€ï¼ŒåŒæ­¥è¿›åº¦æ¡
                try {
                    const response = await getVideoGenerationStatus(currentTaskId);
                    if (response.success && response.data) {
                        const task = response.data;
                        const status = task.status;
                        
                        // æ ¹æ®ä»»åŠ¡çŠ¶æ€æ›´æ–°UI
                        if (status === 'pending') {
                            updateProgress(10, 'ä»»åŠ¡æ’é˜Ÿä¸­...');
                            updateStatus('ğŸ“‹ ä»»åŠ¡æ’é˜Ÿä¸­...');
                        } else if (status === 'running') {
                            // è®¡ç®—è¿›åº¦
                            let progress = 30;
                            if (task.start_time) {
                                try {
                                    const startTime = new Date(task.start_time).getTime();
                                    const elapsedSeconds = (Date.now() - startTime) / 1000;
                                    if (elapsedSeconds <= 30) {
                                        progress = 30 + Math.floor((elapsedSeconds / 30) * 10);
                                    } else if (elapsedSeconds <= 90) {
                                        progress = 40 + Math.floor(((elapsedSeconds - 30) / 60) * 10);
                                    } else if (elapsedSeconds <= 150) {
                                        progress = 50 + Math.floor(((elapsedSeconds - 90) / 60) * 10);
                                    } else if (elapsedSeconds <= 210) {
                                        progress = 60 + Math.floor(((elapsedSeconds - 150) / 60) * 10);
                                    } else if (elapsedSeconds <= 270) {
                                        progress = 70 + Math.floor(((elapsedSeconds - 210) / 60) * 10);
                                    } else {
                                        progress = Math.min(80 + Math.floor(((elapsedSeconds - 270) / 60) * 10), 90);
                                    }
                                } catch (e) {
                                    console.warn('æ— æ³•è§£æä»»åŠ¡å¼€å§‹æ—¶é—´:', e);
                                }
                            }
                            updateProgress(progress, 'ç”Ÿæˆä¸­...');
                            updateStatus('ğŸ“‹ ä»»åŠ¡ç”Ÿæˆä¸­...');
                        } else if (status === 'completed') {
                            // ä»»åŠ¡å·²å®Œæˆï¼Œæ˜¾ç¤ºè§†é¢‘
                            updateProgress(100, 'ç”Ÿæˆå®Œæˆï¼');
                            updateStatus('âœ… è§†é¢‘ç”ŸæˆæˆåŠŸï¼');
                            const videoUrl = `${getApiBaseUrl()}/videos/${currentTaskId}.mp4`;
                            displayVideo(videoUrl, task);
                            // ä»»åŠ¡å®Œæˆï¼Œæ¸…é™¤ä¿å­˜çš„çŠ¶æ€
                            savedTaskState = null;
                            setInputsDisabled(false);
                            document.getElementById('generateBtn').style.display = 'block';
                            document.getElementById('cancelBtn').style.display = 'none';
                            document.getElementById('progressContainer').style.display = 'none';
                        } else if (status === 'failed' || status === 'cancelled') {
                            // ä»»åŠ¡å¤±è´¥æˆ–å·²å–æ¶ˆ
                            const error = task.error || (status === 'cancelled' ? 'ä»»åŠ¡å·²å–æ¶ˆ' : 'æœªçŸ¥é”™è¯¯');
                            updateStatus(`âŒ ${status === 'cancelled' ? 'ä»»åŠ¡å·²å–æ¶ˆ' : 'ç”Ÿæˆå¤±è´¥'}: ${error}`);
                            // ä»»åŠ¡å¤±è´¥ï¼Œæ¸…é™¤ä¿å­˜çš„çŠ¶æ€
                            savedTaskState = null;
                            setInputsDisabled(false);
                            document.getElementById('generateBtn').style.display = 'block';
                            document.getElementById('cancelBtn').style.display = 'none';
                            document.getElementById('progressContainer').style.display = 'none';
                        }
                    }
                } catch (error) {
                    console.error('æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€å¤±è´¥:', error);
                    updateStatus('ğŸ“‹ æ­£åœ¨æ¢å¤ä»»åŠ¡çŠ¶æ€...');
                }

                // é‡æ–°å¼€å§‹çŠ¶æ€è½®è¯¢ï¼ˆå‡†å¤‡æ¥å—ä»»åŠ¡è¿”å›ï¼‰
                startStatusPolling(currentTaskId, savedTaskState.taskStartTime);

                // æ›´æ–°æŒ‰é’®çŠ¶æ€
                updateBackToTaskButton();

                // æ›´æ–°å†å²åˆ—è¡¨
                loadHistoryList();

                // å…³é—­ä¾§è¾¹æ 
                historySidebar.classList.remove("active");

                showToast('å·²è¿”å›å½“å‰ä»»åŠ¡', 'info');
                return;
            }

            // å¦‚æœæ²¡æœ‰ä¿å­˜çš„ä»»åŠ¡çŠ¶æ€ï¼Œæ£€æŸ¥æ˜¯å¦æœ‰æ­£åœ¨è¿è¡Œçš„ä»»åŠ¡
            await checkRunningTask();
            
            // å¦‚æœcheckRunningTaskæ¢å¤äº†ä»»åŠ¡ï¼ˆè®¾ç½®äº†savedTaskStateï¼‰ï¼Œè¯´æ˜æœ‰æ­£åœ¨è¿è¡Œçš„ä»»åŠ¡
            if (savedTaskState && savedTaskState.taskId) {
                // ä»»åŠ¡å·²ç»è¢«checkRunningTaskæ¢å¤äº†ï¼Œæ›´æ–°æŒ‰é’®çŠ¶æ€å¹¶å…³é—­ä¾§è¾¹æ 
                updateBackToTaskButton();
                historySidebar.classList.remove("active");
                showToast('å·²è¿”å›å½“å‰ä»»åŠ¡', 'info');
                return;
            }

            // å¦‚æœæ²¡æœ‰æ­£åœ¨è¿è¡Œçš„ä»»åŠ¡ï¼Œæ˜¾ç¤ºå¯ä»¥å¼€å§‹æ–°ä»»åŠ¡çš„é¡µé¢
            currentViewMode = 'task';
            viewingHistoryId = null;
            
            // æ¸…ç©ºè¾“å…¥æ¡†ï¼ˆå¯é€‰ï¼Œä¹Ÿå¯ä»¥ä¿ç•™å†å²è®°å½•çš„è¾“å…¥ï¼‰
            // document.getElementById('textInput').value = '';
            
            // å¯ç”¨æ‰€æœ‰è¾“å…¥æ¡†
            setInputsDisabled(false);
            document.getElementById('generateBtn').style.display = 'block';
            document.getElementById('cancelBtn').style.display = 'none';
            document.getElementById('progressContainer').style.display = 'none';

            // é‡ç½®è§†é¢‘æ˜¾ç¤º
            document.getElementById('videoContainer').classList.add('hidden');
            document.getElementById('videoPlaceholder').classList.remove('hidden');
            document.getElementById('videoPlaceholder').textContent = 'ç­‰å¾…ç”Ÿæˆè§†é¢‘...';
            document.getElementById('videoControls').style.display = 'none';
            document.getElementById('videoInfo').style.display = 'none';

            // æ›´æ–°çŠ¶æ€
            updateStatus('ç­‰å¾…å¼€å§‹...');

            // æ¸…é™¤ä»»åŠ¡çŠ¶æ€ï¼ˆå› ä¸ºæ²¡æœ‰ä»»åŠ¡ï¼‰
            savedTaskState = null;
            currentTaskId = null;
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€ï¼ˆæ˜¾ç¤º"å¼€å§‹æ–°ä»»åŠ¡"ï¼‰
            updateBackToTaskButton();

            // æ›´æ–°å†å²åˆ—è¡¨
            loadHistoryList();

            // å…³é—­ä¾§è¾¹æ 
            historySidebar.classList.remove("active");

            showToast('å½“å‰æ²¡æœ‰æ­£åœ¨æ‰§è¡Œçš„ä»»åŠ¡ï¼Œå¯ä»¥å¼€å§‹æ–°ä»»åŠ¡', 'info');
        }

        // æ›´æ–°æŒ‰é’®çŠ¶æ€ï¼ˆæ ¹æ®æ˜¯å¦æœ‰ä»»åŠ¡æ˜¾ç¤ºä¸åŒçš„æ–‡æœ¬ï¼‰
        function updateBackToTaskButton() {
            if (!backToTaskBtn) return;
            
            const hasTask = savedTaskState && savedTaskState.taskId;
            if (hasTask) {
                backToTaskBtn.textContent = 'â† è¿”å›å½“å‰ä»»åŠ¡';
                backToTaskBtn.disabled = false;
            } else {
                backToTaskBtn.textContent = 'ğŸš€ å¼€å§‹æ–°ä»»åŠ¡';
                backToTaskBtn.disabled = false;
            }
        }

        if (backToTaskBtn) {
            backToTaskBtn.addEventListener("click", () => {
                const hasTask = savedTaskState && savedTaskState.taskId;
                if (hasTask) {
                    // æœ‰ä»»åŠ¡ï¼Œè¿”å›å½“å‰ä»»åŠ¡
                    backToCurrentTask();
                } else {
                    // æ²¡æœ‰ä»»åŠ¡ï¼Œå¼€å§‹æ–°ä»»åŠ¡ - æ¸…ç©ºæ‰€æœ‰é…ç½®å¹¶ç­‰å¾…ç”¨æˆ·å¡«å†™
                    currentViewMode = 'task';
                    viewingHistoryId = null;
                    historySidebar.classList.remove("active");
                    
                    // æ¸…ç©ºæ‰€æœ‰è¾“å…¥æ¡†
                    document.getElementById('textInput').value = '';
                    document.getElementById('characterInput').value = '';
                    document.getElementById('modelSelect').value = '';
                    
                    // å¯ç”¨æ‰€æœ‰è¾“å…¥æ¡†
                    setInputsDisabled(false);
                    document.getElementById('generateBtn').style.display = 'block';
                    document.getElementById('cancelBtn').style.display = 'none';
                    document.getElementById('progressContainer').style.display = 'none';
                    
                    // é‡ç½®è§†é¢‘æ˜¾ç¤º
                    document.getElementById('videoContainer').classList.add('hidden');
                    document.getElementById('videoPlaceholder').classList.remove('hidden');
                    document.getElementById('videoPlaceholder').textContent = 'ç­‰å¾…ç”Ÿæˆè§†é¢‘...';
                    document.getElementById('videoControls').style.display = 'none';
                    document.getElementById('videoInfo').style.display = 'none';
                    
                    // æ›´æ–°çŠ¶æ€
                    updateStatus('ç­‰å¾…å¼€å§‹...');
                    
                    // æ¸…é™¤ä»»åŠ¡çŠ¶æ€
                    savedTaskState = null;
                    currentTaskId = null;
                    
                    // æ›´æ–°æŒ‰é’®çŠ¶æ€
                    updateBackToTaskButton();
                    
                    // ä¸è°ƒç”¨ startGeneration()ï¼Œç­‰å¾…ç”¨æˆ·å¡«å†™åç‚¹å‡»"å¼€å§‹ç”Ÿæˆè§†é¢‘"æŒ‰é’®
                }
            });
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', async () => {
            // åº”ç”¨è®¾ç½®ï¼ˆä»æ•°æ®åº“è¯»å–ï¼‰
            try {
                const settings = await fetchSettings();
                await Promise.all([
                    applySettingsOnly(settings),
                    updateThemeSelection(settings),
                    updateFontSelection(settings),
                    updateFontSizeSelection(settings)
                ]);
            } catch (error) {
                console.error('åº”ç”¨è®¾ç½®å¤±è´¥:', error);
            }

            // è®¾ç½®ä¾§è¾¹æ æ§åˆ¶
            const settingsBtn = document.getElementById('settingsBtn');
            const settingsSidebar = document.getElementById('settingsSidebar');
            const sidebarOverlay = document.getElementById('sidebarOverlay');
            const sidebarClose = document.getElementById('sidebarClose');

            if (settingsBtn && settingsSidebar) {
                const openSidebar = () => {
                    settingsSidebar.classList.add('active');
                    sidebarOverlay.classList.add('active');
                };

                const closeSidebar = () => {
                    settingsSidebar.classList.remove('active');
                    sidebarOverlay.classList.remove('active');
                };

                settingsBtn.addEventListener('click', openSidebar);
                if (sidebarClose) sidebarClose.addEventListener('click', closeSidebar);
                if (sidebarOverlay) sidebarOverlay.addEventListener('click', closeSidebar);

                // æ ‡ç­¾åˆ‡æ¢
                document.querySelectorAll('.sidebar-tab').forEach(tab => {
                    tab.addEventListener('click', () => {
                        const targetTab = tab.dataset.tab;
                        document.querySelectorAll('.sidebar-tab').forEach(t => t.classList.remove('active'));
                        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                        tab.classList.add('active');
                        const targetContent = document.getElementById(targetTab + 'Tab');
                        if (targetContent) targetContent.classList.add('active');
                    });
                });

                // ä¸»é¢˜é€‰æ‹©
                document.querySelectorAll('[data-theme]').forEach(card => {
                    card.addEventListener('click', () => {
                        applyTheme(card.dataset.theme);
                    });
                });

                // å­—ä½“é€‰æ‹©
                document.querySelectorAll('[data-font]').forEach(card => {
                    card.addEventListener('click', () => {
                        applyFont(card.dataset.font);
                    });
                });

                // å­—å·é€‰æ‹©
                document.querySelectorAll('[data-size]').forEach(btn => {
                    btn.addEventListener('click', () => {
                        if (btn.dataset.size === 'custom') {
                            const customInput = document.getElementById('customSizeInput');
                            if (customInput) customInput.style.display = 'block';
                        } else {
                            const customInput = document.getElementById('customSizeInput');
                            if (customInput) customInput.style.display = 'none';
                            applyFontSize(btn.dataset.size);
                        }
                    });
                });

                // è‡ªå®šä¹‰å­—å·è¾“å…¥
                const customSizeInput = document.getElementById('customSizeValue');
                if (customSizeInput) {
                    customSizeInput.addEventListener('change', () => {
                        applyFontSize('custom');
                    });
                }
            }

            // å…ˆåŠ è½½è§’è‰²å’Œæ¨¡å‹åˆ—è¡¨
            await Promise.all([loadCharacters(), loadModels()]);
            
            // æ£€æŸ¥ URL å‚æ•°ï¼Œå¦‚æœæ˜¯ mode=newï¼Œåˆ™æ¸…ç©ºé…ç½®å¹¶è·³è¿‡ä»»åŠ¡æ£€æŸ¥
            const urlParams = new URLSearchParams(window.location.search);
            const mode = urlParams.get('mode');
            
            if (mode === 'new') {
                // æ–°ä»»åŠ¡æ¨¡å¼ï¼šæ¸…ç©ºæ‰€æœ‰é…ç½®
                document.getElementById('textInput').value = '';
                document.getElementById('characterInput').value = '';
                document.getElementById('modelSelect').value = '';
                
                // é‡ç½®UIçŠ¶æ€
                setInputsDisabled(false);
                document.getElementById('generateBtn').style.display = 'block';
                document.getElementById('cancelBtn').style.display = 'none';
                document.getElementById('progressContainer').style.display = 'none';
                
                // é‡ç½®è§†é¢‘æ˜¾ç¤º
                document.getElementById('videoContainer').classList.add('hidden');
                document.getElementById('videoPlaceholder').classList.remove('hidden');
                document.getElementById('videoPlaceholder').textContent = 'ç­‰å¾…ç”Ÿæˆè§†é¢‘...';
                document.getElementById('videoControls').style.display = 'none';
                document.getElementById('videoInfo').style.display = 'none';
                
                // æ›´æ–°çŠ¶æ€
                updateStatus('ç­‰å¾…å¼€å§‹...');
                
                // æ¸…é™¤ä»»åŠ¡çŠ¶æ€
                savedTaskState = null;
                currentTaskId = null;
                currentViewMode = 'task';
                viewingHistoryId = null;
                
                // æ›´æ–°æŒ‰é’®çŠ¶æ€
                updateBackToTaskButton();
                
                // æ¸…é™¤ URL å‚æ•°ï¼ˆå¯é€‰ï¼Œè®© URL æ›´å¹²å‡€ï¼‰
                if (window.history.replaceState) {
                    window.history.replaceState({}, '', 'generate.html');
                }
            } else {
                // æ­£å¸¸æ¨¡å¼ï¼šæ£€æŸ¥è¿è¡Œä¸­çš„ä»»åŠ¡
            await checkRunningTask();
            }
            
            // åˆå§‹åŒ–æŒ‰é’®çŠ¶æ€
            updateBackToTaskButton();
            
            // ä¸å†è‡ªåŠ¨åˆ·æ–°å†å²è®°å½•åˆ—è¡¨ï¼Œé¿å…å±å¹•é—ªçƒ
            // åªåœ¨ç”¨æˆ·æ‰“å¼€ä¾§è¾¹æ æ—¶åŠ è½½ä¸€æ¬¡ï¼Œæˆ–ç”¨æˆ·æ‰‹åŠ¨åˆ·æ–°
        });

        // åŠ è½½è§’è‰²åˆ—è¡¨ï¼ˆå¸¦è¶…æ—¶å¤„ç†ï¼‰
        async function loadCharacters() {
            const select = document.getElementById('characterInput');
            const refreshBtn = document.getElementById('refreshCharacterBtn');
            const isUserRefresh = refreshBtn && refreshBtn.disabled === false; // åˆ¤æ–­æ˜¯å¦æ˜¯ç”¨æˆ·ä¸»åŠ¨åˆ·æ–°

            try {
                if (refreshBtn) refreshBtn.disabled = true;
                select.innerHTML = '<option value="">åŠ è½½ä¸­...</option>';

                // api.js ä¸­å·²ç»è®¾ç½®äº† 5 ç§’è¶…æ—¶ï¼Œè¿™é‡Œç›´æ¥è°ƒç”¨å³å¯
                const characters = await getCharacters();

                if (characters.length === 0) {
                    select.innerHTML = '<option value="">æœªæ‰¾åˆ°è§’è‰²</option>';
                    if (isUserRefresh) {
                        showToast('æœªæ‰¾åˆ°å·²è®­ç»ƒçš„è§’è‰²', 'warning');
                    }
                    return;
                }

                select.innerHTML = characters.map(c => `<option value="${c}">${c}</option>`).join('');
                if (characters.length > 0) {
                    select.value = characters[0];
                }
            } catch (error) {
                console.error('åŠ è½½è§’è‰²å¤±è´¥:', error);
                const errorMsg = error.message || 'æœªçŸ¥é”™è¯¯';

                // æ ¹æ®é”™è¯¯ç±»å‹æ˜¾ç¤ºä¸åŒçš„æç¤º
                if (errorMsg.includes('è¶…æ—¶') || errorMsg.includes('timeout') || errorMsg.includes('Failed to fetch')) {
                    select.innerHTML = '<option value="">åç«¯æœªè¿æ¥</option>';
                    if (isUserRefresh) {
                        showToast('åç«¯æœåŠ¡æœªå¯åŠ¨æˆ–æ— æ³•è¿æ¥', 'error');
                    } else {
                        console.warn('åç«¯æœåŠ¡å¯èƒ½æœªå¯åŠ¨ï¼Œé¡µé¢å·²å°±ç»ªï¼Œå¯ä»¥ç¨åé‡è¯•');
                    }
                } else {
                    select.innerHTML = '<option value="">åŠ è½½å¤±è´¥</option>';
                    if (isUserRefresh) {
                        showToast('åŠ è½½è§’è‰²å¤±è´¥: ' + errorMsg, 'error');
                    }
                }
            } finally {
                if (refreshBtn) refreshBtn.disabled = false;
            }
        }

        // åŠ è½½æ¨¡å‹åˆ—è¡¨ï¼ˆå¸¦è¶…æ—¶å¤„ç†ï¼‰
        async function loadModels() {
            const select = document.getElementById('modelSelect');
            const refreshBtn = document.getElementById('refreshBtn');
            const isUserRefresh = refreshBtn.disabled === false; // åˆ¤æ–­æ˜¯å¦æ˜¯ç”¨æˆ·ä¸»åŠ¨åˆ·æ–°

            try {
                refreshBtn.disabled = true;
                select.innerHTML = '<option value="">åŠ è½½ä¸­...</option>';

                // api.js ä¸­å·²ç»è®¾ç½®äº† 5 ç§’è¶…æ—¶ï¼Œè¿™é‡Œç›´æ¥è°ƒç”¨å³å¯
                const models = await getModels();

                if (models.length === 0) {
                    select.innerHTML = '<option value="">æœªæ‰¾åˆ°æ¨¡å‹</option>';
                    if (isUserRefresh) {
                        showToast('æœªæ‰¾åˆ°æ¨¡å‹', 'error');
                    }
                    return;
                }

                select.innerHTML = models.map(m => `<option value="${m}">${m}</option>`).join('');
                if (models.length > 0) {
                    select.value = models[0];
                }
            } catch (error) {
                console.error('åŠ è½½æ¨¡å‹å¤±è´¥:', error);
                const errorMsg = error.message || 'æœªçŸ¥é”™è¯¯';

                // æ ¹æ®é”™è¯¯ç±»å‹æ˜¾ç¤ºä¸åŒçš„æç¤º
                if (errorMsg.includes('è¶…æ—¶') || errorMsg.includes('timeout') || errorMsg.includes('Failed to fetch')) {
                    select.innerHTML = '<option value="">åç«¯æœªè¿æ¥</option>';
                    if (isUserRefresh) {
                        showToast('åç«¯æœåŠ¡æœªå¯åŠ¨æˆ–æ— æ³•è¿æ¥', 'error');
                    } else {
                        console.warn('åç«¯æœåŠ¡å¯èƒ½æœªå¯åŠ¨ï¼Œé¡µé¢å·²å°±ç»ªï¼Œå¯ä»¥ç¨åé‡è¯•');
                    }
                } else {
                    select.innerHTML = '<option value="">åŠ è½½å¤±è´¥</option>';
                    if (isUserRefresh) {
                        showToast('åŠ è½½æ¨¡å‹å¤±è´¥: ' + errorMsg, 'error');
                    }
                }
            } finally {
                refreshBtn.disabled = false;
            }
        }

        // æ£€æŸ¥æ˜¯å¦æœ‰æ­£åœ¨è¿è¡Œçš„ä»»åŠ¡ï¼ˆå¸¦è¶…æ—¶å¤„ç†ï¼‰
        async function checkRunningTask() {
            try {
                const apiUrl = getApiBaseUrl();

                // api.js ä¸­å·²ç»è®¾ç½®äº†è¶…æ—¶ï¼Œè¿™é‡Œç›´æ¥è°ƒç”¨å³å¯
                const response = await fetch(`${apiUrl}/generate_video/running`, {
                    signal: AbortSignal.timeout(3000) // 3ç§’è¶…æ—¶
                });

                if (!response.ok) {
                    return; // å¦‚æœå“åº”ä¸æˆåŠŸï¼Œé™é»˜å¤±è´¥
                }

                const data = await response.json();

                if (data.success && data.data) {
                    const task = data.data;
                    const status = task.status;

                    // åªæ¢å¤çœŸæ­£åœ¨è¿è¡Œä¸­çš„ä»»åŠ¡ï¼ˆpending æˆ– runningï¼‰
                    // å¦‚æœä»»åŠ¡å·²ç»å®Œæˆæˆ–å¤±è´¥ï¼Œä¸åº”è¯¥æ¢å¤
                    if (status !== 'pending' && status !== 'running') {
                        console.log(`æ£€æµ‹åˆ°ä»»åŠ¡ ${task.unique_id}ï¼Œä½†çŠ¶æ€ä¸º ${status}ï¼Œä¸æ¢å¤`);
                        return;
                    }

                    currentTaskId = task.unique_id;

                    // ä¿å­˜ä»»åŠ¡çŠ¶æ€ï¼ˆç”¨äºå†å²è®°å½•åˆ‡æ¢ï¼‰
                    savedTaskState = {
                        taskId: task.unique_id,
                        text: task.text || '',
                        character: task.character || 'ayanami',
                        model: task.model_name || '',
                        statusPollInterval: true
                    };

                    // æ¢å¤UIçŠ¶æ€
                    document.getElementById('textInput').value = task.text || '';
                    document.getElementById('characterInput').value = task.character || 'ayanami';
                    document.getElementById('modelSelect').value = task.model_name || '';

                    // æ¸…ç©ºè§†é¢‘æ˜¾ç¤ºï¼ˆä»»åŠ¡è¿˜åœ¨è¿è¡Œä¸­ï¼Œä¸åº”è¯¥æ˜¾ç¤ºæ—§çš„è§†é¢‘ï¼‰
                    document.getElementById('videoContainer').classList.add('hidden');
                    document.getElementById('videoPlaceholder').classList.remove('hidden');
                    document.getElementById('videoPlaceholder').textContent = 'ç­‰å¾…ç”Ÿæˆè§†é¢‘...';
                    document.getElementById('videoControls').style.display = 'none';
                    document.getElementById('videoInfo').style.display = 'none';

                    setInputsDisabled(true);
                    document.getElementById('generateBtn').style.display = 'none';
                    document.getElementById('cancelBtn').style.display = 'block';
                    document.getElementById('progressContainer').style.display = 'block';

                    // æ ¹æ®ä»»åŠ¡å¼€å§‹æ—¶é—´è®¡ç®—åˆå§‹è¿›åº¦
                    let initialProgress = 10;
                    if (task.start_time) {
                        try {
                            const startTime = new Date(task.start_time).getTime();
                            const elapsedSeconds = (Date.now() - startTime) / 1000;

                            // å¦‚æœä»»åŠ¡å·²ç»è¿è¡Œäº†è¶…è¿‡30åˆ†é’Ÿï¼Œä¸åº”è¯¥æ¢å¤ï¼ˆå¯èƒ½æ˜¯å¼‚å¸¸ä»»åŠ¡ï¼‰
                            if (elapsedSeconds > 1800) {
                                console.warn(`ä»»åŠ¡è¿è¡Œæ—¶é—´è¿‡é•¿ (${Math.floor(elapsedSeconds / 60)} åˆ†é’Ÿ)ï¼Œä¸æ¢å¤`);
                                resetUI();
                                return;
                            }

                            // å¦‚æœä»»åŠ¡å·²ç»è¿è¡Œäº†ä¸€æ®µæ—¶é—´ï¼Œè®¾ç½®ä¸€ä¸ªåˆç†çš„åˆå§‹è¿›åº¦
                            if (elapsedSeconds > 30) {
                                initialProgress = Math.min(40 + Math.floor((elapsedSeconds - 30) / 30) * 5, 90);
                            } else {
                                initialProgress = 30 + Math.floor((elapsedSeconds / 30) * 10);
                            }
                        } catch (e) {
                            console.warn('æ— æ³•è§£æä»»åŠ¡å¼€å§‹æ—¶é—´:', e);
                        }
                    }
                    updateProgress(initialProgress, 'æ¢å¤ä»»åŠ¡ä¸­...');

                    // å¼€å§‹è½®è¯¢çŠ¶æ€
                    startStatusPolling(currentTaskId, task.start_time);
                    showToast('æ£€æµ‹åˆ°æ­£åœ¨è¿è¡Œçš„ä»»åŠ¡ï¼Œå·²æ¢å¤', 'info');
                    
                    // æ›´æ–°æŒ‰é’®çŠ¶æ€
                    updateBackToTaskButton();
                } else {
                    // æ²¡æœ‰æ‰¾åˆ°è¿è¡Œä¸­çš„ä»»åŠ¡ï¼Œæ›´æ–°æŒ‰é’®çŠ¶æ€
                    updateBackToTaskButton();
                }
            } catch (error) {
                // é™é»˜å¤±è´¥ï¼Œä¸æ˜¾ç¤ºé”™è¯¯æç¤ºï¼ˆå› ä¸ºå¯èƒ½æ˜¯åç«¯æœªå¯åŠ¨ï¼‰
                // åªåœ¨æ§åˆ¶å°è®°å½•ï¼Œä¸å½±å“ç”¨æˆ·ä½“éªŒ
                if (error.name !== 'AbortError' && !error.message.includes('timeout')) {
                    console.log('æ£€æŸ¥è¿è¡Œä»»åŠ¡:', error.message || 'åç«¯æœåŠ¡å¯èƒ½æœªå¯åŠ¨');
                }
                // å³ä½¿å‡ºé”™ä¹Ÿæ›´æ–°æŒ‰é’®çŠ¶æ€ï¼ˆæ˜¾ç¤º"å¼€å§‹æ–°ä»»åŠ¡"ï¼‰
                updateBackToTaskButton();
            }
        }

        // å¼€å§‹ç”Ÿæˆè§†é¢‘
        async function startGeneration() {
            const text = document.getElementById('textInput').value.trim();
            const character = document.getElementById('characterInput').value;
            const model = document.getElementById('modelSelect').value;

            if (!text) {
                showToast('è¯·è¾“å…¥æ–‡æœ¬', 'error');
                return;
            }

            if (!model) {
                showToast('è¯·é€‰æ‹©æ¨¡å‹', 'error');
                return;
            }

            // ç¦ç”¨è¾“å…¥
            setInputsDisabled(true);
            document.getElementById('generateBtn').style.display = 'none';
            document.getElementById('cancelBtn').style.display = 'block';
            document.getElementById('progressContainer').style.display = 'block';

            // é‡ç½®UI
            document.getElementById('videoContainer').classList.add('hidden');
            document.getElementById('videoPlaceholder').classList.remove('hidden');
            document.getElementById('videoPlaceholder').textContent = 'ç­‰å¾…ç”Ÿæˆè§†é¢‘...';
            document.getElementById('videoControls').style.display = 'none';
            document.getElementById('videoInfo').style.display = 'none';
            updateStatus('ğŸ“‹ æäº¤ä»»åŠ¡ä¸­...');
            updateProgress(0, 'æäº¤ä»»åŠ¡...');

            try {
                // æäº¤ä»»åŠ¡
                const result = await generateVideo({
                    text: text,
                    character: character,
                    model_name: model
                });

                if (!result.success) {
                    throw new Error(result.error || 'ä»»åŠ¡æäº¤å¤±è´¥');
                }

                currentTaskId = result.unique_id;
                
                // ä¿å­˜ä»»åŠ¡çŠ¶æ€ï¼ˆç”¨äºå†å²è®°å½•åˆ‡æ¢ï¼‰
                savedTaskState = {
                    taskId: currentTaskId,
                    text: text,
                    character: character,
                    model: model,
                    statusPollInterval: true,
                    taskStartTime: null // ä»»åŠ¡åˆšæäº¤ï¼Œè¿˜æ²¡æœ‰å¼€å§‹æ—¶é—´
                };
                
                // ç¡®ä¿è§†å›¾æ¨¡å¼æ˜¯ä»»åŠ¡æ¨¡å¼
                currentViewMode = 'task';
                viewingHistoryId = null;
                updateBackToTaskButton();

                updateStatus(`ğŸ“‹ ä»»åŠ¡å·²æäº¤ (ID: ${currentTaskId.substring(0, 8)}...)`);
                showToast('ä»»åŠ¡å·²æäº¤ï¼Œæ­£åœ¨åå°ç”Ÿæˆä¸­...', 'info');

                // å¼€å§‹è½®è¯¢çŠ¶æ€
                startStatusPolling(currentTaskId);

            } catch (error) {
                console.error('ç”Ÿæˆå¤±è´¥:', error);
                updateStatus('âŒ ä»»åŠ¡æäº¤å¤±è´¥: ' + error.message);
                showToast('ä»»åŠ¡æäº¤å¤±è´¥: ' + error.message, 'error');
                resetUI();
            }
        }

        // å¼€å§‹çŠ¶æ€è½®è¯¢
        function startStatusPolling(taskId, taskStartTime = null) {
            if (statusPollInterval) {
                clearInterval(statusPollInterval);
            }

            let pollCount = 0;
            let lastProgress = 0; // è®°å½•ä¸Šæ¬¡çš„è¿›åº¦å€¼ï¼Œé¿å…å€’é€€
            let consecutiveFailures = 0; // è¿ç»­å¤±è´¥æ¬¡æ•°

            // ç¡®å®šå¼€å§‹æ—¶é—´ï¼šå¦‚æœæä¾›äº†ä»»åŠ¡å¼€å§‹æ—¶é—´ï¼Œä½¿ç”¨å®ƒï¼›å¦åˆ™ä½¿ç”¨å½“å‰æ—¶é—´
            let startTime;
            if (taskStartTime) {
                try {
                    startTime = new Date(taskStartTime).getTime();
                } catch (e) {
                    console.warn('æ— æ³•è§£æä»»åŠ¡å¼€å§‹æ—¶é—´ï¼Œä½¿ç”¨å½“å‰æ—¶é—´:', e);
                    startTime = Date.now();
                }
            } else {
                startTime = Date.now();
            }

            // æœ€å¤§è¿è¡Œæ—¶é—´ï¼š30åˆ†é’Ÿï¼ˆ1800ç§’ï¼‰ï¼Œè¶…è¿‡è¿™ä¸ªæ—¶é—´åº”è¯¥åœæ­¢è½®è¯¢
            const MAX_RUNTIME_SECONDS = 1800;

            statusPollInterval = setInterval(async () => {
                pollCount++;
                const elapsedSeconds = (Date.now() - startTime) / 1000;

                // å¦‚æœè¿è¡Œæ—¶é—´è¶…è¿‡æœ€å¤§æ—¶é—´ï¼Œåœæ­¢è½®è¯¢
                if (elapsedSeconds > MAX_RUNTIME_SECONDS) {
                    clearInterval(statusPollInterval);
                    statusPollInterval = null;
                    updateStatus('â±ï¸ ä»»åŠ¡è¿è¡Œæ—¶é—´è¿‡é•¿ï¼Œå·²åœæ­¢ç›‘æ§ã€‚è¯·æ£€æŸ¥åç«¯æ—¥å¿—æˆ–æ‰‹åŠ¨åˆ·æ–°é¡µé¢ã€‚');
                    resetUI();
                    showToast('ä»»åŠ¡è¿è¡Œæ—¶é—´è¿‡é•¿ï¼Œå·²åœæ­¢ç›‘æ§', 'warning');
                    return;
                }

                try {
                    const response = await getVideoGenerationStatus(taskId);

                    // å¦‚æœæŸ¥è¯¢å¤±è´¥æˆ–ä»»åŠ¡ä¸å­˜åœ¨ï¼Œå¢åŠ å¤±è´¥è®¡æ•°
                    if (!response.success) {
                        consecutiveFailures++;
                        console.warn(`ä»»åŠ¡çŠ¶æ€æŸ¥è¯¢å¤±è´¥ (${consecutiveFailures}/5):`, response.error || 'æœªçŸ¥é”™è¯¯');

                        if (consecutiveFailures >= 5) {
                            // è¿ç»­å¤±è´¥5æ¬¡ï¼Œåœæ­¢è½®è¯¢
                            clearInterval(statusPollInterval);
                            statusPollInterval = null;
                            updateStatus('âŒ ä»»åŠ¡çŠ¶æ€æŸ¥è¯¢å¤±è´¥ï¼Œå·²åœæ­¢ç›‘æ§');
                            resetUI();
                            showToast('ä»»åŠ¡çŠ¶æ€æŸ¥è¯¢å¤±è´¥ï¼Œè¯·æ£€æŸ¥åç«¯æœåŠ¡', 'error');
                        }
                        return;
                    }

                    // å¦‚æœä»»åŠ¡æ•°æ®ä¸å­˜åœ¨ï¼Œä¹Ÿè§†ä¸ºå¤±è´¥
                    if (!response.data) {
                        consecutiveFailures++;
                        console.warn(`ä»»åŠ¡æ•°æ®ä¸å­˜åœ¨ (${consecutiveFailures}/5)`);

                        if (consecutiveFailures >= 5) {
                            clearInterval(statusPollInterval);
                            statusPollInterval = null;
                            updateStatus('âŒ ä»»åŠ¡ä¸å­˜åœ¨ï¼Œå·²åœæ­¢ç›‘æ§ã€‚ä»»åŠ¡å¯èƒ½åœ¨åå°è¿è¡Œï¼Œå¯åœ¨å†å²è®°å½•ä¸­æŸ¥çœ‹ã€‚');
                            // ä¸æ¸…é™¤ savedTaskStateï¼Œä¿ç•™ä»»åŠ¡ä¿¡æ¯
                            // åˆ·æ–°å†å²è®°å½•ï¼Œç¡®ä¿ä»»åŠ¡å‡ºç°åœ¨å†å²è®°å½•ä¸­
                            loadHistoryList();
                            // åªåœ¨ä»»åŠ¡æ¨¡å¼ä¸‹æ˜¾ç¤ºé”™è¯¯æç¤º
                            if (currentViewMode === 'task') {
                                showToast('ä»»åŠ¡ä¸å­˜åœ¨ï¼Œå·²åœæ­¢ç›‘æ§ã€‚ä»»åŠ¡å¯èƒ½åœ¨åå°è¿è¡Œï¼Œå¯åœ¨å†å²è®°å½•ä¸­æŸ¥çœ‹ã€‚', 'warning');
                            }
                        }
                        return;
                    }

                    // æŸ¥è¯¢æˆåŠŸï¼Œé‡ç½®å¤±è´¥è®¡æ•°
                    consecutiveFailures = 0;

                    const task = response.data;
                    const status = task.status;

                    // æ›´æ–°è¿›åº¦
                    if (status === 'pending') {
                        updateProgress(10, 'ä»»åŠ¡æ’é˜Ÿä¸­...');
                        lastProgress = 10;
                    } else if (status === 'running') {
                        // æ ¹æ®å·²è¿è¡Œæ—¶é—´è®¡ç®—è¿›åº¦ï¼ˆæœ€å¤šåˆ°90%ï¼Œç•™10%ç»™å®Œæˆï¼‰
                        // è¿›åº¦è®¡ç®—é€»è¾‘ï¼š
                        // 0-30ç§’ï¼š30-40%
                        // 30-90ç§’ï¼š40-50%
                        // 90-150ç§’ï¼š50-60%
                        // 150-210ç§’ï¼š60-70%
                        // 210-270ç§’ï¼š70-80%
                        // 270ç§’ä»¥ä¸Šï¼š80-90%
                        let progress = 30;
                        if (elapsedSeconds <= 30) {
                            progress = 30 + Math.floor((elapsedSeconds / 30) * 10);
                        } else if (elapsedSeconds <= 90) {
                            progress = 40 + Math.floor(((elapsedSeconds - 30) / 60) * 10);
                        } else if (elapsedSeconds <= 150) {
                            progress = 50 + Math.floor(((elapsedSeconds - 90) / 60) * 10);
                        } else if (elapsedSeconds <= 210) {
                            progress = 60 + Math.floor(((elapsedSeconds - 150) / 60) * 10);
                        } else if (elapsedSeconds <= 270) {
                            progress = 70 + Math.floor(((elapsedSeconds - 210) / 60) * 10);
                        } else {
                            progress = Math.min(80 + Math.floor(((elapsedSeconds - 270) / 60) * 10), 90);
                        }

                        // ç¡®ä¿è¿›åº¦ä¸ä¼šå€’é€€ï¼ˆè‡³å°‘ä¿æŒä¸Šæ¬¡çš„è¿›åº¦ï¼‰
                        if (progress < lastProgress) {
                            progress = lastProgress;
                        }
                        // ä½†å…è®¸å°å¹…å¢é•¿ï¼ˆå³ä½¿è®¡ç®—å€¼ç›¸åŒï¼Œä¹Ÿç¨å¾®å¢åŠ ä¸€ç‚¹ï¼Œé¿å…å®Œå…¨å¡ä½ï¼‰
                        else if (progress === lastProgress && elapsedSeconds > 60) {
                            progress = Math.min(lastProgress + 0.5, 90);
                        }

                        lastProgress = progress;

                        const minutes = Math.floor(elapsedSeconds / 60);
                        const seconds = Math.floor(elapsedSeconds % 60);
                        const timeStr = minutes > 0 ? `${minutes}åˆ†${seconds}ç§’` : `${seconds}ç§’`;
                        updateProgress(progress, `ç”Ÿæˆä¸­... (å·²è¿è¡Œ ${timeStr})`);
                    } else if (status === 'completed') {
                        // ä»»åŠ¡å®Œæˆ
                        clearInterval(statusPollInterval);
                        statusPollInterval = null;

                        updateProgress(100, 'ç”Ÿæˆå®Œæˆï¼');
                        updateStatus('âœ… è§†é¢‘ç”ŸæˆæˆåŠŸï¼');

                        // æ˜¾ç¤ºè§†é¢‘
                        const videoUrl = `${getApiBaseUrl()}/videos/${taskId}.mp4`;
                        displayVideo(videoUrl, task);

                        // ä»»åŠ¡å®Œæˆï¼Œæ¸…é™¤ä¿å­˜çš„çŠ¶æ€
                        savedTaskState = null;
                        updateBackToTaskButton();

                        // åˆ·æ–°å†å²è®°å½•åˆ—è¡¨ï¼ˆä»»åŠ¡å·²å®Œæˆï¼Œåº”è¯¥å‡ºç°åœ¨å†å²è®°å½•ä¸­ï¼‰
                        loadHistoryList();

                        // åªåœ¨ä»»åŠ¡æ¨¡å¼ä¸‹é‡ç½®UI
                        if (currentViewMode === 'task') {
                        resetUI();
                        }
                        showToast('è§†é¢‘ç”ŸæˆæˆåŠŸï¼', 'success');

                    } else if (status === 'failed' || status === 'cancelled') {
                        // ä»»åŠ¡å¤±è´¥æˆ–å·²å–æ¶ˆ
                        clearInterval(statusPollInterval);
                        statusPollInterval = null;

                        const error = task.error || (status === 'cancelled' ? 'ä»»åŠ¡å·²å–æ¶ˆ' : 'æœªçŸ¥é”™è¯¯');
                        updateStatus(`âŒ ${status === 'cancelled' ? 'ä»»åŠ¡å·²å–æ¶ˆ' : 'ç”Ÿæˆå¤±è´¥'}: ${error}`);
                        showToast(status === 'cancelled' ? 'ä»»åŠ¡å·²å–æ¶ˆ' : ('ç”Ÿæˆå¤±è´¥: ' + error), 'error');
                        
                        // ä»»åŠ¡å¤±è´¥ï¼Œæ¸…é™¤ä¿å­˜çš„çŠ¶æ€
                        savedTaskState = null;
                        updateBackToTaskButton();
                        
                        // åˆ·æ–°å†å²è®°å½•åˆ—è¡¨ï¼ˆä»»åŠ¡å·²å¤±è´¥ï¼Œåº”è¯¥å‡ºç°åœ¨å†å²è®°å½•ä¸­ï¼‰
                        loadHistoryList();
                        
                        // åªåœ¨ä»»åŠ¡æ¨¡å¼ä¸‹é‡ç½®UI
                        if (currentViewMode === 'task') {
                        resetUI();
                        }
                    } else {
                        // æœªçŸ¥çŠ¶æ€ï¼Œè®°å½•æ—¥å¿—ä½†ç»§ç»­è½®è¯¢
                        console.warn('æœªçŸ¥ä»»åŠ¡çŠ¶æ€:', status);
                    }
                } catch (error) {
                    console.error('çŠ¶æ€æŸ¥è¯¢å¼‚å¸¸:', error);
                    consecutiveFailures++;

                    if (consecutiveFailures >= 5) {
                        // å¦‚æœè¿ç»­å¤±è´¥å¤šæ¬¡ï¼Œåœæ­¢è½®è¯¢
                        clearInterval(statusPollInterval);
                        statusPollInterval = null;
                        updateStatus('âŒ çŠ¶æ€æŸ¥è¯¢å¤±è´¥ï¼Œå·²åœæ­¢ç›‘æ§ã€‚ä»»åŠ¡ä»åœ¨åå°è¿è¡Œï¼Œå¯åœ¨å†å²è®°å½•ä¸­æŸ¥çœ‹ã€‚');
                        // ä¸æ¸…é™¤ savedTaskStateï¼Œä¿ç•™ä»»åŠ¡ä¿¡æ¯ï¼Œç”¨æˆ·å¯ä»¥é€šè¿‡å†å²è®°å½•æŸ¥çœ‹
                        // åˆ·æ–°å†å²è®°å½•ï¼Œç¡®ä¿ä»»åŠ¡å‡ºç°åœ¨å†å²è®°å½•ä¸­
                        loadHistoryList();
                        // åªåœ¨ä»»åŠ¡æ¨¡å¼ä¸‹æ˜¾ç¤ºé”™è¯¯æç¤º
                        if (currentViewMode === 'task') {
                            showToast('çŠ¶æ€æŸ¥è¯¢å¤±è´¥ï¼Œè¯·æ£€æŸ¥åç«¯æœåŠ¡ã€‚ä»»åŠ¡ä»åœ¨åå°è¿è¡Œï¼Œå¯åœ¨å†å²è®°å½•ä¸­æŸ¥çœ‹ã€‚', 'error');
                        }
                    }
                }
            }, 2000); // æ¯2ç§’è½®è¯¢ä¸€æ¬¡
        }

        // æ˜¾ç¤ºè§†é¢‘
        function displayVideo(videoUrl, task) {
            const video = document.getElementById('videoOutput');
            const videoContainer = document.getElementById('videoContainer');
            const placeholder = document.getElementById('videoPlaceholder');

            // æ·»åŠ æ—¶é—´æˆ³å‚æ•°ï¼Œé¿å…ç¼“å­˜é—®é¢˜
            const urlWithTimestamp = videoUrl + (videoUrl.includes('?') ? '&' : '?') + 't=' + Date.now();

            // è®¾ç½®è§†é¢‘æº
            video.src = urlWithTimestamp;
            video.load();

            // æ˜¾ç¤ºè§†é¢‘å®¹å™¨ï¼Œéšè—å ä½ç¬¦
            videoContainer.classList.remove('hidden');
            placeholder.classList.add('hidden');

            // å¤„ç†è§†é¢‘åŠ è½½é”™è¯¯
            video.onerror = function (e) {
                console.error('è§†é¢‘åŠ è½½å¤±è´¥:', videoUrl, e);
                showToast('è§†é¢‘åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥è§†é¢‘æ–‡ä»¶æ˜¯å¦å­˜åœ¨', 'error');
                videoContainer.classList.add('hidden');
                placeholder.classList.remove('hidden');
                placeholder.textContent = 'è§†é¢‘åŠ è½½å¤±è´¥';
            };

            // è§†é¢‘å¯ä»¥æ’­æ”¾æ—¶æ˜¾ç¤ºæ§åˆ¶æŒ‰é’®å’Œä¿¡æ¯
            video.oncanplay = function () {
                console.log('è§†é¢‘å¯ä»¥æ’­æ”¾:', videoUrl);
                document.getElementById('videoControls').style.display = 'flex';
                document.getElementById('videoInfo').style.display = 'block';

                if (task && task.generation_time) {
                    document.getElementById('generationTime').textContent = `${task.generation_time.toFixed(2)} ç§’`;
                }
                if (task && task.unique_id) {
                    document.getElementById('taskId').textContent = task.unique_id.substring(0, 16) + '...';
                }
            };
        }

        // ç»ˆæ­¢ä»»åŠ¡
        async function cancelGeneration() {
            if (!currentTaskId) {
                return;
            }

            if (!confirm('ç¡®å®šè¦ç»ˆæ­¢å½“å‰ä»»åŠ¡å—ï¼Ÿ')) {
                return;
            }

            try {
                const apiUrl = getApiBaseUrl();
                const response = await fetch(`${apiUrl}/generate_video/cancel/${currentTaskId}`, {
                    method: 'POST'
                });
                const data = await response.json();

                if (data.success) {
                    showToast('ä»»åŠ¡å·²ç»ˆæ­¢', 'info');
                    // ä»»åŠ¡å·²ç»ˆæ­¢ï¼Œæ¸…é™¤ä¿å­˜çš„çŠ¶æ€
                    savedTaskState = null;
                    updateBackToTaskButton();
                } else {
                    showToast('ç»ˆæ­¢ä»»åŠ¡å¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'), 'error');
                }
            } catch (error) {
                console.error('ç»ˆæ­¢ä»»åŠ¡å¤±è´¥:', error);
                showToast('ç»ˆæ­¢ä»»åŠ¡å¤±è´¥: ' + error.message, 'error');
            }

            // åªåœ¨ä»»åŠ¡æ¨¡å¼ä¸‹é‡ç½®UI
            if (currentViewMode === 'task') {
            resetUI();
            }
        }

        // ä¸‹è½½è§†é¢‘
        function downloadVideo() {
            const video = document.getElementById('videoOutput');
            if (!video.src) {
                showToast('è§†é¢‘æœªåŠ è½½', 'error');
                return;
            }
            const a = document.createElement('a');
            a.href = video.src;
            a.download = `nerffacespeech_${Date.now()}.mp4`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            showToast('è§†é¢‘ä¸‹è½½å·²å¼€å§‹', 'success');
        }

        // å…¨å±æ’­æ”¾
        function fullscreenVideo() {
            const video = document.getElementById('videoOutput');
            if (video.requestFullscreen) {
                video.requestFullscreen();
            } else if (video.webkitRequestFullscreen) {
                video.webkitRequestFullscreen();
            } else if (video.mozRequestFullScreen) {
                video.mozRequestFullScreen();
            } else if (video.msRequestFullscreen) {
                video.msRequestFullscreen();
            }
        }

        // æ›´æ–°çŠ¶æ€
        function updateStatus(message) {
            document.getElementById('statusBox').textContent = message;
        }

        // æ›´æ–°è¿›åº¦
        function updateProgress(percent, text) {
            document.getElementById('progressFill').style.width = percent + '%';
            document.getElementById('progressText').textContent = text || 'å¤„ç†ä¸­...';
            document.getElementById('progressPercent').textContent = Math.round(percent) + '%';
        }

        // ç¦ç”¨/å¯ç”¨è¾“å…¥
        function setInputsDisabled(disabled) {
            document.getElementById('textInput').disabled = disabled;
            document.getElementById('characterInput').disabled = disabled;
            document.getElementById('modelSelect').disabled = disabled;
            document.getElementById('refreshBtn').disabled = disabled;
            const refreshCharacterBtn = document.getElementById('refreshCharacterBtn');
            if (refreshCharacterBtn) refreshCharacterBtn.disabled = disabled;
        }

        // é‡ç½®UIï¼ˆåªåœ¨ä»»åŠ¡æ¨¡å¼ä¸‹ï¼‰
        function resetUI() {
            // å¦‚æœå½“å‰åœ¨å†å²è®°å½•æ¨¡å¼ï¼Œä¸é‡ç½®UI
            if (currentViewMode === 'history') {
                return;
            }

            if (statusPollInterval) {
                clearInterval(statusPollInterval);
                statusPollInterval = null;
            }

            currentTaskId = null;
            savedTaskState = null;
            setInputsDisabled(false);
            document.getElementById('generateBtn').style.display = 'block';
            document.getElementById('cancelBtn').style.display = 'none';
            document.getElementById('progressContainer').style.display = 'none';
            updateBackToTaskButton();
        }

        // æ˜¾ç¤ºæç¤ºæ¶ˆæ¯
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = message;

            const colors = {
                success: '#4ade80',
                error: '#ef4444',
                info: '#3b82f6'
            };
            toast.style.borderLeft = `4px solid ${colors[type] || colors.info}`;

            document.body.appendChild(toast);

            setTimeout(() => {
                toast.style.animation = 'slideIn 0.3s ease reverse';
                setTimeout(() => {
                    document.body.removeChild(toast);
                }, 300);
            }, 3000);
        }

        // é¡µé¢å¸è½½æ—¶æ¸…ç†
        window.addEventListener('beforeunload', () => {
            if (statusPollInterval) {
                clearInterval(statusPollInterval);
            }
        });
    </script>
</body>

</html>