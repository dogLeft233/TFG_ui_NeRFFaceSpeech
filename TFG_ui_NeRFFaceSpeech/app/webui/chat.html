<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>äººæœºå¯¹è¯ - NeRFFaceSpeech</title>
  <style>
    :root {
      --primary: #1e40af;
      --primary-2: #3b82f6;
      --bg: #0b1020;
      --card: rgba(255, 255, 255, 0.06);
      --border: rgba(255, 255, 255, 0.14);
      --text: #e5e7eb;
      --muted: #9ca3af;
      --g1: rgba(59, 130, 246, 0.16);
      --g2: rgba(14, 165, 233, 0.14);
      --g3: rgba(56, 189, 248, 0.12);
      --card-bg: rgb(24, 66, 134);
      --base-font-size: 14px;
    }

    body.theme-tech {
      --primary: #1e40af;
      --primary-2: #3b82f6;
      --bg: #0b1020;
      --card: rgba(255, 255, 255, 0.06);
      --border: rgba(255, 255, 255, 0.14);
      --text: #e5e7eb;
      --muted: #9ca3af;
      --g1: rgba(59, 130, 246, 0.16);
      --g2: rgba(14, 165, 233, 0.14);
      --g3: rgba(56, 189, 248, 0.12);
      --card-bg: rgb(24, 66, 134);
    }
    body.theme-warm {
      --primary: #f97316; /* ä¸»è‰²è°ƒï¼šæ©™è‰²ï¼Œç”¨äºé€‰ä¸­çŠ¶æ€ã€å¼ºè°ƒæŒ‰é’® */
      --primary-2: #ea580c; /* æ¬¡è¦ä¸»è‰²ï¼šæ·±æ©™è‰²ï¼Œç”¨äºæ¸å˜ã€æ¬¡è¦å¼ºè°ƒ */
      --bg: #fff8f0; /* é¡µé¢èƒŒæ™¯è‰²ï¼šæµ…æš–è‰²èƒŒæ™¯ */
      --card: rgba(255,255,255,0.9); /* å¡ç‰‡èƒŒæ™¯ï¼šåŠé€æ˜ç™½è‰² */
      --border: rgba(249,115,22,0.2); /* è¾¹æ¡†é¢œè‰²ï¼šåŠé€æ˜æ©™è‰²è¾¹æ¡† */
      --text: #1f2937; /* ä¸»æ–‡å­—é¢œè‰²ï¼šæ·±ç°è‰²æ–‡å­— */
      --muted: #6b7280; /* æ¬¡è¦æ–‡å­—é¢œè‰²ï¼šç°è‰² */
      --g1: rgba(251,191,36,0.15); /* æ¸å˜1ï¼šé»„è‰²æ¸å˜ç‚¹1 */
      --g2: rgba(249,115,22,0.12); /* æ¸å˜2ï¼šæ©™è‰²æ¸å˜ç‚¹2 */
      --g3: rgba(234,88,12,0.1); /* æ¸å˜3ï¼šæ·±æ©™è‰²æ¸å˜ç‚¹3 */
      --card-bg: rgba(251,191,36,0.15); /* å¡ç‰‡èƒŒæ™¯è‰²ï¼šæµ…é»„è‰² */
    }
    body.theme-minimal {
      --primary: #6b7280; /* ä¸»è‰²è°ƒï¼šç°è‰²ï¼Œç”¨äºé€‰ä¸­çŠ¶æ€ã€å¼ºè°ƒæŒ‰é’® */
      --primary-2: #4b5563; /* æ¬¡è¦ä¸»è‰²ï¼šæ·±ç°è‰²ï¼Œç”¨äºæ¸å˜ã€æ¬¡è¦å¼ºè°ƒ */
      --bg: #f5f5f5; /* é¡µé¢èƒŒæ™¯è‰²ï¼šæµ…ç°è‰²èƒŒæ™¯ */
      --card: #ffffff; /* å¡ç‰‡èƒŒæ™¯ï¼šç™½è‰² */
      --border: #e5e7eb; /* è¾¹æ¡†é¢œè‰²ï¼šæµ…ç°è‰²è¾¹æ¡† */
      --text: #111827; /* ä¸»æ–‡å­—é¢œè‰²ï¼šæ·±è‰²æ–‡å­— */
      --muted: #6b7280; /* æ¬¡è¦æ–‡å­—é¢œè‰²ï¼šç°è‰² */
      --g1: rgba(107,114,128,0.08); /* æ¸å˜1ï¼šç°è‰²æ¸å˜ç‚¹1 */
      --g2: rgba(75,85,99,0.07); /* æ¸å˜2ï¼šæ·±ç°è‰²æ¸å˜ç‚¹2 */
      --g3: rgba(156,163,175,0.06); /* æ¸å˜3ï¼šæµ…ç°è‰²æ¸å˜ç‚¹3 */
      --card-bg: rgba(107,114,128,0.1); /* å¡ç‰‡èƒŒæ™¯è‰²ï¼šæµ…ç°è‰² */
    }
    * { box-sizing: border-box; }
    :root {
      --base-font-size: 14px; /* åŸºç¡€å­—å· */
    }
    html {
      font-size: var(--base-font-size);
    }
    body {
      margin: 0;
      font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      font-size: 1rem; /* ä½¿ç”¨remå•ä½ï¼ŒåŸºäºæ ¹å…ƒç´ å­—ä½“å¤§å° */
      background: radial-gradient(circle at 20% 20%, var(--g1), transparent 25%),
                  radial-gradient(circle at 80% 30%, var(--g2), transparent 25%),
                  radial-gradient(circle at 50% 80%, var(--g3), transparent 22%),
                  var(--bg);
      color: var(--text);
      min-height: 100vh;
    }
    /* è®¾ç½®æŒ‰é’® */
    .settings-btn {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1000;
      padding: 10px 16px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: var(--card-bg);
      color: var(--text);
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    .settings-btn:hover {
      background: var(--primary);
      color: #fff;
      border-color: var(--primary);
    }
    
    /* ä¾§è¾¹æ é®ç½© */
    .sidebar-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.4);
      z-index: 2000;
      transition: opacity 0.3s ease;
    }
    .sidebar-overlay.active {
      display: block;
    }
    
    /* ä¾§è¾¹æ  */
    .sidebar {
      position: fixed;
      top: 0;
      right: -400px;
      width: 400px;
      height: 100vh;
      background: var(--bg);
      border-left: 1px solid var(--border);
      z-index: 2001;
      transition: right 0.3s ease;
      overflow-y: auto;
      box-shadow: -4px 0 20px rgba(0, 0, 0, 0.2);
    }
    .sidebar.active {
      right: 0;
    }
    .sidebar-content {
      padding: 24px;
    }
    .sidebar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 16px;
      border-bottom: 1px solid var(--border);
    }
    .sidebar-header h2 {
      margin: 0;
      font-size: 20px;
      color: var(--text);
    }
    .sidebar-close {
      background: none;
      border: none;
      font-size: 28px;
      color: var(--muted);
      cursor: pointer;
      padding: 0;
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 8px;
      transition: all 0.2s ease;
    }
    .sidebar-close:hover {
      background: var(--card-bg);
      color: var(--text);
    }
    
    /* åˆ†é¡µæ ‡ç­¾ */
    .sidebar-tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 20px;
      border-bottom: 1px solid var(--border);
    }
    .sidebar-tab {
      padding: 10px 20px;
      background: none;
      border: none;
      border-bottom: 2px solid transparent;
      color: var(--muted);
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    .sidebar-tab.active {
      color: var(--primary);
      border-bottom-color: var(--primary);
    }
    .sidebar-tab:hover {
      color: var(--text);
    }
    
    /* åˆ†é¡µå†…å®¹ */
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }
    
    /* é€‰é¡¹ç½‘æ ¼ */
    .options-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 12px;
      margin-bottom: 20px;
    }
    .option-card {
      padding: 16px;
      border: 2px solid var(--border);
      border-radius: 12px;
      background: var(--card-bg);
      cursor: pointer;
      transition: all 0.2s ease;
      text-align: center;
    }
    .option-card:hover {
      border-color: var(--primary);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    .option-card.selected {
      border-color: var(--primary);
      background: var(--primary);
      color: #fff;
    }
    .option-card.selected .option-name {
      color: #fff;
    }
    .option-name {
      font-size: 14px;
      font-weight: 500;
      color: var(--text);
      margin-bottom: 4px;
    }
    .option-desc {
      font-size: 12px;
      color: var(--muted);
    }
    .option-card.selected .option-desc {
      color: rgba(255, 255, 255, 0.9);
    }
    
    /* å­—å·é€‰æ‹© */
    .font-size-group {
      display: flex;
      gap: 8px;
      margin-bottom: 20px;
    }
    .font-size-btn {
      flex: 1;
      padding: 12px;
      border: 2px solid var(--border);
      border-radius: 10px;
      background: var(--card-bg);
      color: var(--text);
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    .font-size-btn:hover {
      border-color: var(--primary);
    }
    .font-size-btn.selected {
      border-color: var(--primary);
      background: var(--primary);
      color: #fff;
    }
    .font-size-custom {
      margin-top: 16px;
    }
    .font-size-custom input {
      width: 100%;
      padding: 10px;
      border: 1px solid var(--border);
      border-radius: 8px;
      background: var(--card-bg);
      color: var(--text);
      font-size: 14px;
    }
    
    .page { max-width: 1400px; width: 94vw; margin: 0 auto; padding: 20px 24px 40px; min-height: 100vh; }
    header { display: flex; align-items: center; justify-content: space-between; gap: 12px; margin-bottom: 16px; }
    h1 { margin: 0; font-size: 24px; letter-spacing: 0.4px; }
    .pill { display: inline-flex; align-items: center; gap: 6px; padding: 6px 10px; border-radius: 12px; background: rgba(59,130,246,0.2); color: #c7d2fe; font-size: 12px; border: 1px solid rgba(96,165,250,0.5); }
    .card { background: var(--card); border: 1px solid var(--border); border-radius: 16px; padding: 18px; box-shadow: 0 12px 32px rgba(0,0,0,0.25); }
    label { font-weight: 700; margin-bottom: 6px; display: block; }
    textarea {
      width: 100%; border: 1px solid var(--border); border-radius: 12px; padding: 12px 14px;
      font-size: 15px; background: rgba(255,255,255,0.04); color: var(--text);
      outline: none; transition: border-color .15s ease, box-shadow .15s ease;
      min-height: 140px; resize: vertical;
    }
    textarea:focus {
      border-color: rgba(96,165,250,0.8);
      box-shadow: 0 0 0 3px rgba(59,130,246,0.25);
    }
    button.primary {
      background: linear-gradient(135deg, var(--primary), var(--primary-2));
      border: 1px solid var(--primary-2);
      color: #fff; font-weight: 700; border-radius: 12px; padding: 12px 14px; cursor: pointer; width: 100%;
    }
    .log-box {
      background: #0f172a; color: #e2e8f0; padding: 12px; border-radius: 12px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      min-height: 120px; white-space: pre-wrap; word-break: break-all;
    }
    
    /* è¿›åº¦æ¡æ ·å¼ */
    .progress-container {
      margin-top: 12px;
      margin-bottom: 12px;
    }
    .progress-bar {
      width: 100%;
      height: 8px;
      background: rgba(255,255,255,0.1);
      border-radius: 4px;
      overflow: hidden;
      margin-bottom: 8px;
    }
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--primary), var(--primary-2));
      width: 0%;
      transition: width 0.3s ease;
      border-radius: 4px;
    }
    .progress-text {
      font-size: 13px;
      color: var(--muted);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .step-indicator {
      display: flex;
      gap: 8px;
      margin-top: 8px;
      flex-wrap: wrap;
    }
    .step-item {
      padding: 4px 10px;
      border-radius: 6px;
      font-size: 12px;
      background: rgba(255,255,255,0.05);
      border: 1px solid var(--border);
      color: var(--muted);
      transition: all 0.3s ease;
    }
    .step-item.active {
      background: var(--primary);
      color: #fff;
      border-color: var(--primary);
    }
    .step-item.completed {
      background: rgba(34,197,94,0.2);
      color: #4ade80;
      border-color: rgba(34,197,94,0.4);
    }
    a { color: #bfdbfe; text-decoration: none; }
    footer {
      margin-top: 24px;
      padding: 12px;
      text-align: center;
      color: var(--muted);
      font-size: 13px;
      border-top: 1px solid rgba(255,255,255,0.1);
    }
    
    /* èŠå¤©ç•Œé¢æ ·å¼ */
    .chat-container {
      display: flex;
      flex-direction: column;
      height: calc(100vh - 160px);
      max-height: 900px;
      min-height: 700px;
    }
    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 16px;
      background: rgba(255,255,255,0.02);
      border-radius: 12px;
      margin-bottom: 16px;
    }
    .message {
      display: flex;
      gap: 12px;
      animation: fadeIn 0.3s ease;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .message.user {
      justify-content: flex-end;
    }
    .message.assistant {
      justify-content: flex-start;
    }
    .message-bubble {
      max-width: 70%;
      padding: 12px 16px;
      border-radius: 16px;
      word-wrap: break-word;
      position: relative;
    }
    .message.user .message-bubble {
      background: var(--primary);
      color: #fff;
      border-bottom-right-radius: 4px;
    }
    .message.assistant .message-bubble {
      background: var(--card);
      color: var(--text);
      border: 1px solid var(--border);
      border-bottom-left-radius: 4px;
    }
    .message-time {
      font-size: 11px;
      color: var(--muted);
      margin-top: 4px;
      text-align: right;
    }
    .message.assistant .message-time {
      text-align: left;
    }
    .message-audio {
      margin-top: 8px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .audio-player {
      flex: 1;
      height: 32px;
    }
    .audio-player audio {
      width: 100%;
      height: 32px;
    }
    
    .chat-input-area {
      display: flex;
      flex-direction: column;
      gap: 12px;
      padding: 16px;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
    }
    .input-row {
      display: flex;
      gap: 8px;
      align-items: flex-end;
    }
    .input-row textarea {
      flex: 1;
      min-height: 60px;
      max-height: 120px;
      resize: vertical;
    }
    .input-actions {
      display: flex;
      gap: 8px;
      align-items: center;
    }
    .icon-btn {
      width: 40px;
      height: 40px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: var(--card-bg);
      color: var(--text);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
      font-size: 18px;
    }
    .icon-btn:hover {
      background: var(--primary);
      color: #fff;
      border-color: var(--primary);
    }
    .icon-btn.recording {
      background: #ef4444;
      color: #fff;
      border-color: #ef4444;
      animation: pulse 1.5s infinite;
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }
    .icon-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .volume-control {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 10px;
    }
    .volume-control input[type="range"] {
      width: 100px;
    }
    .volume-control.muted {
      opacity: 0.5;
    }
    .file-input-wrapper {
      position: relative;
      display: inline-block;
    }
    .file-input-wrapper input[type="file"] {
      position: absolute;
      opacity: 0;
      width: 0;
      height: 0;
    }
    .typing-indicator {
      display: flex;
      gap: 4px;
      padding: 12px 16px;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 16px;
      border-bottom-left-radius: 4px;
      max-width: 70px;
      position: relative;
    }
    .typing-indicator-wrapper {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .cancel-typing-btn {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      border: 1px solid var(--border);
      background: var(--card-bg);
      color: var(--text);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      transition: all 0.2s ease;
      flex-shrink: 0;
    }
    .cancel-typing-btn:hover {
      background: #ef4444;
      color: #fff;
      border-color: #ef4444;
    }
    .typing-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--muted);
      animation: typing 1.4s infinite;
    }
    .typing-dot:nth-child(2) {
      animation-delay: 0.2s;
    }
    .typing-dot:nth-child(3) {
      animation-delay: 0.4s;
    }
    @keyframes typing {
      0%, 60%, 100% { transform: translateY(0); }
      30% { transform: translateY(-10px); }
    }
    .empty-state {
      text-align: center;
      color: var(--muted);
      padding: 40px;
    }
    
    /* æ¶ˆæ¯çŠ¶æ€ */
    .message-status {
      font-size: 11px;
      color: var(--muted);
      margin-top: 4px;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .message.user .message-status {
      justify-content: flex-end;
    }
    .message-status.sending::before {
      content: "â³";
      animation: spin 1s linear infinite;
    }
    .message-status.sent::before {
      content: "âœ“";
    }
    .message-status.error::before {
      content: "âŒ";
    }
    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
    
    /* å¯¹è¯ç®¡ç†ä¾§è¾¹æ  */
    .chat-sidebar {
      position: fixed;
      left: -320px;
      top: 0;
      width: 320px;
      height: 100vh;
      background: var(--bg);
      border-right: 1px solid var(--border);
      z-index: 1500;
      transition: left 0.3s ease;
      display: flex;
      flex-direction: column;
      box-shadow: 4px 0 20px rgba(0, 0, 0, 0.2);
    }
    .chat-sidebar.active {
      left: 0;
    }
    .chat-sidebar-header {
      padding: 20px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .chat-sidebar-header h3 {
      margin: 0;
      font-size: 18px;
      color: var(--text);
    }
    .chat-sidebar-close {
      background: none;
      border: none;
      font-size: 24px;
      color: var(--muted);
      cursor: pointer;
      padding: 0;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 8px;
      transition: all 0.2s ease;
    }
    .chat-sidebar-close:hover {
      background: var(--card-bg);
      color: var(--text);
    }
    .chat-sidebar-content {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
    }
    .chat-sidebar-actions {
      padding: 16px;
      border-top: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .sidebar-btn {
      padding: 10px 16px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: var(--card-bg);
      color: var(--text);
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 14px;
      text-align: left;
    }
    .sidebar-btn:hover {
      background: var(--primary);
      color: #fff;
      border-color: var(--primary);
    }
    .sidebar-btn.danger:hover {
      background: #ef4444;
      border-color: #ef4444;
    }
    .history-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .history-item {
      padding: 12px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: var(--card-bg);
      cursor: pointer;
      transition: all 0.2s ease;
    }
    .history-item:hover {
      background: var(--primary);
      color: #fff;
      border-color: var(--primary);
    }
    .history-item.active {
      background: var(--primary);
      color: #fff;
      border-color: var(--primary);
    }
    .history-item-title {
      font-weight: 500;
      margin-bottom: 4px;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 8px;
      flex: 1;
    }
    .history-item-title input {
      flex: 1;
      background: transparent;
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 4px 8px;
      color: var(--text);
      font-size: 14px;
      font-weight: 500;
      outline: none;
    }
    .history-item-title input:focus {
      border-color: var(--primary);
      background: var(--card-bg);
    }
    .history-item-edit {
      opacity: 0;
      transition: opacity 0.2s ease;
      cursor: pointer;
      padding: 2px 4px;
      border-radius: 4px;
      font-size: 12px;
    }
    .history-item:hover .history-item-edit {
      opacity: 1;
    }
    .history-item-edit:hover {
      background: rgba(255, 255, 255, 0.1);
    }
    .history-item-time {
      font-size: 11px;
      opacity: 0.7;
    }
    .retry-btn {
      margin-top: 8px;
      padding: 6px 12px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: var(--card-bg);
      color: var(--text);
      cursor: pointer;
      font-size: 12px;
      transition: all 0.2s ease;
    }
    .retry-btn:hover {
      background: var(--primary);
      color: #fff;
      border-color: var(--primary);
    }
    
    /* æµå¼è¾“å‡ºåŠ¨ç”» */
    .streaming-text {
      display: inline;
    }
    .streaming-cursor {
      display: inline-block;
      width: 2px;
      height: 1em;
      background: var(--primary);
      animation: blink 1s infinite;
      margin-left: 2px;
    }
    @keyframes blink {
      0%, 50% { opacity: 1; }
      51%, 100% { opacity: 0; }
    }
    
    /* ä½¿ç”¨ talk.html çš„æ ·å¼ */
    .back-btn {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 8px 16px;
      border-radius: 12px;
      background: rgba(255, 255, 255, 0.08);
      border: 1px solid var(--border);
      color: var(--text);
      text-decoration: none;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    .back-btn:hover {
      background: rgba(255, 255, 255, 0.12);
      border-color: var(--primary-2);
    }
    
    /* è§’è‰²å’Œæ¨¡å‹é€‰æ‹©å¼¹çª— */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.6);
      z-index: 3000;
      align-items: center;
      justify-content: center;
    }
    .modal-overlay.active {
      display: flex;
    }
    .modal {
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 24px;
      max-width: 500px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
    }
    .modal-header {
      margin-bottom: 20px;
      padding-bottom: 16px;
      border-bottom: 1px solid var(--border);
    }
    .modal-header h2 {
      margin: 0;
      font-size: 20px;
      color: var(--text);
    }
    .modal-body {
      margin-bottom: 20px;
    }
    .modal-footer {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
    }
    .modal select {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid var(--border);
      border-radius: 8px;
      background: var(--card-bg);
      color: var(--text);
      font-size: 14px;
      margin-bottom: 16px;
    }
    .modal label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: var(--text);
    }
    .modal .select-wrapper {
      display: flex;
      gap: 8px;
      align-items: center;
    }
    .modal .select-wrapper select {
      flex: 1;
      margin-bottom: 0;
    }
    .modal .select-wrapper button {
      padding: 10px 12px;
      border: 1px solid var(--border);
      border-radius: 8px;
      background: var(--card-bg);
      color: var(--text);
      cursor: pointer;
      transition: all 0.2s ease;
    }
    .modal .select-wrapper button:hover {
      background: var(--primary);
      color: #fff;
      border-color: var(--primary);
    }
    
    /* è§†é¢‘æ’­æ”¾æŒ‰é’® */
    .video-play-btn {
      margin-top: 8px;
      padding: 8px 16px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: var(--card-bg);
      color: var(--text);
      cursor: pointer;
      font-size: 14px;
      transition: all 0.2s ease;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    .video-play-btn:hover {
      background: var(--primary);
      color: #fff;
      border-color: var(--primary);
    }
    .video-play-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .video-container {
      margin-top: 8px;
      display: none;
    }
    .video-container.active {
      display: block;
    }
    .video-container video {
      width: 100%;
      max-width: 500px;
      border-radius: 8px;
      background: #000;
    }
    
    /* å“åº”æ¨¡å¼é€‰æ‹©å™¨ */
    .response-mode-selector {
      display: flex;
      gap: 8px;
      align-items: center;
      margin-bottom: 8px;
      padding: 8px;
      background: rgba(255, 255, 255, 0.03);
      border-radius: 8px;
      border: 1px solid var(--border);
    }
    
    .response-mode-selector label {
      font-size: 13px;
      color: var(--muted);
      margin-right: 4px;
    }
    
    .response-mode-radio {
      display: none;
    }
    
    .response-mode-label {
      padding: 6px 12px;
      border-radius: 6px;
      border: 1px solid var(--border);
      background: var(--card-bg);
      color: var(--text);
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 13px;
      font-weight: 500;
      user-select: none;
    }
    
    .response-mode-label:hover {
      background: rgba(255, 255, 255, 0.1);
      border-color: var(--primary-2);
    }
    
    .response-mode-radio:checked + .response-mode-label {
      background: var(--primary);
      color: #fff;
      border-color: var(--primary);
    }
    
    /* è¯­éŸ³æ°”æ³¡æ ·å¼ï¼ˆä»…æ˜¾ç¤ºéŸ³é¢‘æ—¶é•¿ï¼Œç‚¹å‡»æ’­æ”¾ï¼‰ */
    .audio-bubble {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 16px;
      border-radius: 18px;
      background: var(--card-bg);
      border: 1px solid var(--border);
      cursor: pointer;
      transition: all 0.2s ease;
      min-width: 80px;
      justify-content: center;
    }
    
    .audio-bubble:hover {
      background: var(--primary);
      color: #fff;
      border-color: var(--primary);
    }
    
    .audio-bubble-icon {
      font-size: 16px;
    }
    
    .audio-bubble-duration {
      font-size: 13px;
      font-weight: 500;
    }
    
    /* è§†é¢‘æ¡†æ ·å¼ï¼ˆå°æ­£æ–¹å½¢ï¼‰ */
    .video-preview-box {
      width: 350px;
      height: 350px;
      border-radius: 12px;
      background: rgba(0, 0, 0, 0.3);
      border: 2px solid var(--border);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      overflow: hidden;
      transition: all 0.2s ease;
    }
    
    .video-preview-box:hover {
      border-color: var(--primary);
      transform: scale(1.05);
    }
    
    .video-preview-box video {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .video-play-icon {
      position: absolute;
      font-size: 40px;
      color: rgba(255, 255, 255, 0.9);
      text-shadow: 0 2px 8px rgba(0, 0, 0, 0.5);
      pointer-events: none;
    }
  </style>
  <script src="settings.js"></script>
  <script src="api.js"></script>
</head>
<body>
  <button class="settings-btn" id="settingsBtn">âš™ï¸ è®¾ç½®</button>
  
  <!-- è§’è‰²å’Œæ¨¡å‹é€‰æ‹©å¼¹çª— -->
  <div class="modal-overlay" id="characterModelModal">
    <div class="modal">
      <div class="modal-header">
        <h2>é€‰æ‹©è§’è‰²å’Œæ¨¡å‹</h2>
      </div>
      <div class="modal-body">
        <label for="modalCharacterSelect">è§’è‰²</label>
        <div class="select-wrapper">
          <select id="modalCharacterSelect">
            <option value="">åŠ è½½ä¸­...</option>
          </select>
          <button id="refreshCharacterBtn" title="åˆ·æ–°è§’è‰²åˆ—è¡¨">ğŸ”„</button>
        </div>
        <label for="modalModelSelect">æ¨¡å‹</label>
        <div class="select-wrapper">
          <select id="modalModelSelect">
            <option value="">åŠ è½½ä¸­...</option>
          </select>
          <button id="refreshModelBtn" title="åˆ·æ–°æ¨¡å‹åˆ—è¡¨">ğŸ”„</button>
        </div>
      </div>
      <div class="modal-footer">
        <button class="primary" id="confirmCharacterModelBtn">å¼€å§‹èŠå¤©</button>
      </div>
    </div>
  </div>
  
  <!-- å¯¹è¯ç®¡ç†ä¾§è¾¹æ  -->
  <div class="chat-sidebar" id="chatSidebar">
    <div class="chat-sidebar-header">
      <h3>å¯¹è¯ç®¡ç†</h3>
      <button class="chat-sidebar-close" id="chatSidebarClose">Ã—</button>
    </div>
    <div class="chat-sidebar-content">
      <div class="history-list" id="historyList">
        <div class="history-item active" data-id="current">
          <div class="history-item-title">å½“å‰å¯¹è¯</div>
          <div class="history-item-time">è¿›è¡Œä¸­</div>
        </div>
      </div>
    </div>
    <div class="chat-sidebar-actions">
      <button class="sidebar-btn" id="newChatBtn">â• æ–°å»ºå¯¹è¯</button>
      <button class="sidebar-btn" id="exportChatBtn">ğŸ“¥ å¯¼å‡ºå¯¹è¯è®°å½•</button>
      <button class="sidebar-btn danger" id="clearChatBtn">ğŸ—‘ï¸ æ¸…ç©ºå½“å‰å¯¹è¯</button>
    </div>
  </div>
  
  <!-- ä¾§è¾¹æ é®ç½© -->
  <div class="sidebar-overlay" id="sidebarOverlay"></div>
  
  <!-- è®¾ç½®ä¾§è¾¹æ  -->
  <div class="sidebar" id="settingsSidebar">
    <div class="sidebar-content">
      <div class="sidebar-header">
        <h2>è®¾ç½®</h2>
        <button class="sidebar-close" id="sidebarClose">Ã—</button>
      </div>
      
      <div class="sidebar-tabs">
        <button class="sidebar-tab active" data-tab="theme">ä¸»é¢˜</button>
        <button class="sidebar-tab" data-tab="font">å­—ä½“</button>
      </div>
      
      <!-- ä¸»é¢˜è®¾ç½® -->
      <div class="tab-content active" id="themeTab">
        <div class="options-grid">
          <div class="option-card" data-theme="tech">
            <div class="option-name">ç§‘æŠ€é£</div>
            <div class="option-desc">æ·±è“è‰²ç§‘æŠ€æ„Ÿ</div>
          </div>
          <div class="option-card" data-theme="warm">
            <div class="option-name">æ¸©é¦¨é£</div>
            <div class="option-desc">æš–è‰²è°ƒæ¸©é¦¨</div>
          </div>
          <div class="option-card" data-theme="minimal">
            <div class="option-name">ç®€çº¦é£</div>
            <div class="option-desc">ç°è‰²ç®€çº¦</div>
          </div>
        </div>
      </div>
      
      <!-- å­—ä½“è®¾ç½® -->
      <div class="tab-content" id="fontTab">
        <div style="margin-bottom: 16px;">
          <label style="display: block; margin-bottom: 8px; color: var(--text); font-weight: 500;">å­—ä½“æ ·å¼</label>
          <div class="options-grid">
            <div class="option-card" data-font="SimSun">
              <div class="option-name">å®‹ä½“</div>
              <div class="option-desc">SimSun</div>
            </div>
            <div class="option-card" data-font="SimHei">
              <div class="option-name">é»‘ä½“</div>
              <div class="option-desc">SimHei</div>
            </div>
            <div class="option-card" data-font="Microsoft YaHei">
              <div class="option-name">å¾®è½¯é›…é»‘</div>
              <div class="option-desc">Microsoft YaHei</div>
            </div>
            <div class="option-card" data-font="Arial">
              <div class="option-name">Arial</div>
              <div class="option-desc">Arial</div>
            </div>
            <div class="option-card" data-font="Times New Roman">
              <div class="option-name">Times New Roman</div>
              <div class="option-desc">Times New Roman</div>
            </div>
            <div class="option-card" data-font="Inter">
              <div class="option-name">Inter</div>
              <div class="option-desc">Interï¼ˆé»˜è®¤ï¼‰</div>
            </div>
          </div>
        </div>
        
        <div>
          <label style="display: block; margin-bottom: 8px; color: var(--text); font-weight: 500;">å­—å·å¤§å°</label>
          <div class="font-size-group">
            <button class="font-size-btn" data-size="small">å°</button>
            <button class="font-size-btn" data-size="medium">ä¸­</button>
            <button class="font-size-btn" data-size="large">å¤§</button>
            <button class="font-size-btn" data-size="custom">è‡ªå®šä¹‰</button>
          </div>
          <div class="font-size-custom" id="customSizeInput" style="display: none;">
            <input type="number" id="customSizeValue" placeholder="è¾“å…¥å­—å·ï¼ˆpxï¼‰" min="10" max="24" value="14">
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="page">
    <header>
      <a href="index.html" class="back-btn">â† è¿”å›é¦–é¡µ</a>
      <h1>ğŸ’¬ äººæœºå¯¹è¯</h1>
      <button class="back-btn" id="chatManageBtn" style="margin: 0;">ğŸ’¬ å¯¹è¯ç®¡ç†</button>
    </header>

    <div class="card chat-container">
      <!-- èŠå¤©æ¶ˆæ¯åŒºåŸŸ -->
      <div class="chat-messages" id="chatMessages">
        <div class="empty-state">
          <p>ğŸ‘‹ å¼€å§‹å¯¹è¯å§ï¼è¾“å…¥æ–‡å­—æˆ–å½•åˆ¶è¯­éŸ³ä¸AIäº¤æµ</p>
        </div>
      </div>
      
      <!-- è¾“å…¥åŒºåŸŸ -->
      <div class="chat-input-area">
        <!-- å“åº”æ¨¡å¼é€‰æ‹©å™¨ -->
        <div class="response-mode-selector">
          <label>å“åº”æ¨¡å¼:</label>
          <input type="radio" name="responseMode" id="modeText" value="text" class="response-mode-radio" checked>
          <label for="modeText" class="response-mode-label">ğŸ“ æ–‡æœ¬</label>
          
          <input type="radio" name="responseMode" id="modeAudio" value="audio" class="response-mode-radio">
          <label for="modeAudio" class="response-mode-label">ğŸ”Š è¯­éŸ³</label>
          
          <input type="radio" name="responseMode" id="modeVideo" value="video" class="response-mode-radio">
          <label for="modeVideo" class="response-mode-label">ğŸ¬ è§†é¢‘</label>
        </div>
        
        <!-- è¾“å…¥æ¡†å’ŒæŒ‰é’® -->
        <div class="input-row">
          <textarea id="chatInput" placeholder="è¾“å…¥æ¶ˆæ¯... (Shift+Enteræ¢è¡Œï¼ŒEnterå‘é€)"></textarea>
          <div class="input-actions">
            <!-- è¯­éŸ³å½•åˆ¶æŒ‰é’® -->
            <button class="icon-btn" id="recordBtn" title="å½•åˆ¶è¯­éŸ³">ğŸ¤</button>
            <!-- ä¸Šä¼ éŸ³é¢‘æŒ‰é’® -->
            <div class="file-input-wrapper">
              <input type="file" id="audioUpload" accept="audio/*">
              <button class="icon-btn" id="uploadBtn" title="ä¸Šä¼ éŸ³é¢‘æ–‡ä»¶">ğŸ“</button>
            </div>
            <!-- å‘é€æŒ‰é’® -->
            <button class="primary" id="sendBtn" style="width: auto; padding: 10px 20px;">å‘é€</button>
          </div>
        </div>
        
        <!-- è¿›åº¦æ˜¾ç¤ºåŒºåŸŸ -->
        <div class="progress-container" id="chatProgressContainer" style="display: none; margin-top: 12px;">
          <div class="progress-bar">
            <div class="progress-fill" id="chatProgressFill"></div>
      </div>
          <div class="progress-text">
            <span id="chatProgressText">å‡†å¤‡ä¸­...</span>
            <span id="chatProgressPercent">0%</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <footer>
    åŒ—äº¬ç†å·¥å¤§å­¦ Â· NeRFFaceSpeech å›¢é˜Ÿ
  </footer>

  <script>
    let mediaRecorder = null;
    let audioChunks = [];
    let isRecording = false;
    let currentAudioBase64 = null;
    let recordingTimer = null;
    let recordingStartTime = null;
    let isMuted = false;
    let character = null; // å½“å‰å¯¹è¯çš„è§’è‰²ï¼ˆä»èŠå¤©å†å²ä¸­è·å–ï¼‰
    let model = null; // å½“å‰å¯¹è¯çš„æ¨¡å‹ï¼ˆä»èŠå¤©å†å²ä¸­è·å–ï¼‰
    let currentChatId = "current"; // å½“å‰å¯¹è¯IDï¼ˆå‰ç«¯ä½¿ç”¨çš„IDï¼‰
    let currentSessionId = null; // å½“å‰ä¼šè¯IDï¼ˆåç«¯æ•°æ®åº“çš„session_idï¼‰
    let chatHistory = {}; // å­˜å‚¨æ‰€æœ‰å¯¹è¯å†å² {chatId: {messages: [], title: "", time: "", sessionId: null, character: "", model: ""}}
    let isWaitingForAudio = false; // æ˜¯å¦æ­£åœ¨ç­‰å¾…éŸ³é¢‘è¿”å›
    let isWaitingForVideo = false; // æ˜¯å¦æ­£åœ¨ç­‰å¾…è§†é¢‘ç”Ÿæˆ
    let isTranscribing = false; // æ˜¯å¦æ­£åœ¨å¤„ç†è¯­éŸ³è¯†åˆ«
    let abortController = null; // ç”¨äºå–æ¶ˆæ­£åœ¨è¿›è¡Œçš„è¯·æ±‚
    let logPollInterval = null; // æ—¥å¿—è½®è¯¢é—´éš”ID
    let currentStage = null; // å½“å‰é˜¶æ®µï¼š'llm', 'tts', 'video'
    let stageStartTime = null; // å½“å‰é˜¶æ®µå¼€å§‹æ—¶é—´

    // ==================== å¯¹è¯ç®¡ç†åŠŸèƒ½ ====================
    const chatManageBtn = document.getElementById("chatManageBtn");
    const chatSidebar = document.getElementById("chatSidebar");
    const chatSidebarClose = document.getElementById("chatSidebarClose");
    const newChatBtn = document.getElementById("newChatBtn");
    const exportChatBtn = document.getElementById("exportChatBtn");
    const clearChatBtn = document.getElementById("clearChatBtn");

    // æ‰“å¼€/å…³é—­å¯¹è¯ç®¡ç†ä¾§è¾¹æ 
    if (chatManageBtn && chatSidebar) {
        chatManageBtn.addEventListener("click", () => {
            chatSidebar.classList.toggle("active");
            if (chatSidebar.classList.contains("active")) {
                updateHistoryList();
            }
        });
    }

    if (chatSidebarClose) {
        chatSidebarClose.addEventListener("click", () => {
            chatSidebar.classList.remove("active");
        });
    }

    // æ–°å»ºå¯¹è¯
    if (newChatBtn) {
        newChatBtn.addEventListener("click", () => {
            const newChatId = `chat-${Date.now()}`;
            chatHistory[newChatId] = {
                messages: [],
                title: "æ–°å¯¹è¯",
                time: new Date().toISOString()
            };
            saveChatHistory();
            switchChat(newChatId);
            // æ˜¾ç¤ºè§’è‰²å’Œæ¨¡å‹é€‰æ‹©å¼¹çª—
            setTimeout(() => {
                showCharacterModelModal();
            }, 300);
        });
    }

    // æ¸…ç©ºå½“å‰å¯¹è¯
    if (clearChatBtn) {
        clearChatBtn.addEventListener("click", () => {
            if (confirm("ç¡®å®šè¦æ¸…ç©ºå½“å‰å¯¹è¯å—ï¼Ÿ")) {
                if (chatHistory[currentChatId]) {
                    chatHistory[currentChatId].messages = [];
                    chatHistory[currentChatId].title = "å½“å‰å¯¹è¯";
                    chatHistory[currentChatId].time = new Date().toISOString();
                    saveChatHistory();
                }
                const chatMessages = document.getElementById("chatMessages");
                if (chatMessages) {
                    chatMessages.innerHTML = '<div class="empty-state"><p>ğŸ‘‹ å¼€å§‹å¯¹è¯å§ï¼è¾“å…¥æ–‡å­—æˆ–å½•åˆ¶è¯­éŸ³ä¸AIäº¤æµ</p></div>';
                }
                updateHistoryList();
            }
        });
    }

    // å¯¼å‡ºå¯¹è¯è®°å½•
    if (exportChatBtn) {
        exportChatBtn.addEventListener("click", () => {
            if (!chatHistory[currentChatId] || chatHistory[currentChatId].messages.length === 0) {
                alert("å½“å‰å¯¹è¯ä¸ºç©ºï¼Œæ— æ³•å¯¼å‡º");
                return;
            }
            
            const messages = chatHistory[currentChatId].messages;
            let exportText = `å¯¹è¯è®°å½• - ${new Date().toLocaleString('zh-CN')}\n`;
            exportText += "=".repeat(50) + "\n\n";
            
            messages.forEach(msg => {
                const role = msg.isUser ? "ç”¨æˆ·" : "AI";
                const time = new Date(msg.time).toLocaleString('zh-CN');
                exportText += `[${time}] ${role}:\n${msg.text}\n\n`;
            });
            
            // åˆ›å»ºä¸‹è½½é“¾æ¥
            const blob = new Blob([exportText], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `å¯¹è¯è®°å½•_${new Date().toISOString().slice(0, 10)}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        });
    }

    // éŸ³é‡æ§åˆ¶å…ƒç´ ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
    const volumeSlider = document.getElementById("volumeSlider");
    const volumeControl = document.getElementById("volumeControl");
    const volumeBtn = document.getElementById("volumeBtn");
    const volumeValue = document.getElementById("volumeValue");
    
    // åç«¯APIåœ°å€ - è‡ªåŠ¨æ£€æµ‹æœåŠ¡å™¨åœ°å€
    // è‡ªåŠ¨æ£€æµ‹æœåŠ¡å™¨åœ°å€
    const FASTAPI_URL = (() => {
      const currentOrigin = window.location.origin;
      const currentHostname = window.location.hostname;
      const currentPort = window.location.port;
      const currentPath = window.location.pathname;
      const currentProtocol = window.location.protocol;
      
      // å¦‚æœå½“å‰ç«¯å£æ˜¯7860ï¼ˆå‰ç«¯æœåŠ¡å™¨ï¼‰ï¼Œåˆ™ä½¿ç”¨åç«¯æœåŠ¡å™¨ï¼ˆ8000ç«¯å£ï¼‰
      if (currentPort === '7860') {
        const backendUrl = `${currentProtocol}//${currentHostname}:8000`;
        console.log('âœ… æ£€æµ‹åˆ°å‰ç«¯æœåŠ¡å™¨ï¼ˆç«¯å£7860ï¼‰ï¼Œä½¿ç”¨åç«¯APIæœåŠ¡å™¨:', backendUrl);
        return backendUrl;
      }
      
      // å¦‚æœè·¯å¾„åŒ…å« /webui/ï¼Œè¯´æ˜æ˜¯æŒ‚è½½åœ¨FastAPIä¸‹çš„
      if (currentPath.includes('/webui/')) {
        console.log('âœ… æ£€æµ‹åˆ°FastAPIé™æ€æ–‡ä»¶æœåŠ¡ï¼Œä½¿ç”¨å½“å‰origin:', currentOrigin);
        return currentOrigin;
      }
      
      // å¦åˆ™ä½¿ç”¨å½“å‰origin
      console.log('âœ… ä½¿ç”¨å½“å‰originä½œä¸ºAPIæœåŠ¡å™¨:', currentOrigin);
      return currentOrigin;
    })();
    
    console.log('æœ€ç»ˆç¡®å®šçš„APIæœåŠ¡å™¨åœ°å€:', FASTAPI_URL);
    let isStreaming = false; // æ˜¯å¦æ­£åœ¨æµå¼è¾“å‡º
    let streamingMessageId = null; // æ­£åœ¨æµå¼è¾“å‡ºçš„æ¶ˆæ¯ID

    // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', async () => {
      // åº”ç”¨è®¾ç½®ï¼ˆä»æ•°æ®åº“è¯»å–ï¼‰
      try {
            const settings = await fetchSettings();
            await Promise.all([
                applySettingsOnly(settings),
                updateThemeSelection(settings),
                updateFontSelection(settings),
                updateFontSizeSelection(settings)
            ]);
      } catch (error) {
        console.error('åº”ç”¨è®¾ç½®å¤±è´¥:', error);
      }
      
        // è®¾ç½®ä¾§è¾¹æ æ§åˆ¶
      const settingsBtn = document.getElementById('settingsBtn');
      const settingsSidebar = document.getElementById('settingsSidebar');
      const sidebarOverlay = document.getElementById('sidebarOverlay');
      const sidebarClose = document.getElementById('sidebarClose');
      
        if (settingsBtn && settingsSidebar) {
            const openSidebar = () => {
        settingsSidebar.classList.add('active');
        sidebarOverlay.classList.add('active');
            };
      
            const closeSidebar = () => {
        settingsSidebar.classList.remove('active');
        sidebarOverlay.classList.remove('active');
            };
      
      settingsBtn.addEventListener('click', openSidebar);
      if (sidebarClose) sidebarClose.addEventListener('click', closeSidebar);
      if (sidebarOverlay) sidebarOverlay.addEventListener('click', closeSidebar);
      
            // æ ‡ç­¾åˆ‡æ¢
      document.querySelectorAll('.sidebar-tab').forEach(tab => {
        tab.addEventListener('click', () => {
          const targetTab = tab.dataset.tab;
          document.querySelectorAll('.sidebar-tab').forEach(t => t.classList.remove('active'));
          document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
          tab.classList.add('active');
          const targetContent = document.getElementById(targetTab + 'Tab');
          if (targetContent) targetContent.classList.add('active');
        });
      });
      
      // ä¸»é¢˜é€‰æ‹©
      document.querySelectorAll('[data-theme]').forEach(card => {
        card.addEventListener('click', () => {
          applyTheme(card.dataset.theme);
        });
      });
      
      // å­—ä½“é€‰æ‹©
      document.querySelectorAll('[data-font]').forEach(card => {
        card.addEventListener('click', () => {
          applyFont(card.dataset.font);
        });
      });
      
      // å­—å·é€‰æ‹©
      document.querySelectorAll('[data-size]').forEach(btn => {
        btn.addEventListener('click', () => {
                    if (btn.dataset.size === 'custom') {
                        const customInput = document.getElementById('customSizeInput');
                        if (customInput) customInput.style.display = 'block';
                    } else {
                        const customInput = document.getElementById('customSizeInput');
                        if (customInput) customInput.style.display = 'none';
          applyFontSize(btn.dataset.size);
                    }
        });
      });
      
      // è‡ªå®šä¹‰å­—å·è¾“å…¥
            const customSizeInput = document.getElementById('customSizeValue');
            if (customSizeInput) {
                customSizeInput.addEventListener('change', () => {
            applyFontSize('custom');
        });
      }
        }
    });
    
    // ä»æ•°æ®åº“åŠ è½½å¯¹è¯å†å²
    async function loadChatHistoryFromDatabase() {
      try {
        const response = await fetch(`${FASTAPI_URL}/chat/sessions?limit=100`);
        if (!response.ok) {
          console.error("åŠ è½½å¯¹è¯å†å²å¤±è´¥:", response.status);
          return;
        }
        const data = await response.json();
        if (data.success && data.data) {
          const sessions = data.data;
          
          // å°†æ•°æ®åº“ä¼šè¯è½¬æ¢ä¸ºå‰ç«¯æ ¼å¼
          for (const session of sessions) {
            const sessionId = session.session_id;
            const frontendChatId = sessionId; // ä½¿ç”¨session_idä½œä¸ºå‰ç«¯chatId
            
            // è·å–è¯¥ä¼šè¯çš„æ‰€æœ‰æ¶ˆæ¯
            const messagesResponse = await fetch(`${FASTAPI_URL}/chat/sessions/${sessionId}/messages`);
            if (messagesResponse.ok) {
              const messagesData = await messagesResponse.json();
              if (messagesData.success && messagesData.data && messagesData.data.length > 0) {
                // åªåŠ è½½æœ‰æ¶ˆæ¯çš„ä¼šè¯ï¼ˆè¿‡æ»¤ç©ºä¼šè¯ï¼‰
                const messages = messagesData.data.map(msg => {
                  // æ ¹æ®content_typeæ¨æ–­responseMode
                  let responseMode = null;
                  if (!msg.isUser && msg.content_type) {
                    if (msg.content_type === 'text') {
                      responseMode = 'text';
                    } else if (msg.content_type === 'text+audio' || msg.content_type === 'audio') {
                      responseMode = 'audio';
                    } else if (msg.content_type === 'text+audio+video' || msg.content_type === 'video+audio' || msg.content_type === 'video') {
                      responseMode = 'video';
                    }
                  }
                  
                  return {
                  text: msg.text_content || '',
                  isUser: msg.message_type === 'user',
                  audioBase64: msg.audio_base64 || null,
                  audioUrl: msg.audio_url || null,
                  audioDuration: 0,
                  messageId: msg.message_id,
                  status: 'sent',
                  time: msg.created_at,
                  videoUrl: msg.video_url || null,
                    videoTaskId: msg.video_task_id || null,
                    responseMode: responseMode
                  };
                });
                
                chatHistory[frontendChatId] = {
                  messages: messages,
                  title: session.title || messages[0]?.text?.substring(0, 20) || 'æœªå‘½åå¯¹è¯',
                  time: session.created_at,
                  sessionId: sessionId,
                  character: session.character || null,
                  model: session.model_name || null
                };
              }
            }
          }
          
          updateHistoryList();
        }
      } catch (error) {
        console.error("ä»æ•°æ®åº“åŠ è½½å¯¹è¯å†å²å¤±è´¥:", error);
      }
    }
    
    // åŠ è½½è§’è‰²åˆ—è¡¨
    async function loadCharacters(selectElement) {
      try {
        if (selectElement) {
          selectElement.innerHTML = '<option value="">åŠ è½½ä¸­...</option>';
        }
        const characters = await getCharacters();
        if (selectElement) {
          if (characters.length === 0) {
            selectElement.innerHTML = '<option value="">æœªæ‰¾åˆ°è§’è‰²</option>';
            return;
          }
          selectElement.innerHTML = characters.map(c => `<option value="${c}">${c}</option>`).join('');
        }
        return characters;
      } catch (error) {
        console.error('åŠ è½½è§’è‰²å¤±è´¥:', error);
        if (selectElement) {
          selectElement.innerHTML = '<option value="">åŠ è½½å¤±è´¥</option>';
        }
        return [];
      }
    }
    
    // åŠ è½½æ¨¡å‹åˆ—è¡¨
    async function loadModels(selectElement) {
      try {
        if (selectElement) {
          selectElement.innerHTML = '<option value="">åŠ è½½ä¸­...</option>';
        }
        const models = await getModels();
        if (selectElement) {
          if (models.length === 0) {
            selectElement.innerHTML = '<option value="">æœªæ‰¾åˆ°æ¨¡å‹</option>';
            return;
          }
          selectElement.innerHTML = models.map(m => `<option value="${m}">${m}</option>`).join('');
        }
        return models;
      } catch (error) {
        console.error('åŠ è½½æ¨¡å‹å¤±è´¥:', error);
        if (selectElement) {
          selectElement.innerHTML = '<option value="">åŠ è½½å¤±è´¥</option>';
        }
        return [];
      }
    }
    
    // æ˜¾ç¤ºè§’è‰²å’Œæ¨¡å‹é€‰æ‹©å¼¹çª—
    function showCharacterModelModal() {
      const modal = document.getElementById('characterModelModal');
      const characterSelect = document.getElementById('modalCharacterSelect');
      const modelSelect = document.getElementById('modalModelSelect');
      const confirmBtn = document.getElementById('confirmCharacterModelBtn');
      const refreshCharacterBtn = document.getElementById('refreshCharacterBtn');
      const refreshModelBtn = document.getElementById('refreshModelBtn');
      
      // æ˜¾ç¤ºå¼¹çª—
      modal.classList.add('active');
      
      // åŠ è½½è§’è‰²å’Œæ¨¡å‹åˆ—è¡¨
      loadCharacters(characterSelect);
      loadModels(modelSelect);
      
      // ç§»é™¤æ‰€æœ‰æ—§çš„äº‹ä»¶ç›‘å¬å™¨ï¼ˆé€šè¿‡å…‹éš†èŠ‚ç‚¹ï¼‰
      const newCharacterSelect = characterSelect.cloneNode(true);
      characterSelect.parentNode.replaceChild(newCharacterSelect, characterSelect);
      const newModelSelect = modelSelect.cloneNode(true);
      modelSelect.parentNode.replaceChild(newModelSelect, modelSelect);
      
      // é‡æ–°è·å–å…ƒç´ å¼•ç”¨
      const charSelect = document.getElementById('modalCharacterSelect');
      const modSelect = document.getElementById('modalModelSelect');
      
      // åŠ è½½è§’è‰²å’Œæ¨¡å‹åˆ—è¡¨
      loadCharacters(charSelect);
      loadModels(modSelect);
      
      // æ£€æŸ¥æ˜¯å¦å¯ä»¥ç¡®è®¤ï¼ˆä½¿ç”¨æ–°çš„å…ƒç´ å¼•ç”¨ï¼‰- å…è®¸å³ä½¿æ²¡æœ‰é€‰æ‹©ä¹Ÿèƒ½è¿›å…¥
      const checkCanConfirm = () => {
        // ä¸å†ç¦ç”¨æŒ‰é’®ï¼Œå…è®¸å³ä½¿æ²¡æœ‰é€‰æ‹©ä¹Ÿèƒ½è¿›å…¥èŠå¤©
        // const hasCharacter = charSelect.value && charSelect.value !== '';
        // const hasModel = modSelect.value && modSelect.value !== '';
        // confirmBtn.disabled = !(hasCharacter && hasModel);
        confirmBtn.disabled = false;
      };
      
      // ç»‘å®šæ–°çš„äº‹ä»¶ç›‘å¬å™¨
      charSelect.addEventListener('change', checkCanConfirm);
      modSelect.addEventListener('change', checkCanConfirm);
      
      // åˆ·æ–°æŒ‰é’®
      refreshCharacterBtn.onclick = () => {
        loadCharacters(charSelect).then(() => {
          checkCanConfirm();
        });
      };
      refreshModelBtn.onclick = () => {
        loadModels(modSelect).then(() => {
          checkCanConfirm();
        });
      };
      
      // ç¡®è®¤æŒ‰é’® - ç›´æ¥èµ‹å€¼ onclickï¼Œç¡®ä¿æ¯æ¬¡éƒ½æ˜¯æ–°çš„å¤„ç†å‡½æ•°
      confirmBtn.onclick = function() {
        const selectedCharacter = charSelect.value || '';
        const selectedModel = modSelect.value || '';
        
        // å…è®¸å³ä½¿æ²¡æœ‰é€‰æ‹©ä¹Ÿèƒ½è¿›å…¥ï¼ˆä½¿ç”¨é»˜è®¤å€¼æˆ–ç©ºå€¼ï¼‰
        // ä¿å­˜åˆ°å½“å‰å¯¹è¯
        if (!chatHistory[currentChatId]) {
          chatHistory[currentChatId] = {
            messages: [],
            title: "å½“å‰å¯¹è¯",
            time: new Date().toISOString()
          };
        }
        chatHistory[currentChatId].character = selectedCharacter || null;
        chatHistory[currentChatId].model = selectedModel || null;
        character = selectedCharacter || null;
        model = selectedModel || null;
        
        // å…³é—­å¼¹çª—
        modal.classList.remove('active');
        saveChatHistory();
        
        // æ˜¾ç¤ºæç¤º
        if (selectedCharacter && selectedModel) {
          showToast(`å·²é€‰æ‹©è§’è‰²: ${selectedCharacter}, æ¨¡å‹: ${selectedModel}`, 'success');
        } else {
          showToast('å·²è¿›å…¥èŠå¤©é¡µé¢ï¼ˆæœªé€‰æ‹©è§’è‰²å’Œæ¨¡å‹ï¼Œå°†ä½¿ç”¨é»˜è®¤å€¼ï¼‰', 'info');
        }
      };
      
      // å…è®¸å³ä½¿åŠ è½½å¤±è´¥ä¹Ÿèƒ½ç‚¹å‡»å¼€å§‹èŠå¤©
      confirmBtn.disabled = false;
      
      // åˆå§‹æ£€æŸ¥ï¼ˆå»¶è¿Ÿï¼Œç­‰å¾…é€‰é¡¹åŠ è½½å®Œæˆï¼‰
      setTimeout(checkCanConfirm, 500);
    }
    
    // åˆå§‹åŒ–å¯¹è¯å†å²
    async function initChatHistory() {
      // ä»æ•°æ®åº“åŠ è½½å†å²è®°å½•
      await loadChatHistoryFromDatabase();
      
      // åˆå§‹åŒ–å½“å‰å¯¹è¯
      if (!chatHistory[currentChatId]) {
        chatHistory[currentChatId] = {
          messages: [],
          title: "å½“å‰å¯¹è¯",
          time: new Date().toISOString()
        };
      }
      
      // å¦‚æœå½“å‰å¯¹è¯æ²¡æœ‰è§’è‰²å’Œæ¨¡å‹ï¼Œæ˜¾ç¤ºé€‰æ‹©å¼¹çª—
      const currentChat = chatHistory[currentChatId];
      if (!currentChat.character || !currentChat.model || currentChat.messages.length === 0) {
        // å»¶è¿Ÿæ˜¾ç¤ºï¼Œç¡®ä¿é¡µé¢å·²åŠ è½½
        setTimeout(() => {
          showCharacterModelModal();
        }, 300);
      } else {
        // æ¢å¤è§’è‰²å’Œæ¨¡å‹
        character = currentChat.character;
        model = currentChat.model;
      }
    }
    
    // ä¿å­˜å¯¹è¯å†å²ï¼ˆä¸å†ä½¿ç”¨localStorageï¼Œè®°å½•å·²é€šè¿‡APIä¿å­˜åˆ°æ•°æ®åº“ï¼‰
    function saveChatHistory() {
      // ä¸å†ä½¿ç”¨localStorageï¼Œè®°å½•å·²é€šè¿‡APIä¿å­˜åˆ°æ•°æ®åº“
      // è¿™é‡Œä¿ç•™å‡½æ•°æ˜¯ä¸ºäº†å…¼å®¹ç°æœ‰ä»£ç ï¼Œä½†ä¸æ‰§è¡Œä»»ä½•æ“ä½œ
    }
    
    // æ›´æ–°å¯¹è¯æ ‡é¢˜ï¼ˆä½¿ç”¨ç¬¬ä¸€æ¡ç”¨æˆ·æ¶ˆæ¯ï¼‰
    function updateChatTitle(chatId, firstUserMessage) {
      if (chatHistory[chatId] && firstUserMessage) {
        const title = firstUserMessage.length > 20 
          ? firstUserMessage.substring(0, 20) + "..."
          : firstUserMessage;
        chatHistory[chatId].title = title;
        saveChatHistory();
        updateHistoryList();
      }
    }
    
    // æ·»åŠ æ¶ˆæ¯åˆ°èŠå¤©ç•Œé¢
    function addMessage(text, isUser, audioBase64 = null, audioDuration = 0, messageId = null, status = 'sent', messageData = null) {
      // å¦‚æœæ˜¯ç¬¬ä¸€æ¡æ¶ˆæ¯ï¼Œæ¸…ç©ºç©ºçŠ¶æ€
      const emptyState = chatMessages.querySelector('.empty-state');
      if (emptyState) {
        emptyState.remove();
      }
      
      if (!messageId) {
        messageId = `msg-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
      }
      
      const messageDiv = document.createElement("div");
      messageDiv.className = `message ${isUser ? 'user' : 'assistant'}`;
      messageDiv.dataset.messageId = messageId;
      
      const bubble = document.createElement("div");
      bubble.className = "message-bubble";
      
      const time = document.createElement("div");
      time.className = "message-time";
      time.textContent = new Date().toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
      
      // æ·»åŠ æ¶ˆæ¯çŠ¶æ€ï¼ˆä»…ç”¨æˆ·æ¶ˆæ¯æ˜¾ç¤ºï¼‰
      if (isUser) {
        const statusDiv = document.createElement("div");
        statusDiv.className = `message-status ${status}`;
        statusDiv.id = `status-${messageId}`;
        messageDiv.appendChild(statusDiv);
      }
      
      // æ ¹æ®å“åº”æ¨¡å¼æ˜¾ç¤ºä¸åŒçš„å†…å®¹
      const responseMode = messageData && messageData.responseMode ? messageData.responseMode : null;
      
      if (isUser || !responseMode) {
        // ç”¨æˆ·æ¶ˆæ¯æˆ–æ²¡æœ‰æŒ‡å®šå“åº”æ¨¡å¼ï¼šæ˜¾ç¤ºæ–‡æœ¬
        bubble.textContent = text;
      } else if (responseMode === "audio" && !isUser) {
        // è¯­éŸ³æ¨¡å¼ï¼šç›´æ¥ä½¿ç”¨audio-bubbleæ›¿æ¢message-bubbleï¼Œä¸è¦å¤–å±‚è¾¹æ¡†
        const audioBubble = document.createElement("div");
        audioBubble.className = "audio-bubble";
        
        const icon = document.createElement("span");
        icon.className = "audio-bubble-icon";
        icon.textContent = "ğŸ”Š";
        
        const duration = document.createElement("span");
        duration.className = "audio-bubble-duration";
        const durationText = audioDuration > 0 
          ? `${Math.floor(audioDuration)}ç§’` 
          : "éŸ³é¢‘";
        duration.textContent = durationText;
        
        audioBubble.appendChild(icon);
        audioBubble.appendChild(duration);
        
        // åˆ›å»ºéšè—çš„éŸ³é¢‘å…ƒç´ ç”¨äºæ’­æ”¾
        const audio = document.createElement("audio");
        audio.style.display = "none";
        if (messageData && messageData.audioUrl) {
          audio.src = `${FASTAPI_URL}${messageData.audioUrl}`;
        } else if (messageData && messageData.audioBase64) {
          audio.src = `data:audio/wav;base64,${messageData.audioBase64}`;
        } else if (audioUrl) {
          audio.src = `${FASTAPI_URL}${audioUrl}`;
        } else if (audioBase64) {
          audio.src = `data:audio/wav;base64,${audioBase64}`;
        }
        
        // å½“éŸ³é¢‘å…ƒæ•°æ®åŠ è½½å®Œæˆåï¼Œæ›´æ–°æ—¶é•¿æ˜¾ç¤ºï¼ˆå¦‚æœaudioDurationä¸º0æˆ–æœªè®¾ç½®ï¼‰
        if (audioDuration <= 0) {
          audio.addEventListener('loadedmetadata', () => {
            if (audio.duration && isFinite(audio.duration)) {
              duration.textContent = `${Math.floor(audio.duration)}ç§’`;
            }
          }, { once: true });
        }
        
        // ç‚¹å‡»æ°”æ³¡æ’­æ”¾éŸ³é¢‘
        audioBubble.addEventListener("click", () => {
          if (audio.paused) {
            audio.play().catch(e => {
              console.error("æ’­æ”¾éŸ³é¢‘å¤±è´¥:", e);
              showToast("æ’­æ”¾éŸ³é¢‘å¤±è´¥", "error");
            });
          } else {
            audio.pause();
            audio.currentTime = 0;
          }
        });
        
        // æ’­æ”¾çŠ¶æ€æ›´æ–°å›¾æ ‡
        audio.addEventListener('play', () => {
          icon.textContent = "ğŸ”Š";
        });
        audio.addEventListener('pause', () => {
          icon.textContent = "ğŸ”Š";
          audio.currentTime = 0;
        });
        audio.addEventListener('ended', () => {
          audio.currentTime = 0;
        });
        
        // ç›´æ¥æ›¿æ¢bubbleçš„å†…å®¹ï¼Œä½¿ç”¨audio-bubble
        bubble.innerHTML = "";
        bubble.className = ""; // æ¸…é™¤message-bubbleçš„æ ·å¼
        bubble.appendChild(audioBubble);
        bubble.appendChild(audio);
      } else if (responseMode === "video" && !isUser) {
        // è§†é¢‘æ¨¡å¼ï¼šæ˜¾ç¤ºè§†é¢‘é¢„è§ˆæ¡†ï¼ˆä¸æ˜¾ç¤ºæ–‡æœ¬ï¼‰
        if (messageData && messageData.videoTaskId) {
          // è§†é¢‘ä»»åŠ¡IDæ¨¡å¼ï¼šæ˜¾ç¤º"è§†é¢‘ç”Ÿæˆä¸­"
          bubble.textContent = "è§†é¢‘ç”Ÿæˆä¸­...";
        } else if (messageData && messageData.videoUrl) {
          // æ„å»ºå®Œæ•´çš„è§†é¢‘URLï¼ˆå¦‚æœæ˜¯ç›¸å¯¹è·¯å¾„ï¼Œéœ€è¦åŠ ä¸ŠFASTAPI_URLå‰ç¼€ï¼‰
          let videoUrl = messageData.videoUrl;
          if (videoUrl.startsWith('/')) {
            // ç›¸å¯¹è·¯å¾„ï¼Œéœ€è¦åŠ ä¸ŠFASTAPI_URLå‰ç¼€
            videoUrl = `${FASTAPI_URL}${videoUrl}`;
          }
          
          const videoPreviewBox = document.createElement("div");
          videoPreviewBox.className = "video-preview-box";
          
          const video = document.createElement("video");
          const urlWithTimestamp = videoUrl + (videoUrl.includes('?') ? '&' : '?') + 't=' + Date.now();
          video.src = urlWithTimestamp;
          video.muted = true;
          video.loop = true;
          video.playsInline = true;
          
          const playIcon = document.createElement("div");
          playIcon.className = "video-play-icon";
          playIcon.textContent = "â–¶";
          
          videoPreviewBox.appendChild(video);
          videoPreviewBox.appendChild(playIcon);
          
          // è¯¦ç»†çš„é”™è¯¯å¤„ç†
          video.onerror = async function(e) {
            console.error("è§†é¢‘åŠ è½½å¤±è´¥:", {
              videoUrl: videoUrl,
              src: video.src,
              error: e,
              networkState: video.networkState,
              readyState: video.readyState
            });
            
            // å°è¯•æ£€æŸ¥è§†é¢‘æ–‡ä»¶æ˜¯å¦å­˜åœ¨
            let errorMessage = "è§†é¢‘åŠ è½½å¤±è´¥";
            try {
              const checkResponse = await fetch(videoUrl, { method: 'HEAD' });
              if (!checkResponse.ok) {
                if (checkResponse.status === 404) {
                  errorMessage = `è§†é¢‘æ–‡ä»¶ä¸å­˜åœ¨ (404): ${videoUrl}`;
                } else {
                  errorMessage = `è§†é¢‘æœåŠ¡å™¨é”™è¯¯ (${checkResponse.status}): ${videoUrl}`;
                }
              } else {
                const contentType = checkResponse.headers.get('content-type');
                if (!contentType || !contentType.startsWith('video/')) {
                  errorMessage = `è§†é¢‘æ ¼å¼é”™è¯¯ï¼ŒContent-Type: ${contentType || 'æœªçŸ¥'}`;
                } else {
                  errorMessage = `è§†é¢‘åŠ è½½å¤±è´¥ï¼Œå¯èƒ½æ ¼å¼ä¸æ”¯æŒæˆ–æ–‡ä»¶æŸå`;
                }
              }
            } catch (fetchError) {
              errorMessage = `æ— æ³•è®¿é—®è§†é¢‘æ–‡ä»¶: ${fetchError.message || 'ç½‘ç»œé”™è¯¯'}`;
            }
            
            console.error("è§†é¢‘åŠ è½½è¯¦ç»†é”™è¯¯:", errorMessage);
            bubble.textContent = errorMessage;
            videoPreviewBox.style.display = "none";
          };
          
          // ç‚¹å‡»é¢„è§ˆæ¡†æ’­æ”¾è§†é¢‘
          videoPreviewBox.addEventListener("click", () => {
            const fullVideo = document.createElement("video");
            fullVideo.controls = true;
            fullVideo.style.width = "350px";
            fullVideo.style.height = "350px";
            fullVideo.style.borderRadius = "12px";
            fullVideo.style.objectFit = "cover";
            const fullUrlWithTimestamp = videoUrl + (videoUrl.includes('?') ? '&' : '?') + 't=' + Date.now();
            fullVideo.src = fullUrlWithTimestamp;
            fullVideo.muted = false;
            
            bubble.innerHTML = "";
            bubble.appendChild(fullVideo);
            
            fullVideo.onerror = async function(e) {
              console.error("å…¨å±è§†é¢‘æ’­æ”¾å¤±è´¥:", {
                videoUrl: videoUrl,
                src: fullVideo.src,
                error: e,
                networkState: fullVideo.networkState,
                readyState: fullVideo.readyState
              });
              
              let errorMessage = "è§†é¢‘æ’­æ”¾å¤±è´¥";
              try {
                const checkResponse = await fetch(videoUrl, { method: 'HEAD' });
                if (!checkResponse.ok) {
                  if (checkResponse.status === 404) {
                    errorMessage = `è§†é¢‘æ–‡ä»¶ä¸å­˜åœ¨ (404)`;
                  } else {
                    errorMessage = `è§†é¢‘æœåŠ¡å™¨é”™è¯¯ (${checkResponse.status})`;
                  }
                } else {
                  const contentType = checkResponse.headers.get('content-type');
                  if (!contentType || !contentType.startsWith('video/')) {
                    errorMessage = `è§†é¢‘æ ¼å¼é”™è¯¯ (Content-Type: ${contentType || 'æœªçŸ¥'})`;
                  } else {
                    errorMessage = `è§†é¢‘æ’­æ”¾å¤±è´¥ï¼Œå¯èƒ½æ ¼å¼ä¸æ”¯æŒæˆ–æ–‡ä»¶æŸå`;
                  }
                }
              } catch (fetchError) {
                errorMessage = `æ— æ³•è®¿é—®è§†é¢‘æ–‡ä»¶: ${fetchError.message || 'ç½‘ç»œé”™è¯¯'}`;
              }
              
              console.error("å…¨å±è§†é¢‘æ’­æ”¾è¯¦ç»†é”™è¯¯:", errorMessage);
              showToast(errorMessage, "error");
            };
            
            fullVideo.play().catch(e => {
              console.error("æ’­æ”¾è§†é¢‘å¼‚å¸¸:", e);
              showToast(`æ’­æ”¾å¤±è´¥: ${e.message || 'æœªçŸ¥é”™è¯¯'}`, "error");
            });
          });
          
          // åŠ è½½è§†é¢‘ç¬¬ä¸€å¸§ä½œä¸ºé¢„è§ˆ
          video.addEventListener('loadeddata', () => {
            video.currentTime = 0.1;
          }, { once: true });
          
          bubble.appendChild(videoPreviewBox);
        } else {
          bubble.textContent = text || "è§†é¢‘åŠ è½½ä¸­...";
        }
      } else {
        // é»˜è®¤ï¼šæ˜¾ç¤ºæ–‡æœ¬
        bubble.textContent = text;
      }
      
      messageDiv.appendChild(bubble);
      messageDiv.appendChild(time);
      
      // å¦‚æœæ˜¯AIå›å¤ä¸”æœ‰éŸ³é¢‘ï¼ˆå…¼å®¹æ—§é€»è¾‘ï¼Œéå“åº”æ¨¡å¼ï¼‰- æ”¹ä¸ºä½¿ç”¨audio-bubbleæ˜¾ç¤º
      const hasAudio = (audioBase64 || (messageData && messageData.audioUrl)) && !responseMode;
      if (!isUser && hasAudio) {
        // ä½¿ç”¨audio-bubbleæ˜¾ç¤ºï¼Œå’Œå“åº”æ¨¡å¼ä¸€è‡´
        const audioBubble = document.createElement("div");
        audioBubble.className = "audio-bubble";
        
        const icon = document.createElement("span");
        icon.className = "audio-bubble-icon";
        icon.textContent = "ğŸ”Š";
        
        const duration = document.createElement("span");
        duration.className = "audio-bubble-duration";
        // å¦‚æœæœ‰audioDurationå°±æ˜¾ç¤ºï¼Œå¦åˆ™æ˜¾ç¤º"éŸ³é¢‘"ï¼Œç­‰åŠ è½½åæ›´æ–°
        const durationText = audioDuration > 0 
          ? `${Math.floor(audioDuration)}ç§’` 
          : "éŸ³é¢‘";
        duration.textContent = durationText;
        
        audioBubble.appendChild(icon);
        audioBubble.appendChild(duration);
        
        // åˆ›å»ºéšè—çš„éŸ³é¢‘å…ƒç´ ç”¨äºæ’­æ”¾
        const audio = document.createElement("audio");
        audio.style.display = "none";
        if (volumeSlider) {
          audio.volume = isMuted ? 0 : volumeSlider.value / 100;
        }
        
        // ä¼˜å…ˆä½¿ç”¨URLï¼Œå¦‚æœä¸å­˜åœ¨åˆ™ä½¿ç”¨base64
        if (messageData && messageData.audioUrl) {
          audio.src = `${FASTAPI_URL}${messageData.audioUrl}`;
        } else if (messageData && messageData.audioBase64) {
          audio.src = `data:audio/wav;base64,${messageData.audioBase64}`;
        } else if (audioUrl) {
          audio.src = `${FASTAPI_URL}${audioUrl}`;
        } else if (audioBase64) {
          audio.src = `data:audio/wav;base64,${audioBase64}`;
        }
        
        // å½“éŸ³é¢‘å…ƒæ•°æ®åŠ è½½å®Œæˆåï¼Œæ›´æ–°æ—¶é•¿æ˜¾ç¤º
        audio.addEventListener('loadedmetadata', () => {
          if (audio.duration && isFinite(audio.duration)) {
            duration.textContent = `${Math.floor(audio.duration)}ç§’`;
          }
        }, { once: true });
        
        // ç‚¹å‡»æ°”æ³¡æ’­æ”¾éŸ³é¢‘
        audioBubble.addEventListener("click", () => {
          if (audio.paused) {
            audio.play().catch(e => {
              console.error("æ’­æ”¾éŸ³é¢‘å¤±è´¥:", e);
              showToast("æ’­æ”¾éŸ³é¢‘å¤±è´¥", "error");
            });
          } else {
            audio.pause();
            audio.currentTime = 0;
          }
        });
        
        // æ’­æ”¾çŠ¶æ€æ›´æ–°å›¾æ ‡
        audio.addEventListener('play', () => {
          icon.textContent = "ğŸ”Š";
        });
        audio.addEventListener('pause', () => {
          icon.textContent = "ğŸ”Š";
          audio.currentTime = 0;
        });
        audio.addEventListener('ended', () => {
          audio.currentTime = 0;
        });
        
        // æ¸…é™¤message-bubbleæ ·å¼ï¼Œæ·»åŠ audio-bubble
        bubble.className = "";
        bubble.appendChild(audioBubble);
        bubble.appendChild(audio);
        
        // ä¿å­˜å½“å‰éŸ³é¢‘å¼•ç”¨
        currentAudio = audio;
        
        // è®¾ç½®åˆå§‹éŸ³é‡
        if (volumeSlider) {
          audio.volume = isMuted ? 0 : volumeSlider.value / 100;
        }
        
        // è‡ªåŠ¨æ’­æ”¾ï¼ˆå¦‚æœæœªé™éŸ³ï¼‰
        if (!isMuted) {
          audio.play().catch(e => console.log("è‡ªåŠ¨æ’­æ”¾å¤±è´¥:", e));
        }
      }
      
      // å¦‚æœæ˜¯AIå›å¤ä¸”æœ‰è§†é¢‘ï¼Œæ·»åŠ è§†é¢‘æ’­æ”¾æŒ‰é’®
      const hasVideo = (messageData && messageData.videoUrl) || (messageData && messageData.videoTaskId);
      if (!isUser && hasVideo) {
        const videoContainer = document.createElement("div");
        videoContainer.className = "video-container";
        videoContainer.id = `video-container-${messageId}`;
        
        const videoPlayBtn = document.createElement("button");
        videoPlayBtn.className = "video-play-btn";
        videoPlayBtn.textContent = "ğŸ¬ æ’­æ”¾è§†é¢‘";
        videoPlayBtn.onclick = () => {
          // æ„å»ºå®Œæ•´çš„è§†é¢‘URLï¼ˆå¦‚æœæ˜¯ç›¸å¯¹è·¯å¾„ï¼Œéœ€è¦åŠ ä¸ŠFASTAPI_URLå‰ç¼€ï¼‰
          let videoUrl = messageData.videoUrl || `${FASTAPI_URL}/videos/${messageData.videoTaskId}.mp4`;
          if (videoUrl.startsWith('/')) {
            // ç›¸å¯¹è·¯å¾„ï¼Œéœ€è¦åŠ ä¸ŠFASTAPI_URLå‰ç¼€
            videoUrl = `${FASTAPI_URL}${videoUrl}`;
          }
          
          const video = document.createElement("video");
          video.controls = true;
          video.style.width = "100%";
          video.style.maxWidth = "500px";
          video.style.borderRadius = "8px";
          const urlWithTimestamp = videoUrl + (videoUrl.includes('?') ? '&' : '?') + 't=' + Date.now();
          video.src = urlWithTimestamp;
          
          videoContainer.innerHTML = "";
          videoContainer.appendChild(video);
          videoContainer.classList.add("active");
          videoPlayBtn.style.display = "none";
          
          video.onerror = async function() {
            console.error("è§†é¢‘åŠ è½½å¤±è´¥:", {
              videoUrl: videoUrl,
              src: video.src,
              networkState: video.networkState,
              readyState: video.readyState
            });
            
            // å°è¯•æ£€æŸ¥è§†é¢‘æ–‡ä»¶æ˜¯å¦å­˜åœ¨
            let errorMessage = "è§†é¢‘åŠ è½½å¤±è´¥";
            try {
              const checkResponse = await fetch(videoUrl, { method: 'HEAD' });
              if (!checkResponse.ok) {
                if (checkResponse.status === 404) {
                  errorMessage = `è§†é¢‘æ–‡ä»¶ä¸å­˜åœ¨ (404): ${videoUrl}`;
                } else {
                  errorMessage = `è§†é¢‘æœåŠ¡å™¨é”™è¯¯ (${checkResponse.status}): ${videoUrl}`;
                }
              } else {
                const contentType = checkResponse.headers.get('content-type');
                if (!contentType || !contentType.startsWith('video/')) {
                  errorMessage = `è§†é¢‘æ ¼å¼é”™è¯¯ï¼ŒContent-Type: ${contentType || 'æœªçŸ¥'}`;
                } else {
                  errorMessage = `è§†é¢‘åŠ è½½å¤±è´¥ï¼Œå¯èƒ½æ ¼å¼ä¸æ”¯æŒæˆ–æ–‡ä»¶æŸå`;
                }
              }
            } catch (fetchError) {
              errorMessage = `æ— æ³•è®¿é—®è§†é¢‘æ–‡ä»¶: ${fetchError.message || 'ç½‘ç»œé”™è¯¯'}`;
            }
            
            console.error("è§†é¢‘åŠ è½½è¯¦ç»†é”™è¯¯:", errorMessage);
            showToast(errorMessage, "error");
            videoContainer.innerHTML = "";
            videoContainer.classList.remove("active");
            videoPlayBtn.style.display = "block";
          };
        };
        
        videoContainer.appendChild(videoPlayBtn);
        bubble.appendChild(videoContainer);
      }
      
      chatMessages.appendChild(messageDiv);
      chatMessages.scrollTop = chatMessages.scrollHeight;
      
      // ä¿å­˜åˆ°å¯¹è¯å†å²ï¼ˆå»¶è¿Ÿä¿å­˜ï¼Œé¿å…åœ¨æµå¼è¾“å‡ºæ—¶é¢‘ç¹ä¿å­˜ï¼‰
      if (chatHistory[currentChatId] && !isStreaming) {
        const existingMessage = chatHistory[currentChatId].messages.find(m => m.messageId === messageId);
        if (!existingMessage) {
          chatHistory[currentChatId].messages.push({
            text,
            isUser,
            audioBase64,
            audioDuration,
            messageId,
            status,
            time: new Date().toISOString()
          });
          saveChatHistory();
        }
      }
      
      return messageDiv;
    }
    
    // æ›´æ–°æ¶ˆæ¯çŠ¶æ€
    function updateMessageStatus(messageId, status) {
      const statusDiv = document.getElementById(`status-${messageId}`);
      if (statusDiv) {
        statusDiv.className = `message-status ${status}`;
      }
      
      // æ›´æ–°å†å²è®°å½•ä¸­çš„çŠ¶æ€
      if (chatHistory[currentChatId]) {
        const message = chatHistory[currentChatId].messages.find(m => m.messageId === messageId);
        if (message) {
          message.status = status;
          saveChatHistory();
        }
      }
    }
    
    // æ›´æ–°æ¶ˆæ¯å†…å®¹ï¼ˆç”¨äºæµå¼è¾“å‡ºï¼‰
    function updateMessageText(messageId, text, isComplete = false) {
      const messageDiv = document.querySelector(`[data-message-id="${messageId}"]`);
      if (messageDiv) {
        const bubble = messageDiv.querySelector('.message-bubble');
        if (bubble) {
          if (isComplete) {
            bubble.textContent = text;
            // ç§»é™¤æµå¼å…‰æ ‡
            const cursor = bubble.querySelector('.streaming-cursor');
            if (cursor) {
              cursor.remove();
            }
          } else {
            bubble.innerHTML = `<span class="streaming-text">${text}</span><span class="streaming-cursor"></span>`;
          }
          chatMessages.scrollTop = chatMessages.scrollHeight;
        }
      }
      
      // æ›´æ–°å†å²è®°å½•
      if (chatHistory[currentChatId]) {
        const message = chatHistory[currentChatId].messages.find(m => m.messageId === messageId);
        if (message) {
          message.text = text;
          saveChatHistory();
        }
      }
    }
    
    // æ˜¾ç¤ºè¾“å…¥æŒ‡ç¤ºå™¨ï¼ˆå¸¦å–æ¶ˆæŒ‰é’®ï¼‰
    function showTypingIndicator() {
      const indicator = document.createElement("div");
      indicator.className = "message assistant";
      indicator.id = "typingIndicator";
      
      const wrapper = document.createElement("div");
      wrapper.className = "typing-indicator-wrapper";
      
      const typingDiv = document.createElement("div");
      typingDiv.className = "typing-indicator";
      typingDiv.innerHTML = `
          <div class="typing-dot"></div>
          <div class="typing-dot"></div>
          <div class="typing-dot"></div>
      `;
      
      const cancelBtn = document.createElement("button");
      cancelBtn.className = "cancel-typing-btn";
      cancelBtn.textContent = "Ã—";
      cancelBtn.title = "å–æ¶ˆå›å¤";
      cancelBtn.onclick = () => {
        if (abortController) {
          abortController.abort();
        }
        hideTypingIndicator();
      };
      
      wrapper.appendChild(typingDiv);
      wrapper.appendChild(cancelBtn);
      indicator.appendChild(wrapper);
      chatMessages.appendChild(indicator);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }
    
    // éšè—è¾“å…¥æŒ‡ç¤ºå™¨
    function hideTypingIndicator() {
      const indicator = document.getElementById("typingIndicator");
      if (indicator) {
        indicator.remove();
      }
    }
    
    // è·å–å½“å‰é€‰æ‹©çš„å“åº”æ¨¡å¼
    function getResponseMode() {
      const textRadio = document.getElementById("modeText");
      const audioRadio = document.getElementById("modeAudio");
      const videoRadio = document.getElementById("modeVideo");
      
      if (videoRadio && videoRadio.checked) {
        return "video";
      } else if (audioRadio && audioRadio.checked) {
        return "audio";
      } else {
        return "text";
      }
    }
    
    // æ›´æ–°è¿›åº¦æ˜¾ç¤º
    function updateProgress(step, progress, resetStage = false) {
      const progressContainer = document.getElementById('chatProgressContainer');
      const progressFill = document.getElementById('chatProgressFill');
      const progressText = document.getElementById('chatProgressText');
      const progressPercent = document.getElementById('chatProgressPercent');
      
      if (!progressContainer || !progressFill || !progressText || !progressPercent) {
        return;
      }
      
      // æ˜¾ç¤ºè¿›åº¦å®¹å™¨
      if (progressContainer.style.display === 'none') {
        progressContainer.style.display = 'block';
      }
      
      // æ›´æ–°è¿›åº¦æ¡
      progressFill.style.width = progress + '%';
      progressPercent.textContent = Math.round(progress) + '%';
      
      // æ›´æ–°è¿›åº¦æ–‡æœ¬
      const stageNames = {
        'llm': 'LLM æ–‡æœ¬ç”Ÿæˆ',
        'tts': 'TTS éŸ³é¢‘ç”Ÿæˆ',
        'nerf': 'NeRF è§†é¢‘ç”Ÿæˆ',
        'video': 'NeRF è§†é¢‘ç”Ÿæˆ'  // å…¼å®¹videoåç§°
      };
      const stageName = stageNames[step] || 'å¤„ç†ä¸­';
      
      if (resetStage) {
        progressText.textContent = 'å‡†å¤‡ä¸­...';
      } else {
        progressText.textContent = `${stageName}ä¸­...`;
      }
    }
    
    // ä»æ—¥å¿—ä¸­æ£€æµ‹å½“å‰é˜¶æ®µå’Œå®ŒæˆçŠ¶æ€
    function detectStageFromLogs(logs) {
      if (!logs || !Array.isArray(logs)) {
        return { stage: null, stageCompleted: false };
      }
      
      let llmCompleted = false;
      let ttsCompleted = false;
      let videoCompleted = false;
      let currentStage = null;
      
      // ä»æœ€æ–°çš„æ—¥å¿—å¼€å§‹æŸ¥æ‰¾ï¼ˆå€’åºï¼‰
      for (let i = logs.length - 1; i >= 0; i--) {
        const log = logs[i];
        const message = log.message || '';
        
        // æ£€æŸ¥é˜¶æ®µå®Œæˆæ ‡è®°
        if (message.includes('é˜¶æ®µ1å®Œæˆ') && message.includes('LLM')) {
          llmCompleted = true;
          if (!currentStage) currentStage = 'tts';
        } else if (message.includes('é˜¶æ®µ2å®Œæˆ') && message.includes('TTS')) {
          ttsCompleted = true;
          if (!currentStage) currentStage = 'video';
        } else if (message.includes('é˜¶æ®µ3å®Œæˆ') || message.includes('è§†é¢‘ç”Ÿæˆä»»åŠ¡æäº¤å®Œæˆ')) {
          videoCompleted = true;
          if (!currentStage) currentStage = 'video';
        }
        
        // æ£€æŸ¥å½“å‰é˜¶æ®µæ ‡è®°ï¼ˆå¦‚æœæ²¡æœ‰å®Œæˆæ ‡è®°ï¼‰
        if (!currentStage) {
          if (message.includes('é˜¶æ®µ1') && message.includes('LLM')) {
            currentStage = 'llm';
          } else if (message.includes('é˜¶æ®µ2') && message.includes('TTS')) {
            currentStage = 'tts';
          } else if (message.includes('é˜¶æ®µ3') && (message.includes('è§†é¢‘') || message.includes('NeRF'))) {
            currentStage = 'video';
          }
        }
      }
      
      return { 
        stage: currentStage, 
        llmCompleted, 
        ttsCompleted, 
        videoCompleted 
      };
    }
    
    // å¼€å§‹æ—¥å¿—è½®è¯¢
    function startLogPolling() {
      // æ¸…é™¤ä¹‹å‰çš„è½®è¯¢
      stopLogPolling();
      
      // é‡ç½®é˜¶æ®µçŠ¶æ€
      currentStage = null;
      stageStartTime = null;
      
      // æ˜¾ç¤ºè¿›åº¦å®¹å™¨å¹¶åˆå§‹åŒ–
      updateProgress('llm', 0, true);
      
      // å¼€å§‹è½®è¯¢æ—¥å¿—
      logPollInterval = setInterval(async () => {
        try {
          const response = await fetch(`${FASTAPI_URL}/logs/full?debug=false`);
          if (!response.ok) {
            return;
          }
          
          const data = await response.json();
          if (data.success && data.logs) {
            // æ£€æµ‹å½“å‰é˜¶æ®µå’Œå®ŒæˆçŠ¶æ€
            const stageInfo = detectStageFromLogs(data.logs);
            
            if (stageInfo.stage && stageInfo.stage !== currentStage) {
              // é˜¶æ®µå˜åŒ–
              currentStage = stageInfo.stage;
              stageStartTime = Date.now();
            }
            
            // æ ¹æ®é˜¶æ®µå®ŒæˆçŠ¶æ€å’Œå½“å‰é˜¶æ®µè®¡ç®—è¿›åº¦
            let progress = 0;
            let activeStep = 'llm';
            
            if (stageInfo.llmCompleted) {
              progress = 33;
              activeStep = 'tts';
              
              if (stageInfo.ttsCompleted) {
                progress = 66;
                activeStep = 'video';
                
                if (stageInfo.videoCompleted) {
                  progress = 100;
                } else if (currentStage === 'video') {
                  // è§†é¢‘é˜¶æ®µè¿›è¡Œä¸­ï¼š66-100%
                  const elapsed = stageStartTime ? (Date.now() - stageStartTime) / 1000 : 0;
                  progress = 66 + Math.min(34, Math.floor(elapsed / 60 * 34)); // å‡è®¾60ç§’å†…å®Œæˆ
                }
              } else if (currentStage === 'tts') {
                // TTSé˜¶æ®µè¿›è¡Œä¸­ï¼š33-66%
                const elapsed = stageStartTime ? (Date.now() - stageStartTime) / 1000 : 0;
                progress = 33 + Math.min(33, Math.floor(elapsed / 15 * 33)); // å‡è®¾15ç§’å†…å®Œæˆ
              }
            } else if (currentStage === 'llm') {
              // LLMé˜¶æ®µè¿›è¡Œä¸­ï¼š0-33%
              const elapsed = stageStartTime ? (Date.now() - stageStartTime) / 1000 : 0;
              progress = Math.min(33, Math.floor(elapsed / 10 * 33)); // å‡è®¾10ç§’å†…å®Œæˆ
            } else {
              // å¦‚æœè¿˜æ²¡æ£€æµ‹åˆ°é˜¶æ®µï¼Œæ˜¾ç¤ºè¾ƒå°çš„åˆå§‹è¿›åº¦
              progress = 5;
            }
            
            updateProgress(activeStep, progress);
          }
        } catch (error) {
          console.error('æ—¥å¿—è½®è¯¢å¤±è´¥:', error);
        }
      }, 1000); // æ¯ç§’è½®è¯¢ä¸€æ¬¡
    }
    
    // åœæ­¢æ—¥å¿—è½®è¯¢
    function stopLogPolling() {
      if (logPollInterval) {
        clearInterval(logPollInterval);
        logPollInterval = null;
      }
      
      // éšè—è¿›åº¦å®¹å™¨
      const progressContainer = document.getElementById('chatProgressContainer');
      if (progressContainer) {
        progressContainer.style.display = 'none';
      }
      
      // é‡ç½®é˜¶æ®µçŠ¶æ€
      currentStage = null;
      stageStartTime = null;
    }
    
    // ç®€å•çš„toastæç¤ºå‡½æ•°
    function showToast(message, type = 'info') {
      // åˆ›å»ºä¸€ä¸ªç®€å•çš„toastå…ƒç´ 
      const toast = document.createElement('div');
      toast.style.cssText = `
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        padding: 12px 24px;
        background: ${type === 'error' ? '#ef4444' : type === 'success' ? '#10b981' : type === 'warning' ? '#f59e0b' : '#3b82f6'};
        color: white;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        z-index: 10000;
        font-size: 14px;
        font-weight: 500;
      `;
      toast.textContent = message;
      document.body.appendChild(toast);
      
      // 3ç§’åè‡ªåŠ¨ç§»é™¤
      setTimeout(() => {
        toast.style.opacity = '0';
        toast.style.transition = 'opacity 0.3s';
        setTimeout(() => {
          document.body.removeChild(toast);
        }, 300);
      }, 3000);
    }
    
    // å‘é€æ¶ˆæ¯
    async function sendMessage(text, retryMessageId = null) {
      if (!text.trim()) return;
      
      // å¦‚æœæ­£åœ¨ç­‰å¾…éŸ³é¢‘è¿”å›æˆ–è§†é¢‘ç”Ÿæˆï¼Œç¦æ­¢å‘é€æ–°æ¶ˆæ¯
      if (isWaitingForAudio || isWaitingForVideo || isStreaming) {
        showToast("è¯·ç­‰å¾…AIå›å¤å®Œæˆåå†å‘é€", "warning");
        return;
      }
      
      // æ£€æŸ¥æ˜¯å¦æœ‰è§’è‰²å’Œæ¨¡å‹
      if (!character || !model) {
        showToast("è¯·å…ˆé€‰æ‹©è§’è‰²å’Œæ¨¡å‹", "error");
        showCharacterModelModal();
        return;
      }
      
      const userMessageId = retryMessageId || `user-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
      const responseMode = getResponseMode(); // è·å–é€‰æ‹©çš„å“åº”æ¨¡å¼
      
      // æ ¹æ®å“åº”æ¨¡å¼è®¾ç½®enable_audioå’Œenable_video
      const enable_audio = responseMode === "audio";
      const enable_video = responseMode === "video";
      
      // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯ï¼ˆå¦‚æœæ˜¯é‡è¯•ï¼Œä¸é‡å¤æ·»åŠ ï¼‰
      if (!retryMessageId) {
        addMessage(text, true, null, 0, userMessageId, 'sending');
        updateChatTitle(currentChatId, text);
        chatInput.value = "";
      } else {
        // é‡è¯•æ—¶æ›´æ–°çŠ¶æ€
        updateMessageStatus(userMessageId, 'sending');
      }
      
      // æ˜¾ç¤ºè¾“å…¥æŒ‡ç¤ºå™¨
      showTypingIndicator();
      
      // ç¦ç”¨å‘é€æŒ‰é’®ï¼ˆä¸å†ä¿®æ”¹æ–‡æœ¬ï¼‰
      sendBtn.disabled = true;
      
      // å¯åŠ¨æ—¥å¿—è½®è¯¢ä»¥æ˜¾ç¤ºè¿›åº¦
      startLogPolling();
      
      // åˆ›å»ºAbortControllerç”¨äºå–æ¶ˆè¯·æ±‚
      // è§†é¢‘æ¨¡å¼éœ€è¦æ›´é•¿çš„è¶…æ—¶æ—¶é—´ï¼ˆ15åˆ†é’Ÿï¼‰ï¼Œå› ä¸ºè§†é¢‘ç”Ÿæˆå¯èƒ½éœ€è¦å¾ˆé•¿æ—¶é—´
      const timeoutDuration = responseMode === "video" ? 900000 : 300000; // è§†é¢‘æ¨¡å¼15åˆ†é’Ÿï¼Œå…¶ä»–5åˆ†é’Ÿ
      abortController = new AbortController();
      const timeoutId = setTimeout(() => {
        abortController.abort();
      }, timeoutDuration);
      
      try {
        const response = await fetch(`${FASTAPI_URL}/chat`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            text: text,
            character: character,
            enable_audio: enable_audio,
            enable_video: enable_video,  // æ–°å¢å‚æ•°
            response_mode: responseMode,  // æ–°å¢å‚æ•°ï¼Œæ–¹ä¾¿åç«¯è¯†åˆ«
            session_id: currentSessionId  // ä½¿ç”¨å½“å‰ä¼šè¯ID
          }),
          signal: abortController.signal  // æ”¯æŒå–æ¶ˆè¯·æ±‚
        });
        
        clearTimeout(timeoutId);  // æ¸…é™¤è¶…æ—¶å®šæ—¶å™¨
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        
        hideTypingIndicator();
        
        // æ›´æ–°ç”¨æˆ·æ¶ˆæ¯çŠ¶æ€ä¸ºå·²é€è¾¾
        updateMessageStatus(userMessageId, 'sent');
        
        // æ›´æ–°ä¼šè¯IDï¼ˆå¦‚æœAPIè¿”å›äº†æ–°çš„ä¼šè¯IDï¼‰
        if (data.data && data.data.session_id) {
          currentSessionId = data.data.session_id;
          // å¦‚æœå½“å‰å¯¹è¯è¿˜æ²¡æœ‰sessionIdï¼Œæ›´æ–°å®ƒ
          if (chatHistory[currentChatId] && !chatHistory[currentChatId].sessionId) {
            chatHistory[currentChatId].sessionId = currentSessionId;
          }
        }
        
        if (data.success) {
          const answer = data.data.llm_answer || "";
          const audioBase64 = data.data.audio_base64 || null;
          const audioUrl = data.data.audio_url || null;  // å¦‚æœéŸ³é¢‘å·²ä¿å­˜ä¸ºæ–‡ä»¶
          const audioDuration = data.data.audio_duration || 0;
          const videoUrl = data.data.video_url || null;  // è§†é¢‘URLï¼ˆå¦‚æœåç«¯ç›´æ¥è¿”å›ï¼‰
          const videoTaskId = data.data.video_task_id || null;  // è§†é¢‘ä»»åŠ¡IDï¼ˆå¦‚æœå¼‚æ­¥ç”Ÿæˆï¼‰
          const assistantMessageId = data.data.assistant_message_id || `assistant-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
          
          // æ ¹æ®å“åº”æ¨¡å¼å¤„ç†ä¸åŒçš„æ˜¾ç¤ºé€»è¾‘
          // å¯¹äºéè§†é¢‘æ¨¡å¼ï¼Œåœæ­¢æ—¥å¿—è½®è¯¢ï¼ˆLLMå’ŒTTSå·²å®Œæˆï¼‰
          if (responseMode !== "video") {
            stopLogPolling();
          }
          // å¯¹äºè§†é¢‘æ¨¡å¼ï¼Œç»§ç»­æ—¥å¿—è½®è¯¢ç›´åˆ°è§†é¢‘ç”Ÿæˆå®Œæˆ
          
          if (responseMode === "text") {
            // æ–‡æœ¬æ¨¡å¼ï¼šåªæ˜¾ç¤ºæ–‡æœ¬
            if (!answer || answer.length === 0) {
              addMessage("AIå›å¤ä¸ºç©º", false, null, 0, assistantMessageId, 'sent');
              sendBtn.disabled = false;
            } else {
              streamingMessageId = assistantMessageId;
              isStreaming = true;
          
          // å…ˆåˆ›å»ºç©ºæ¶ˆæ¯
              addMessage("", false, null, 0, assistantMessageId, 'sent', {
                responseMode: "text"
              });
              
              // é€å­—æ˜¾ç¤ºæ–‡æœ¬
              let currentText = "";
              for (let i = 0; i < answer.length; i++) {
                if (!isStreaming) break;
                currentText += answer[i];
                updateMessageText(assistantMessageId, currentText, false);
                await new Promise(resolve => setTimeout(resolve, 30));
              }
              
              updateMessageText(assistantMessageId, answer, true);
              isStreaming = false;
              streamingMessageId = null;
              sendBtn.disabled = false;
            }
            
            // ä¿å­˜æ¶ˆæ¯åˆ°å†å²è®°å½•
            if (chatHistory[currentChatId]) {
              const existingMessage = chatHistory[currentChatId].messages.find(m => m.messageId === assistantMessageId);
              if (!existingMessage) {
                chatHistory[currentChatId].messages.push({
                  text: answer,
                  isUser: false,
                  messageId: assistantMessageId,
                  status: 'sent',
                  time: new Date().toISOString(),
                  responseMode: "text"
                });
              }
            }
          } else if (responseMode === "audio" && (audioBase64 || audioUrl)) {
            // è¯­éŸ³æ¨¡å¼ï¼šæ˜¾ç¤ºè¯­éŸ³æ°”æ³¡ï¼ˆæ˜¾ç¤ºç§’æ•°ï¼‰ï¼Œä¸æ˜¾ç¤ºæ–‡æœ¬ï¼Œç‚¹å‡»æ’­æ”¾
            addMessage("", false, null, audioDuration, assistantMessageId, 'sent', {
              responseMode: "audio",
              audioBase64: audioBase64,
              audioUrl: audioUrl,
              audioDuration: audioDuration
            });
            
            // åˆ›å»ºè¯­éŸ³æ°”æ³¡æ˜¾ç¤º
            const messageDiv = document.querySelector(`[data-message-id="${assistantMessageId}"]`);
            if (messageDiv) {
              const bubble = messageDiv.querySelector('.message-bubble');
              if (bubble) {
                const audioBubble = document.createElement("div");
                audioBubble.className = "audio-bubble";
                
                const icon = document.createElement("span");
                icon.className = "audio-bubble-icon";
                icon.textContent = "ğŸ”Š";
                
                const duration = document.createElement("span");
                duration.className = "audio-bubble-duration";
                const durationText = audioDuration > 0 
                  ? `${Math.floor(audioDuration)}ç§’` 
                  : "éŸ³é¢‘";
                duration.textContent = durationText;
                
                audioBubble.appendChild(icon);
                audioBubble.appendChild(duration);
                
                // åˆ›å»ºéšè—çš„éŸ³é¢‘å…ƒç´ ç”¨äºæ’­æ”¾
                const audio = document.createElement("audio");
                audio.style.display = "none";
                if (audioUrl) {
                  audio.src = `${FASTAPI_URL}${audioUrl}`;
                } else if (audioBase64) {
                audio.src = `data:audio/wav;base64,${audioBase64}`;
                }
                
                // å½“éŸ³é¢‘å…ƒæ•°æ®åŠ è½½å®Œæˆåï¼Œæ›´æ–°æ—¶é•¿æ˜¾ç¤ºï¼ˆå¦‚æœaudioDurationä¸º0æˆ–æœªè®¾ç½®ï¼‰
                if (audioDuration <= 0) {
                  audio.addEventListener('loadedmetadata', () => {
                    if (audio.duration && isFinite(audio.duration)) {
                      duration.textContent = `${Math.floor(audio.duration)}ç§’`;
                    }
                  }, { once: true });
                }
                
                // ç‚¹å‡»æ°”æ³¡æ’­æ”¾éŸ³é¢‘
                audioBubble.addEventListener("click", () => {
                  if (audio.paused) {
                    audio.play().catch(e => {
                      console.error("æ’­æ”¾éŸ³é¢‘å¤±è´¥:", e);
                      showToast("æ’­æ”¾éŸ³é¢‘å¤±è´¥", "error");
                    });
                  } else {
                    audio.pause();
                    audio.currentTime = 0;
                  }
                });
                
                // æ’­æ”¾çŠ¶æ€æ›´æ–°å›¾æ ‡
                audio.addEventListener('play', () => {
                  icon.textContent = "ğŸ”Š";
                });
                audio.addEventListener('pause', () => {
                  icon.textContent = "ğŸ”Š";
                  audio.currentTime = 0;
                });
                audio.addEventListener('ended', () => {
                  audio.currentTime = 0;
                });
                
                // ç›´æ¥æ›¿æ¢bubbleçš„å†…å®¹ï¼Œä½¿ç”¨audio-bubbleï¼Œæ¸…é™¤message-bubbleæ ·å¼
                bubble.innerHTML = "";
                bubble.className = ""; // æ¸…é™¤message-bubbleçš„æ ·å¼
                bubble.appendChild(audioBubble);
                bubble.appendChild(audio);
                    
                // ä¿å­˜æ¶ˆæ¯åˆ°å†å²è®°å½•
                if (chatHistory[currentChatId]) {
                  const existingMessage = chatHistory[currentChatId].messages.find(m => m.messageId === assistantMessageId);
                  if (!existingMessage) {
                    chatHistory[currentChatId].messages.push({
                      text: "", // è¯­éŸ³æ¨¡å¼ä¸ä¿å­˜æ–‡æœ¬
                      isUser: false,
                      messageId: assistantMessageId,
                      status: 'sent',
                      time: new Date().toISOString(),
                      responseMode: "audio",
                      audioBase64: audioBase64,
                      audioUrl: audioUrl,
                      audioDuration: audioDuration
                    });
                  }
                }
              }
            }
            sendBtn.disabled = false;
          } else if (responseMode === "video") {
            // è§†é¢‘æ¨¡å¼ï¼šæŒ‰ç…§generate.htmlçš„æ–¹å¼ï¼Œç›´æ¥è°ƒç”¨ /generate_video API
            isWaitingForVideo = true;
            
            // å…ˆæ˜¾ç¤º"è§†é¢‘ç”Ÿæˆä¸­"çš„å ä½ç¬¦
            addMessage("", false, null, 0, assistantMessageId, 'sent', {
              responseMode: "video"
            });
            
            const messageDiv = document.querySelector(`[data-message-id="${assistantMessageId}"]`);
            if (messageDiv) {
              const bubble = messageDiv.querySelector('.message-bubble');
              if (bubble) {
                bubble.textContent = "è§†é¢‘ç”Ÿæˆä¸­...";
              }
            }
            
            // ç›´æ¥è°ƒç”¨ /generate_video APIï¼ˆå°±åƒgenerate.htmlé‚£æ ·ï¼‰
            // æ³¨æ„ï¼šæ¥è‡ªèŠå¤©ï¼Œä¼ é€’is_from_chat=trueï¼Œè¿™æ ·è§†é¢‘ä¸ä¼šä¿å­˜åˆ°video_recordsæ•°æ®åº“
            try {
              const videoResult = await generateVideo({
                text: answer,  // ä½¿ç”¨LLMç”Ÿæˆçš„å›ç­”ä½œä¸ºè¾“å…¥
                character: character,
                model_name: model,  // ä½¿ç”¨æ¨¡å‹åï¼ˆå’Œgenerate.htmlå®Œå…¨ä¸€è‡´ï¼‰
                is_from_chat: true  // æ ‡è®°ä¸ºæ¥è‡ªèŠå¤©ï¼Œä¸ä¿å­˜åˆ°video_recordsæ•°æ®åº“
              });
              
              if (!videoResult.success) {
                throw new Error(videoResult.error || 'è§†é¢‘ä»»åŠ¡æäº¤å¤±è´¥');
              }
              
              const videoTaskId = videoResult.unique_id;
                    
              // æ›´æ–°æ¶ˆæ¯ï¼Œæ·»åŠ videoTaskId
              if (messageDiv) {
                const bubble = messageDiv.querySelector('.message-bubble');
                if (bubble) {
                  const messageData = chatHistory[currentChatId]?.messages?.find(m => m.messageId === assistantMessageId);
                  if (messageData) {
                    messageData.videoTaskId = videoTaskId;
                  }
                }
                    }
                    
              // å¼€å§‹è½®è¯¢è§†é¢‘ç”ŸæˆçŠ¶æ€ï¼ˆå®Œå…¨æŒ‰ç…§generate.htmlçš„é€»è¾‘ï¼‰
              let pollCount = 0;
              let lastProgress = 0;
              let consecutiveFailures = 0;
              const startTime = Date.now();
              const MAX_RUNTIME_SECONDS = 1800;
              
              const checkVideoStatus = async () => {
                try {
                  pollCount++;
                  const elapsedSeconds = (Date.now() - startTime) / 1000;
                  
                  if (elapsedSeconds > MAX_RUNTIME_SECONDS) {
                    stopLogPolling();
                    isWaitingForVideo = false;
                      sendBtn.disabled = false;
                    const messageDiv = document.querySelector(`[data-message-id="${assistantMessageId}"]`);
                    if (messageDiv) {
                      const bubble = messageDiv.querySelector('.message-bubble');
                      if (bubble) {
                        bubble.textContent = "è§†é¢‘ç”Ÿæˆè¶…æ—¶";
                      }
                    }
                    showToast('è§†é¢‘ç”Ÿæˆæ—¶é—´è¿‡é•¿ï¼Œå·²åœæ­¢ç›‘æ§', 'warning');
                    return;
                  }
                  
                  const statusResult = await getVideoGenerationStatus(videoTaskId);
                  
                  if (!statusResult.success) {
                    consecutiveFailures++;
                    if (consecutiveFailures >= 5) {
                      stopLogPolling();
                      isWaitingForVideo = false;
                      sendBtn.disabled = false;
                      showToast("è§†é¢‘çŠ¶æ€æŸ¥è¯¢å¤±è´¥ï¼Œå·²åœæ­¢ç›‘æ§", "error");
                      return;
                    }
                    setTimeout(checkVideoStatus, 2000);
                    return;
                  }
                  
                  if (!statusResult.data) {
                    consecutiveFailures++;
                    if (consecutiveFailures >= 5) {
                      stopLogPolling();
                      isWaitingForVideo = false;
                      sendBtn.disabled = false;
                      showToast("è§†é¢‘ä»»åŠ¡ä¸å­˜åœ¨ï¼Œå·²åœæ­¢ç›‘æ§", "error");
                      return;
                    }
                    setTimeout(checkVideoStatus, 2000);
                    return;
                  }
                  
                  consecutiveFailures = 0;
                  const task = statusResult.data;
                  const status = task.status;
                  
                  // æ›´æ–°è¿›åº¦ï¼ˆå®Œå…¨æŒ‰ç…§generate.htmlçš„é€»è¾‘ï¼‰
                  if (status === 'pending') {
                    updateProgress('video', 10, false);
                  } else if (status === 'running') {
                    let progress = 30;
                    if (elapsedSeconds <= 30) {
                      progress = 30 + Math.floor((elapsedSeconds / 30) * 10);
                    } else if (elapsedSeconds <= 90) {
                      progress = 40 + Math.floor(((elapsedSeconds - 30) / 60) * 10);
                    } else if (elapsedSeconds <= 150) {
                      progress = 50 + Math.floor(((elapsedSeconds - 90) / 60) * 10);
                    } else if (elapsedSeconds <= 210) {
                      progress = 60 + Math.floor(((elapsedSeconds - 150) / 60) * 10);
                    } else if (elapsedSeconds <= 270) {
                      progress = 70 + Math.floor(((elapsedSeconds - 210) / 60) * 10);
                    } else {
                      progress = Math.min(80 + Math.floor(((elapsedSeconds - 270) / 60) * 10), 90);
                    }
                    
                    if (progress < lastProgress) {
                      progress = lastProgress;
                    } else if (progress === lastProgress && elapsedSeconds > 60) {
                      progress = Math.min(lastProgress + 0.5, 90);
                    }
                    
                    lastProgress = progress;
                    updateProgress('video', progress, false);
                    setTimeout(checkVideoStatus, 2000);
                  } else if (status === 'completed') {
                                  // è§†é¢‘ç”Ÿæˆå®Œæˆ
                    updateProgress('video', 100, false);
                    stopLogPolling();
                                  
                    // ä»ä»»åŠ¡æ•°æ®ä¸­è·å–video_pathï¼ˆæ–‡ä»¶ç³»ç»Ÿè·¯å¾„ï¼‰
                    const videoPath = task.video_path;  // è¿™æ˜¯æ–‡ä»¶ç³»ç»Ÿè·¯å¾„ï¼Œå¦‚ /path/to/videos/task_id.mp4
                    const finalVideoUrl = `${FASTAPI_URL}/videos/${videoTaskId}.mp4`;
                    
                    // å¦‚æœvideo_pathå­˜åœ¨ï¼Œæ›´æ–°chat_messagesè¡¨çš„video_path
                    if (videoPath && typeof updateMessageVideoPath === 'function') {
                      try {
                        const updateResult = await updateMessageVideoPath(assistantMessageId, videoPath);
                        if (updateResult.success) {
                          console.log('[èŠå¤©] è§†é¢‘è·¯å¾„å·²æ›´æ–°åˆ°æ•°æ®åº“:', videoPath);
                        } else {
                          console.warn('[èŠå¤©] æ›´æ–°è§†é¢‘è·¯å¾„å¤±è´¥:', updateResult.error);
                        }
                      } catch (error) {
                        console.error('[èŠå¤©] æ›´æ–°è§†é¢‘è·¯å¾„å¼‚å¸¸:', error);
                      }
                    }
                    
                    // æ›´æ–°æ¶ˆæ¯ï¼Œæ˜¾ç¤ºè§†é¢‘é¢„è§ˆæ¡†
                                  const messageDiv = document.querySelector(`[data-message-id="${assistantMessageId}"]`);
                                  if (messageDiv) {
                                    const bubble = messageDiv.querySelector('.message-bubble');
                                    if (bubble) {
                        const videoPreviewBox = document.createElement("div");
                        videoPreviewBox.className = "video-preview-box";
                                      
                                        const video = document.createElement("video");
                        const urlWithTimestamp = finalVideoUrl + (finalVideoUrl.includes('?') ? '&' : '?') + 't=' + Date.now();
                        video.src = urlWithTimestamp;
                        video.muted = true;
                        video.loop = true;
                        video.playsInline = true;
                        
                        // è¯¦ç»†çš„é”™è¯¯å¤„ç†
                        video.onerror = async function(e) {
                          console.error("è§†é¢‘åŠ è½½å¤±è´¥:", {
                            videoUrl: finalVideoUrl,
                            src: video.src,
                            error: e,
                            networkState: video.networkState,
                            readyState: video.readyState
                          });
                          
                          // å°è¯•æ£€æŸ¥è§†é¢‘æ–‡ä»¶æ˜¯å¦å­˜åœ¨
                          let errorMessage = "è§†é¢‘åŠ è½½å¤±è´¥";
                          try {
                            const checkResponse = await fetch(finalVideoUrl, { method: 'HEAD' });
                            if (!checkResponse.ok) {
                              if (checkResponse.status === 404) {
                                errorMessage = `è§†é¢‘æ–‡ä»¶ä¸å­˜åœ¨ (404): ${finalVideoUrl}`;
                              } else {
                                errorMessage = `è§†é¢‘æœåŠ¡å™¨é”™è¯¯ (${checkResponse.status}): ${finalVideoUrl}`;
                              }
                            } else {
                              const contentType = checkResponse.headers.get('content-type');
                              if (!contentType || !contentType.startsWith('video/')) {
                                errorMessage = `è§†é¢‘æ ¼å¼é”™è¯¯ï¼ŒContent-Type: ${contentType || 'æœªçŸ¥'}`;
                              } else {
                                errorMessage = `è§†é¢‘åŠ è½½å¤±è´¥ï¼Œå¯èƒ½æ ¼å¼ä¸æ”¯æŒæˆ–æ–‡ä»¶æŸå`;
                              }
                            }
                          } catch (fetchError) {
                            errorMessage = `æ— æ³•è®¿é—®è§†é¢‘æ–‡ä»¶: ${fetchError.message || 'ç½‘ç»œé”™è¯¯'}`;
                          }
                          
                          console.error("è§†é¢‘åŠ è½½è¯¦ç»†é”™è¯¯:", errorMessage);
                          bubble.textContent = errorMessage;
                          videoPreviewBox.style.display = "none";
                        };
                        
                        const playIcon = document.createElement("div");
                        playIcon.className = "video-play-icon";
                        playIcon.textContent = "â–¶";
                        
                        videoPreviewBox.appendChild(video);
                        videoPreviewBox.appendChild(playIcon);
                        
                        videoPreviewBox.addEventListener("click", () => {
                          const fullVideo = document.createElement("video");
                          fullVideo.controls = true;
                          fullVideo.style.width = "350px";
                          fullVideo.style.height = "350px";
                          fullVideo.style.borderRadius = "12px";
                          fullVideo.style.objectFit = "cover";
                          const fullUrlWithTimestamp = finalVideoUrl + (finalVideoUrl.includes('?') ? '&' : '?') + 't=' + Date.now();
                          fullVideo.src = fullUrlWithTimestamp;
                          fullVideo.muted = false;
                          
                          bubble.innerHTML = "";
                          bubble.appendChild(fullVideo);
                          
                          fullVideo.onerror = async function(e) {
                            console.error("å…¨å±è§†é¢‘æ’­æ”¾å¤±è´¥:", {
                              videoUrl: finalVideoUrl,
                              src: fullVideo.src,
                              error: e,
                              networkState: fullVideo.networkState,
                              readyState: fullVideo.readyState
                            });
                            
                            let errorMessage = "è§†é¢‘æ’­æ”¾å¤±è´¥";
                            try {
                              const checkResponse = await fetch(finalVideoUrl, { method: 'HEAD' });
                              if (!checkResponse.ok) {
                                if (checkResponse.status === 404) {
                                  errorMessage = `è§†é¢‘æ–‡ä»¶ä¸å­˜åœ¨ (404)`;
                                } else {
                                  errorMessage = `è§†é¢‘æœåŠ¡å™¨é”™è¯¯ (${checkResponse.status})`;
                                }
                              } else {
                                const contentType = checkResponse.headers.get('content-type');
                                if (!contentType || !contentType.startsWith('video/')) {
                                  errorMessage = `è§†é¢‘æ ¼å¼é”™è¯¯ (Content-Type: ${contentType || 'æœªçŸ¥'})`;
                                } else {
                                  errorMessage = `è§†é¢‘æ’­æ”¾å¤±è´¥ï¼Œå¯èƒ½æ ¼å¼ä¸æ”¯æŒæˆ–æ–‡ä»¶æŸå`;
                                }
                              }
                            } catch (fetchError) {
                              errorMessage = `æ— æ³•è®¿é—®è§†é¢‘æ–‡ä»¶: ${fetchError.message || 'ç½‘ç»œé”™è¯¯'}`;
                            }
                            
                            console.error("å…¨å±è§†é¢‘æ’­æ”¾è¯¦ç»†é”™è¯¯:", errorMessage);
                            showToast(errorMessage, "error");
                          };
                          
                          fullVideo.play().catch(e => {
                            console.error("æ’­æ”¾è§†é¢‘å¼‚å¸¸:", e);
                            showToast(`æ’­æ”¾å¤±è´¥: ${e.message || 'æœªçŸ¥é”™è¯¯'}`, "error");
                          });
                        });
                        
                        video.addEventListener('loadeddata', () => {
                          video.currentTime = 0.1;
                        }, { once: true });
                        
                        bubble.innerHTML = "";
                        bubble.appendChild(videoPreviewBox);
                      }
                    }
                                      
                                      // æ›´æ–°å†å²è®°å½•
                                      if (chatHistory[currentChatId]) {
                                        const message = chatHistory[currentChatId].messages.find(m => m.messageId === assistantMessageId);
                                        if (message) {
                        message.videoUrl = finalVideoUrl;
                                          message.videoTaskId = videoTaskId;
                                    }
                                  }
                                  
                                  isWaitingForVideo = false;
                                  sendBtn.disabled = false;
                    showToast('è§†é¢‘ç”ŸæˆæˆåŠŸï¼', 'success');
                  } else if (status === 'failed' || status === 'cancelled') {
                    stopLogPolling();
                                  isWaitingForVideo = false;
                                  sendBtn.disabled = false;
                    const error = task.error || (status === 'cancelled' ? 'ä»»åŠ¡å·²å–æ¶ˆ' : 'æœªçŸ¥é”™è¯¯');
                    const messageDiv = document.querySelector(`[data-message-id="${assistantMessageId}"]`);
                    if (messageDiv) {
                      const bubble = messageDiv.querySelector('.message-bubble');
                      if (bubble) {
                        bubble.textContent = `è§†é¢‘ç”Ÿæˆå¤±è´¥: ${error}`;
                                }
                    }
                    showToast(status === 'cancelled' ? 'ä»»åŠ¡å·²å–æ¶ˆ' : ('ç”Ÿæˆå¤±è´¥: ' + error), 'error');
                              } else {
                    setTimeout(checkVideoStatus, 2000);
                              }
                            } catch (error) {
                              console.error("æŸ¥è¯¢è§†é¢‘çŠ¶æ€å¤±è´¥:", error);
                  consecutiveFailures++;
                  if (consecutiveFailures >= 5) {
                    stopLogPolling();
                              isWaitingForVideo = false;
                              sendBtn.disabled = false;
                    showToast("æŸ¥è¯¢è§†é¢‘çŠ¶æ€å¤±è´¥ï¼Œå·²åœæ­¢ç›‘æ§", "error");
                  } else {
                    setTimeout(checkVideoStatus, 2000);
                  }
                            }
                          };
                          
                          // å¼€å§‹è½®è¯¢
                          setTimeout(checkVideoStatus, 2000);
                      } catch (error) {
              console.error("è§†é¢‘ä»»åŠ¡æäº¤å¤±è´¥:", error);
              stopLogPolling();
                        isWaitingForVideo = false;
                        sendBtn.disabled = false;
              const messageDiv = document.querySelector(`[data-message-id="${assistantMessageId}"]`);
              if (messageDiv) {
                const bubble = messageDiv.querySelector('.message-bubble');
                if (bubble) {
                  bubble.textContent = `è§†é¢‘ä»»åŠ¡æäº¤å¤±è´¥: ${error.message || error}`;
                }
              }
              showToast("è§†é¢‘ä»»åŠ¡æäº¤å¤±è´¥: " + (error.message || error), "error");
                  }
          }
          
          // ä¿å­˜æ¶ˆæ¯åˆ°å†å²è®°å½•ï¼ˆæ•°æ®åº“å·²è‡ªåŠ¨ä¿å­˜ï¼Œè¿™é‡Œä¸éœ€è¦é¢å¤–æ“ä½œï¼‰
          saveChatHistory();
          } else {
          // é”™è¯¯å¤„ç†ï¼ˆå…¼å®¹æ—§é€»è¾‘ï¼Œç”¨äºéresponseModeçš„æƒ…å†µï¼‰
          // è¿™éƒ¨åˆ†ä»£ç ä¿ç•™ç”¨äºå‘åå…¼å®¹
          if (false) { // è¿™ä¸ªåˆ†æ”¯æš‚æ—¶ä¸ä½¿ç”¨
              addMessage("", false, null, 0, assistantMessageId, 'sent', {
                responseMode: "video",
                videoUrl: videoUrl
              });
            
              // åˆ›å»ºè§†é¢‘é¢„è§ˆæ¡†
              const messageDiv = document.querySelector(`[data-message-id="${assistantMessageId}"]`);
              if (messageDiv) {
                const bubble = messageDiv.querySelector('.message-bubble');
                if (bubble) {
                  const videoPreviewBox = document.createElement("div");
                  videoPreviewBox.className = "video-preview-box";
                  
                  const video = document.createElement("video");
                  video.src = videoUrl + '?t=' + Date.now();
                  video.muted = true; // é¢„è§ˆæ—¶é™éŸ³
                  video.loop = true;
                  video.playsInline = true;
                  
                  const playIcon = document.createElement("div");
                  playIcon.className = "video-play-icon";
                  playIcon.textContent = "â–¶";
                  
                  videoPreviewBox.appendChild(video);
                  videoPreviewBox.appendChild(playIcon);
                  
                  // ç‚¹å‡»é¢„è§ˆæ¡†æ’­æ”¾è§†é¢‘
                  videoPreviewBox.addEventListener("click", () => {
                    const fullVideo = document.createElement("video");
                    fullVideo.controls = true;
                    fullVideo.style.width = "350px";
                    fullVideo.style.height = "350px";
                    fullVideo.style.borderRadius = "12px";
                    fullVideo.style.objectFit = "cover";
                    fullVideo.src = videoUrl + '?t=' + Date.now();
                    fullVideo.muted = false;
                    
                    bubble.innerHTML = "";
                    bubble.appendChild(fullVideo);
                    
                    fullVideo.play().catch(e => {
                      console.error("æ’­æ”¾è§†é¢‘å¤±è´¥:", e);
                      showToast("æ’­æ”¾è§†é¢‘å¤±è´¥", "error");
                    });
                  });
            
                  // åŠ è½½è§†é¢‘ç¬¬ä¸€å¸§ä½œä¸ºé¢„è§ˆ
                  video.addEventListener('loadeddata', () => {
                    video.currentTime = 0.1;
                  }, { once: true });
                  
                  bubble.innerHTML = "";
                  bubble.appendChild(videoPreviewBox);
          
          // ä¿å­˜æ¶ˆæ¯åˆ°å†å²è®°å½•
          if (chatHistory[currentChatId]) {
            const existingMessage = chatHistory[currentChatId].messages.find(m => m.messageId === assistantMessageId);
            if (!existingMessage) {
              chatHistory[currentChatId].messages.push({
                        text: "", // è§†é¢‘æ¨¡å¼ä¸ä¿å­˜æ–‡æœ¬
                isUser: false,
                messageId: assistantMessageId,
                status: 'sent',
                        time: new Date().toISOString(),
                        responseMode: "video",
                        videoUrl: videoUrl
              });
            }
          }
                }
              }
              sendBtn.disabled = false;
            } else if (videoTaskId) {
              // å¦‚æœåç«¯è¿”å›äº†è§†é¢‘ä»»åŠ¡IDï¼Œéœ€è¦è½®è¯¢è§†é¢‘ç”ŸæˆçŠ¶æ€
              isWaitingForVideo = true;
              
              // å…ˆæ˜¾ç¤º"è§†é¢‘ç”Ÿæˆä¸­"çš„å ä½ç¬¦
              addMessage("", false, null, 0, assistantMessageId, 'sent', {
                responseMode: "video",
                videoTaskId: videoTaskId
              });
              
              const messageDiv = document.querySelector(`[data-message-id="${assistantMessageId}"]`);
              if (messageDiv) {
                const bubble = messageDiv.querySelector('.message-bubble');
                if (bubble) {
                  bubble.textContent = "è§†é¢‘ç”Ÿæˆä¸­...";
                }
              }
              
              // è½®è¯¢è§†é¢‘ç”ŸæˆçŠ¶æ€
              const checkVideoStatus = async () => {
                try {
                  const statusResult = await getVideoGenerationStatus(videoTaskId);
                  
                  if (statusResult.success) {
                    const status = statusResult.data.status;
                    
                    if (status === 'completed') {
                      const finalVideoUrl = `${FASTAPI_URL}/videos/${videoTaskId}.mp4`;
                      
                      // æ›´æ–°æ¶ˆæ¯ï¼Œæ˜¾ç¤ºè§†é¢‘é¢„è§ˆæ¡†
                      const messageDiv = document.querySelector(`[data-message-id="${assistantMessageId}"]`);
                      if (messageDiv) {
                        const bubble = messageDiv.querySelector('.message-bubble');
                        if (bubble) {
                          const videoPreviewBox = document.createElement("div");
                          videoPreviewBox.className = "video-preview-box";
                          
                          const video = document.createElement("video");
                          video.src = finalVideoUrl + '?t=' + Date.now();
                          video.muted = true;
                          video.loop = true;
                          video.playsInline = true;
                          
                          const playIcon = document.createElement("div");
                          playIcon.className = "video-play-icon";
                          playIcon.textContent = "â–¶";
                          
                          videoPreviewBox.appendChild(video);
                          videoPreviewBox.appendChild(playIcon);
                          
                          videoPreviewBox.addEventListener("click", () => {
                            const fullVideo = document.createElement("video");
                            fullVideo.controls = true;
                            fullVideo.style.width = "350px";
                            fullVideo.style.height = "350px";
                            fullVideo.style.borderRadius = "12px";
                            fullVideo.style.objectFit = "cover";
                            fullVideo.src = finalVideoUrl + '?t=' + Date.now();
                            fullVideo.muted = false;
                            
                            bubble.innerHTML = "";
                            bubble.appendChild(fullVideo);
                            
                            fullVideo.play().catch(e => {
                              console.error("æ’­æ”¾è§†é¢‘å¤±è´¥:", e);
                              showToast("æ’­æ”¾è§†é¢‘å¤±è´¥", "error");
                            });
                          });
                          
                          video.addEventListener('loadeddata', () => {
                            video.currentTime = 0.1;
                          }, { once: true });
                          
                          bubble.innerHTML = "";
                          bubble.appendChild(videoPreviewBox);
                        }
                      }
                      
                      // æ›´æ–°å†å²è®°å½•
                      if (chatHistory[currentChatId]) {
                        const message = chatHistory[currentChatId].messages.find(m => m.messageId === assistantMessageId);
                        if (message) {
                          message.videoUrl = finalVideoUrl;
                          message.videoTaskId = videoTaskId;
                        }
                      }
                      
                      // è§†é¢‘ç”Ÿæˆå®Œæˆï¼Œåœæ­¢æ—¥å¿—è½®è¯¢
                      stopLogPolling();
                      isWaitingForVideo = false;
                      sendBtn.disabled = false;
                    } else if (status === 'running' || status === 'pending') {
                      setTimeout(checkVideoStatus, 2000);
                    } else {
                      showToast("è§†é¢‘ç”Ÿæˆå¤±è´¥", "error");
                      stopLogPolling();
                      const messageDiv = document.querySelector(`[data-message-id="${assistantMessageId}"]`);
                      if (messageDiv) {
                        const bubble = messageDiv.querySelector('.message-bubble');
                        if (bubble) {
                          bubble.textContent = "è§†é¢‘ç”Ÿæˆå¤±è´¥";
                        }
                      }
                      isWaitingForVideo = false;
                      sendBtn.disabled = false;
                    }
                  } else {
                    showToast("æŸ¥è¯¢è§†é¢‘çŠ¶æ€å¤±è´¥", "error");
                    stopLogPolling();
                    isWaitingForVideo = false;
                    sendBtn.disabled = false;
                  }
                } catch (error) {
                  console.error("æŸ¥è¯¢è§†é¢‘çŠ¶æ€å¤±è´¥:", error);
                  showToast("æŸ¥è¯¢è§†é¢‘çŠ¶æ€å¤±è´¥", "error");
                  stopLogPolling();
                  isWaitingForVideo = false;
                  sendBtn.disabled = false;
                }
              };
              
              setTimeout(checkVideoStatus, 2000);
            } else {
              // è§†é¢‘æ¨¡å¼ä½†æ²¡æœ‰è§†é¢‘æ•°æ®ï¼Œæ˜¾ç¤ºé”™è¯¯
              stopLogPolling();
              addMessage("è§†é¢‘ç”Ÿæˆå¤±è´¥ï¼šæœªè¿”å›è§†é¢‘æ•°æ®", false, null, 0, assistantMessageId, 'sent');
              sendBtn.disabled = false;
            }
          }
          
          // ä¿å­˜æ¶ˆæ¯åˆ°å†å²è®°å½•ï¼ˆæ•°æ®åº“å·²è‡ªåŠ¨ä¿å­˜ï¼Œè¿™é‡Œä¸éœ€è¦é¢å¤–æ“ä½œï¼‰
          saveChatHistory();
      } catch (error) {
        hideTypingIndicator();
        isWaitingForAudio = false;
        isWaitingForVideo = false;
        
        // åœæ­¢æ—¥å¿—è½®è¯¢
        stopLogPolling();
        
        // å¦‚æœæ˜¯å–æ¶ˆè¯·æ±‚ï¼Œä¸æ˜¾ç¤ºé”™è¯¯
        if (error.name === 'AbortError') {
          console.log("è¯·æ±‚å·²å–æ¶ˆ");
          // åœæ­¢æµå¼è¾“å‡º
          isStreaming = false;
          const currentStreamingId = streamingMessageId; // ä¿å­˜å½“å‰å€¼
          streamingMessageId = null;
          isWaitingForAudio = false;
          
          // ç§»é™¤å‘é€ä¸­çš„ç”¨æˆ·æ¶ˆæ¯
          const userMessageDiv = document.querySelector(`[data-message-id="${userMessageId}"]`);
          if (userMessageDiv) {
            userMessageDiv.remove();
          }
          
          // ç§»é™¤æ­£åœ¨ç”Ÿæˆçš„æ¶ˆæ¯ï¼ˆå¦‚æœæœ‰ï¼‰
          if (currentStreamingId) {
            const streamingDiv = document.querySelector(`[data-message-id="${currentStreamingId}"]`);
            if (streamingDiv) {
              streamingDiv.remove();
            }
          }
          
          // ç§»é™¤è¾“å…¥æŒ‡ç¤ºå™¨
          hideTypingIndicator();
          
          // æ¢å¤å‘é€æŒ‰é’®
          sendBtn.disabled = false;
          
          return;
        }
        
        const errorMessage = "âŒ ç½‘ç»œé”™è¯¯: " + error.message;
        const errorMessageId = `msg-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
        const errorDiv = addMessage(errorMessage, false, null, 0, errorMessageId);
        
        // æ·»åŠ é‡è¯•æŒ‰é’®
        const retryBtn = document.createElement("button");
        retryBtn.className = "retry-btn";
        retryBtn.textContent = "ğŸ”„ é‡è¯•";
        retryBtn.onclick = () => {
          sendMessage(text, userMessageId);
          errorDiv.remove();
        };
        errorDiv.querySelector('.message-bubble').appendChild(retryBtn);
        
        // æ›´æ–°ç”¨æˆ·æ¶ˆæ¯çŠ¶æ€ä¸ºé”™è¯¯
        updateMessageStatus(userMessageId, 'error');
      } finally {
        // ç¡®ä¿åœæ­¢æ—¥å¿—è½®è¯¢
        stopLogPolling();
        
        // å¦‚æœä¸åœ¨ç­‰å¾…éŸ³é¢‘ï¼Œæ¢å¤å‘é€æŒ‰é’®
        if (!isWaitingForAudio && !isWaitingForVideo) {
        sendBtn.disabled = false;
        }
        abortController = null;
      }
    }
    
    // å‘é€æŒ‰é’®ç‚¹å‡»
    sendBtn.addEventListener("click", () => {
      sendMessage(chatInput.value.trim());
    });
    
    // Enterå‘é€ï¼ŒShift+Enteræ¢è¡Œ
    chatInput.addEventListener("keydown", (e) => {
      // å¦‚æœæ­£åœ¨å¤„ç†è¯­éŸ³è¯†åˆ«ï¼Œç¦æ­¢å‘é€
      if (isTranscribing) {
        if (e.key === "Enter" && !e.shiftKey) {
          e.preventDefault();
          showToast("è¯·ç­‰å¾…è¯­éŸ³è¯†åˆ«å®Œæˆ", "warning");
        }
        return;
      }
      
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        sendMessage(chatInput.value.trim());
      }
    });
    
    // ==================== ç¦ç”¨/å¯ç”¨è¾“å…¥æ§ä»¶ ====================
    function setInputControlsDisabled(disabled) {
      const chatInput = document.getElementById("chatInput");
      const recordBtn = document.getElementById("recordBtn");
      const uploadBtn = document.getElementById("uploadBtn");
      const sendBtn = document.getElementById("sendBtn");
      
      if (chatInput) {
        chatInput.disabled = disabled;
      }
      if (recordBtn) {
        recordBtn.disabled = disabled;
      }
      if (uploadBtn) {
        uploadBtn.disabled = disabled;
      }
      // sendBtn åœ¨è¯­éŸ³è¯†åˆ«æœŸé—´ä¹Ÿç¦ç”¨ï¼Œè¯†åˆ«å®Œæˆåæ¢å¤
      if (sendBtn) {
        sendBtn.disabled = disabled;
      }
    }
    
    // ==================== è¯­éŸ³å½•åˆ¶åŠŸèƒ½ ====================
    async function startRecording() {
      // å¦‚æœæ­£åœ¨å¤„ç†è¯­éŸ³è¯†åˆ«ï¼Œç¦æ­¢å½•åˆ¶
      if (isTranscribing) {
        showToast("è¯·ç­‰å¾…è¯­éŸ³è¯†åˆ«å®Œæˆ", "warning");
        return;
      }
      
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);
        audioChunks = [];
        
        mediaRecorder.ondataavailable = (event) => {
          if (event.data.size > 0) {
          audioChunks.push(event.data);
          }
        };
        
        mediaRecorder.onstop = async () => {
          const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
          
          // è½¬æ¢ä¸ºBase64
          const reader = new FileReader();
          reader.onload = async () => {
            const arrayBuffer = reader.result;
            const base64 = btoa(String.fromCharCode(...new Uint8Array(arrayBuffer)));
            currentAudioBase64 = base64;
            
            // ç¦ç”¨è¾“å…¥æ§ä»¶ï¼Œå¼€å§‹è¯­éŸ³è¯†åˆ«
            isTranscribing = true;
            setInputControlsDisabled(true);
            showToast("æ­£åœ¨è¯†åˆ«è¯­éŸ³...", "info");
            
            try {
              // è‡ªåŠ¨è¿›è¡Œè¯­éŸ³è¯†åˆ«
              const text = await performTranscription();
              if (text) {
                // å°†è¯†åˆ«åˆ°çš„æ–‡æœ¬å¡«å…¥è¾“å…¥æ¡†
                chatInput.value = text;
                showToast("è¯­éŸ³è¯†åˆ«å®Œæˆ", "success");
                // å¯é€‰ï¼šè‡ªåŠ¨å‘é€æ¶ˆæ¯
                // sendMessage(text);
              } else {
                showToast("è¯­éŸ³è¯†åˆ«å¤±è´¥", "error");
              }
            } catch (error) {
              console.error('è¯­éŸ³è¯†åˆ«å‡ºé”™:', error);
              showToast("è¯­éŸ³è¯†åˆ«å¤±è´¥: " + (error.message || "æœªçŸ¥é”™è¯¯"), "error");
            } finally {
              // æ¢å¤è¾“å…¥æ§ä»¶
              isTranscribing = false;
              setInputControlsDisabled(false);
            }
          };
          reader.readAsArrayBuffer(audioBlob);
          
          // åœæ­¢æ‰€æœ‰éŸ³é¢‘è½¨é“
          stream.getTracks().forEach(track => track.stop());
        };
        
        mediaRecorder.start();
        isRecording = true;
        recordBtn.classList.add("recording");
        recordBtn.textContent = "â¹ï¸";
        recordBtn.title = "åœæ­¢å½•åˆ¶";
        
        // æ˜¾ç¤ºå½•éŸ³æ—¶é—´ï¼ˆå¦‚æœæœ‰recordingTimeå…ƒç´ ï¼‰
        recordingStartTime = Date.now();
        if (recordingTimer) clearInterval(recordingTimer);
        recordingTimer = setInterval(() => {
          const elapsed = Math.floor((Date.now() - recordingStartTime) / 1000);
          const minutes = Math.floor(elapsed / 60);
          const seconds = elapsed % 60;
          // å¯ä»¥åœ¨è¿™é‡Œæ›´æ–°å½•éŸ³æ—¶é—´æ˜¾ç¤º
        }, 1000);
      } catch (error) {
        console.error('å½•éŸ³å¤±è´¥:', error);
        alert("æ— æ³•è®¿é—®éº¦å…‹é£: " + error.message);
      }
    }
    
    function stopRecording() {
      if (mediaRecorder && isRecording) {
        mediaRecorder.stop();
        isRecording = false;
        recordBtn.classList.remove("recording");
        recordBtn.textContent = "ğŸ¤";
        recordBtn.title = "å½•åˆ¶è¯­éŸ³";
        
        // æ¸…é™¤å½•éŸ³è®¡æ—¶å™¨
        if (recordingTimer) {
          clearInterval(recordingTimer);
          recordingTimer = null;
        }
      }
    }
    
    // è¯­éŸ³è¯†åˆ«
    async function performTranscription() {
      if (!currentAudioBase64) {
        showToast('æ²¡æœ‰å¯è¯†åˆ«çš„éŸ³é¢‘', "error");
        return null;
      }

      try {
        // ä½¿ç”¨api.jsä¸­çš„å‡½æ•°ï¼Œæ”¯æŒè¶…æ—¶å¤„ç†
        const result = await transcribeAudio({
          audio_base64: currentAudioBase64,
          model_name: 'base',
          language: null,
          task: 'transcribe'
        });

        if (result.success && result.data) {
          const text = result.data.text || '';
          return text;
        } else {
          throw new Error(result.error?.message || result.error || 'è¯†åˆ«å¤±è´¥');
        }
      } catch (error) {
        console.error('è¯­éŸ³è¯†åˆ«å¤±è´¥:', error);
        const errorMsg = error.message || 'è¯†åˆ«å¤±è´¥';
        throw error; // æŠ›å‡ºé”™è¯¯ï¼Œè®©è°ƒç”¨è€…å¤„ç†
      }
    }
    
    recordBtn.addEventListener("click", () => {
      // å¦‚æœæ­£åœ¨å¤„ç†è¯­éŸ³è¯†åˆ«ï¼Œç¦æ­¢å½•åˆ¶
      if (isTranscribing) {
        showToast("è¯·ç­‰å¾…è¯­éŸ³è¯†åˆ«å®Œæˆ", "warning");
        return;
      }
      
      if (isRecording) {
        stopRecording();
      } else {
        startRecording();
      }
    });
    
    // ==================== éŸ³é¢‘ä¸Šä¼ åŠŸèƒ½ ====================
    uploadBtn.addEventListener("click", () => {
      // å¦‚æœæ­£åœ¨å¤„ç†è¯­éŸ³è¯†åˆ«ï¼Œç¦æ­¢ä¸Šä¼ 
      if (isTranscribing) {
        showToast("è¯·ç­‰å¾…è¯­éŸ³è¯†åˆ«å®Œæˆ", "warning");
        return;
      }
      audioUpload.click();
    });
    
    audioUpload.addEventListener("change", async (e) => {
      const file = e.target.files[0];
      if (!file) {
        audioUpload.value = "";
        return;
      }
      
      // å¦‚æœæ­£åœ¨å¤„ç†è¯­éŸ³è¯†åˆ«ï¼Œç¦æ­¢ä¸Šä¼ 
      if (isTranscribing) {
        showToast("è¯·ç­‰å¾…è¯­éŸ³è¯†åˆ«å®Œæˆ", "warning");
        audioUpload.value = "";
        return;
      }
      
      if (!file.type.startsWith('audio/')) {
        showToast("è¯·é€‰æ‹©éŸ³é¢‘æ–‡ä»¶ï¼", "error");
        audioUpload.value = "";
        return;
      }
      
      // æ£€æŸ¥æ–‡ä»¶å¤§å°ï¼ˆé™åˆ¶ä¸º50MBï¼‰
      const maxSize = 50 * 1024 * 1024; // 50MB
      if (file.size > maxSize) {
        showToast("éŸ³é¢‘æ–‡ä»¶è¿‡å¤§ï¼Œè¯·é€‰æ‹©å°äº50MBçš„æ–‡ä»¶", "error");
        audioUpload.value = "";
        return;
      }
      
      console.log('å¼€å§‹å¤„ç†ä¸Šä¼ çš„éŸ³é¢‘æ–‡ä»¶:', {
        name: file.name,
        type: file.type,
        size: file.size
      });
      
      // è¯»å–æ–‡ä»¶å¹¶è½¬æ¢ä¸ºBase64ï¼ˆå®Œå…¨æŒ‰ç…§å½•éŸ³çš„æ–¹å¼å¤„ç†ï¼‰
      const reader = new FileReader();
      
      reader.onload = async () => {
        try {
          const arrayBuffer = reader.result;
          console.log('æ–‡ä»¶è¯»å–å®Œæˆï¼ŒArrayBufferå¤§å°:', arrayBuffer.byteLength);
          
          // ä½¿ç”¨ä¸å½•éŸ³ç›¸åŒçš„æ–¹å¼è½¬æ¢ä¸ºBase64ï¼ˆå¤„ç†å¤§æ–‡ä»¶ï¼‰
          const uint8Array = new Uint8Array(arrayBuffer);
          // å¯¹äºå¤§æ–‡ä»¶ï¼Œåˆ†å—å¤„ç†é¿å…"Maximum call stack size exceeded"é”™è¯¯
          let base64 = '';
          const chunkSize = 8192; // æ¯æ¬¡å¤„ç†8KB
          for (let i = 0; i < uint8Array.length; i += chunkSize) {
            const chunk = uint8Array.slice(i, i + chunkSize);
            base64 += String.fromCharCode.apply(null, chunk);
          }
          base64 = btoa(base64);
          
          console.log('Base64è½¬æ¢å®Œæˆï¼Œé•¿åº¦:', base64.length);
          currentAudioBase64 = base64;
          
          // ç¦ç”¨è¾“å…¥æ§ä»¶ï¼Œå¼€å§‹è¯­éŸ³è¯†åˆ«ï¼ˆä¸å½•éŸ³å®Œå…¨ä¸€è‡´ï¼‰
          isTranscribing = true;
          setInputControlsDisabled(true);
          showToast("æ­£åœ¨è¯†åˆ«è¯­éŸ³...", "info");
          
          try {
            // è‡ªåŠ¨è¿›è¡Œè¯­éŸ³è¯†åˆ«ï¼ˆä¸å½•éŸ³ä½¿ç”¨ç›¸åŒçš„å‡½æ•°ï¼‰
            const text = await performTranscription();
            if (text && text.trim()) {
              // å°†è¯†åˆ«åˆ°çš„æ–‡æœ¬å¡«å…¥è¾“å…¥æ¡†
              chatInput.value = text;
              showToast("è¯­éŸ³è¯†åˆ«å®Œæˆ", "success");
              console.log('è¯­éŸ³è¯†åˆ«æˆåŠŸï¼Œæ–‡æœ¬:', text);
              // å¯é€‰ï¼šè‡ªåŠ¨å‘é€æ¶ˆæ¯
              // sendMessage(text);
            } else {
              showToast("è¯­éŸ³è¯†åˆ«å¤±è´¥ï¼šæœªè¯†åˆ«åˆ°æ–‡æœ¬", "error");
              console.warn('è¯­éŸ³è¯†åˆ«è¿”å›ç©ºæ–‡æœ¬');
            }
          } catch (error) {
            console.error('è¯­éŸ³è¯†åˆ«å‡ºé”™:', error);
            showToast("è¯­éŸ³è¯†åˆ«å¤±è´¥: " + (error.message || "æœªçŸ¥é”™è¯¯"), "error");
          } finally {
            // æ¢å¤è¾“å…¥æ§ä»¶
            isTranscribing = false;
            setInputControlsDisabled(false);
            currentAudioBase64 = null; // æ¸…ç†ï¼Œé‡Šæ”¾å†…å­˜
          }
        } catch (error) {
          console.error('Base64è½¬æ¢å¤±è´¥:', error);
          showToast('éŸ³é¢‘æ–‡ä»¶å¤„ç†å¤±è´¥: ' + (error.message || "æœªçŸ¥é”™è¯¯"), "error");
          currentAudioBase64 = null;
          // æ¢å¤è¾“å…¥æ§ä»¶
          isTranscribing = false;
          setInputControlsDisabled(false);
        }
      };
      
      reader.onerror = (error) => {
        console.error('æ–‡ä»¶è¯»å–é”™è¯¯:', error);
        showToast('è¯»å–éŸ³é¢‘æ–‡ä»¶å¤±è´¥', "error");
        currentAudioBase64 = null;
        // æ¢å¤è¾“å…¥æ§ä»¶
        isTranscribing = false;
        setInputControlsDisabled(false);
      };
      
      // å¼€å§‹è¯»å–æ–‡ä»¶ï¼ˆä¸å½•éŸ³ä½¿ç”¨ç›¸åŒçš„æ–¹å¼ï¼‰
      try {
        reader.readAsArrayBuffer(file);
      } catch (error) {
        console.error('è¯»å–æ–‡ä»¶å¤±è´¥:', error);
        showToast('è¯»å–éŸ³é¢‘æ–‡ä»¶å¤±è´¥: ' + (error.message || "æœªçŸ¥é”™è¯¯"), "error");
        currentAudioBase64 = null;
        // æ¢å¤è¾“å…¥æ§ä»¶
        isTranscribing = false;
        setInputControlsDisabled(false);
        audioUpload.value = "";
      }
      
      // æ³¨æ„ï¼šä¸åœ¨è¿™é‡Œé‡ç½®æ–‡ä»¶è¾“å…¥ï¼Œç­‰å¤„ç†å®Œæˆåå†é‡ç½®
      // å¦‚æœç«‹å³é‡ç½®ï¼Œå¯èƒ½ä¼šå¯¼è‡´æŸäº›æµè§ˆå™¨çš„é—®é¢˜
    });
    
    // ==================== éŸ³é‡æ§åˆ¶ ====================
    function updateAllAudioVolumes() {
      if (!volumeSlider) return;
      // æ›´æ–°æ‰€æœ‰éŸ³é¢‘å…ƒç´ çš„éŸ³é‡ï¼ˆåŒ…æ‹¬éšè—çš„audioå…ƒç´ ï¼‰
      const volume = isMuted ? 0 : volumeSlider.value / 100;
      // æ›´æ–°å½“å‰éŸ³é¢‘å¼•ç”¨
      if (currentAudio) {
        currentAudio.volume = volume;
      }
      // æ›´æ–°æ‰€æœ‰æ¶ˆæ¯ä¸­çš„éšè—éŸ³é¢‘å…ƒç´ ï¼ˆaudio-bubbleä¸­çš„audioå…ƒç´ ï¼‰
      const allMessageAudios = document.querySelectorAll('.message audio');
      allMessageAudios.forEach(audio => {
        audio.volume = volume;
      });
    }
    
    if (volumeSlider && volumeValue) {
    volumeSlider.addEventListener("input", (e) => {
      const volume = e.target.value;
      volumeValue.textContent = volume + "%";
      updateAllAudioVolumes();
    });
    }
    
    if (volumeBtn && volumeControl) {
    volumeBtn.addEventListener("click", () => {
      isMuted = !isMuted;
      
      if (isMuted) {
        volumeBtn.textContent = "ğŸ”‡";
        volumeControl.classList.add("muted");
      } else {
        volumeBtn.textContent = "ğŸ”Š";
        volumeControl.classList.remove("muted");
      }
      updateAllAudioVolumes();
    });
    }
    
    // ==================== å¯¹è¯ç®¡ç†åŠŸèƒ½ ====================
    // æ³¨æ„ï¼šå¯¹è¯ç®¡ç†æŒ‰é’®çš„äº‹ä»¶ç›‘å¬å™¨å·²åœ¨ DOMContentLoaded å¤–éƒ¨ç»‘å®š
    
    // ç¼–è¾‘å¯¹è¯åç§°
    function editChatName(chatId, titleSpan, editBtn) {
      const chatData = chatHistory[chatId];
      if (!chatData) return;
      
      const currentTitle = chatData.title || 'æœªå‘½åå¯¹è¯';
      const input = document.createElement("input");
      input.type = "text";
      input.value = currentTitle;
      input.style.width = "100%";
      
      // æ›¿æ¢æ ‡é¢˜ä¸ºè¾“å…¥æ¡†
      titleSpan.style.display = 'none';
      editBtn.style.display = 'none';
      titleSpan.parentElement.insertBefore(input, titleSpan);
      
      input.focus();
      input.select();
      
      const finishEdit = () => {
        const newTitle = input.value.trim() || 'æœªå‘½åå¯¹è¯';
        chatData.title = newTitle;
        titleSpan.textContent = newTitle;
        titleSpan.style.display = '';
        editBtn.style.display = '';
        input.remove();
        saveChatHistory();
        updateHistoryList(); // é‡æ–°æ¸²æŸ“ä»¥æ›´æ–°æ˜¾ç¤º
      };
      
      input.addEventListener("blur", finishEdit);
      input.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          e.preventDefault();
          finishEdit();
        } else if (e.key === "Escape") {
          titleSpan.style.display = '';
          editBtn.style.display = '';
          input.remove();
        }
      });
    }
    
    // æ›´æ–°å†å²åˆ—è¡¨
    function updateHistoryList() {
      const historyList = document.getElementById("historyList");
      if (!historyList) return;
      historyList.innerHTML = '';
      
      // æ·»åŠ å½“å‰å¯¹è¯
      const currentItem = document.createElement("div");
      currentItem.className = `history-item ${currentChatId === 'current' ? 'active' : ''}`;
      currentItem.dataset.id = 'current';
      
      const currentTitleDiv = document.createElement("div");
      currentTitleDiv.className = "history-item-title";
      
      const currentTitleSpan = document.createElement("span");
      currentTitleSpan.textContent = "å½“å‰å¯¹è¯";
      currentTitleSpan.style.flex = '1';
      currentTitleSpan.style.cursor = 'pointer';
      
      const currentEditBtn = document.createElement("span");
      currentEditBtn.className = "history-item-edit";
      currentEditBtn.textContent = "âœï¸";
      currentEditBtn.title = "ç¼–è¾‘åç§°";
      currentEditBtn.onclick = (e) => {
        e.stopPropagation();
        editChatName('current', currentTitleSpan, currentEditBtn);
      };
      
      // åŒå‡»æ ‡é¢˜ä¹Ÿå¯ä»¥ç¼–è¾‘ï¼ˆä¸å½±å“å•å‡»åˆ‡æ¢å¯¹è¯ï¼‰
      currentTitleSpan.ondblclick = (e) => {
        e.stopPropagation();
        editChatName('current', currentTitleSpan, currentEditBtn);
      };
      
      // å•å‡»æ ‡é¢˜åŒºåŸŸæ—¶åˆ‡æ¢å¯¹è¯ï¼ˆä¸é˜»æ­¢äº‹ä»¶å†’æ³¡ï¼‰
      currentTitleSpan.onclick = (e) => {
        // ä¸é˜»æ­¢äº‹ä»¶ä¼ æ’­ï¼Œè®©itemçš„clickäº‹ä»¶è§¦å‘
      };
      
      currentTitleDiv.appendChild(currentTitleSpan);
      currentTitleDiv.appendChild(currentEditBtn);
      
      const currentTimeDiv = document.createElement("div");
      currentTimeDiv.className = "history-item-time";
      currentTimeDiv.textContent = "è¿›è¡Œä¸­";
      
      currentItem.appendChild(currentTitleDiv);
      currentItem.appendChild(currentTimeDiv);
      
      // ç¡®ä¿ç‚¹å‡»itemçš„ä»»ä½•ä½ç½®éƒ½èƒ½åˆ‡æ¢å¯¹è¯
      currentItem.addEventListener("click", (e) => {
        // å¦‚æœç‚¹å‡»çš„æ˜¯ç¼–è¾‘æŒ‰é’®ï¼Œä¸åˆ‡æ¢å¯¹è¯
        if (e.target === currentEditBtn || currentEditBtn.contains(e.target)) {
          return;
        }
        switchChat('current');
      });
      historyList.appendChild(currentItem);
      
      // æ·»åŠ å†å²å¯¹è¯ï¼ˆè¿‡æ»¤æ‰ç©ºçš„ä¼šè¯ï¼‰
      const sortedChats = Object.entries(chatHistory)
        .filter(([id]) => id !== 'current')
        .filter(([id, data]) => data.messages && data.messages.length > 0)  // åªæ˜¾ç¤ºæœ‰æ¶ˆæ¯çš„ä¼šè¯
        .sort((a, b) => new Date(b[1].time) - new Date(a[1].time));
      
      sortedChats.forEach(([chatId, chatData]) => {
        const item = document.createElement("div");
        item.className = `history-item ${currentChatId === chatId ? 'active' : ''}`;
        item.dataset.id = chatId;
        
        const titleDiv = document.createElement("div");
        titleDiv.className = "history-item-title";
        
        const titleSpan = document.createElement("span");
        titleSpan.textContent = chatData.title || 'æœªå‘½åå¯¹è¯';
        titleSpan.style.flex = '1';
        titleSpan.style.cursor = 'pointer';
        
        const editBtn = document.createElement("span");
        editBtn.className = "history-item-edit";
        editBtn.textContent = "âœï¸";
        editBtn.title = "ç¼–è¾‘åç§°";
        editBtn.onclick = (e) => {
          e.stopPropagation();
          editChatName(chatId, titleSpan, editBtn);
        };
        
        // åŒå‡»æ ‡é¢˜ä¹Ÿå¯ä»¥ç¼–è¾‘ï¼ˆä¸å½±å“å•å‡»åˆ‡æ¢å¯¹è¯ï¼‰
        titleSpan.ondblclick = (e) => {
          e.stopPropagation();
          editChatName(chatId, titleSpan, editBtn);
        };
        
        // å•å‡»æ ‡é¢˜åŒºåŸŸæ—¶åˆ‡æ¢å¯¹è¯ï¼ˆä¸é˜»æ­¢äº‹ä»¶å†’æ³¡ï¼‰
        titleSpan.onclick = (e) => {
          // ä¸é˜»æ­¢äº‹ä»¶ä¼ æ’­ï¼Œè®©itemçš„clickäº‹ä»¶è§¦å‘
        };
        
        titleDiv.appendChild(titleSpan);
        titleDiv.appendChild(editBtn);
        
        const timeDiv = document.createElement("div");
        timeDiv.className = "history-item-time";
        timeDiv.textContent = new Date(chatData.time).toLocaleString('zh-CN');
        
        item.appendChild(titleDiv);
        item.appendChild(timeDiv);
        
        // ç¡®ä¿ç‚¹å‡»itemçš„ä»»ä½•ä½ç½®éƒ½èƒ½åˆ‡æ¢å¯¹è¯
        item.addEventListener("click", (e) => {
          // å¦‚æœç‚¹å‡»çš„æ˜¯ç¼–è¾‘æŒ‰é’®ï¼Œä¸åˆ‡æ¢å¯¹è¯
          if (e.target === editBtn || editBtn.contains(e.target)) {
            return;
          }
          switchChat(chatId);
        });
        historyList.appendChild(item);
      });
    }
    
    // åˆ‡æ¢å¯¹è¯
    function switchChat(chatId) {
      // ä¿å­˜å½“å‰å¯¹è¯
      if (chatHistory[currentChatId]) {
        saveChatHistory();
      }
      
      // åˆ‡æ¢åˆ°æ–°å¯¹è¯
      currentChatId = chatId;
      
      // å¦‚æœå¯¹è¯ä¸å­˜åœ¨ï¼Œåˆ›å»ºæ–°å¯¹è¯
      if (!chatHistory[currentChatId]) {
        chatHistory[currentChatId] = {
          messages: [],
          title: chatId === 'current' ? "å½“å‰å¯¹è¯" : "æ–°å¯¹è¯",
          time: new Date().toISOString(),
          sessionId: null,
          character: null,
          model: null
        };
      } else {
        // å¦‚æœå¯¹è¯å­˜åœ¨ï¼Œæ¢å¤ä¼šè¯IDã€è§’è‰²å’Œæ¨¡å‹
        currentSessionId = chatHistory[currentChatId].sessionId || null;
        character = chatHistory[currentChatId].character || null;
        model = chatHistory[currentChatId].model || null;
      }
      
      // æ¸…ç©ºæ¶ˆæ¯æ˜¾ç¤ºåŒºåŸŸ
      chatMessages.innerHTML = '';
      
      // åŠ è½½å¯¹è¯æ¶ˆæ¯
      const messages = chatHistory[currentChatId].messages || [];
      if (messages.length === 0) {
        chatMessages.innerHTML = '<div class="empty-state"><p>ğŸ‘‹ å¼€å§‹å¯¹è¯å§ï¼è¾“å…¥æ–‡å­—æˆ–å½•åˆ¶è¯­éŸ³ä¸AIäº¤æµ</p></div>';
      } else {
        // ä¸´æ—¶ç¦ç”¨ä¿å­˜ï¼Œé¿å…é‡å¤ä¿å­˜
        const wasStreaming = isStreaming;
        isStreaming = true;
        
        messages.forEach(msg => {
          // å†å²è®°å½•æ˜¾ç¤ºå®Œæ•´å†…å®¹ï¼ˆæ–‡æœ¬ã€éŸ³é¢‘ã€è§†é¢‘ï¼‰
          // ç›´æ¥ä½¿ç”¨æ¶ˆæ¯å¯¹è±¡ä¸­çš„ responseModeï¼ˆå·²åœ¨ loadChatHistoryFromDatabase ä¸­æ¨æ–­ï¼‰
          const messageDiv = addMessage(
            msg.text,
            msg.isUser,
            msg.audioBase64 || null,  // ä¼ é€’éŸ³é¢‘æ•°æ®
            msg.audioDuration || 0,   // ä¼ é€’éŸ³é¢‘æ—¶é•¿
            msg.messageId,
            msg.status || 'sent',
            { 
              audioUrl: msg.audioUrl,
              videoUrl: msg.videoUrl,
              videoTaskId: msg.videoTaskId,
              responseMode: msg.responseMode  // ä½¿ç”¨å·²æ¨æ–­çš„ responseMode
            }
          );
          
          // å¦‚æœæ˜¯é”™è¯¯æ¶ˆæ¯ï¼Œæ·»åŠ é‡è¯•æŒ‰é’®
          if (!msg.isUser && msg.text.includes('âŒ')) {
            const retryBtn = document.createElement("button");
            retryBtn.className = "retry-btn";
            retryBtn.textContent = "ğŸ”„ é‡è¯•";
            retryBtn.onclick = () => {
              // æ‰¾åˆ°å¯¹åº”çš„ç”¨æˆ·æ¶ˆæ¯
              const userMsg = messages.find(m => m.isUser && messages.indexOf(m) < messages.indexOf(msg));
              if (userMsg) {
                sendMessage(userMsg.text, userMsg.messageId);
                messageDiv.remove();
              }
            };
            messageDiv.querySelector('.message-bubble').appendChild(retryBtn);
          }
        });
        
        // æ¢å¤æµå¼çŠ¶æ€
        isStreaming = wasStreaming;
      }
      
      // æ›´æ–°å†å²åˆ—è¡¨
      updateHistoryList();
      
      // å…³é—­ä¾§è¾¹æ 
      chatSidebar.classList.remove("active");
    }
    
    // æ³¨æ„ï¼šæ–°å»ºå¯¹è¯ã€æ¸…ç©ºå¯¹è¯ã€å¯¼å‡ºå¯¹è¯çš„äº‹ä»¶ç›‘å¬å™¨å·²åœ¨ DOMContentLoaded ä¸­ç»‘å®š
    
    // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨åŠ è½½å†å²èŠå¤©è®°å½•
    initChatHistory().then(() => {
    updateHistoryList();
    });
    
    // é¡µé¢å¸è½½æ—¶å–æ¶ˆæ­£åœ¨è¿›è¡Œçš„è¯·æ±‚ï¼ˆåªæœ‰çœŸæ­£å…³é—­æ ‡ç­¾é¡µæ—¶æ‰å–æ¶ˆï¼‰
    window.addEventListener('beforeunload', () => {
      if (abortController) {
        abortController.abort();
      }
    });
    
  </script>
</body>
</html>


